<!doctype html>



  


<html class="theme-next pisces use-motion">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Cloud, Container, Kubernetes, SDN, Docker" />





  <link rel="alternate" href="/atom.xml" title="Feisky's Blog" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.2" />






<meta name="description" content="Go语言技巧常用工具
go fmt
golint
go vet
goimports
https://goreportcard.com/

惯用法
注释用完整句子，以方法或包名开头
每行控制80字节长度
error字符串首字母小写
多个相同变量的返回值加上名字以便清晰
创建空slice：var t []int

技巧汇总避免循环中的变量逃逸到循环外func print(pi *int) &amp;#123;">
<meta property="og:type" content="website">
<meta property="og:title" content="Go语言技巧">
<meta property="og:url" content="http://feisky.xyz/programing/go.html">
<meta property="og:site_name" content="Feisky's Blog">
<meta property="og:description" content="Go语言技巧常用工具
go fmt
golint
go vet
goimports
https://goreportcard.com/

惯用法
注释用完整句子，以方法或包名开头
每行控制80字节长度
error字符串首字母小写
多个相同变量的返回值加上名字以便清晰
创建空slice：var t []int

技巧汇总避免循环中的变量逃逸到循环外func print(pi *int) &amp;#123;">
<meta property="og:updated_time" content="2016-11-13T00:02:28.563Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Go语言技巧">
<meta name="twitter:description" content="Go语言技巧常用工具
go fmt
golint
go vet
goimports
https://goreportcard.com/

惯用法
注释用完整句子，以方法或包名开头
每行控制80字节长度
error字符串首字母小写
多个相同变量的返回值加上名字以便清晰
创建空slice：var t []int

技巧汇总避免循环中的变量逃逸到循环外func print(pi *int) &amp;#123;">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"always"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    }
  };
</script>




  <link rel="canonical" href="http://feisky.xyz/programing/go.html"/>


  <title>
  

  
    Go语言技巧 | Feisky's Blog
  
</title><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>

<body itemscope itemtype="//schema.org/WebPage" lang="zh-Hans">

  


<!-- hexo-inject:begin --><!-- hexo-inject:end --><script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-69699206-1', 'auto');
  ga('send', 'pageview');
</script>









  
  
    
  

  <div class="container one-collumn sidebar-position-left  ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="//schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Feisky's Blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">Notes about anything.</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-pages">
          <a href="/pages" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            笔记
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404.html" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />
            
            公益404
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>


    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    
    
      <h1 id="Go语言技巧"><a href="#Go语言技巧" class="headerlink" title="Go语言技巧"></a>Go语言技巧</h1><h2 id="常用工具"><a href="#常用工具" class="headerlink" title="常用工具"></a>常用工具</h2><ul>
<li>go fmt</li>
<li>golint</li>
<li>go vet</li>
<li>goimports</li>
<li><a href="https://goreportcard.com/" target="_blank" rel="external">https://goreportcard.com/</a></li>
</ul>
<h2 id="惯用法"><a href="#惯用法" class="headerlink" title="惯用法"></a>惯用法</h2><ul>
<li>注释用完整句子，以方法或包名开头</li>
<li>每行控制80字节长度</li>
<li>error字符串首字母小写</li>
<li>多个相同变量的返回值加上名字以便清晰</li>
<li>创建空slice：<code>var t []int</code></li>
</ul>
<h2 id="技巧汇总"><a href="#技巧汇总" class="headerlink" title="技巧汇总"></a>技巧汇总</h2><h3 id="避免循环中的变量逃逸到循环外"><a href="#避免循环中的变量逃逸到循环外" class="headerlink" title="避免循环中的变量逃逸到循环外"></a>避免循环中的变量逃逸到循环外</h3><figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">print</span><span class="params">(pi *<span class="keyword">int</span>)</span></span> &#123; </div><div class="line">    fmt.Println(*pi) </div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;  </div><div class="line">    <span class="keyword">defer</span> fmt.Println(i) <span class="comment">// 预期的结果; 打印 9 ... 0</span></div><div class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span>&#123; fmt.Println(i) &#125;() <span class="comment">// 错误的结果; 打印10个"10"</span></div><div class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">(i <span class="keyword">int</span>)</span></span>&#123; fmt.Println(i) &#125;(i) <span class="comment">// 正确的预期结果</span></div><div class="line">    <span class="keyword">defer</span> <span class="built_in">print</span>(&amp;i) <span class="comment">// 错误的结果; 打印10个"10"</span></div><div class="line">    <span class="keyword">go</span> fmt.Println(i) <span class="comment">// 正确; 但是打印 0-9之间的顺序不保证</span></div><div class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span>&#123; fmt.Println(i) &#125;() <span class="comment">// 错误; 完全不可预知.</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">for</span> key, value := <span class="keyword">range</span> myMap &#123;  </div><div class="line">    <span class="comment">// Same for key &amp; value as i!</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>每个人期望这些值和循环内的值相同，但是Go重用了每次循环的变量. 这就意味着你绝对不要让<code>key，value，i</code>这些值的地址逃逸出循环。使用匿名函数<code>func() { /* do something with i */ } (a &quot;closure&quot;)</code>是一个微妙的解决地址逃逸问题的方法，因为在Go里面函数调用的参数是值copy。</p>
<p>另外一个例子：</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="keyword">type</span> T <span class="keyword">struct</span> &#123;</div><div class="line">	ID <span class="keyword">int</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *T)</span> <span class="title">PrintID</span><span class="params">()</span></span> &#123;</div><div class="line">	fmt.Println(t.ID)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">F1</span><span class="params">()</span></span> &#123;</div><div class="line">	ts := []T&#123;&#123;<span class="number">1</span>&#125;, &#123;<span class="number">2</span>&#125;, &#123;<span class="number">3</span>&#125;&#125;</div><div class="line">	<span class="keyword">for</span> _, t := <span class="keyword">range</span> ts &#123;</div><div class="line">		<span class="keyword">defer</span> t.PrintID() <span class="comment">// prints always 3</span></div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// a method call is equivalent to a regular function call </span></div><div class="line"><span class="comment">// with the receiver passed as an argument. Since the argument</span></div><div class="line"><span class="comment">// is evaluated at the time the defer statement is invoked,</span></div><div class="line"><span class="comment">// you get different values of t each time.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">F2</span><span class="params">()</span></span> &#123;</div><div class="line">	ts := []*T&#123;&amp;T&#123;<span class="number">1</span>&#125;, &amp;T&#123;<span class="number">2</span>&#125;, &amp;T&#123;<span class="number">3</span>&#125;&#125;</div><div class="line">	<span class="keyword">for</span> _, t := <span class="keyword">range</span> ts &#123;</div><div class="line">		<span class="keyword">defer</span> t.PrintID() <span class="comment">// prints 3, 2, 1</span></div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	fmt.Println(<span class="string">"F1()"</span>)</div><div class="line">	F1()</div><div class="line">	fmt.Println()</div><div class="line">	fmt.Println(<span class="string">"F2()"</span>)</div><div class="line">	F2()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="区分nil-interface跟nil指针成员的不同"><a href="#区分nil-interface跟nil指针成员的不同" class="headerlink" title="区分nil interface跟nil指针成员的不同"></a>区分nil interface跟nil指针成员的不同</h3><figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">type</span> Cat <span class="keyword">interface</span> &#123;</div><div class="line">  Meow()</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> Tabby <span class="keyword">struct</span> &#123;&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(*Tabby)</span> <span class="title">Meow</span><span class="params">()</span></span> &#123; fmt.Println(<span class="string">"meow"</span>) &#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetACat</span><span class="params">()</span> <span class="title">Cat</span></span> &#123;</div><div class="line">  <span class="keyword">var</span> myTabby *Tabby = <span class="literal">nil</span></div><div class="line">  <span class="comment">// Oops, we forgot to set myTabby to a real value</span></div><div class="line">  <span class="keyword">return</span> myTabby</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestGetACat</span><span class="params">(t *testing.T)</span></span> &#123;</div><div class="line">  <span class="keyword">if</span> GetACat() == <span class="literal">nil</span> &#123;</div><div class="line">    t.Errorf(<span class="string">"Forgot to return a real cat!"</span>)</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>大家猜猜会怎么样? 上面的这个测试讲永远不会检测到空指针。这是因为interface作为一个指针的容器来使用了，因此GetACat可以返回一个指针或者空指针. </p>
<pre><code>An interface value is nil only if the inner value and type are both unset, `(nil, nil)`. In particular, a nil interface will always hold a nil type. If we store a nil pointer of type `*int` inside an interface value, the inner type will be *int regardless of the value of the pointer: `(*int, nil)`. Such an interface value will therefore be non-nil even when the pointer inside is nil.
</code></pre><p>这种错误在err里面也是经常见 (详见 <a href="http://golang.org/doc/faq#nil_error" target="_blank" rel="external">http://golang.org/doc/faq#nil_error</a>)</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">returnsError</span><span class="params">()</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> p *MyError = <span class="literal">nil</span></div><div class="line">	<span class="keyword">if</span> bad() &#123;</div><div class="line">		p = ErrBad</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> p <span class="comment">// Will always return a non-nil error.</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>正确的做法是显式返回nil:</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">returnsError</span><span class="params">()</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> bad() &#123;</div><div class="line">		<span class="keyword">return</span> ErrBad</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="影子变量带来的困惑"><a href="#影子变量带来的困惑" class="headerlink" title="影子变量带来的困惑"></a>影子变量带来的困惑</h3><figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">var</span> ErrDidNotWork = errors.New(<span class="string">"did not work"</span>)</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">DoTheThing</span><span class="params">(reallyDoIt <span class="keyword">bool</span>)</span> <span class="params">(err error)</span></span> &#123;  </div><div class="line">    <span class="keyword">if</span> reallyDoIt &#123;    </div><div class="line">       result, err := tryTheThing()    </div><div class="line">       <span class="keyword">if</span> err != <span class="literal">nil</span> || result != <span class="string">"it worked"</span> &#123;</div><div class="line">         err = ErrDidNotWork</div><div class="line">       &#125;</div><div class="line">    &#125;  </div><div class="line">   <span class="keyword">return</span> err <span class="comment">//永远返回nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面的代码永远返回nil，这是因为循环内的err变量是一个函数返回err变量的影子变量. 所以上面的代码解决方案是添加一个<code>var result string</code>，而不要在内部使用<code>:=</code>来定义什么新变量。</p>
<p><del>2016-10-08补充</del></p>
<p>即使在同一个scope之内，也会出现影子变量问题，比如：</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"fmt"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">trivial</span><span class="params">()</span> <span class="params">(<span class="keyword">string</span>, <span class="keyword">string</span>)</span></span> &#123;</div><div class="line">    <span class="keyword">return</span> <span class="string">"hello"</span>, <span class="string">"world"</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="keyword">var</span> he = <span class="string">"hello, a"</span></div><div class="line">    <span class="keyword">defer</span> fmt.Println(<span class="string">"defer: "</span>, he)</div><div class="line">    he, wo := trivial()</div><div class="line">    fmt.Println(he, wo)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上述代码输出如下：</p>
<figure class="highlight avrasm"><table><tr><td class="code"><pre><div class="line">hello world</div><div class="line"><span class="symbol">defer:</span>  hello, a</div></pre></td></tr></table></figure>
<h3 id="开大括号不能放在单独的一行"><a href="#开大括号不能放在单独的一行" class="headerlink" title="开大括号不能放在单独的一行"></a>开大括号不能放在单独的一行</h3><p>在大多数其他使用大括号的语言中，你需要选择放置它们的位置。Go的方式不同。你可以为此感谢下自动分号的注入（没有预读）。是的，Go中也是有分号的：-）</p>
<p>Fails:  </p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>  </div><div class="line">&#123; <span class="comment">//error, can't have the opening brace on a separate line</span></div><div class="line">    fmt.Println(<span class="string">"hello there!"</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Compile Error:  </p>
<blockquote>
<p>/tmp/sandbox826898458/main.go:6: syntax error: unexpected semicolon or newline before {</p>
</blockquote>
<p>Works:  </p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    fmt.Println(<span class="string">"works!"</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="未使用的变量"><a href="#未使用的变量" class="headerlink" title="未使用的变量"></a>未使用的变量</h3><p>如果你有未使用的变量，代码将编译失败。当然也有例外。在函数内一定要使用声明的变量，但未使用的全局变量是没问题的。如果你给未使用的变量分配了一个新的值，代码还是会编译失败。你需要在某个地方使用这个变量，才能让编译器愉快的编译。</p>
<p>Fails:  </p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">var</span> gvar <span class="keyword">int</span> <span class="comment">//not an error</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    <span class="keyword">var</span> one <span class="keyword">int</span>   <span class="comment">//error, unused variable</span></div><div class="line">    two := <span class="number">2</span>      <span class="comment">//error, unused variable</span></div><div class="line">    <span class="keyword">var</span> three <span class="keyword">int</span> <span class="comment">//error, even though it's assigned 3 on the next line</span></div><div class="line">    three = <span class="number">3</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">func</span><span class="params">(unused <span class="keyword">string</span>)</span></span> &#123;</div><div class="line">        fmt.Println(<span class="string">"Unused arg. No compile error"</span>)</div><div class="line">    &#125;(<span class="string">"what?"</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Compile Errors:  </p>
<blockquote>
<p>/tmp/sandbox473116179/main.go:6: one declared and not used<br>/tmp/sandbox473116179/main.go:7: two declared and not used<br>/tmp/sandbox473116179/main.go:8: three declared and not used</p>
</blockquote>
<p>Works:  </p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    <span class="keyword">var</span> one <span class="keyword">int</span></div><div class="line">    _ = one</div><div class="line"></div><div class="line">    two := <span class="number">2</span> </div><div class="line">    fmt.Println(two)</div><div class="line"></div><div class="line">    <span class="keyword">var</span> three <span class="keyword">int</span> </div><div class="line">    three = <span class="number">3</span></div><div class="line">    one = three</div><div class="line"></div><div class="line">    <span class="keyword">var</span> four <span class="keyword">int</span></div><div class="line">    four = four</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>另一个选择是注释掉或者移除未使用的变量 ：-）</p>
<h3 id="未使用的Imports"><a href="#未使用的Imports" class="headerlink" title="未使用的Imports"></a>未使用的Imports</h3><p>如果你引入一个包，而没有使用其中的任何函数、接口、结构体或者变量的话，代码将会编译失败。如果你真的需要引入的包，你可以添加一个下划线标记符<code>_</code>来作为这个包的名字，从而避免编译失败。</p>
<p>Fails:  </p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (  </div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"log"</span></div><div class="line">    <span class="string">"time"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Compile Errors:  </p>
<blockquote>
<p>/tmp/sandbox627475386/main.go:4: imported and not used: “fmt”<br>/tmp/sandbox627475386/main.go:5: imported and not used: “log”<br>/tmp/sandbox627475386/main.go:6: imported and not used: “time”</p>
</blockquote>
<p>Works:  </p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (  </div><div class="line">    _ <span class="string">"fmt"</span></div><div class="line">    <span class="string">"log"</span></div><div class="line">    <span class="string">"time"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">var</span> _ = log.Println</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    _ = time.Now</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>另一个选择是移除或者注释掉未使用的imports， <a href="http://godoc.org/golang.org/x/tools/cmd/goimports" target="_blank" rel="external"><code>goimports</code></a>可以帮你来干这个活.</p>
<h3 id="简式的变量声明仅可以在函数内部使用"><a href="#简式的变量声明仅可以在函数内部使用" class="headerlink" title="简式的变量声明仅可以在函数内部使用"></a>简式的变量声明仅可以在函数内部使用</h3><p>Fails:  </p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line">myvar := <span class="number">1</span> <span class="comment">//error</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Compile Error:  </p>
<blockquote>
<p>/tmp/sandbox265716165/main.go:3: non-declaration statement outside function body</p>
</blockquote>
<p>Works:  </p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">var</span> myvar = <span class="number">1</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="使用简式声明重复声明变量"><a href="#使用简式声明重复声明变量" class="headerlink" title="使用简式声明重复声明变量"></a>使用简式声明重复声明变量</h3><p>你不能在一个单独的声明中重复声明一个变量，但在多变量声明中这是允许的，其中至少要有一个新的声明变量。</p>
<p>重复变量需要在相同的代码块内，否则你将得到一个隐藏变量。</p>
<p>Fails:  </p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    one := <span class="number">0</span></div><div class="line">    one := <span class="number">1</span> <span class="comment">//error</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Compile Error:  </p>
<blockquote>
<p>/tmp/sandbox706333626/main.go:5: no new variables on left side of :=</p>
</blockquote>
<p>Works:  </p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    one := <span class="number">0</span></div><div class="line">    one, two := <span class="number">1</span>,<span class="number">2</span></div><div class="line"></div><div class="line">    one,two = two,one</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="不能使用简式声明来设置成员变量"><a href="#不能使用简式声明来设置成员变量" class="headerlink" title="不能使用简式声明来设置成员变量"></a>不能使用简式声明来设置成员变量</h3><p>Fails:  </p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (  </div><div class="line">  <span class="string">"fmt"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">type</span> info <span class="keyword">struct</span> &#123;  </div><div class="line">  result <span class="keyword">int</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">work</span><span class="params">()</span> <span class="params">(<span class="keyword">int</span>,error)</span></span> &#123;  </div><div class="line">    <span class="keyword">return</span> <span class="number">13</span>,<span class="literal">nil</span>  </div><div class="line">  &#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">  <span class="keyword">var</span> data info</div><div class="line"></div><div class="line">  data.result, err := work() <span class="comment">//error</span></div><div class="line">  fmt.Printf(<span class="string">"info: %+v\n"</span>,data)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Compile Error:  </p>
<blockquote>
<p>prog.go:18: non-name data.result on left side of :=   </p>
</blockquote>
<p>解决方式是使用局部变量:</p>
<p>Works:  </p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (  </div><div class="line">  <span class="string">"fmt"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">type</span> info <span class="keyword">struct</span> &#123;  </div><div class="line">  result <span class="keyword">int</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">work</span><span class="params">()</span> <span class="params">(<span class="keyword">int</span>,error)</span></span> &#123;  </div><div class="line">    <span class="keyword">return</span> <span class="number">13</span>,<span class="literal">nil</span>  </div><div class="line">  &#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">  <span class="keyword">var</span> data info</div><div class="line"></div><div class="line">  <span class="keyword">var</span> err error</div><div class="line">  data.result, err = work() <span class="comment">//ok</span></div><div class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">    fmt.Println(err)</div><div class="line">    <span class="keyword">return</span></div><div class="line">  &#125;</div><div class="line"></div><div class="line">  fmt.Printf(<span class="string">"info: %+v\n"</span>,data) <span class="comment">//prints: info: &#123;result:13&#125;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Accidental-Variable-Shadowing"><a href="#Accidental-Variable-Shadowing" class="headerlink" title="Accidental Variable Shadowing"></a>Accidental Variable Shadowing</h3><p>短式变量声明的语法如此的方便（尤其对于那些使用过动态语言的开发者而言），很容易让人把它当成一个正常的分配操作。如果你在一个新的代码块中犯了这个错误，将不会出现编译错误，但你的应用将不会做你所期望的事情。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    x := <span class="number">1</span></div><div class="line">    fmt.Println(x)     <span class="comment">//prints 1</span></div><div class="line">    &#123;</div><div class="line">        fmt.Println(x) <span class="comment">//prints 1</span></div><div class="line">        x := <span class="number">2</span></div><div class="line">        fmt.Println(x) <span class="comment">//prints 2</span></div><div class="line">    &#125;</div><div class="line">    fmt.Println(x)     <span class="comment">//prints 1 (bad if you need 2)</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>即使对于经验丰富的Go开发者而言，这也是一个非常常见的陷阱。这个坑很容易挖，但又很难发现。</p>
<p>可以借助<a href="http://godoc.org/golang.org/x/tools/cmd/vet" target="_blank" rel="external"><code>vet</code></a>来排查这种问题，<code>go tool vet -shadow your_file.go</code>。</p>
<p>Note that the <code>vet</code> command will not report all shadowed variables. Use <a href="https://github.com/barakmich/go-nyet" target="_blank" rel="external"><code>go-nyet</code></a> for more aggressive shadowed variable detection.</p>
<h3 id="不使用显式类型，无法使用“nil”来初始化变量"><a href="#不使用显式类型，无法使用“nil”来初始化变量" class="headerlink" title="不使用显式类型，无法使用“nil”来初始化变量"></a>不使用显式类型，无法使用“nil”来初始化变量</h3><p>“nil”标志符用于表示interface、函数、maps、slices和channels的“零值”。如果你不指定变量的类型，编译器将无法编译你的代码，因为它猜不出具体的类型。</p>
<p>Fails:  </p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    <span class="keyword">var</span> x = <span class="literal">nil</span> <span class="comment">//error</span></div><div class="line"></div><div class="line">    _ = x</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Compile Error:  </p>
<blockquote>
<p>/tmp/sandbox188239583/main.go:4: use of untyped nil</p>
</blockquote>
<p>Works:  </p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    <span class="keyword">var</span> x <span class="keyword">interface</span>&#123;&#125; = <span class="literal">nil</span></div><div class="line"></div><div class="line">    _ = x</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Using-“nil”-Slices-and-Maps"><a href="#Using-“nil”-Slices-and-Maps" class="headerlink" title="Using “nil” Slices and Maps"></a>Using “nil” Slices and Maps</h3><p>在一个“nil”的slice中添加元素是没问题的，但对一个map做同样的事将会生成一个运行时的panic。</p>
<p>Works:  </p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    <span class="keyword">var</span> s []<span class="keyword">int</span></div><div class="line">    s = <span class="built_in">append</span>(s,<span class="number">1</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Fails:  </p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    <span class="keyword">var</span> m <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">int</span></div><div class="line">    m[<span class="string">"one"</span>] = <span class="number">1</span> <span class="comment">//error</span></div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Map-Capacity"><a href="#Map-Capacity" class="headerlink" title="Map Capacity"></a>Map Capacity</h3><p>你可以在map创建时指定它的容量，但你无法在map上使用cap()函数。</p>
<p>Fails:  </p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    m := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">int</span>,<span class="number">99</span>)</div><div class="line">    <span class="built_in">cap</span>(m) <span class="comment">//error</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Compile Error:  </p>
<blockquote>
<p>/tmp/sandbox326543983/main.go:5: invalid argument m (type map[string]int) for cap</p>
</blockquote>
<h3 id="Strings-Can’t-Be-“nil”"><a href="#Strings-Can’t-Be-“nil”" class="headerlink" title="Strings Can’t Be “nil”"></a>Strings Can’t Be “nil”</h3><p>这对于经常使用“nil”分配字符串变量的开发者而言是个需要注意的地方。</p>
<p>Fails:  </p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    <span class="keyword">var</span> x <span class="keyword">string</span> = <span class="literal">nil</span> <span class="comment">//error</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> x == <span class="literal">nil</span> &#123; <span class="comment">//error</span></div><div class="line">        x = <span class="string">"default"</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Compile Errors:  </p>
<blockquote>
<p>/tmp/sandbox630560459/main.go:4: cannot use nil as type string in assignment<br>/tmp/sandbox630560459/main.go:6: invalid operation: x == nil (mismatched types string and nil)</p>
</blockquote>
<p>Works:  </p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    <span class="keyword">var</span> x <span class="keyword">string</span> <span class="comment">//defaults to "" (zero value)</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> x == <span class="string">""</span> &#123;</div><div class="line">        x = <span class="string">"default"</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Array-Function-Arguments"><a href="#Array-Function-Arguments" class="headerlink" title="Array Function Arguments"></a>Array Function Arguments</h3><p>如果你是一个C或则C++开发者，那么数组对你而言就是指针。当你向函数中传递数组时，函数会参照相同的内存区域，这样它们就可以修改原始的数据。Go中的数组是数值，因此当你向函数中传递数组时，函数会得到原始数组数据的一份复制。如果你打算更新数组的数据，这将会是个问题。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    x := [<span class="number">3</span>]<span class="keyword">int</span>&#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>&#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">func</span><span class="params">(arr [3]<span class="keyword">int</span>)</span></span> &#123;</div><div class="line">        arr[<span class="number">0</span>] = <span class="number">7</span></div><div class="line">        fmt.Println(arr) <span class="comment">//prints [7 2 3]</span></div><div class="line">    &#125;(x)</div><div class="line"></div><div class="line">    fmt.Println(x) <span class="comment">//prints [1 2 3] (not ok if you need [7 2 3])</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果你需要更新原始数组的数据，你可以使用数组指针类型。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    x := [<span class="number">3</span>]<span class="keyword">int</span>&#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>&#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">func</span><span class="params">(arr *[3]<span class="keyword">int</span>)</span></span> &#123;</div><div class="line">        (*arr)[<span class="number">0</span>] = <span class="number">7</span></div><div class="line">        fmt.Println(arr) <span class="comment">//prints &amp;[7 2 3]</span></div><div class="line">    &#125;(&amp;x)</div><div class="line"></div><div class="line">    fmt.Println(x) <span class="comment">//prints [7 2 3]</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>另一个选择是使用slice。即使你的函数得到了slice变量的一份拷贝，它依旧会参照原始的数据。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    x := []<span class="keyword">int</span>&#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>&#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">func</span><span class="params">(arr []<span class="keyword">int</span>)</span></span> &#123;</div><div class="line">        arr[<span class="number">0</span>] = <span class="number">7</span></div><div class="line">        fmt.Println(arr) <span class="comment">//prints [7 2 3]</span></div><div class="line">    &#125;(x)</div><div class="line"></div><div class="line">    fmt.Println(x) <span class="comment">//prints [7 2 3]</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Unexpected-Values-in-Slice-and-Array-“range”-Clauses"><a href="#Unexpected-Values-in-Slice-and-Array-“range”-Clauses" class="headerlink" title="Unexpected Values in Slice and Array “range” Clauses"></a>Unexpected Values in Slice and Array “range” Clauses</h3><p>如果你在其他的语言中使用“for-in”或者“foreach”语句时会发生这种情况。Go中的“range”语法不太一样。它会得到两个值：第一个值是元素的索引，而另一个值是元素的数据。</p>
<p>Bad:  </p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    x := []<span class="keyword">string</span>&#123;<span class="string">"a"</span>,<span class="string">"b"</span>,<span class="string">"c"</span>&#125;</div><div class="line"></div><div class="line">    <span class="keyword">for</span> v := <span class="keyword">range</span> x &#123;</div><div class="line">        fmt.Println(v) <span class="comment">//prints 0, 1, 2</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Good:  </p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    x := []<span class="keyword">string</span>&#123;<span class="string">"a"</span>,<span class="string">"b"</span>,<span class="string">"c"</span>&#125;</div><div class="line"></div><div class="line">    <span class="keyword">for</span> _, v := <span class="keyword">range</span> x &#123;</div><div class="line">        fmt.Println(v) <span class="comment">//prints a, b, c</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Slices-and-Arrays-Are-One-Dimensional"><a href="#Slices-and-Arrays-Are-One-Dimensional" class="headerlink" title="Slices and Arrays Are One-Dimensional"></a>Slices and Arrays Are One-Dimensional</h3><p>看起来Go好像支持多维的Array和Slice，但不是这样的。尽管可以创建数组的数组或者切片的切片。对于依赖于动态多维数组的数值计算应用而言，Go在性能和复杂度上还相距甚远。</p>
<p>你可以使用纯一维数组、“独立”切片的切片，“共享数据”切片的切片来构建动态的多维数组。</p>
<p>如果你使用纯一维的数组，你需要处理索引、边界检查、当数组需要变大时的内存重新分配。</p>
<p>使用“独立”slice来创建一个动态的多维数组需要两步。首先，你需要创建一个外部的slice。然后，你需要分配每个内部的slice。内部的slice相互之间独立。你可以增加减少它们，而不会影响其他内部的slice。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    x := <span class="number">2</span></div><div class="line">    y := <span class="number">4</span></div><div class="line"></div><div class="line">    table := <span class="built_in">make</span>([][]<span class="keyword">int</span>,x)</div><div class="line">    <span class="keyword">for</span> i:= <span class="keyword">range</span> table &#123;</div><div class="line">        table[i] = <span class="built_in">make</span>([]<span class="keyword">int</span>,y)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>使用“共享数据”slice的slice来创建一个动态的多维数组需要三步。首先，你需要创建一个用于存放原始数据的数据“容器”。然后，你再创建外部的slice。最后，通过重新切片原始数据slice来初始化各个内部的slice。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    h, w := <span class="number">2</span>, <span class="number">4</span></div><div class="line"></div><div class="line">    raw := <span class="built_in">make</span>([]<span class="keyword">int</span>,h*w)</div><div class="line">    <span class="keyword">for</span> i := <span class="keyword">range</span> raw &#123;</div><div class="line">        raw[i] = i</div><div class="line">    &#125;</div><div class="line">    fmt.Println(raw,&amp;raw[<span class="number">4</span>])</div><div class="line">    <span class="comment">//prints: [0 1 2 3 4 5 6 7] &lt;ptr_addr_x&gt;</span></div><div class="line"></div><div class="line">    table := <span class="built_in">make</span>([][]<span class="keyword">int</span>,h)</div><div class="line">    <span class="keyword">for</span> i:= <span class="keyword">range</span> table &#123;</div><div class="line">        table[i] = raw[i*w:i*w + w]</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    fmt.Println(table,&amp;table[<span class="number">1</span>][<span class="number">0</span>])</div><div class="line">    <span class="comment">//prints: [[0 1 2 3] [4 5 6 7]] &lt;ptr_addr_x&gt;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Accessing-Non-Existing-Map-Keys"><a href="#Accessing-Non-Existing-Map-Keys" class="headerlink" title="Accessing Non-Existing Map Keys"></a>Accessing Non-Existing Map Keys</h3><p>这对于那些希望得到“nil”标示符的开发者而言是个技巧（和其他语言中做的一样）。如果对应的数据类型的“零值”是“nil”，那返回的值将会是“nil”，但对于其他的数据类型是不一样的。检测对应的“零值”可以用于确定map中的记录是否存在，但这并不总是可信（比如，如果在二值的map中“零值”是false，这时你要怎么做）。检测给定map中的记录是否存在的最可信的方法是，通过map的访问操作，检查第二个返回的值。</p>
<p>Bad:  </p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    x := <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>&#123;<span class="string">"one"</span>:<span class="string">"a"</span>,<span class="string">"two"</span>:<span class="string">""</span>,<span class="string">"three"</span>:<span class="string">"c"</span>&#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> v := x[<span class="string">"two"</span>]; v == <span class="string">""</span> &#123; <span class="comment">//incorrect</span></div><div class="line">        fmt.Println(<span class="string">"no entry"</span>)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Good:  </p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    x := <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>&#123;<span class="string">"one"</span>:<span class="string">"a"</span>,<span class="string">"two"</span>:<span class="string">""</span>,<span class="string">"three"</span>:<span class="string">"c"</span>&#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> _,ok := x[<span class="string">"two"</span>]; !ok &#123;</div><div class="line">        fmt.Println(<span class="string">"no entry"</span>)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Strings-Are-Immutable"><a href="#Strings-Are-Immutable" class="headerlink" title="Strings Are Immutable"></a>Strings Are Immutable</h3><p>尝试使用索引操作来更新字符串变量中的单个字符将会失败。string是只读的byte slice（和一些额外的属性）。如果你确实需要更新一个字符串，那么使用byte slice，并在需要时把它转换为string类型。</p>
<p>Fails:  </p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    x := <span class="string">"text"</span></div><div class="line">    x[<span class="number">0</span>] = <span class="string">'T'</span></div><div class="line"></div><div class="line">    fmt.Println(x)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Compile Error:  </p>
<blockquote>
<p>/tmp/sandbox305565531/main.go:7: cannot assign to x[0]</p>
</blockquote>
<p>Works:  </p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    x := <span class="string">"text"</span></div><div class="line">    xbytes := []<span class="keyword">byte</span>(x)</div><div class="line">    xbytes[<span class="number">0</span>] = <span class="string">'T'</span></div><div class="line"></div><div class="line">    fmt.Println(<span class="keyword">string</span>(xbytes)) <span class="comment">//prints Text</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>需要注意的是：这并不是在文字string中更新字符的正确方式，因为给定的字符可能会存储在多个byte中。如果你确实需要更新一个文字string，先把它转换为一个rune slice。即使使用rune slice，单个字符也可能会占据多个rune，比如当你的字符有特定的重音符号时就是这种情况。这种复杂又模糊的“字符”本质是Go字符串使用byte序列表示的原因。</p>
<h3 id="Conversions-Between-Strings-and-Byte-Slices"><a href="#Conversions-Between-Strings-and-Byte-Slices" class="headerlink" title="Conversions Between Strings and Byte Slices"></a>Conversions Between Strings and Byte Slices</h3><ul>
<li>level: beginner</li>
</ul>
<p>当你把一个字符串转换为一个byte slice（或者反之）时，你就得到了一个原始数据的完整拷贝。这和其他语言中cast操作不同，也和新的slice变量指向原始byte slice使用的相同数组时的重新slice操作不同。</p>
<p>Go在<code>[]byte</code>到<code>string</code>和<code>string</code>到<code>[]byte</code>的转换中确实使用了一些优化来避免额外的分配（在todo列表中有更多的优化）。</p>
<p>第一个优化避免了当<code>[]byte</code>key用于在<code>map[string]</code>集合中查询时的额外分配:<code>m[string(key)]</code>。</p>
<p>第二个优化避免了字符串转换为<code>[]byte</code>后在<code>for range</code>语句中的额外分配：<code>for i,v := range []byte(str) {...}</code>。</p>
<h3 id="Strings-and-Index-Operator"><a href="#Strings-and-Index-Operator" class="headerlink" title="Strings and Index Operator"></a>Strings and Index Operator</h3><p>字符串上的索引操作返回一个byte值，而不是一个字符（和其他语言中的做法一样）。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    x := <span class="string">"text"</span></div><div class="line">    fmt.Println(x[<span class="number">0</span>]) <span class="comment">//print 116</span></div><div class="line">    fmt.Printf(<span class="string">"%T"</span>,x[<span class="number">0</span>]) <span class="comment">//prints uint8</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果你需要访问特定的字符串“字符”（unicode编码的points/runes），使用<code>for range</code>。官方的“unicode/utf8”包和实验中的utf8string包（golang.org/x/exp/utf8string）也可以用。utf8string包中包含了一个很方便的<code>At()</code>方法。把字符串转换为rune的切片也是一个选项。</p>
<h3 id="Strings-Are-Not-Always-UTF8-Text"><a href="#Strings-Are-Not-Always-UTF8-Text" class="headerlink" title="Strings Are Not Always UTF8 Text"></a>Strings Are Not Always UTF8 Text</h3><p>字符串的值不需要是UTF8的文本。它们可以包含任意的字节。只有在string literal使用时，字符串才会是UTF8。即使之后它们可以使用转义序列来包含其他的数据。</p>
<p>为了知道字符串是否是UTF8，你可以使用“unicode/utf8”包中的<code>ValidString()</code>函数。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (  </div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"unicode/utf8"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    data1 := <span class="string">"ABC"</span></div><div class="line">    fmt.Println(utf8.ValidString(data1)) <span class="comment">//prints: true</span></div><div class="line"></div><div class="line">    data2 := <span class="string">"A\xfeC"</span></div><div class="line">    fmt.Println(utf8.ValidString(data2)) <span class="comment">//prints: false</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="String-Length"><a href="#String-Length" class="headerlink" title="String Length"></a>String Length</h3><p>让我们假设你是Python开发者，你有下面这段代码：</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line">data = u<span class="string">'♥'</span>  </div><div class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(data)) #prints: <span class="number">1</span></div></pre></td></tr></table></figure>
<p>当把它转换为Go代码时，你可能会大吃一惊。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    data := <span class="string">"♥"</span></div><div class="line">    fmt.Println(<span class="built_in">len</span>(data)) <span class="comment">//prints: 3</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>内建的<code>len()</code>函数返回byte的数量，而不是像Python中计算好的unicode字符串中字符的数量。</p>
<p>要在Go中得到相同的结果，可以使用“unicode/utf8”包中的<code>RuneCountInString()</code>函数:</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (  </div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"unicode/utf8"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    data := <span class="string">"♥"</span></div><div class="line">    fmt.Println(utf8.RuneCountInString(data)) <span class="comment">//prints: 1</span></div></pre></td></tr></table></figure>
<p>理论上说<code>RuneCountInString()</code>函数并不返回字符的数量，因为单个字符可能占用多个rune。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (  </div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"unicode/utf8"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    data := <span class="string">"é"</span></div><div class="line">    fmt.Println(<span class="built_in">len</span>(data))                    <span class="comment">//prints: 3</span></div><div class="line">    fmt.Println(utf8.RuneCountInString(data)) <span class="comment">//prints: 2</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Missing-Comma-In-Multi-Line-Slice-Array-and-Map-Literals"><a href="#Missing-Comma-In-Multi-Line-Slice-Array-and-Map-Literals" class="headerlink" title="Missing Comma In Multi-Line Slice, Array, and Map Literals"></a>Missing Comma In Multi-Line Slice, Array, and Map Literals</h3><p>Fails:  </p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    x := []<span class="keyword">int</span>&#123;</div><div class="line">    <span class="number">1</span>,</div><div class="line">    <span class="number">2</span> <span class="comment">//error</span></div><div class="line">    &#125;</div><div class="line">    _ = x</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Compile Errors:  </p>
<blockquote>
<p>/tmp/sandbox367520156/main.go:6: syntax error: need trailing comma before newline in composite literal<br>/tmp/sandbox367520156/main.go:8: non-declaration statement outside function body<br>/tmp/sandbox367520156/main.go:9: syntax error: unexpected }</p>
</blockquote>
<p>Works:  </p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    x := []<span class="keyword">int</span>&#123;</div><div class="line">    <span class="number">1</span>,</div><div class="line">    <span class="number">2</span>,</div><div class="line">    &#125;</div><div class="line">    x = x</div><div class="line"></div><div class="line">    y := []<span class="keyword">int</span>&#123;<span class="number">3</span>,<span class="number">4</span>,&#125; <span class="comment">//no error</span></div><div class="line">    y = y</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当你把声明折叠到单行时，如果你没加末尾的逗号，你将不会得到编译错误。</p>
<h3 id="log-Fatal-and-log-Panic-Do-More-Than-Log"><a href="#log-Fatal-and-log-Panic-Do-More-Than-Log" class="headerlink" title="log.Fatal and log.Panic Do More Than Log"></a>log.Fatal and log.Panic Do More Than Log</h3><p>Logging库一般提供不同的log等级。与这些logging库不同，Go中log包在你调用它的<code>Fatal*()</code>和<code>Panic*()</code>函数时，可以做的不仅仅是log。当你的应用调用这些函数时，Go也将会终止应用 :-)</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"log"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    log.Fatalln(<span class="string">"Fatal Level: log entry"</span>) <span class="comment">//app exits here</span></div><div class="line">    log.Println(<span class="string">"Normal Level: log entry"</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Built-in-Data-Structure-Operations-Are-Not-Synchronized"><a href="#Built-in-Data-Structure-Operations-Are-Not-Synchronized" class="headerlink" title="Built-in Data Structure Operations Are Not Synchronized"></a>Built-in Data Structure Operations Are Not Synchronized</h3><p>即使Go本身有很多特性来支持并发，并发安全的数据集合并不是其中之一 :-)确保数据集合以原子的方式更新是你的职责。Goroutines和channels是实现这些原子操作的推荐方式，但你也可以使用“sync”包，如果它对你的应用有意义的话。</p>
<h3 id="Iteration-Values-For-Strings-in-“range”-Clauses"><a href="#Iteration-Values-For-Strings-in-“range”-Clauses" class="headerlink" title="Iteration Values For Strings in “range” Clauses"></a>Iteration Values For Strings in “range” Clauses</h3><p>索引值（“range”操作返回的第一个值）是返回的第二个值的当前“字符”（unicode编码的point/rune）的第一个byte的索引。它不是当前“字符”的索引，这与其他语言不同。注意真实的字符可能会由多个rune表示。如果你需要处理字符，确保你使用了“norm”包（golang.org/x/text/unicode/norm）。</p>
<p>string变量的<code>for range</code>语句将会尝试把数据翻译为UTF8文本。对于它无法理解的任何byte序列，它将返回0xfffd runes（即unicode替换字符），而不是真实的数据。如果你任意（非UTF8文本）的数据保存在string变量中，确保把它们转换为byte slice，以得到所有保存的数据。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    data := <span class="string">"A\xfe\x02\xff\x04"</span></div><div class="line">    <span class="keyword">for</span> _,v := <span class="keyword">range</span> data &#123;</div><div class="line">        fmt.Printf(<span class="string">"%#x "</span>,v)</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//prints: 0x41 0xfffd 0x2 0xfffd 0x4 (not ok)</span></div><div class="line"></div><div class="line">    fmt.Println()</div><div class="line">    <span class="keyword">for</span> _,v := <span class="keyword">range</span> []<span class="keyword">byte</span>(data) &#123;</div><div class="line">        fmt.Printf(<span class="string">"%#x "</span>,v)</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//prints: 0x41 0xfe 0x2 0xff 0x4 (good)</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Iterating-Through-a-Map-Using-a-“for-range”-Clause"><a href="#Iterating-Through-a-Map-Using-a-“for-range”-Clause" class="headerlink" title="Iterating Through a Map Using a “for range” Clause"></a>Iterating Through a Map Using a “for range” Clause</h3><p>如果你希望以某个顺序（比如，按key值排序）的方式得到元素，就需要这个技巧。每次的map迭代将会生成不同的结果。Go的runtime有心尝试随机化迭代顺序，但并不总会成功，这样你可能得到一些相同的map迭代结果。所以如果连续看到5个相同的迭代结果，不要惊讶。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    m := <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">int</span>&#123;<span class="string">"one"</span>:<span class="number">1</span>,<span class="string">"two"</span>:<span class="number">2</span>,<span class="string">"three"</span>:<span class="number">3</span>,<span class="string">"four"</span>:<span class="number">4</span>&#125;</div><div class="line">    <span class="keyword">for</span> k,v := <span class="keyword">range</span> m &#123;</div><div class="line">        fmt.Println(k,v)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>而且如果你使用Go的playground（<a href="https://play.golang.org/)，你将总会得到同样的结果，因为除非你修改代码，否则它不会重新编译代码。" target="_blank" rel="external">https://play.golang.org/)，你将总会得到同样的结果，因为除非你修改代码，否则它不会重新编译代码。</a></p>
<h3 id="Fallthrough-Behavior-in-“switch”-Statements"><a href="#Fallthrough-Behavior-in-“switch”-Statements" class="headerlink" title="Fallthrough Behavior in “switch” Statements"></a>Fallthrough Behavior in “switch” Statements</h3><p>在“switch”声明语句中的“case”语句块在默认情况下会break。这和其他语言中的进入下一个“next”代码块的默认行为不同。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    isSpace := <span class="function"><span class="keyword">func</span><span class="params">(ch <span class="keyword">byte</span>)</span> <span class="title">bool</span></span> &#123;</div><div class="line">        <span class="keyword">switch</span>(ch) &#123;</div><div class="line">        <span class="keyword">case</span> <span class="string">' '</span>: <span class="comment">//error</span></div><div class="line">        <span class="keyword">case</span> <span class="string">'\t'</span>:</div><div class="line">            <span class="keyword">return</span> <span class="literal">true</span></div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="literal">false</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    fmt.Println(isSpace(<span class="string">'\t'</span>)) <span class="comment">//prints true (ok)</span></div><div class="line">    fmt.Println(isSpace(<span class="string">' '</span>))  <span class="comment">//prints false (not ok)</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>你可以通过在每个“case”块的结尾使用“fallthrough”，来强制“case”代码块进入。你也可以重写switch语句，来使用“case”块中的表达式列表。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    isSpace := <span class="function"><span class="keyword">func</span><span class="params">(ch <span class="keyword">byte</span>)</span> <span class="title">bool</span></span> &#123;</div><div class="line">        <span class="keyword">switch</span>(ch) &#123;</div><div class="line">        <span class="keyword">case</span> <span class="string">' '</span>, <span class="string">'\t'</span>:</div><div class="line">            <span class="keyword">return</span> <span class="literal">true</span></div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="literal">false</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    fmt.Println(isSpace(<span class="string">'\t'</span>)) <span class="comment">//prints true (ok)</span></div><div class="line">    fmt.Println(isSpace(<span class="string">' '</span>))  <span class="comment">//prints true (ok)</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Increments-and-Decrements"><a href="#Increments-and-Decrements" class="headerlink" title="Increments and Decrements"></a>Increments and Decrements</h3><p>许多语言都有自增和自减操作。不像其他语言，Go不支持前置版本的操作。你也无法在表达式中使用这两个操作符。</p>
<p>Fails:  </p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    data := []<span class="keyword">int</span>&#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>&#125;</div><div class="line">    i := <span class="number">0</span></div><div class="line">    ++i <span class="comment">//error</span></div><div class="line">    fmt.Println(data[i++]) <span class="comment">//error</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Compile Errors:  </p>
<blockquote>
<p>/tmp/sandbox101231828/main.go:8: syntax error: unexpected ++<br>/tmp/sandbox101231828/main.go:9: syntax error: unexpected ++, expecting :</p>
</blockquote>
<p>Works:  </p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    data := []<span class="keyword">int</span>&#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>&#125;</div><div class="line">    i := <span class="number">0</span></div><div class="line">    i++</div><div class="line">    fmt.Println(data[i])</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Bitwise-NOT-Operator"><a href="#Bitwise-NOT-Operator" class="headerlink" title="Bitwise NOT Operator"></a>Bitwise NOT Operator</h3><p>许多语言使用 <code>~</code> 作为一元的NOT操作符（即按位补足），但Go为了这个重用了XOR操作符（<code>^</code>）。</p>
<p>Fails:  </p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    fmt.Println(~<span class="number">2</span>) <span class="comment">//error</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Compile Error:  </p>
<blockquote>
<p>/tmp/sandbox965529189/main.go:6: the bitwise complement operator is ^</p>
</blockquote>
<p>Works:  </p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    <span class="keyword">var</span> d <span class="keyword">uint8</span> = <span class="number">2</span></div><div class="line">    fmt.Printf(<span class="string">"%08b\n"</span>,^d)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Go依旧使用<code>^</code>作为XOR的操作符，这可能会让一些人迷惑。</p>
<p>如果你愿意，你可以使用一个二元的XOR操作（如， 0x02 XOR 0xff）来表示一个一元的NOT操作（如，NOT 0x02）。这可以解释为什么<code>^</code>被重用来表示一元的NOT操作。</p>
<p>Go也有特殊的‘AND NOT’按位操作（<code>&amp;^</code>），这也让NOT操作更加的让人迷惑。这看起来需要特殊的特性/hack来支持 <code>A AND (NOT B)</code>，而无需括号。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    <span class="keyword">var</span> a <span class="keyword">uint8</span> = <span class="number">0x82</span></div><div class="line">    <span class="keyword">var</span> b <span class="keyword">uint8</span> = <span class="number">0x02</span></div><div class="line">    fmt.Printf(<span class="string">"%08b [A]\n"</span>,a)</div><div class="line">    fmt.Printf(<span class="string">"%08b [B]\n"</span>,b)</div><div class="line"></div><div class="line">    fmt.Printf(<span class="string">"%08b (NOT B)\n"</span>,^b)</div><div class="line">    fmt.Printf(<span class="string">"%08b ^ %08b = %08b [B XOR 0xff]\n"</span>,b,<span class="number">0xff</span>,b ^ <span class="number">0xff</span>)</div><div class="line"></div><div class="line">    fmt.Printf(<span class="string">"%08b ^ %08b = %08b [A XOR B]\n"</span>,a,b,a ^ b)</div><div class="line">    fmt.Printf(<span class="string">"%08b &amp; %08b = %08b [A AND B]\n"</span>,a,b,a &amp; b)</div><div class="line">    fmt.Printf(<span class="string">"%08b &amp;^%08b = %08b [A 'AND NOT' B]\n"</span>,a,b,a &amp;^ b)</div><div class="line">    fmt.Printf(<span class="string">"%08b&amp;(^%08b)= %08b [A AND (NOT B)]\n"</span>,a,b,a &amp; (^b))</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Operator-Precedence-Differences"><a href="#Operator-Precedence-Differences" class="headerlink" title="Operator Precedence Differences"></a>Operator Precedence Differences</h3><p>除了”bit clear“操作（<code>&amp;^</code>），Go也一个与许多其他语言共享的标准操作符的集合。尽管操作优先级并不总是一样。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    fmt.Printf(<span class="string">"0x2 &amp; 0x2 + 0x4 -&gt; %#x\n"</span>,<span class="number">0x2</span> &amp; <span class="number">0x2</span> + <span class="number">0x4</span>)</div><div class="line">    <span class="comment">//prints: 0x2 &amp; 0x2 + 0x4 -&gt; 0x6</span></div><div class="line">    <span class="comment">//Go:    (0x2 &amp; 0x2) + 0x4</span></div><div class="line">    <span class="comment">//C++:    0x2 &amp; (0x2 + 0x4) -&gt; 0x2</span></div><div class="line"></div><div class="line">    fmt.Printf(<span class="string">"0x2 + 0x2 &lt;&lt; 0x1 -&gt; %#x\n"</span>,<span class="number">0x2</span> + <span class="number">0x2</span> &lt;&lt; <span class="number">0x1</span>)</div><div class="line">    <span class="comment">//prints: 0x2 + 0x2 &lt;&lt; 0x1 -&gt; 0x6</span></div><div class="line">    <span class="comment">//Go:     0x2 + (0x2 &lt;&lt; 0x1)</span></div><div class="line">    <span class="comment">//C++:   (0x2 + 0x2) &lt;&lt; 0x1 -&gt; 0x8</span></div><div class="line"></div><div class="line">    fmt.Printf(<span class="string">"0xf | 0x2 ^ 0x2 -&gt; %#x\n"</span>,<span class="number">0xf</span> | <span class="number">0x2</span> ^ <span class="number">0x2</span>)</div><div class="line">    <span class="comment">//prints: 0xf | 0x2 ^ 0x2 -&gt; 0xd</span></div><div class="line">    <span class="comment">//Go:    (0xf | 0x2) ^ 0x2</span></div><div class="line">    <span class="comment">//C++:    0xf | (0x2 ^ 0x2) -&gt; 0xf</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Unexported-Structure-Fields-Are-Not-Encoded"><a href="#Unexported-Structure-Fields-Are-Not-Encoded" class="headerlink" title="Unexported Structure Fields Are Not Encoded"></a>Unexported Structure Fields Are Not Encoded</h3><p>以小写字母开头的结构体将不会被（json、xml、gob等）编码，因此当你编码这些未导出的结构体时，你将会得到零值。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (  </div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"encoding/json"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">type</span> MyData <span class="keyword">struct</span> &#123;  </div><div class="line">    One <span class="keyword">int</span></div><div class="line">    two <span class="keyword">string</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    in := MyData&#123;<span class="number">1</span>,<span class="string">"two"</span>&#125;</div><div class="line">    fmt.Printf(<span class="string">"%#v\n"</span>,in) <span class="comment">//prints main.MyData&#123;One:1, two:"two"&#125;</span></div><div class="line"></div><div class="line">    encoded,_ := json.Marshal(in)</div><div class="line">    fmt.Println(<span class="keyword">string</span>(encoded)) <span class="comment">//prints &#123;"One":1&#125;</span></div><div class="line"></div><div class="line">    <span class="keyword">var</span> out MyData</div><div class="line">    json.Unmarshal(encoded,&amp;out)</div><div class="line"></div><div class="line">    fmt.Printf(<span class="string">"%#v\n"</span>,out) <span class="comment">//prints main.MyData&#123;One:1, two:""&#125;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="App-Exits-With-Active-Goroutines"><a href="#App-Exits-With-Active-Goroutines" class="headerlink" title="App Exits With Active Goroutines"></a>App Exits With Active Goroutines</h3><p>应用将不会等所有的goroutines完成。这对于初学者而言是个很常见的错误。每个人都是以某个程度开始，因此如果犯了初学者的错误也没神马好丢脸的 :-)</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (  </div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"time"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    workerCount := <span class="number">2</span></div><div class="line"></div><div class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; workerCount; i++ &#123;</div><div class="line">        <span class="keyword">go</span> doit(i)</div><div class="line">    &#125;</div><div class="line">    time.Sleep(<span class="number">1</span> * time.Second)</div><div class="line">    fmt.Println(<span class="string">"all done!"</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">doit</span><span class="params">(workerId <span class="keyword">int</span>)</span></span> &#123;  </div><div class="line">    fmt.Printf(<span class="string">"[%v] is running\n"</span>,workerId)</div><div class="line">    time.Sleep(<span class="number">3</span> * time.Second)</div><div class="line">    fmt.Printf(<span class="string">"[%v] is done\n"</span>,workerId)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>You’ll see:  </p>
<blockquote>
<p>[0] is running<br>[1] is running<br>all done!  </p>
</blockquote>
<p>一个最常见的解决方法是使用“WaitGroup”变量。它将会让主goroutine等待所有的worker goroutine完成。如果你的应用有长时运行的消息处理循环的worker，你也将需要一个方法向这些goroutine发送信号，让它们退出。你可以给各个worker发送一个“kill”消息。另一个选项是关闭一个所有worker都接收的channel。这是一次向所有goroutine发送信号的简单方式。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (  </div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"sync"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    <span class="keyword">var</span> wg sync.WaitGroup</div><div class="line">    done := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</div><div class="line">    workerCount := <span class="number">2</span></div><div class="line"></div><div class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; workerCount; i++ &#123;</div><div class="line">        wg.Add(<span class="number">1</span>)</div><div class="line">        <span class="keyword">go</span> doit(i,done,wg)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="built_in">close</span>(done)</div><div class="line">    wg.Wait()</div><div class="line">    fmt.Println(<span class="string">"all done!"</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">doit</span><span class="params">(workerId <span class="keyword">int</span>,done &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;,wg sync.WaitGroup)</span></span> &#123;  </div><div class="line">    fmt.Printf(<span class="string">"[%v] is running\n"</span>,workerId)</div><div class="line">    <span class="keyword">defer</span> wg.Done()</div><div class="line">    &lt;- done</div><div class="line">    fmt.Printf(<span class="string">"[%v] is done\n"</span>,workerId)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果你运行这个应用，你将会看到：</p>
<blockquote>
<p>[0] is running<br>[0] is done<br>[1] is running<br>[1] is done  </p>
</blockquote>
<p>看起来所有的worker在主goroutine退出前都完成了。棒！然而，你也将会看到这个：</p>
<blockquote>
<p>fatal error: all goroutines are asleep - deadlock!</p>
</blockquote>
<p>这可不太好 :-) 发送了神马？为什么会出现死锁？worker退出了，它们也执行了wg.Done()。应用应该没问题啊。</p>
<p>死锁发生是因为各个worker都得到了原始的“WaitGroup”变量的一个拷贝。当worker执行wg.Done()时，并没有在主goroutine上的“WaitGroup”变量上生效。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (  </div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"sync"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    <span class="keyword">var</span> wg sync.WaitGroup</div><div class="line">    done := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</div><div class="line">    wq := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">interface</span>&#123;&#125;)</div><div class="line">    workerCount := <span class="number">2</span></div><div class="line"></div><div class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; workerCount; i++ &#123;</div><div class="line">        wg.Add(<span class="number">1</span>)</div><div class="line">        <span class="keyword">go</span> doit(i,wq,done,&amp;wg)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; workerCount; i++ &#123;</div><div class="line">        wq &lt;- i</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="built_in">close</span>(done)</div><div class="line">    wg.Wait()</div><div class="line">    fmt.Println(<span class="string">"all done!"</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">doit</span><span class="params">(workerId <span class="keyword">int</span>, wq &lt;-<span class="keyword">chan</span> <span class="keyword">interface</span>&#123;&#125;,done &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;,wg *sync.WaitGroup)</span></span> &#123;  </div><div class="line">    fmt.Printf(<span class="string">"[%v] is running\n"</span>,workerId)</div><div class="line">    <span class="keyword">defer</span> wg.Done()</div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">        <span class="keyword">select</span> &#123;</div><div class="line">        <span class="keyword">case</span> m := &lt;- wq:</div><div class="line">            fmt.Printf(<span class="string">"[%v] m =&gt; %v\n"</span>,workerId,m)</div><div class="line">        <span class="keyword">case</span> &lt;- done:</div><div class="line">            fmt.Printf(<span class="string">"[%v] is done\n"</span>,workerId)</div><div class="line">            <span class="keyword">return</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Sending-to-an-Unbuffered-Channel-Returns-As-Soon-As-the-Target-Receiver-Is-Ready"><a href="#Sending-to-an-Unbuffered-Channel-Returns-As-Soon-As-the-Target-Receiver-Is-Ready" class="headerlink" title="Sending to an Unbuffered Channel Returns As Soon As the Target Receiver Is Ready"></a>Sending to an Unbuffered Channel Returns As Soon As the Target Receiver Is Ready</h3><p>发送者将不会被阻塞，除非消息正在被接收者处理。根据你运行代码的机器的不同，接收者的goroutine可能会或者不会有足够的时间，在发送者继续执行前处理消息。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">string</span>)</div><div class="line"></div><div class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">        <span class="keyword">for</span> m := <span class="keyword">range</span> ch &#123;</div><div class="line">            fmt.Println(<span class="string">"processed:"</span>,m)</div><div class="line">        &#125;</div><div class="line">    &#125;()</div><div class="line"></div><div class="line">    ch &lt;- <span class="string">"cmd.1"</span></div><div class="line">    ch &lt;- <span class="string">"cmd.2"</span> <span class="comment">//won't be processed</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Use-time-NewTimer-instead-of-time-After"><a href="#Use-time-NewTimer-instead-of-time-After" class="headerlink" title="Use time.NewTimer instead of time.After"></a>Use time.NewTimer instead of time.After</h3><figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"time"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    ch := <span class="built_in">make</span>(<span class="keyword">chan</span> error)</div><div class="line">    <span class="comment">// time.After is not very efficient</span></div><div class="line">    <span class="comment">// The underlying Timer is not recovered by the garbage collector</span></div><div class="line">    <span class="comment">// until the timer fires. If efficiency is a concern, use NewTimer</span></div><div class="line">    <span class="comment">// instead and call Timer.Stop if the timer is no longer needed.</span></div><div class="line">    timer := time.NewTimer(time.Second)</div><div class="line">    <span class="keyword">defer</span> timer.Stop()</div><div class="line">    </div><div class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">        ch &lt;- fmt.Errorf(<span class="string">"done"</span>)</div><div class="line">    &#125;()</div><div class="line">    </div><div class="line">    <span class="keyword">select</span> &#123;</div><div class="line">    <span class="keyword">case</span> err := &lt;- ch:</div><div class="line">        fmt.Println(err)</div><div class="line">    <span class="keyword">case</span> &lt;-timer.C:</div><div class="line">        fmt.Println(<span class="string">"timeout"</span>)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Sending-to-an-Closed-Channel-Causes-a-Panic"><a href="#Sending-to-an-Closed-Channel-Causes-a-Panic" class="headerlink" title="Sending to an Closed Channel Causes a Panic"></a>Sending to an Closed Channel Causes a Panic</h3><p>从一个关闭的channel接收是安全的。在接收状态下的<code>ok</code>的返回值将被设置为<code>false</code>，这意味着没有数据被接收。如果你从一个有缓存的channel接收，你将会首先得到缓存的数据，一旦它为空，返回的<code>ok</code>值将变为<code>false</code>。</p>
<p>向关闭的channel中发送数据会引起panic。这个行为有文档说明，但对于新的Go开发者的直觉不同，他们可能希望发送行为与接收行为很像。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (  </div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"time"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</div><div class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">3</span>; i++ &#123;</div><div class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(idx <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">            ch &lt;- (idx + <span class="number">1</span>) * <span class="number">2</span></div><div class="line">        &#125;(i)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//get the first result</span></div><div class="line">    fmt.Println(&lt;-ch)</div><div class="line">    <span class="built_in">close</span>(ch) <span class="comment">//not ok (you still have other senders)</span></div><div class="line">    <span class="comment">//do other work</span></div><div class="line">    time.Sleep(<span class="number">2</span> * time.Second)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>根据不同的应用，修复方法也将不同。可能是很小的代码修改，也可能需要修改应用的设计。无论是哪种方法，你都需要确保你的应用不会向关闭的channel中发送数据。</p>
<p>上面那个有bug的例子可以通过使用一个特殊的废弃的channel来向剩余的worker发送不再需要它们的结果的信号来修复。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (  </div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"time"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</div><div class="line">    done := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</div><div class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">3</span>; i++ &#123;</div><div class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(idx <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">            <span class="keyword">select</span> &#123;</div><div class="line">            <span class="keyword">case</span> ch &lt;- (idx + <span class="number">1</span>) * <span class="number">2</span>: fmt.Println(idx,<span class="string">"sent result"</span>)</div><div class="line">            <span class="keyword">case</span> &lt;- done: fmt.Println(idx,<span class="string">"exiting"</span>)</div><div class="line">            &#125;</div><div class="line">        &#125;(i)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//get first result</span></div><div class="line">    fmt.Println(<span class="string">"result:"</span>,&lt;-ch)</div><div class="line">    <span class="built_in">close</span>(done)</div><div class="line">    <span class="comment">//do other work</span></div><div class="line">    time.Sleep(<span class="number">3</span> * time.Second)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Using-“nil”-Channels"><a href="#Using-“nil”-Channels" class="headerlink" title="Using “nil” Channels"></a>Using “nil” Channels</h3><p>在一个nil的channel上发送和接收操作会被永久阻塞。这个行为有详细的文档解释，但它对于新的Go开发者而言是个惊喜。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (  </div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"time"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    <span class="keyword">var</span> ch <span class="keyword">chan</span> <span class="keyword">int</span></div><div class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">3</span>; i++ &#123;</div><div class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(idx <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">            ch &lt;- (idx + <span class="number">1</span>) * <span class="number">2</span></div><div class="line">        &#125;(i)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//get first result</span></div><div class="line">    fmt.Println(<span class="string">"result:"</span>,&lt;-ch)</div><div class="line">    <span class="comment">//do other work</span></div><div class="line">    time.Sleep(<span class="number">2</span> * time.Second)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果运行代码你将会看到一个runtime错误： <code>fatal error: all goroutines are asleep - deadlock!</code></p>
<p>这个行为可以在select声明中用于动态开启和关闭case代码块的方法。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span>  </div><div class="line"><span class="keyword">import</span> <span class="string">"time"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    inch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</div><div class="line">    outch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</div><div class="line"></div><div class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">        <span class="keyword">var</span> in &lt;- <span class="keyword">chan</span> <span class="keyword">int</span> = inch</div><div class="line">        <span class="keyword">var</span> out <span class="keyword">chan</span> &lt;- <span class="keyword">int</span></div><div class="line">        <span class="keyword">var</span> val <span class="keyword">int</span></div><div class="line">        <span class="keyword">for</span> &#123;</div><div class="line">            <span class="keyword">select</span> &#123;</div><div class="line">            <span class="keyword">case</span> out &lt;- val:</div><div class="line">                out = <span class="literal">nil</span></div><div class="line">                in = inch</div><div class="line">            <span class="keyword">case</span> val = &lt;- in:</div><div class="line">                out = outch</div><div class="line">                in = <span class="literal">nil</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;()</div><div class="line"></div><div class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">        <span class="keyword">for</span> r := <span class="keyword">range</span> outch &#123;</div><div class="line">            fmt.Println(<span class="string">"result:"</span>,r)</div><div class="line">        &#125;</div><div class="line">    &#125;()</div><div class="line"></div><div class="line">    time.Sleep(<span class="number">0</span>)</div><div class="line">    inch &lt;- <span class="number">1</span></div><div class="line">    inch &lt;- <span class="number">2</span></div><div class="line">    time.Sleep(<span class="number">3</span> * time.Second)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Methods-with-Value-Receivers-Can’t-Change-the-Original-Value"><a href="#Methods-with-Value-Receivers-Can’t-Change-the-Original-Value" class="headerlink" title="Methods with Value Receivers Can’t Change the Original Value"></a>Methods with Value Receivers Can’t Change the Original Value</h3><p>方法的接收者就像常规的函数参数。如果声明为值，那么你的函数/方法得到的是接收者参数的拷贝。这意味着对接收者所做的修改将不会影响原有的值，除非接收者是一个map或者slice变量，而你更新了集合中的元素，或者你更新的域的接收者是指针。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="keyword">type</span> data <span class="keyword">struct</span> &#123;  </div><div class="line">    num <span class="keyword">int</span></div><div class="line">    key *<span class="keyword">string</span></div><div class="line">    items <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">bool</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(this *data)</span> <span class="title">pmethod</span><span class="params">()</span></span> &#123;  </div><div class="line">    this.num = <span class="number">7</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(this data)</span> <span class="title">vmethod</span><span class="params">()</span></span> &#123;  </div><div class="line">    this.num = <span class="number">8</span></div><div class="line">    *this.key = <span class="string">"v.key"</span></div><div class="line">    this.items[<span class="string">"vmethod"</span>] = <span class="literal">true</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    key := <span class="string">"key.1"</span></div><div class="line">    d := data&#123;<span class="number">1</span>,&amp;key,<span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">bool</span>)&#125;</div><div class="line"></div><div class="line">    fmt.Printf(<span class="string">"num=%v key=%v items=%v\n"</span>,d.num,*d.key,d.items)</div><div class="line">    <span class="comment">//prints num=1 key=key.1 items=map[]</span></div><div class="line"></div><div class="line">    d.pmethod()</div><div class="line">    fmt.Printf(<span class="string">"num=%v key=%v items=%v\n"</span>,d.num,*d.key,d.items) </div><div class="line">    <span class="comment">//prints num=7 key=key.1 items=map[]</span></div><div class="line"></div><div class="line">    d.vmethod()</div><div class="line">    fmt.Printf(<span class="string">"num=%v key=%v items=%v\n"</span>,d.num,*d.key,d.items)</div><div class="line">    <span class="comment">//prints num=7 key=v.key items=map[vmethod:true]</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Closing-HTTP-Response-Body"><a href="#Closing-HTTP-Response-Body" class="headerlink" title="Closing HTTP Response Body"></a>Closing HTTP Response Body</h3><p>当你使用标准http库发起请求时，你得到一个http的响应变量。如果你不读取响应主体，你依旧需要关闭它。注意对于空的响应你也一定要这么做。对于新的Go开发者而言，这个很容易就会忘掉。</p>
<p>一些新的Go开发者确实尝试关闭响应主体，但他们在错误的地方做。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (  </div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"net/http"</span></div><div class="line">    <span class="string">"io/ioutil"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    resp, err := http.Get(<span class="string">"https://api.ipify.org?format=json"</span>)</div><div class="line">    <span class="keyword">defer</span> resp.Body.Close()<span class="comment">//not ok</span></div><div class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">        fmt.Println(err)</div><div class="line">        <span class="keyword">return</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    body, err := ioutil.ReadAll(resp.Body)</div><div class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">        fmt.Println(err)</div><div class="line">        <span class="keyword">return</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    fmt.Println(<span class="keyword">string</span>(body))</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这段代码对于成功的请求没问题，但如果http的请求失败，resp变量可能会是nil，这将导致一个runtime panic。</p>
<p>最常见的关闭响应主体的方法是在http响应的错误检查后调用defer。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (  </div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"net/http"</span></div><div class="line">    <span class="string">"io/ioutil"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    resp, err := http.Get(<span class="string">"https://api.ipify.org?format=json"</span>)</div><div class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">        fmt.Println(err)</div><div class="line">        <span class="keyword">return</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">defer</span> resp.Body.Close()<span class="comment">//ok, most of the time :-)</span></div><div class="line">    body, err := ioutil.ReadAll(resp.Body)</div><div class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">        fmt.Println(err)</div><div class="line">        <span class="keyword">return</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    fmt.Println(<span class="keyword">string</span>(body))</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>大多数情况下，当你的http响应失败时，resp变量将为nil，而err变量将是non-nil。然而，当你得到一个重定向的错误时，两个变量都将是non-nil。这意味着你最后依然会内存泄露。</p>
<p>通过在http响应错误处理中添加一个关闭non-nil响应主体的的调用来修复这个问题。另一个方法是使用一个defer调用来关闭所有失败和成功的请求的响应主体。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (  </div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"net/http"</span></div><div class="line">    <span class="string">"io/ioutil"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    resp, err := http.Get(<span class="string">"https://api.ipify.org?format=json"</span>)</div><div class="line">    <span class="keyword">if</span> resp != <span class="literal">nil</span> &#123;</div><div class="line">        <span class="keyword">defer</span> resp.Body.Close()</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">        fmt.Println(err)</div><div class="line">        <span class="keyword">return</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    body, err := ioutil.ReadAll(resp.Body)</div><div class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">        fmt.Println(err)</div><div class="line">        <span class="keyword">return</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    fmt.Println(<span class="keyword">string</span>(body))</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>resp.Body.Close()</code>的原始实现也会读取并丢弃剩余的响应主体数据。这确保了http的链接在keepalive http连接行为开启的情况下，可以被另一个请求复用。最新的http客户端的行为是不同的。现在读取并丢弃剩余的响应数据是你的职责。如果你不这么做，http的连接可能会关闭，而无法被重用。这个小技巧应该会写在Go 1.5的文档中。</p>
<p>如果http连接的重用对你的应用很重要，你可能需要在响应处理逻辑的后面添加像下面的代码：</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line">_, err = io.Copy(ioutil.Discard, resp.Body)</div></pre></td></tr></table></figure>
<p>如果你不立即读取整个响应将是必要的，这可能在你处理json API响应时会发生：</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line">json.NewDecoder(resp.Body).Decode(&amp;data)</div></pre></td></tr></table></figure>
<h3 id="Closing-HTTP-Connections"><a href="#Closing-HTTP-Connections" class="headerlink" title="Closing HTTP Connections"></a>Closing HTTP Connections</h3><p>一些HTTP服务器保持会保持一段时间的网络连接（根据HTTP 1.1的说明和服务器端的“keep-alive”配置）。默认情况下，标准http库只在目标HTTP服务器要求关闭时才会关闭网络连接。这意味着你的应用在某些条件下消耗完sockets/file的描述符。</p>
<p>你可以通过设置请求变量中的<code>Close</code>域的值为<code>true</code>，来让http库在请求完成时关闭连接。</p>
<p>另一个选项是添加一个<code>Connection</code>的请求头，并设置为<code>close</code>。目标HTTP服务器应该也会响应一个<code>Connection: close</code>的头。当http库看到这个响应头时，它也将会关闭连接。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (  </div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"net/http"</span></div><div class="line">    <span class="string">"io/ioutil"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    req, err := http.NewRequest(<span class="string">"GET"</span>,<span class="string">"http://golang.org"</span>,<span class="literal">nil</span>)</div><div class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">        fmt.Println(err)</div><div class="line">        <span class="keyword">return</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    req.Close = <span class="literal">true</span></div><div class="line">    <span class="comment">//or do this:</span></div><div class="line">    <span class="comment">//req.Header.Add("Connection", "close")</span></div><div class="line"></div><div class="line">    resp, err := http.DefaultClient.Do(req)</div><div class="line">    <span class="keyword">if</span> resp != <span class="literal">nil</span> &#123;</div><div class="line">        <span class="keyword">defer</span> resp.Body.Close()</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">        fmt.Println(err)</div><div class="line">        <span class="keyword">return</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    body, err := ioutil.ReadAll(resp.Body)</div><div class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">        fmt.Println(err)</div><div class="line">        <span class="keyword">return</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    fmt.Println(<span class="built_in">len</span>(<span class="keyword">string</span>(body)))</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>你也可以取消http的全局连接复用。你将需要为此创建一个自定义的http传输配置。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (  </div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"net/http"</span></div><div class="line">    <span class="string">"io/ioutil"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    tr := &amp;http.Transport&#123;DisableKeepAlives: <span class="literal">true</span>&#125;</div><div class="line">    client := &amp;http.Client&#123;Transport: tr&#125;</div><div class="line"></div><div class="line">    resp, err := client.Get(<span class="string">"http://golang.org"</span>)</div><div class="line">    <span class="keyword">if</span> resp != <span class="literal">nil</span> &#123;</div><div class="line">        <span class="keyword">defer</span> resp.Body.Close()</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">        fmt.Println(err)</div><div class="line">        <span class="keyword">return</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    fmt.Println(resp.StatusCode)</div><div class="line"></div><div class="line">    body, err := ioutil.ReadAll(resp.Body)</div><div class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">        fmt.Println(err)</div><div class="line">        <span class="keyword">return</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    fmt.Println(<span class="built_in">len</span>(<span class="keyword">string</span>(body)))</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果你向同一个HTTP服务器发送大量的请求，那么把保持网络连接的打开是没问题的。然而，如果你的应用在短时间内向大量不同的HTTP服务器发送一两个请求，那么在引用收到响应后立刻关闭网络连接是一个好主意。增加打开文件的限制数可能也是个好主意。当然，正确的选择源自于应用。</p>
<h3 id="Unmarshalling-JSON-Numbers-into-Interface-Values"><a href="#Unmarshalling-JSON-Numbers-into-Interface-Values" class="headerlink" title="Unmarshalling JSON Numbers into Interface Values"></a>Unmarshalling JSON Numbers into Interface Values</h3><p>默认情况下，Go认为JSON中的数字是<code>float64</code>，下面这样json.Unmarshal会panic:</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (  </div><div class="line">  <span class="string">"encoding/json"</span></div><div class="line">  <span class="string">"fmt"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">  <span class="keyword">var</span> data = []<span class="keyword">byte</span>(<span class="string">`&#123;"status": 200&#125;`</span>)</div><div class="line"></div><div class="line">  <span class="keyword">var</span> result <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;</div><div class="line">  <span class="keyword">if</span> err := json.Unmarshal(data, &amp;result); err != <span class="literal">nil</span> &#123;</div><div class="line">    fmt.Println(<span class="string">"error:"</span>, err)</div><div class="line">    <span class="keyword">return</span></div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">var</span> status = result[<span class="string">"status"</span>].(<span class="keyword">int</span>) <span class="comment">//error</span></div><div class="line">  fmt.Println(<span class="string">"status value:"</span>,status)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Runtime Panic:  </p>
<blockquote>
<p>panic: interface conversion: interface is float64, not int   </p>
</blockquote>
<p>If the JSON value you are trying to decode is an integer you have serveral options.</p>
<p>Option one: use the float value as-is :-)</p>
<p>Option two: convert the float value to the integer type you need.</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (  </div><div class="line">  <span class="string">"encoding/json"</span></div><div class="line">  <span class="string">"fmt"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">  <span class="keyword">var</span> data = []<span class="keyword">byte</span>(<span class="string">`&#123;"status": 200&#125;`</span>)</div><div class="line"></div><div class="line">  <span class="keyword">var</span> result <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;</div><div class="line">  <span class="keyword">if</span> err := json.Unmarshal(data, &amp;result); err != <span class="literal">nil</span> &#123;</div><div class="line">    fmt.Println(<span class="string">"error:"</span>, err)</div><div class="line">    <span class="keyword">return</span></div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">var</span> status = <span class="keyword">uint64</span>(result[<span class="string">"status"</span>].(<span class="keyword">float64</span>)) <span class="comment">//ok</span></div><div class="line">  fmt.Println(<span class="string">"status value:"</span>,status)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Option three: use a <code>Decoder</code> type to unmarshal JSON and tell it to represent JSON numbers using the <code>Number</code> interface type.</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (  </div><div class="line">  <span class="string">"encoding/json"</span></div><div class="line">  <span class="string">"bytes"</span></div><div class="line">  <span class="string">"fmt"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">  <span class="keyword">var</span> data = []<span class="keyword">byte</span>(<span class="string">`&#123;"status": 200&#125;`</span>)</div><div class="line"></div><div class="line">  <span class="keyword">var</span> result <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;</div><div class="line">  <span class="keyword">var</span> decoder = json.NewDecoder(bytes.NewReader(data))</div><div class="line">  decoder.UseNumber()</div><div class="line"></div><div class="line">  <span class="keyword">if</span> err := decoder.Decode(&amp;result); err != <span class="literal">nil</span> &#123;</div><div class="line">    fmt.Println(<span class="string">"error:"</span>, err)</div><div class="line">    <span class="keyword">return</span></div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">var</span> status,_ = result[<span class="string">"status"</span>].(json.Number).Int64() <span class="comment">//ok</span></div><div class="line">  fmt.Println(<span class="string">"status value:"</span>,status)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>You can use the string representation of your <code>Number</code> value to unmarshal it to a different numeric type:</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (  </div><div class="line">  <span class="string">"encoding/json"</span></div><div class="line">  <span class="string">"bytes"</span></div><div class="line">  <span class="string">"fmt"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">  <span class="keyword">var</span> data = []<span class="keyword">byte</span>(<span class="string">`&#123;"status": 200&#125;`</span>)</div><div class="line"></div><div class="line">  <span class="keyword">var</span> result <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;</div><div class="line">  <span class="keyword">var</span> decoder = json.NewDecoder(bytes.NewReader(data))</div><div class="line">  decoder.UseNumber()</div><div class="line"></div><div class="line">  <span class="keyword">if</span> err := decoder.Decode(&amp;result); err != <span class="literal">nil</span> &#123;</div><div class="line">    fmt.Println(<span class="string">"error:"</span>, err)</div><div class="line">    <span class="keyword">return</span></div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">var</span> status <span class="keyword">uint64</span></div><div class="line">  <span class="keyword">if</span> err := json.Unmarshal([]<span class="keyword">byte</span>(result[<span class="string">"status"</span>].(json.Number).String()), &amp;status); err != <span class="literal">nil</span> &#123;</div><div class="line">    fmt.Println(<span class="string">"error:"</span>, err)</div><div class="line">    <span class="keyword">return</span></div><div class="line">  &#125;</div><div class="line"></div><div class="line">  fmt.Println(<span class="string">"status value:"</span>,status)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Option four: use a <code>struct</code> type that maps your numeric value to the numeric type you need.</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (  </div><div class="line">  <span class="string">"encoding/json"</span></div><div class="line">  <span class="string">"bytes"</span></div><div class="line">  <span class="string">"fmt"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">  <span class="keyword">var</span> data = []<span class="keyword">byte</span>(<span class="string">`&#123;"status": 200&#125;`</span>)</div><div class="line"></div><div class="line">  <span class="keyword">var</span> result <span class="keyword">struct</span> &#123;</div><div class="line">    Status <span class="keyword">uint64</span> <span class="string">`json:"status"`</span></div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">if</span> err := json.NewDecoder(bytes.NewReader(data)).Decode(&amp;result); err != <span class="literal">nil</span> &#123;</div><div class="line">    fmt.Println(<span class="string">"error:"</span>, err)</div><div class="line">    <span class="keyword">return</span></div><div class="line">  &#125;</div><div class="line"></div><div class="line">  fmt.Printf(<span class="string">"result =&gt; %+v"</span>,result)</div><div class="line">  <span class="comment">//prints: result =&gt; &#123;Status:200&#125;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Option five: use a <code>struct</code> that maps your numeric value to the <code>json.RawMessage</code> type if you need to defer the value decoding.</p>
<p>This option is useful if you have to perform conditional JSON field decoding where the field type or structure might change.</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (  </div><div class="line">  <span class="string">"encoding/json"</span></div><div class="line">  <span class="string">"bytes"</span></div><div class="line">  <span class="string">"fmt"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">  records := [][]<span class="keyword">byte</span>&#123;</div><div class="line">    []<span class="keyword">byte</span>(<span class="string">`&#123;"status": 200, "tag":"one"&#125;`</span>),</div><div class="line">    []<span class="keyword">byte</span>(<span class="string">`&#123;"status":"ok", "tag":"two"&#125;`</span>),</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">for</span> idx, record := <span class="keyword">range</span> records &#123;</div><div class="line">    <span class="keyword">var</span> result <span class="keyword">struct</span> &#123;</div><div class="line">      StatusCode <span class="keyword">uint64</span></div><div class="line">      StatusName <span class="keyword">string</span></div><div class="line">      Status json.RawMessage <span class="string">`json:"status"`</span></div><div class="line">      Tag <span class="keyword">string</span>             <span class="string">`json:"tag"`</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> err := json.NewDecoder(bytes.NewReader(record)).Decode(&amp;result); err != <span class="literal">nil</span> &#123;</div><div class="line">      fmt.Println(<span class="string">"error:"</span>, err)</div><div class="line">      <span class="keyword">return</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">var</span> sstatus <span class="keyword">string</span></div><div class="line">    <span class="keyword">if</span> err := json.Unmarshal(result.Status, &amp;sstatus); err == <span class="literal">nil</span> &#123;</div><div class="line">      result.StatusName = sstatus</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">var</span> nstatus <span class="keyword">uint64</span></div><div class="line">    <span class="keyword">if</span> err := json.Unmarshal(result.Status, &amp;nstatus); err == <span class="literal">nil</span> &#123;</div><div class="line">      result.StatusCode = nstatus</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    fmt.Printf(<span class="string">"[%v] result =&gt; %+v\n"</span>,idx,result)</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Comparing-Structs-Arrays-Slices-and-Maps"><a href="#Comparing-Structs-Arrays-Slices-and-Maps" class="headerlink" title="Comparing Structs, Arrays, Slices, and Maps"></a>Comparing Structs, Arrays, Slices, and Maps</h3><p>如果结构体中的各个元素都可以用你可以使用等号来比较的话，那就可以使用相号, ==，来比较结构体变量。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="keyword">type</span> data <span class="keyword">struct</span> &#123;  </div><div class="line">    num <span class="keyword">int</span></div><div class="line">    fp <span class="keyword">float32</span></div><div class="line">    <span class="built_in">complex</span> <span class="keyword">complex64</span></div><div class="line">    str <span class="keyword">string</span></div><div class="line">    char <span class="keyword">rune</span></div><div class="line">    yes <span class="keyword">bool</span></div><div class="line">    events &lt;-<span class="keyword">chan</span> <span class="keyword">string</span></div><div class="line">    handler <span class="keyword">interface</span>&#123;&#125;</div><div class="line">    ref *<span class="keyword">byte</span></div><div class="line">    raw [<span class="number">10</span>]<span class="keyword">byte</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    v1 := data&#123;&#125;</div><div class="line">    v2 := data&#123;&#125;</div><div class="line">    fmt.Println(<span class="string">"v1 == v2:"</span>,v1 == v2) <span class="comment">//prints: v1 == v2: true</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果结构体中的元素无法比较，那使用等号将导致编译错误。注意数组仅在它们的数据元素可比较的情况下才可以比较。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="keyword">type</span> data <span class="keyword">struct</span> &#123;  </div><div class="line">    num <span class="keyword">int</span>                <span class="comment">//ok</span></div><div class="line">    checks [<span class="number">10</span>]<span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">bool</span> //<span class="title">not</span> <span class="title">comparable</span></span></div><div class="line">    <span class="title">doit</span> <span class="title">func</span><span class="params">()</span> <span class="title">bool</span>       //<span class="title">not</span> <span class="title">comparable</span></div><div class="line">    <span class="title">m</span> <span class="title">map</span>[<span class="title">string</span>] <span class="title">string</span>   //<span class="title">not</span> <span class="title">comparable</span></div><div class="line">    <span class="title">bytes</span> []<span class="title">byte</span>           //<span class="title">not</span> <span class="title">comparable</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="title">func</span> <span class="title">main</span><span class="params">()</span> &#123;  </div><div class="line">    v1 := data&#123;&#125;</div><div class="line">    v2 := data&#123;&#125;</div><div class="line">    fmt.Println(<span class="string">"v1 == v2:"</span>,v1 == v2)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Go确实提供了一些助手函数，用于比较那些无法使用等号比较的变量。最常用的方法是使用<code>reflect</code>包中的<code>DeepEqual()</code>函数。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (  </div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"reflect"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">type</span> data <span class="keyword">struct</span> &#123;  </div><div class="line">    num <span class="keyword">int</span>                <span class="comment">//ok</span></div><div class="line">    checks [<span class="number">10</span>]<span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">bool</span> //<span class="title">not</span> <span class="title">comparable</span></span></div><div class="line">    <span class="title">doit</span> <span class="title">func</span><span class="params">()</span> <span class="title">bool</span>       //<span class="title">not</span> <span class="title">comparable</span></div><div class="line">    <span class="title">m</span> <span class="title">map</span>[<span class="title">string</span>] <span class="title">string</span>   //<span class="title">not</span> <span class="title">comparable</span></div><div class="line">    <span class="title">bytes</span> []<span class="title">byte</span>           //<span class="title">not</span> <span class="title">comparable</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="title">func</span> <span class="title">main</span><span class="params">()</span> &#123;  </div><div class="line">    v1 := data&#123;&#125;</div><div class="line">    v2 := data&#123;&#125;</div><div class="line">    fmt.Println(<span class="string">"v1 == v2:"</span>,reflect.DeepEqual(v1,v2)) <span class="comment">//prints: v1 == v2: true</span></div><div class="line"></div><div class="line">    m1 := <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>&#123;<span class="string">"one"</span>: <span class="string">"a"</span>,<span class="string">"two"</span>: <span class="string">"b"</span>&#125;</div><div class="line">    m2 := <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>&#123;<span class="string">"two"</span>: <span class="string">"b"</span>, <span class="string">"one"</span>: <span class="string">"a"</span>&#125;</div><div class="line">    fmt.Println(<span class="string">"m1 == m2:"</span>,reflect.DeepEqual(m1, m2)) <span class="comment">//prints: m1 == m2: true</span></div><div class="line"></div><div class="line">    s1 := []<span class="keyword">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;</div><div class="line">    s2 := []<span class="keyword">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;</div><div class="line">    fmt.Println(<span class="string">"s1 == s2:"</span>,reflect.DeepEqual(s1, s2)) <span class="comment">//prints: s1 == s2: true</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>除了很慢（这个可能会也可能不会影响你的应用），<code>DeepEqual()</code>也有其他自身的技巧。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (  </div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"reflect"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    <span class="keyword">var</span> b1 []<span class="keyword">byte</span> = <span class="literal">nil</span></div><div class="line">    b2 := []<span class="keyword">byte</span>&#123;&#125;</div><div class="line">    fmt.Println(<span class="string">"b1 == b2:"</span>,reflect.DeepEqual(b1, b2)) <span class="comment">//prints: b1 == b2: false</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>DeepEqual()</code>不会认为空的slice与“nil”的slice相等。这个行为与你使用<code>bytes.Equal()</code>函数的行为不同。<code>bytes.Equal()</code>认为“nil”和空的slice是相等的。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (  </div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"bytes"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    <span class="keyword">var</span> b1 []<span class="keyword">byte</span> = <span class="literal">nil</span></div><div class="line">    b2 := []<span class="keyword">byte</span>&#123;&#125;</div><div class="line">    fmt.Println(<span class="string">"b1 == b2:"</span>,bytes.Equal(b1, b2)) <span class="comment">//prints: b1 == b2: true</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>DeepEqual()</code> isn’t always perfect comparing slices.</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (  </div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"reflect"</span></div><div class="line">    <span class="string">"encoding/json"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    <span class="keyword">var</span> str <span class="keyword">string</span> = <span class="string">"one"</span></div><div class="line">    <span class="keyword">var</span> in <span class="keyword">interface</span>&#123;&#125; = <span class="string">"one"</span></div><div class="line">    fmt.Println(<span class="string">"str == in:"</span>,str == in,reflect.DeepEqual(str, in)) </div><div class="line">    <span class="comment">//prints: str == in: true true</span></div><div class="line"></div><div class="line">    v1 := []<span class="keyword">string</span>&#123;<span class="string">"one"</span>,<span class="string">"two"</span>&#125;</div><div class="line">    v2 := []<span class="keyword">interface</span>&#123;&#125;&#123;<span class="string">"one"</span>,<span class="string">"two"</span>&#125;</div><div class="line">    fmt.Println(<span class="string">"v1 == v2:"</span>,reflect.DeepEqual(v1, v2)) </div><div class="line">    <span class="comment">//prints: v1 == v2: false (not ok)</span></div><div class="line"></div><div class="line">    data := <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;</div><div class="line">        <span class="string">"code"</span>: <span class="number">200</span>,</div><div class="line">        <span class="string">"value"</span>: []<span class="keyword">string</span>&#123;<span class="string">"one"</span>,<span class="string">"two"</span>&#125;,</div><div class="line">    &#125;</div><div class="line">    encoded, _ := json.Marshal(data)</div><div class="line">    <span class="keyword">var</span> decoded <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;</div><div class="line">    json.Unmarshal(encoded, &amp;decoded)</div><div class="line">    fmt.Println(<span class="string">"data == decoded:"</span>,reflect.DeepEqual(data, decoded)) </div><div class="line">    <span class="comment">//prints: data == decoded: false (not ok)</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果你的byte slice（或者字符串）中包含文字数据，而当你要不区分大小写形式的值时（在使用<code>==</code>，<code>bytes.Equal()</code>，或者<code>bytes.Compare()</code>），你可能会尝试使用“bytes”和“string”包中的<code>ToUpper()</code>或者<code>ToLower()</code>函数。对于英语文本，这么做是没问题的，但对于许多其他的语言来说就不行了。这时应该使用<code>strings.EqualFold()</code>和<code>bytes.EqualFold()</code>。</p>
<p>如果你的byte slice中包含需要验证用户数据的隐私信息（比如，加密哈希、tokens等），不要使用<code>reflect.DeepEqual()</code>、<code>bytes.Equal()</code>，或者<code>bytes.Compare()</code>，因为这些函数将会让你的应用易于被定时攻击。为了避免泄露时间信息，使用<code>&#39;crypto/subtle&#39;</code>包中的函数（即，<code>subtle.ConstantTimeCompare()</code>）。</p>
<h3 id="Recovering-From-a-Panic"><a href="#Recovering-From-a-Panic" class="headerlink" title="Recovering From a Panic"></a>Recovering From a Panic</h3><p><code>recover()</code>函数可以用于获取/拦截panic。仅当在一个defer函数中被完成时，调用<code>recover()</code>将会完成这个小技巧。</p>
<p>Incorrect:  </p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    <span class="built_in">recover</span>() <span class="comment">//doesn't do anything</span></div><div class="line">    <span class="built_in">panic</span>(<span class="string">"not good"</span>)</div><div class="line">    <span class="built_in">recover</span>() <span class="comment">//won't be executed :)</span></div><div class="line">    fmt.Println(<span class="string">"ok"</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Works:  </p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">        fmt.Println(<span class="string">"recovered:"</span>,<span class="built_in">recover</span>())</div><div class="line">    &#125;()</div><div class="line"></div><div class="line">    <span class="built_in">panic</span>(<span class="string">"not good"</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>recover()</code>的调用仅当它在defer函数中被直接调用时才有效。</p>
<p>Fails:  </p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">doRecover</span><span class="params">()</span></span> &#123;  </div><div class="line">    fmt.Println(<span class="string">"recovered =&gt;"</span>,<span class="built_in">recover</span>()) <span class="comment">//prints: recovered =&gt; &lt;nil&gt;</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">        doRecover() <span class="comment">//panic is not recovered</span></div><div class="line">    &#125;()</div><div class="line"></div><div class="line">    <span class="built_in">panic</span>(<span class="string">"not good"</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Updating-and-Referencing-Item-Values-in-Slice-Array-and-Map-“range”-Clauses"><a href="#Updating-and-Referencing-Item-Values-in-Slice-Array-and-Map-“range”-Clauses" class="headerlink" title="Updating and Referencing Item Values in Slice, Array, and Map “range” Clauses"></a>Updating and Referencing Item Values in Slice, Array, and Map “range” Clauses</h3><p>在“range”语句中生成的数据的值是真实集合元素的拷贝。它们不是原有元素的引用。这意味着更新这些值将不会修改原来的数据。同时也意味着使用这些值的地址将不会得到原有数据的指针。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    data := []<span class="keyword">int</span>&#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>&#125;</div><div class="line">    <span class="keyword">for</span> _,v := <span class="keyword">range</span> data &#123;</div><div class="line">        v *= <span class="number">10</span> <span class="comment">//original item is not changed</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    fmt.Println(<span class="string">"data:"</span>,data) <span class="comment">//prints data: [1 2 3]</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果你需要更新原有集合中的数据，使用索引操作符来获得数据。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    data := []<span class="keyword">int</span>&#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>&#125;</div><div class="line">    <span class="keyword">for</span> i,_ := <span class="keyword">range</span> data &#123;</div><div class="line">        data[i] *= <span class="number">10</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    fmt.Println(<span class="string">"data:"</span>,data) <span class="comment">//prints data: [10 20 30]</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果你的集合保存的是指针，那规则会稍有不同。如果要更新原有记录指向的数据，你依然需要使用索引操作，但你可以使用<code>for range</code>语句中的第二个值来更新存储在目标位置的数据。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    data := []*<span class="keyword">struct</span>&#123;num <span class="keyword">int</span>&#125; &#123;&#123;<span class="number">1</span>&#125;,&#123;<span class="number">2</span>&#125;,&#123;<span class="number">3</span>&#125;&#125;</div><div class="line"></div><div class="line">    <span class="keyword">for</span> _,v := <span class="keyword">range</span> data &#123;</div><div class="line">        v.num *= <span class="number">10</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    fmt.Println(data[<span class="number">0</span>],data[<span class="number">1</span>],data[<span class="number">2</span>]) <span class="comment">//prints &amp;&#123;10&#125; &amp;&#123;20&#125; &amp;&#123;30&#125;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="“Hidden”-Data-in-Slices"><a href="#“Hidden”-Data-in-Slices" class="headerlink" title="“Hidden” Data in Slices"></a>“Hidden” Data in Slices</h3><p>当你重新划分一个slice时，新的slice将引用原有slice的数组。如果你忘了这个行为的话，在你的应用分配大量临时的slice用于创建新的slice来引用原有数据的一小部分时，会导致难以预期的内存使用。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">get</span><span class="params">()</span> []<span class="title">byte</span></span> &#123;  </div><div class="line">    raw := <span class="built_in">make</span>([]<span class="keyword">byte</span>,<span class="number">10000</span>)</div><div class="line">    fmt.Println(<span class="built_in">len</span>(raw),<span class="built_in">cap</span>(raw),&amp;raw[<span class="number">0</span>]) <span class="comment">//prints: 10000 10000 &lt;byte_addr_x&gt;</span></div><div class="line">    <span class="keyword">return</span> raw[:<span class="number">3</span>]</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    data := get()</div><div class="line">    fmt.Println(<span class="built_in">len</span>(data),<span class="built_in">cap</span>(data),&amp;data[<span class="number">0</span>]) <span class="comment">//prints: 3 10000 &lt;byte_addr_x&gt;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>为了避免这个陷阱，你需要从临时的slice中拷贝数据（而不是重新划分slice）。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">get</span><span class="params">()</span> []<span class="title">byte</span></span> &#123;  </div><div class="line">    raw := <span class="built_in">make</span>([]<span class="keyword">byte</span>,<span class="number">10000</span>)</div><div class="line">    fmt.Println(<span class="built_in">len</span>(raw),<span class="built_in">cap</span>(raw),&amp;raw[<span class="number">0</span>]) <span class="comment">//prints: 10000 10000 &lt;byte_addr_x&gt;</span></div><div class="line">    res := <span class="built_in">make</span>([]<span class="keyword">byte</span>,<span class="number">3</span>)</div><div class="line">    <span class="built_in">copy</span>(res,raw[:<span class="number">3</span>])</div><div class="line">    <span class="keyword">return</span> res</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    data := get()</div><div class="line">    fmt.Println(<span class="built_in">len</span>(data),<span class="built_in">cap</span>(data),&amp;data[<span class="number">0</span>]) <span class="comment">//prints: 3 3 &lt;byte_addr_y&gt;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Slice-Data-“Corruption”"><a href="#Slice-Data-“Corruption”" class="headerlink" title="Slice Data “Corruption”"></a>Slice Data “Corruption”</h3><p>比如说你需要重新一个路径（在slice中保存）。你通过修改第一个文件夹的名字，然后把名字合并来创建新的路劲，来重新划分指向各个文件夹的路径。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (  </div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"bytes"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    path := []<span class="keyword">byte</span>(<span class="string">"AAAA/BBBBBBBBB"</span>)</div><div class="line">    sepIndex := bytes.IndexByte(path,<span class="string">'/'</span>)</div><div class="line">    dir1 := path[:sepIndex]</div><div class="line">    dir2 := path[sepIndex+<span class="number">1</span>:]</div><div class="line">    fmt.Println(<span class="string">"dir1 =&gt;"</span>,<span class="keyword">string</span>(dir1)) <span class="comment">//prints: dir1 =&gt; AAAA</span></div><div class="line">    fmt.Println(<span class="string">"dir2 =&gt;"</span>,<span class="keyword">string</span>(dir2)) <span class="comment">//prints: dir2 =&gt; BBBBBBBBB</span></div><div class="line"></div><div class="line">    dir1 = <span class="built_in">append</span>(dir1,<span class="string">"suffix"</span>...)</div><div class="line">    path = bytes.Join([][]<span class="keyword">byte</span>&#123;dir1,dir2&#125;,[]<span class="keyword">byte</span>&#123;<span class="string">'/'</span>&#125;)</div><div class="line"></div><div class="line">    fmt.Println(<span class="string">"dir1 =&gt;"</span>,<span class="keyword">string</span>(dir1)) <span class="comment">//prints: dir1 =&gt; AAAAsuffix</span></div><div class="line">    fmt.Println(<span class="string">"dir2 =&gt;"</span>,<span class="keyword">string</span>(dir2)) <span class="comment">//prints: dir2 =&gt; uffixBBBB (not ok)</span></div><div class="line"></div><div class="line">    fmt.Println(<span class="string">"new path =&gt;"</span>,<span class="keyword">string</span>(path))</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>结果与你想的不一样。与”AAAAsuffix/BBBBBBBBB”相反，你将会得到”AAAAsuffix/uffixBBBB”。这个情况的发生是因为两个文件夹的slice都潜在的引用了同一个原始的路径slice。这意味着原始路径也被修改了。根据你的应用，这也许会是个问题。</p>
<p>通过分配新的slice并拷贝需要的数据，你可以修复这个问题。另一个选择是使用完整的slice表达式。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (  </div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"bytes"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    path := []<span class="keyword">byte</span>(<span class="string">"AAAA/BBBBBBBBB"</span>)</div><div class="line">    sepIndex := bytes.IndexByte(path,<span class="string">'/'</span>)</div><div class="line">    dir1 := path[:sepIndex:sepIndex] <span class="comment">//full slice expression</span></div><div class="line">    dir2 := path[sepIndex+<span class="number">1</span>:]</div><div class="line">    fmt.Println(<span class="string">"dir1 =&gt;"</span>,<span class="keyword">string</span>(dir1)) <span class="comment">//prints: dir1 =&gt; AAAA</span></div><div class="line">    fmt.Println(<span class="string">"dir2 =&gt;"</span>,<span class="keyword">string</span>(dir2)) <span class="comment">//prints: dir2 =&gt; BBBBBBBBB</span></div><div class="line"></div><div class="line">    dir1 = <span class="built_in">append</span>(dir1,<span class="string">"suffix"</span>...)</div><div class="line">    path = bytes.Join([][]<span class="keyword">byte</span>&#123;dir1,dir2&#125;,[]<span class="keyword">byte</span>&#123;<span class="string">'/'</span>&#125;)</div><div class="line"></div><div class="line">    fmt.Println(<span class="string">"dir1 =&gt;"</span>,<span class="keyword">string</span>(dir1)) <span class="comment">//prints: dir1 =&gt; AAAAsuffix</span></div><div class="line">    fmt.Println(<span class="string">"dir2 =&gt;"</span>,<span class="keyword">string</span>(dir2)) <span class="comment">//prints: dir2 =&gt; BBBBBBBBB (ok now)</span></div><div class="line"></div><div class="line">    fmt.Println(<span class="string">"new path =&gt;"</span>,<span class="keyword">string</span>(path))</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>完整的slice表达式中的额外参数可以控制新的slice的容量。现在在那个slice后添加元素将会触发一个新的buffer分配，而不是覆盖第二个slice中的数据。</p>
<h3 id="“Stale”-Slices"><a href="#“Stale”-Slices" class="headerlink" title="“Stale” Slices"></a>“Stale” Slices</h3><p>多个slice可以引用同一个数据。比如，当你从一个已有的slice创建一个新的slice时，这就会发生。如果你的应用功能需要这种行为，那么你将需要关注下“走味的”slice。</p>
<p>在某些情况下，在一个slice中添加新的数据，在原有数组无法保持更多新的数据时，将导致分配一个新的数组。而现在其他的slice还指向老的数组（和老的数据）。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    s1 := []<span class="keyword">int</span>&#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>&#125;</div><div class="line">    fmt.Println(<span class="built_in">len</span>(s1),<span class="built_in">cap</span>(s1),s1) <span class="comment">//prints 3 3 [1 2 3]</span></div><div class="line"></div><div class="line">    s2 := s1[<span class="number">1</span>:]</div><div class="line">    fmt.Println(<span class="built_in">len</span>(s2),<span class="built_in">cap</span>(s2),s2) <span class="comment">//prints 2 2 [2 3]</span></div><div class="line"></div><div class="line">    <span class="keyword">for</span> i := <span class="keyword">range</span> s2 &#123; s2[i] += <span class="number">20</span> &#125;</div><div class="line"></div><div class="line">    <span class="comment">//still referencing the same array</span></div><div class="line">    fmt.Println(s1) <span class="comment">//prints [1 22 23]</span></div><div class="line">    fmt.Println(s2) <span class="comment">//prints [22 23]</span></div><div class="line"></div><div class="line">    s2 = <span class="built_in">append</span>(s2,<span class="number">4</span>)</div><div class="line"></div><div class="line">    <span class="keyword">for</span> i := <span class="keyword">range</span> s2 &#123; s2[i] += <span class="number">10</span> &#125;</div><div class="line"></div><div class="line">    <span class="comment">//s1 is now "stale"</span></div><div class="line">    fmt.Println(s1) <span class="comment">//prints [1 22 23]</span></div><div class="line">    fmt.Println(s2) <span class="comment">//prints [32 33 14]</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Type-Declarations-and-Methods"><a href="#Type-Declarations-and-Methods" class="headerlink" title="Type Declarations and Methods"></a>Type Declarations and Methods</h3><p>当你通过把一个现有（非interface）的类型定义为一个新的类型时，新的类型不会继承现有类型的方法。</p>
<p>Fails:  </p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"sync"</span></div><div class="line"></div><div class="line"><span class="keyword">type</span> myMutex sync.Mutex</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    <span class="keyword">var</span> mtx myMutex</div><div class="line">    mtx.Lock() <span class="comment">//error</span></div><div class="line">    mtx.Unlock() <span class="comment">//error  </span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Compile Errors:  </p>
<blockquote>
<p>/tmp/sandbox106401185/main.go:9: mtx.Lock undefined (type myMutex has no field or method Lock)<br>/tmp/sandbox106401185/main.go:10: mtx.Unlock undefined (type myMutex has no field or method Unlock)</p>
</blockquote>
<p>如果你确实需要原有类型的方法，你可以定义一个新的struct类型，用匿名方式把原有类型嵌入其中。</p>
<p>Works:  </p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"sync"</span></div><div class="line"></div><div class="line"><span class="keyword">type</span> myLocker <span class="keyword">struct</span> &#123;  </div><div class="line">    sync.Mutex</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    <span class="keyword">var</span> lock myLocker</div><div class="line">    lock.Lock() <span class="comment">//ok</span></div><div class="line">    lock.Unlock() <span class="comment">//ok</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>interface类型的声明也会保留它们的方法集合。</p>
<p>Works:  </p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"sync"</span></div><div class="line"></div><div class="line"><span class="keyword">type</span> myLocker sync.Locker</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    <span class="keyword">var</span> lock myLocker = <span class="built_in">new</span>(sync.Mutex)</div><div class="line">    lock.Lock() <span class="comment">//ok</span></div><div class="line">    lock.Unlock() <span class="comment">//ok</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Breaking-Out-of-“for-switch”-and-“for-select”-Code-Blocks"><a href="#Breaking-Out-of-“for-switch”-and-“for-select”-Code-Blocks" class="headerlink" title="Breaking Out of “for switch” and “for select” Code Blocks"></a>Breaking Out of “for switch” and “for select” Code Blocks</h3><p>没有标签的“break”声明只能从内部的switch/select代码块中跳出来。如果无法使用“return”声明的话，那就为外部循环定义一个标签是另一个好的选择。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    loop:</div><div class="line">        <span class="keyword">for</span> &#123;</div><div class="line">            <span class="keyword">switch</span> &#123;</div><div class="line">            <span class="keyword">case</span> <span class="literal">true</span>:</div><div class="line">                fmt.Println(<span class="string">"breaking out..."</span>)</div><div class="line">                <span class="keyword">break</span> loop</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    fmt.Println(<span class="string">"out!"</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>A “goto” statement will do the trick too…</p>
<h3 id="Iteration-Variables-and-Closures-in-“for”-Statements"><a href="#Iteration-Variables-and-Closures-in-“for”-Statements" class="headerlink" title="Iteration Variables and Closures in “for” Statements"></a>Iteration Variables and Closures in “for” Statements</h3><p>这在Go中是个很常见的技巧。<code>for</code>语句中的迭代变量在每次迭代时被重新使用。这就意味着你在<code>for</code>循环中创建的闭包（即函数字面量）将会引用同一个变量（而在那些goroutine开始执行时就会得到那个变量的值）。</p>
<p>Incorrect:  </p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (  </div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"time"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    data := []<span class="keyword">string</span>&#123;<span class="string">"one"</span>,<span class="string">"two"</span>,<span class="string">"three"</span>&#125;</div><div class="line"></div><div class="line">    <span class="keyword">for</span> _,v := <span class="keyword">range</span> data &#123;</div><div class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">            fmt.Println(v)</div><div class="line">        &#125;()</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    time.Sleep(<span class="number">3</span> * time.Second)</div><div class="line">    <span class="comment">//goroutines print: three, three, three</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最简单的解决方法（不需要修改goroutine）是，在for循环代码块内把当前迭代的变量值保存到一个局部变量中。</p>
<p>Works:  </p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (  </div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"time"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    data := []<span class="keyword">string</span>&#123;<span class="string">"one"</span>,<span class="string">"two"</span>,<span class="string">"three"</span>&#125;</div><div class="line"></div><div class="line">    <span class="keyword">for</span> _,v := <span class="keyword">range</span> data &#123;</div><div class="line">        vcopy := v <span class="comment">//</span></div><div class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">            fmt.Println(vcopy)</div><div class="line">        &#125;()</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    time.Sleep(<span class="number">3</span> * time.Second)</div><div class="line">    <span class="comment">//goroutines print: one, two, three</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>另一个解决方法是把当前的迭代变量作为匿名goroutine的参数。</p>
<p>Works:  </p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (  </div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"time"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    data := []<span class="keyword">string</span>&#123;<span class="string">"one"</span>,<span class="string">"two"</span>,<span class="string">"three"</span>&#125;</div><div class="line"></div><div class="line">    <span class="keyword">for</span> _,v := <span class="keyword">range</span> data &#123;</div><div class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(in <span class="keyword">string</span>)</span></span> &#123;</div><div class="line">            fmt.Println(in)</div><div class="line">        &#125;(v)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    time.Sleep(<span class="number">3</span> * time.Second)</div><div class="line">    <span class="comment">//goroutines print: one, two, three</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>下面这个陷阱稍微复杂一些的版本。</p>
<p>Incorrect:  </p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (  </div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"time"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">type</span> field <span class="keyword">struct</span> &#123;  </div><div class="line">    name <span class="keyword">string</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *field)</span> <span class="title">print</span><span class="params">()</span></span> &#123;  </div><div class="line">    fmt.Println(p.name)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    data := []field&#123;&#123;<span class="string">"one"</span>&#125;,&#123;<span class="string">"two"</span>&#125;,&#123;<span class="string">"three"</span>&#125;&#125;</div><div class="line"></div><div class="line">    <span class="keyword">for</span> _,v := <span class="keyword">range</span> data &#123;</div><div class="line">        <span class="keyword">go</span> v.<span class="built_in">print</span>()</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    time.Sleep(<span class="number">3</span> * time.Second)</div><div class="line">    <span class="comment">//goroutines print: three, three, three</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Works:  </p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (  </div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"time"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">type</span> field <span class="keyword">struct</span> &#123;  </div><div class="line">    name <span class="keyword">string</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *field)</span> <span class="title">print</span><span class="params">()</span></span> &#123;  </div><div class="line">    fmt.Println(p.name)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    data := []field&#123;&#123;<span class="string">"one"</span>&#125;,&#123;<span class="string">"two"</span>&#125;,&#123;<span class="string">"three"</span>&#125;&#125;</div><div class="line"></div><div class="line">    <span class="keyword">for</span> _,v := <span class="keyword">range</span> data &#123;</div><div class="line">        v := v</div><div class="line">        <span class="keyword">go</span> v.<span class="built_in">print</span>()</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    time.Sleep(<span class="number">3</span> * time.Second)</div><div class="line">    <span class="comment">//goroutines print: one, two, three</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>What do you think you’ll see when you run this code (and why)?</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (  </div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"time"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">type</span> field <span class="keyword">struct</span> &#123;  </div><div class="line">    name <span class="keyword">string</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *field)</span> <span class="title">print</span><span class="params">()</span></span> &#123;  </div><div class="line">    fmt.Println(p.name)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    data := []*field&#123;&#123;<span class="string">"one"</span>&#125;,&#123;<span class="string">"two"</span>&#125;,&#123;<span class="string">"three"</span>&#125;&#125;</div><div class="line"></div><div class="line">    <span class="keyword">for</span> _,v := <span class="keyword">range</span> data &#123;</div><div class="line">        <span class="keyword">go</span> v.<span class="built_in">print</span>()</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    time.Sleep(<span class="number">3</span> * time.Second)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Deferred-Function-Call-Argument-Evaluation"><a href="#Deferred-Function-Call-Argument-Evaluation" class="headerlink" title="Deferred Function Call Argument Evaluation"></a>Deferred Function Call Argument Evaluation</h3><p>Arguments for a deferred function call are evaluated when the <code>defer</code> statement is evaluated (not when the function is actually executing).</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    <span class="keyword">var</span> i <span class="keyword">int</span> = <span class="number">1</span></div><div class="line"></div><div class="line">    <span class="keyword">defer</span> fmt.Println(<span class="string">"result =&gt;"</span>,<span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">int</span></span> &#123; <span class="keyword">return</span> i * <span class="number">2</span> &#125;())</div><div class="line">    i++</div><div class="line">    <span class="comment">//prints: result =&gt; 2 (not ok if you expected 4)</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Deferred-Function-Call-Execution"><a href="#Deferred-Function-Call-Execution" class="headerlink" title="Deferred Function Call Execution"></a>Deferred Function Call Execution</h3><p>被defer的调用会在包含的函数的末尾执行，而不是包含代码块的末尾。对于Go新手而言，一个很常犯的错误就是无法区分被defer的代码执行规则和变量作用规则。如果你有一个长时运行的函数，而函数内有一个for循环试图在每次迭代时都defer资源清理调用，那就会出现问题。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (  </div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"os"</span></div><div class="line">    <span class="string">"path/filepath"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(os.Args) != <span class="number">2</span> &#123;</div><div class="line">        os.Exit(<span class="number">-1</span>)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    start, err := os.Stat(os.Args[<span class="number">1</span>])</div><div class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> || !start.IsDir()&#123;</div><div class="line">        os.Exit(<span class="number">-1</span>)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">var</span> targets []<span class="keyword">string</span></div><div class="line">    filepath.Walk(os.Args[<span class="number">1</span>], <span class="function"><span class="keyword">func</span><span class="params">(fpath <span class="keyword">string</span>, fi os.FileInfo, err error)</span> <span class="title">error</span></span> &#123;</div><div class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">            <span class="keyword">return</span> err</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> !fi.Mode().IsRegular() &#123;</div><div class="line">            <span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        targets = <span class="built_in">append</span>(targets,fpath)</div><div class="line">        <span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">    &#125;)</div><div class="line"></div><div class="line">    <span class="keyword">for</span> _,target := <span class="keyword">range</span> targets &#123;</div><div class="line">        f, err := os.Open(target)</div><div class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">            fmt.Println(<span class="string">"bad target:"</span>,target,<span class="string">"error:"</span>,err) <span class="comment">//prints error: too many open files</span></div><div class="line">            <span class="keyword">break</span></div><div class="line">        &#125;</div><div class="line">        <span class="keyword">defer</span> f.Close() <span class="comment">//will not be closed at the end of this code block</span></div><div class="line">        <span class="comment">//do something with the file...</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>解决这个问题的一个方法是把代码块写成一个函数。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (  </div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"os"</span></div><div class="line">    <span class="string">"path/filepath"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(os.Args) != <span class="number">2</span> &#123;</div><div class="line">        os.Exit(<span class="number">-1</span>)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    start, err := os.Stat(os.Args[<span class="number">1</span>])</div><div class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> || !start.IsDir()&#123;</div><div class="line">        os.Exit(<span class="number">-1</span>)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">var</span> targets []<span class="keyword">string</span></div><div class="line">    filepath.Walk(os.Args[<span class="number">1</span>], <span class="function"><span class="keyword">func</span><span class="params">(fpath <span class="keyword">string</span>, fi os.FileInfo, err error)</span> <span class="title">error</span></span> &#123;</div><div class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">            <span class="keyword">return</span> err</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> !fi.Mode().IsRegular() &#123;</div><div class="line">            <span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        targets = <span class="built_in">append</span>(targets,fpath)</div><div class="line">        <span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">    &#125;)</div><div class="line"></div><div class="line">    <span class="keyword">for</span> _,target := <span class="keyword">range</span> targets &#123;</div><div class="line">        <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">            f, err := os.Open(target)</div><div class="line">            <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">                fmt.Println(<span class="string">"bad target:"</span>,target,<span class="string">"error:"</span>,err)</div><div class="line">                <span class="keyword">return</span></div><div class="line">            &#125;</div><div class="line">            <span class="keyword">defer</span> f.Close() <span class="comment">//ok</span></div><div class="line">            <span class="comment">//do something with the file...</span></div><div class="line">        &#125;()</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>另一个方法是去掉defer语句 :-)</p>
<h3 id="Failed-Type-Assertions"><a href="#Failed-Type-Assertions" class="headerlink" title="Failed Type Assertions"></a>Failed Type Assertions</h3><p>失败的类型断言返回断言声明中使用的目标类型的“零值”。这在与隐藏变量混合时，会发生未知情况。</p>
<p>Incorrect:  </p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    <span class="keyword">var</span> data <span class="keyword">interface</span>&#123;&#125; = <span class="string">"great"</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> data, ok := data.(<span class="keyword">int</span>); ok &#123;</div><div class="line">        fmt.Println(<span class="string">"[is an int] value =&gt;"</span>,data)</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        fmt.Println(<span class="string">"[not an int] value =&gt;"</span>,data) </div><div class="line">        <span class="comment">//prints: [not an int] value =&gt; 0 (not "great")</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Works:  </p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    <span class="keyword">var</span> data <span class="keyword">interface</span>&#123;&#125; = <span class="string">"great"</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> res, ok := data.(<span class="keyword">int</span>); ok &#123;</div><div class="line">        fmt.Println(<span class="string">"[is an int] value =&gt;"</span>,res)</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        fmt.Println(<span class="string">"[not an int] value =&gt;"</span>,data) </div><div class="line">        <span class="comment">//prints: [not an int] value =&gt; great (as expected)</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Blocked-Goroutines-and-Resource-Leaks"><a href="#Blocked-Goroutines-and-Resource-Leaks" class="headerlink" title="Blocked Goroutines and Resource Leaks"></a>Blocked Goroutines and Resource Leaks</h3><p>Rob Pike talked about a number of fundamental concurrency patterns in his <a href="https://talks.golang.org/2012/concurrency.slide#1" target="_blank" rel="external">“Go Concurrency Patterns”</a> presentation at Google I/O in 2012. Fetching the first result from a number of targets is one of them.</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">First</span><span class="params">(query <span class="keyword">string</span>, replicas ...Search)</span> <span class="title">Result</span></span> &#123;  </div><div class="line">    c := <span class="built_in">make</span>(<span class="keyword">chan</span> Result)</div><div class="line">    searchReplica := <span class="function"><span class="keyword">func</span><span class="params">(i <span class="keyword">int</span>)</span></span> &#123; c &lt;- replicas[i](query) &#125;</div><div class="line">    <span class="keyword">for</span> i := <span class="keyword">range</span> replicas &#123;</div><div class="line">        <span class="keyword">go</span> searchReplica(i)</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> &lt;-c</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个函数在每次搜索重复时都会起一个goroutine。每个goroutine把它的搜索结果发送到结果的channel中。结果channel的第一个值被返回。</p>
<p>那其他goroutine的结果会怎样呢？还有那些goroutine自身呢？</p>
<p>在<code>First()</code>函数中的结果channel是没缓存的。这意味着只有第一个goroutine返回。其他的goroutine会困在尝试发送结果的过程中。这意味着，如果你有不止一个的重复时，每个调用将会泄露资源。</p>
<p>为了避免泄露，你需要确保所有的goroutine退出。一个不错的方法是使用一个有足够保存所有缓存结果的channel。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">First</span><span class="params">(query <span class="keyword">string</span>, replicas ...Search)</span> <span class="title">Result</span></span> &#123;  </div><div class="line">    c := <span class="built_in">make</span>(<span class="keyword">chan</span> Result,<span class="built_in">len</span>(replicas))</div><div class="line">    searchReplica := <span class="function"><span class="keyword">func</span><span class="params">(i <span class="keyword">int</span>)</span></span> &#123; c &lt;- replicas[i](query) &#125;</div><div class="line">    <span class="keyword">for</span> i := <span class="keyword">range</span> replicas &#123;</div><div class="line">        <span class="keyword">go</span> searchReplica(i)</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> &lt;-c</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>另一个不错的解决方法是使用一个有<code>default</code>情况的<code>select</code>语句和一个保存一个缓存结果的channel。<code>default</code>情况保证了即使当结果channel无法收到消息的情况下，goroutine也不会堵塞。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">First</span><span class="params">(query <span class="keyword">string</span>, replicas ...Search)</span> <span class="title">Result</span></span> &#123;  </div><div class="line">    c := <span class="built_in">make</span>(<span class="keyword">chan</span> Result,<span class="number">1</span>)</div><div class="line">    searchReplica := <span class="function"><span class="keyword">func</span><span class="params">(i <span class="keyword">int</span>)</span></span> &#123; </div><div class="line">        <span class="keyword">select</span> &#123;</div><div class="line">        <span class="keyword">case</span> c &lt;- replicas[i](query):</div><div class="line">        <span class="keyword">default</span>:</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">for</span> i := <span class="keyword">range</span> replicas &#123;</div><div class="line">        <span class="keyword">go</span> searchReplica(i)</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> &lt;-c</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>你也可以使用特殊的取消channel来终止workers。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">First</span><span class="params">(query <span class="keyword">string</span>, replicas ...Search)</span> <span class="title">Result</span></span> &#123;  </div><div class="line">    c := <span class="built_in">make</span>(<span class="keyword">chan</span> Result)</div><div class="line">    done := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</div><div class="line">    <span class="keyword">defer</span> <span class="built_in">close</span>(done)</div><div class="line">    searchReplica := <span class="function"><span class="keyword">func</span><span class="params">(i <span class="keyword">int</span>)</span></span> &#123; </div><div class="line">        <span class="keyword">select</span> &#123;</div><div class="line">        <span class="keyword">case</span> c &lt;- replicas[i](query):</div><div class="line">        <span class="keyword">case</span> &lt;- done:</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">for</span> i := <span class="keyword">range</span> replicas &#123;</div><div class="line">        <span class="keyword">go</span> searchReplica(i)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> &lt;-c</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>为何在演讲中会包含这些bug？Rob Pike仅仅是不想把演示复杂化。这么作是合理的，但对于Go新手而言，可能会直接使用代码，而不去思考它可能有问题。</p>
<h3 id="Using-Pointer-Receiver-Methods-On-Value-Instances"><a href="#Using-Pointer-Receiver-Methods-On-Value-Instances" class="headerlink" title="Using Pointer Receiver Methods On Value Instances"></a>Using Pointer Receiver Methods On Value Instances</h3><p>只要值是可取址的，那在这个值上调用指针接收方法是没问题的。换句话说，在某些情况下，你不需要在有一个接收值的方法版本。</p>
<p>然而并不是所有的变量是可取址的。Map的元素就不是。通过interface引用的变量也不是。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="keyword">type</span> data <span class="keyword">struct</span> &#123;  </div><div class="line">    name <span class="keyword">string</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *data)</span> <span class="title">print</span><span class="params">()</span></span> &#123;  </div><div class="line">    fmt.Println(<span class="string">"name:"</span>,p.name)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> printer <span class="keyword">interface</span> &#123;  </div><div class="line">    <span class="built_in">print</span>()</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    d1 := data&#123;<span class="string">"one"</span>&#125;</div><div class="line">    d1.<span class="built_in">print</span>() <span class="comment">//ok</span></div><div class="line"></div><div class="line">    <span class="keyword">var</span> in printer = data&#123;<span class="string">"two"</span>&#125; <span class="comment">//error</span></div><div class="line">    in.<span class="built_in">print</span>()</div><div class="line"></div><div class="line">    m := <span class="keyword">map</span>[<span class="keyword">string</span>]data &#123;<span class="string">"x"</span>:data&#123;<span class="string">"three"</span>&#125;&#125;</div><div class="line">    m[<span class="string">"x"</span>].<span class="built_in">print</span>() <span class="comment">//error</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Compile Errors:  </p>
<blockquote>
<p>/tmp/sandbox017696142/main.go:21: cannot use data literal (type data) as type printer in assignment:<br>data does not implement printer (print method has pointer receiver)<br>/tmp/sandbox017696142/main.go:25: cannot call pointer method on m[“x”]<br>/tmp/sandbox017696142/main.go:25: cannot take the address of m[“x”]</p>
</blockquote>
<h3 id="Updating-Map-Value-Fields"><a href="#Updating-Map-Value-Fields" class="headerlink" title="Updating Map Value Fields"></a>Updating Map Value Fields</h3><p>如果你有一个struct值的map，你无法更新单个的struct值。</p>
<p>Fails:  </p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">type</span> data <span class="keyword">struct</span> &#123;  </div><div class="line">    name <span class="keyword">string</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    m := <span class="keyword">map</span>[<span class="keyword">string</span>]data &#123;<span class="string">"x"</span>:&#123;<span class="string">"one"</span>&#125;&#125;</div><div class="line">    m[<span class="string">"x"</span>].name = <span class="string">"two"</span> <span class="comment">//error</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Compile Error:  </p>
<blockquote>
<p>/tmp/sandbox380452744/main.go:9: cannot assign to m[“x”].name</p>
</blockquote>
<p>这个操作无效是因为map元素是无法取址的。</p>
<p>而让Go新手更加困惑的是slice元素是可以取址的。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="keyword">type</span> data <span class="keyword">struct</span> &#123;  </div><div class="line">    name <span class="keyword">string</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    s := []data &#123;&#123;<span class="string">"one"</span>&#125;&#125;</div><div class="line">    s[<span class="number">0</span>].name = <span class="string">"two"</span> <span class="comment">//ok</span></div><div class="line">    fmt.Println(s)    <span class="comment">//prints: [&#123;two&#125;]</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>注意在不久之前，使用编译器之一（gccgo）是可以更新map的元素值的，但这一行为很快就被修复了 :-)它也被认为是Go 1.3的潜在特性。在那时还不是要急需支持的，但依旧在todo list中。</p>
<p>第一个有效的方法是使用一个临时变量。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="keyword">type</span> data <span class="keyword">struct</span> &#123;  </div><div class="line">    name <span class="keyword">string</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    m := <span class="keyword">map</span>[<span class="keyword">string</span>]data &#123;<span class="string">"x"</span>:&#123;<span class="string">"one"</span>&#125;&#125;</div><div class="line">    r := m[<span class="string">"x"</span>]</div><div class="line">    r.name = <span class="string">"two"</span></div><div class="line">    m[<span class="string">"x"</span>] = r</div><div class="line">    fmt.Printf(<span class="string">"%v"</span>,m) <span class="comment">//prints: map[x:&#123;two&#125;]</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>另一个有效的方法是使用指针的map。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="keyword">type</span> data <span class="keyword">struct</span> &#123;  </div><div class="line">    name <span class="keyword">string</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    m := <span class="keyword">map</span>[<span class="keyword">string</span>]*data &#123;<span class="string">"x"</span>:&#123;<span class="string">"one"</span>&#125;&#125;</div><div class="line">    m[<span class="string">"x"</span>].name = <span class="string">"two"</span> <span class="comment">//ok</span></div><div class="line">    fmt.Println(m[<span class="string">"x"</span>]) <span class="comment">//prints: &amp;&#123;two&#125;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>By the way, what happens when you run this code?</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">type</span> data <span class="keyword">struct</span> &#123;  </div><div class="line">    name <span class="keyword">string</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    m := <span class="keyword">map</span>[<span class="keyword">string</span>]*data &#123;<span class="string">"x"</span>:&#123;<span class="string">"one"</span>&#125;&#125;</div><div class="line">    m[<span class="string">"z"</span>].name = <span class="string">"what?"</span> <span class="comment">//???</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="“nil”-Interfaces-and-“nil”-Interfaces-Values"><a href="#“nil”-Interfaces-and-“nil”-Interfaces-Values" class="headerlink" title="“nil” Interfaces and “nil” Interfaces Values"></a>“nil” Interfaces and “nil” Interfaces Values</h3><p>这在Go中是第二最常见的技巧，因为interface虽然看起来像指针，但并不是指针。interface变量仅在类型和值为“nil”时才为“nil”。</p>
<p>interface的类型和值会根据用于创建对应interface变量的类型和值的变化而变化。当你检查一个interface变量是否等于“nil”时，这就会导致未预期的行为。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    <span class="keyword">var</span> data *<span class="keyword">byte</span></div><div class="line">    <span class="keyword">var</span> in <span class="keyword">interface</span>&#123;&#125;</div><div class="line"></div><div class="line">    fmt.Println(data,data == <span class="literal">nil</span>) <span class="comment">//prints: &lt;nil&gt; true</span></div><div class="line">    fmt.Println(in,in == <span class="literal">nil</span>)     <span class="comment">//prints: &lt;nil&gt; true</span></div><div class="line"></div><div class="line">    in = data</div><div class="line">    fmt.Println(in,in == <span class="literal">nil</span>)     <span class="comment">//prints: &lt;nil&gt; false</span></div><div class="line">    <span class="comment">//'data' is 'nil', but 'in' is not 'nil'</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当你的函数返回interface时，小心这个陷阱。</p>
<p>Incorrect:  </p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    doit := <span class="function"><span class="keyword">func</span><span class="params">(arg <span class="keyword">int</span>)</span> <span class="title">interface</span></span>&#123;&#125; &#123;</div><div class="line">        <span class="keyword">var</span> result *<span class="keyword">struct</span>&#123;&#125; = <span class="literal">nil</span></div><div class="line"></div><div class="line">        <span class="keyword">if</span>(arg &gt; <span class="number">0</span>) &#123;</div><div class="line">            result = &amp;<span class="keyword">struct</span>&#123;&#125;&#123;&#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> result</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> res := doit(<span class="number">-1</span>); res != <span class="literal">nil</span> &#123;</div><div class="line">        fmt.Println(<span class="string">"good result:"</span>,res) <span class="comment">//prints: good result: &lt;nil&gt;</span></div><div class="line">        <span class="comment">//'res' is not 'nil', but its value is 'nil'</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Works:  </p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    doit := <span class="function"><span class="keyword">func</span><span class="params">(arg <span class="keyword">int</span>)</span> <span class="title">interface</span></span>&#123;&#125; &#123;</div><div class="line">        <span class="keyword">var</span> result *<span class="keyword">struct</span>&#123;&#125; = <span class="literal">nil</span></div><div class="line"></div><div class="line">        <span class="keyword">if</span>(arg &gt; <span class="number">0</span>) &#123;</div><div class="line">            result = &amp;<span class="keyword">struct</span>&#123;&#125;&#123;&#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">return</span> <span class="literal">nil</span> <span class="comment">//return an explicit 'nil'</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> result</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> res := doit(<span class="number">-1</span>); res != <span class="literal">nil</span> &#123;</div><div class="line">        fmt.Println(<span class="string">"good result:"</span>,res)</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        fmt.Println(<span class="string">"bad result (res is nil)"</span>) <span class="comment">//here as expected</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Stack-and-Heap-Variables"><a href="#Stack-and-Heap-Variables" class="headerlink" title="Stack and Heap Variables"></a>Stack and Heap Variables</h3><p>你并不总是知道变量是分配到栈还是堆上。在C++中，使用<code>new</code>创建的变量总是在堆上。在Go中，即使是使用<code>new()</code>或者<code>make()</code>函数来分配，变量的位置还是由编译器决定。编译器根据变量的大小和“泄露分析”的结果来决定其位置。这也意味着在局部变量上返回引用是没问题的，而这在C或者C++这样的语言中是不行的。</p>
<p>如果你想知道变量分配的位置，在“go build”或“go run”上传入“-m“ gc标志（即，<code>go run -gcflags -m app.go</code>）。</p>
<h3 id="GOMAXPROCS-Concurrency-and-Parallelism"><a href="#GOMAXPROCS-Concurrency-and-Parallelism" class="headerlink" title="GOMAXPROCS, Concurrency, and Parallelism"></a>GOMAXPROCS, Concurrency, and Parallelism</h3><p>Go 1.4 and below uses only one execution context / OS thread. This means that only one goroutine can execute at any given time. Starting with 1.5 Go sets the number of execution contexts to the number of logical CPU cores returned by <code>runtime.NumCPU()</code>. That number may or may not match the total number of logical CPU cores on your system depending on the CPU affinity settings of your process.  You can adjust this number by changing the <code>GOMAXPROCS</code> environment variable or by calling the <code>runtime.GOMAXPROCS()</code> function.</p>
<p>There’s a common misconception that <code>GOMAXPROCS</code> represents the number of CPUs Go will use to run goroutines. The <code>runtime.GOMAXPROCS()</code> function documentation adds more to the confusion. The <code>GOMAXPROCS</code> variable description (<a href="https://golang.org/pkg/runtime/" target="_blank" rel="external">https://golang.org/pkg/runtime/</a>) does a better job talking about OS threads.</p>
<p>You can set <code>GOMAXPROCS</code> to more than the number of your CPUs. The max value for <code>GOMAXPROCS</code> is 256.</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (  </div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"runtime"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    fmt.Println(runtime.GOMAXPROCS(<span class="number">-1</span>)) <span class="comment">//prints: X (1 on play.golang.org)</span></div><div class="line">    fmt.Println(runtime.NumCPU())       <span class="comment">//prints: X (1 on play.golang.org)</span></div><div class="line">    runtime.GOMAXPROCS(<span class="number">20</span>)</div><div class="line">    fmt.Println(runtime.GOMAXPROCS(<span class="number">-1</span>)) <span class="comment">//prints: 20</span></div><div class="line">    runtime.GOMAXPROCS(<span class="number">300</span>)</div><div class="line">    fmt.Println(runtime.GOMAXPROCS(<span class="number">-1</span>)) <span class="comment">//prints: 256</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Read-and-Write-Operation-Reordering"><a href="#Read-and-Write-Operation-Reordering" class="headerlink" title="Read and Write Operation Reordering"></a>Read and Write Operation Reordering</h3><p>Go可能会对某些操作进行重新排序，但它能保证在一个goroutine内的所有行为顺序是不变的。然而，它并不保证多goroutine的执行顺序。</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (  </div><div class="line">    <span class="string">"runtime"</span></div><div class="line">    <span class="string">"time"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">var</span> _ = runtime.GOMAXPROCS(<span class="number">3</span>)</div><div class="line"></div><div class="line"><span class="keyword">var</span> a, b <span class="keyword">int</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">u1</span><span class="params">()</span></span> &#123;  </div><div class="line">    a = <span class="number">1</span></div><div class="line">    b = <span class="number">2</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">u2</span><span class="params">()</span></span> &#123;  </div><div class="line">    a = <span class="number">3</span></div><div class="line">    b = <span class="number">4</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">p</span><span class="params">()</span></span> &#123;  </div><div class="line">    <span class="built_in">println</span>(a)</div><div class="line">    <span class="built_in">println</span>(b)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    <span class="keyword">go</span> u1()</div><div class="line">    <span class="keyword">go</span> u2()</div><div class="line">    <span class="keyword">go</span> p()</div><div class="line">    time.Sleep(<span class="number">1</span> * time.Second)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>If you run this code a few times you might see these <code>a</code> and <code>b</code> variable combinations:</p>
<blockquote>
<p>1<br>2  </p>
<p>3<br>4  </p>
<p>0<br>2  </p>
<p>0<br>0  </p>
<p>1<br>4    </p>
</blockquote>
<p>The most interesting combination for <code>a</code> and <code>b</code> is “02”. It shows that <code>b</code> was updated before <code>a</code>.</p>
<p>如果你需要在多goroutine内放置读写顺序的变化，你将需要使用channel，或者使用”sync”包构建合适的结构体。</p>
<h3 id="Preemptive-Scheduling"><a href="#Preemptive-Scheduling" class="headerlink" title="Preemptive Scheduling"></a>Preemptive Scheduling</h3><p>It’s possible to have a rogue goroutine that prevents other goroutines from running. It can happen if you have a <code>for</code> loop that doesn’t allow the scheduler to run.</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    done := <span class="literal">false</span></div><div class="line"></div><div class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span>&#123;</div><div class="line">        done = <span class="literal">true</span></div><div class="line">    &#125;()</div><div class="line"></div><div class="line">    <span class="keyword">for</span> !done &#123;</div><div class="line">    &#125;</div><div class="line">    fmt.Println(<span class="string">"done!"</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>The <code>for</code> loop doesn’t have to be empty. It’ll be a problem as long as it contains code that doesn’t trigger the scheduler execution.</p>
<p>The scheduler will run after GC, “go” statements, blocking channel operations, blocking system calls, and lock operations. It may also run when a non-inlined function is called.</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    done := <span class="literal">false</span></div><div class="line"></div><div class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span>&#123;</div><div class="line">        done = <span class="literal">true</span></div><div class="line">    &#125;()</div><div class="line"></div><div class="line">    <span class="keyword">for</span> !done &#123;</div><div class="line">        fmt.Println(<span class="string">"not done!"</span>) <span class="comment">//not inlined</span></div><div class="line">    &#125;</div><div class="line">    fmt.Println(<span class="string">"done!"</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>To find out if the function you call in the <code>for</code> loop is inlined pass the “-m” gc flag to “go build” or “go run” (e.g., <code>go build -gcflags -m</code>).</p>
<p>Another option is to invoke the scheduler explicitly. You can do it with the <code>Gosched()</code> function from the “runtime” package.</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (  </div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"runtime"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </div><div class="line">    done := <span class="literal">false</span></div><div class="line"></div><div class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span>&#123;</div><div class="line">        done = <span class="literal">true</span></div><div class="line">    &#125;()</div><div class="line"></div><div class="line">    <span class="keyword">for</span> !done &#123;</div><div class="line">        runtime.Gosched()</div><div class="line">    &#125;</div><div class="line">    fmt.Println(<span class="string">"done!"</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>If you made it here and you have comments or ideas feel free to add a note to <a href="https://www.reddit.com/r/golang/comments/360vlb/draft_traps_gotchas_and_common_mistakes_in_go/" target="_blank" rel="external">this Reddit discussion</a>.</p>
<h3 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h3><ul>
<li><a href="http://devs.cloudimmunity.com/gotchas-and-common-mistakes-in-go-golang/" target="_blank" rel="external">http://devs.cloudimmunity.com/gotchas-and-common-mistakes-in-go-golang/</a></li>
<li><a href="https://gist.github.com/lavalamp/4bd23295a9f32706a48f" target="_blank" rel="external">https://gist.github.com/lavalamp/4bd23295a9f32706a48f</a></li>
<li><a href="https://golang.org/doc/faq#nil_error" target="_blank" rel="external">https://golang.org/doc/faq#nil_error</a></li>
<li><a href="https://go-talks.appspot.com/github.com/davecheney/high-performance-go-workshop/high-performance-go-workshop.slide" target="_blank" rel="external">https://go-talks.appspot.com/github.com/davecheney/high-performance-go-workshop/high-performance-go-workshop.slide</a></li>
</ul>

    
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="//schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/qrcode.jpg"
               alt="Feisky" />
          <p class="site-author-name" itemprop="name">Feisky</p>
          <p class="site-description motion-element" itemprop="description">Notes about anything.</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">89</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">14</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">28</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/feiskyer" target="_blank" title="Github">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  Github
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/feisky" target="_blank" title="Twitter">
                  
                    <i class="fa fa-fw fa-twitter"></i>
                  
                  Twitter
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/371069890" target="_blank" title="Weibo">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  Weibo
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.cnblogs.com/feisky/" target="_blank" title="博客园">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  博客园
                </a>
              </span>
            
          
        </div>

        
        

        
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Go语言技巧"><span class="nav-number">1.</span> <span class="nav-text">Go语言技巧</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#常用工具"><span class="nav-number">1.1.</span> <span class="nav-text">常用工具</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#惯用法"><span class="nav-number">1.2.</span> <span class="nav-text">惯用法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#技巧汇总"><span class="nav-number">1.3.</span> <span class="nav-text">技巧汇总</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#避免循环中的变量逃逸到循环外"><span class="nav-number">1.3.1.</span> <span class="nav-text">避免循环中的变量逃逸到循环外</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#区分nil-interface跟nil指针成员的不同"><span class="nav-number">1.3.2.</span> <span class="nav-text">区分nil interface跟nil指针成员的不同</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#影子变量带来的困惑"><span class="nav-number">1.3.3.</span> <span class="nav-text">影子变量带来的困惑</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#开大括号不能放在单独的一行"><span class="nav-number">1.3.4.</span> <span class="nav-text">开大括号不能放在单独的一行</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#未使用的变量"><span class="nav-number">1.3.5.</span> <span class="nav-text">未使用的变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#未使用的Imports"><span class="nav-number">1.3.6.</span> <span class="nav-text">未使用的Imports</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#简式的变量声明仅可以在函数内部使用"><span class="nav-number">1.3.7.</span> <span class="nav-text">简式的变量声明仅可以在函数内部使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用简式声明重复声明变量"><span class="nav-number">1.3.8.</span> <span class="nav-text">使用简式声明重复声明变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#不能使用简式声明来设置成员变量"><span class="nav-number">1.3.9.</span> <span class="nav-text">不能使用简式声明来设置成员变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Accidental-Variable-Shadowing"><span class="nav-number">1.3.10.</span> <span class="nav-text">Accidental Variable Shadowing</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#不使用显式类型，无法使用“nil”来初始化变量"><span class="nav-number">1.3.11.</span> <span class="nav-text">不使用显式类型，无法使用“nil”来初始化变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Using-“nil”-Slices-and-Maps"><span class="nav-number">1.3.12.</span> <span class="nav-text">Using “nil” Slices and Maps</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Map-Capacity"><span class="nav-number">1.3.13.</span> <span class="nav-text">Map Capacity</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Strings-Can’t-Be-“nil”"><span class="nav-number">1.3.14.</span> <span class="nav-text">Strings Can’t Be “nil”</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Array-Function-Arguments"><span class="nav-number">1.3.15.</span> <span class="nav-text">Array Function Arguments</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Unexpected-Values-in-Slice-and-Array-“range”-Clauses"><span class="nav-number">1.3.16.</span> <span class="nav-text">Unexpected Values in Slice and Array “range” Clauses</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Slices-and-Arrays-Are-One-Dimensional"><span class="nav-number">1.3.17.</span> <span class="nav-text">Slices and Arrays Are One-Dimensional</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Accessing-Non-Existing-Map-Keys"><span class="nav-number">1.3.18.</span> <span class="nav-text">Accessing Non-Existing Map Keys</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Strings-Are-Immutable"><span class="nav-number">1.3.19.</span> <span class="nav-text">Strings Are Immutable</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Conversions-Between-Strings-and-Byte-Slices"><span class="nav-number">1.3.20.</span> <span class="nav-text">Conversions Between Strings and Byte Slices</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Strings-and-Index-Operator"><span class="nav-number">1.3.21.</span> <span class="nav-text">Strings and Index Operator</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Strings-Are-Not-Always-UTF8-Text"><span class="nav-number">1.3.22.</span> <span class="nav-text">Strings Are Not Always UTF8 Text</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#String-Length"><span class="nav-number">1.3.23.</span> <span class="nav-text">String Length</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Missing-Comma-In-Multi-Line-Slice-Array-and-Map-Literals"><span class="nav-number">1.3.24.</span> <span class="nav-text">Missing Comma In Multi-Line Slice, Array, and Map Literals</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#log-Fatal-and-log-Panic-Do-More-Than-Log"><span class="nav-number">1.3.25.</span> <span class="nav-text">log.Fatal and log.Panic Do More Than Log</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Built-in-Data-Structure-Operations-Are-Not-Synchronized"><span class="nav-number">1.3.26.</span> <span class="nav-text">Built-in Data Structure Operations Are Not Synchronized</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Iteration-Values-For-Strings-in-“range”-Clauses"><span class="nav-number">1.3.27.</span> <span class="nav-text">Iteration Values For Strings in “range” Clauses</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Iterating-Through-a-Map-Using-a-“for-range”-Clause"><span class="nav-number">1.3.28.</span> <span class="nav-text">Iterating Through a Map Using a “for range” Clause</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Fallthrough-Behavior-in-“switch”-Statements"><span class="nav-number">1.3.29.</span> <span class="nav-text">Fallthrough Behavior in “switch” Statements</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Increments-and-Decrements"><span class="nav-number">1.3.30.</span> <span class="nav-text">Increments and Decrements</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Bitwise-NOT-Operator"><span class="nav-number">1.3.31.</span> <span class="nav-text">Bitwise NOT Operator</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Operator-Precedence-Differences"><span class="nav-number">1.3.32.</span> <span class="nav-text">Operator Precedence Differences</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Unexported-Structure-Fields-Are-Not-Encoded"><span class="nav-number">1.3.33.</span> <span class="nav-text">Unexported Structure Fields Are Not Encoded</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#App-Exits-With-Active-Goroutines"><span class="nav-number">1.3.34.</span> <span class="nav-text">App Exits With Active Goroutines</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Sending-to-an-Unbuffered-Channel-Returns-As-Soon-As-the-Target-Receiver-Is-Ready"><span class="nav-number">1.3.35.</span> <span class="nav-text">Sending to an Unbuffered Channel Returns As Soon As the Target Receiver Is Ready</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Use-time-NewTimer-instead-of-time-After"><span class="nav-number">1.3.36.</span> <span class="nav-text">Use time.NewTimer instead of time.After</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Sending-to-an-Closed-Channel-Causes-a-Panic"><span class="nav-number">1.3.37.</span> <span class="nav-text">Sending to an Closed Channel Causes a Panic</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Using-“nil”-Channels"><span class="nav-number">1.3.38.</span> <span class="nav-text">Using “nil” Channels</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Methods-with-Value-Receivers-Can’t-Change-the-Original-Value"><span class="nav-number">1.3.39.</span> <span class="nav-text">Methods with Value Receivers Can’t Change the Original Value</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Closing-HTTP-Response-Body"><span class="nav-number">1.3.40.</span> <span class="nav-text">Closing HTTP Response Body</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Closing-HTTP-Connections"><span class="nav-number">1.3.41.</span> <span class="nav-text">Closing HTTP Connections</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Unmarshalling-JSON-Numbers-into-Interface-Values"><span class="nav-number">1.3.42.</span> <span class="nav-text">Unmarshalling JSON Numbers into Interface Values</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Comparing-Structs-Arrays-Slices-and-Maps"><span class="nav-number">1.3.43.</span> <span class="nav-text">Comparing Structs, Arrays, Slices, and Maps</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Recovering-From-a-Panic"><span class="nav-number">1.3.44.</span> <span class="nav-text">Recovering From a Panic</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Updating-and-Referencing-Item-Values-in-Slice-Array-and-Map-“range”-Clauses"><span class="nav-number">1.3.45.</span> <span class="nav-text">Updating and Referencing Item Values in Slice, Array, and Map “range” Clauses</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#“Hidden”-Data-in-Slices"><span class="nav-number">1.3.46.</span> <span class="nav-text">“Hidden” Data in Slices</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Slice-Data-“Corruption”"><span class="nav-number">1.3.47.</span> <span class="nav-text">Slice Data “Corruption”</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#“Stale”-Slices"><span class="nav-number">1.3.48.</span> <span class="nav-text">“Stale” Slices</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Type-Declarations-and-Methods"><span class="nav-number">1.3.49.</span> <span class="nav-text">Type Declarations and Methods</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Breaking-Out-of-“for-switch”-and-“for-select”-Code-Blocks"><span class="nav-number">1.3.50.</span> <span class="nav-text">Breaking Out of “for switch” and “for select” Code Blocks</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Iteration-Variables-and-Closures-in-“for”-Statements"><span class="nav-number">1.3.51.</span> <span class="nav-text">Iteration Variables and Closures in “for” Statements</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Deferred-Function-Call-Argument-Evaluation"><span class="nav-number">1.3.52.</span> <span class="nav-text">Deferred Function Call Argument Evaluation</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Deferred-Function-Call-Execution"><span class="nav-number">1.3.53.</span> <span class="nav-text">Deferred Function Call Execution</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Failed-Type-Assertions"><span class="nav-number">1.3.54.</span> <span class="nav-text">Failed Type Assertions</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Blocked-Goroutines-and-Resource-Leaks"><span class="nav-number">1.3.55.</span> <span class="nav-text">Blocked Goroutines and Resource Leaks</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Using-Pointer-Receiver-Methods-On-Value-Instances"><span class="nav-number">1.3.56.</span> <span class="nav-text">Using Pointer Receiver Methods On Value Instances</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Updating-Map-Value-Fields"><span class="nav-number">1.3.57.</span> <span class="nav-text">Updating Map Value Fields</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#“nil”-Interfaces-and-“nil”-Interfaces-Values"><span class="nav-number">1.3.58.</span> <span class="nav-text">“nil” Interfaces and “nil” Interfaces Values</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Stack-and-Heap-Variables"><span class="nav-number">1.3.59.</span> <span class="nav-text">Stack and Heap Variables</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GOMAXPROCS-Concurrency-and-Parallelism"><span class="nav-number">1.3.60.</span> <span class="nav-text">GOMAXPROCS, Concurrency, and Parallelism</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Read-and-Write-Operation-Reordering"><span class="nav-number">1.3.61.</span> <span class="nav-text">Read and Write Operation Reordering</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Preemptive-Scheduling"><span class="nav-number">1.3.62.</span> <span class="nav-text">Preemptive Scheduling</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#参考文档"><span class="nav-number">1.3.63.</span> <span class="nav-text">参考文档</span></a></li></ol></li></ol></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Feisky</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.0.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.2"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.2"></script>



  



  




  
  
  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
       search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body").append('<div class="popoverlay">').css('overflow', 'hidden');
      $('.popup').toggle();

    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
    'use strict';
    $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
            // get the contents from search data
            isfetched = true;
            $('.popup').detach().appendTo('.header-inner');
            var datas = $( "entry", xmlResponse ).map(function() {
                return {
                    title: $( "title", this ).text(),
                    content: $("content",this).text(),
                    url: $( "url" , this).text()
                };
            }).get();
            var $input = document.getElementById(search_id);
            var $resultContent = document.getElementById(content_id);
            $input.addEventListener('input', function(){
                var matchcounts = 0;
                var str='<ul class=\"search-result-list\">';
                var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                $resultContent.innerHTML = "";
                if (this.value.trim().length > 1) {
                // perform local searching
                datas.forEach(function(data) {
                    var isMatch = false;
                    var content_index = [];
                    var data_title = data.title.trim().toLowerCase();
                    var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                    var data_url = decodeURIComponent(data.url);
                    var index_title = -1;
                    var index_content = -1;
                    var first_occur = -1;
                    // only match artiles with not empty titles and contents
                    if(data_title != '') {
                        keywords.forEach(function(keyword, i) {
                            index_title = data_title.indexOf(keyword);
                            index_content = data_content.indexOf(keyword);
                            if( index_title >= 0 || index_content >= 0 ){
                                isMatch = true;
								if (i == 0) {
                                    first_occur = index_content;
                                }
                            } 
							
                        });
                    }
                    // show search results
                    if (isMatch) {
                        matchcounts += 1;
                        str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                        var content = data.content.trim().replace(/<[^>]+>/g,"");
                        if (first_occur >= 0) {
                            // cut out 100 characters
                            var start = first_occur - 20;
                            var end = first_occur + 80;
                            if(start < 0){
                                start = 0;
                            }
                            if(start == 0){
                                end = 50;
                            }
                            if(end > content.length){
                                end = content.length;
                            }
                            var match_content = content.substring(start, end);
                            // highlight all keywords
                            keywords.forEach(function(keyword){
                                var regS = new RegExp(keyword, "gi");
                                match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                            });

                            str += "<p class=\"search-result\">" + match_content +"...</p>"
                        }
                        str += "</li>";
                    }
                })};
                str += "</ul>";
                if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
                if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
                $resultContent.innerHTML = str;
            });
            proceedsearch();
        }
    });}

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };

    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".popoverlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>


  
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
  </script>

  <script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for (i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
      }
    });
  </script>
  <script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>


  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->


  


</body>
</html>
