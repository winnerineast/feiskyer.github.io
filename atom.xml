<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Feisky&#39;s Blog</title>
  <subtitle>Notes about anything.</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://feisky.xyz/"/>
  <updated>2016-12-15T00:14:54.373Z</updated>
  <id>http://feisky.xyz/</id>
  
  <author>
    <name>Feisky</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Kubernetes v1.5.0 release</title>
    <link href="http://feisky.xyz/2016/12/13/Kubernetes-v1-5-0-release/"/>
    <id>http://feisky.xyz/2016/12/13/Kubernetes-v1-5-0-release/</id>
    <published>2016-12-13T03:51:29.000Z</published>
    <updated>2016-12-15T00:14:54.373Z</updated>
    
    <content type="html"><![CDATA[<p><strong>Update on 2016.12.14:</strong></p>
<p>Due to a serious security problem, kubernetes v1.5.0 is not recommanded. Kubernetes v1.5.1 has just released, so we should upgrade to v1.5.1 directly.</p>
<blockquote>
<p>The <code>--anonymous-auth=</code> flag in v1.5.0 is true by default (which may result in any users being able to access kubernetes API), but v1.5.1 turns it to false.</p>
</blockquote>
<h2 id="Kubernetes-v1-5-0"><a href="#Kubernetes-v1-5-0" class="headerlink" title="Kubernetes v1.5.0"></a>Kubernetes v1.5.0</h2><ul>
<li>StatefulSets (ex-PetSets)<ul>
<li>StatefulSets are beta now (fixes and stabilization)</li>
</ul>
</li>
<li>Improved Federation Support<ul>
<li>New command: <code>kubefed</code></li>
<li>DaemonSets</li>
<li>Deployments</li>
<li>ConfigMaps</li>
</ul>
</li>
<li>Simplified Cluster Deployment<ul>
<li>Improvements to <code>kubeadm</code></li>
<li>HA Setup for Master</li>
</ul>
</li>
<li>Node Robustness and Extensibility<ul>
<li>Windows Server Container support</li>
<li>CRI for pluggable container runtimes</li>
<li><code>kubelet</code> API supports authentication and authorization</li>
</ul>
</li>
</ul>
<h2 id="Features"><a href="#Features" class="headerlink" title="Features"></a>Features</h2><p>Features for this release were tracked via the use of the <a href="https://github.com/kubernetes/features" target="_blank" rel="external">kubernetes/features</a> issues repo.  Each Feature issue is owned by a Special Interest Group from <a href="https://github.com/kubernetes/community" target="_blank" rel="external">kubernetes/community</a></p>
<ul>
<li><strong>API Machinery</strong><ul>
<li>[beta] <code>kube-apiserver</code> support for the OpenAPI spec is moving from alpha to beta. The first <a href="https://github.com/kubernetes-incubator/client-python" target="_blank" rel="external">non-go client</a> is based on it (<a href="https://github.com/kubernetes/features/issues/53" target="_blank" rel="external">kubernetes/features#53</a>)</li>
</ul>
</li>
<li><strong>Apps</strong><ul>
<li>[stable] When replica sets cannot create pods, they will now report detail via the API about the underlying reason (<a href="https://github.com/kubernetes/features/issues/120" target="_blank" rel="external">kubernetes/features#120</a>)</li>
<li>[stable] <code>kubectl apply</code> is now able to delete resources you no longer need with <code>--prune</code> (<a href="https://github.com/kubernetes/features/issues/128" target="_blank" rel="external">kubernetes/features#128</a>)</li>
<li>[beta] Deployments that cannot make progress in rolling out the newest version will now indicate via the API they are blocked (<a href="http://kubernetes.io/docs/user-guide/deployments/#failed-deployment" target="_blank" rel="external">docs</a>) (<a href="https://github.com/kubernetes/features/issues/122" target="_blank" rel="external">kubernetes/features#122</a>)</li>
<li>[beta] StatefulSets allow workloads that require persistent identity or per-instance storage to be created and managed on Kubernetes. (<a href="http://kubernetes.io/docs/concepts/abstractions/controllers/statefulsets/" target="_blank" rel="external">docs</a>) (<a href="https://github.com/kubernetes/features/issues/137" target="_blank" rel="external">kubernetes/features#137</a>)</li>
<li>[beta] In order to preserve safety guarantees the cluster no longer force deletes pods on un-responsive nodes and users are now warned if they try to force delete pods via the CLI. (<a href="http://kubernetes.io/docs/tasks/manage-stateful-set/scale-stateful-set/" target="_blank" rel="external">docs</a>) (<a href="https://github.com/kubernetes/features/issues/119" target="_blank" rel="external">kubernetes/features#119</a>)</li>
</ul>
</li>
<li><strong>Auth</strong><ul>
<li>[alpha] Further polishing of the Role-based access control alpha API including a default set of cluster roles. (<a href="http://kubernetes.io/docs/admin/authorization/" target="_blank" rel="external">docs</a>) (<a href="https://github.com/kubernetes/features/issues/2" target="_blank" rel="external">kubernetes/features#2</a>)</li>
<li>[beta] Added ability to authenticate/authorize access to the Kubelet API (<a href="http://kubernetes.io/docs/admin/kubelet-authentication-authorization/" target="_blank" rel="external">docs</a>) (<a href="https://github.com/kubernetes/features/issues/89" target="_blank" rel="external">kubernetes/features#89</a>)</li>
</ul>
</li>
<li><strong>AWS</strong><ul>
<li>[stable] Roles should appear in kubectl get nodes (<a href="https://github.com/kubernetes/features/issues/113" target="_blank" rel="external">kubernetes/features#113</a>)</li>
</ul>
</li>
<li><strong>Cluster Lifecycle</strong><ul>
<li>[alpha] Improved UX and usability for the kubeadm binary that makes it easy to get a new cluster running. (<a href="http://kubernetes.io/docs/getting-started-guides/kubeadm/" target="_blank" rel="external">docs</a>) (<a href="https://github.com/kubernetes/features/issues/11" target="_blank" rel="external">kubernetes/features#11</a>)</li>
</ul>
</li>
<li><strong>Cluster Ops</strong><ul>
<li>[alpha] Added ability to create/remove clusters w/highly available (replicated) masters on GCE using kube-up/kube-down scripts. (<a href="http://kubernetes.io/docs/admin/ha-master-gce/" target="_blank" rel="external">docs</a>) (<a href="https://github.com/kubernetes/features/issues/48" target="_blank" rel="external">kubernetes/features#48</a>)</li>
</ul>
</li>
<li><strong>Federation</strong><ul>
<li>[alpha] Support for ConfigMaps in federation. (<a href="http://kubernetes.io/docs/user-guide/federation/configmap/" target="_blank" rel="external">docs</a>) (<a href="https://github.com/kubernetes/features/issues/105" target="_blank" rel="external">kubernetes/features#105</a>)</li>
<li>[alpha] Alpha level support for DaemonSets in federation. (<a href="http://kubernetes.io/docs/user-guide/federation/daemonsets/" target="_blank" rel="external">docs</a>) (<a href="https://github.com/kubernetes/features/issues/101" target="_blank" rel="external">kubernetes/features#101</a>)</li>
<li>[alpha] Alpha level support for Deployments in federation. (<a href="http://kubernetes.io/docs/user-guide/federation/deployment/" target="_blank" rel="external">docs</a>) (<a href="https://github.com/kubernetes/features/issues/100" target="_blank" rel="external">kubernetes/features#100</a>)</li>
<li>[alpha] Cluster federation: Added support for DeleteOptions.OrphanDependents for federation resources. (<a href="http://kubernetes.io/docs/user-guide/federation/#cascading-deletion" target="_blank" rel="external">docs</a>) (<a href="https://github.com/kubernetes/features/issues/99" target="_blank" rel="external">kubernetes/features#99</a>)</li>
<li>[alpha] Introducing <code>kubefed</code>, a new command line tool to simplify federation control plane kubernetes.io/docs/admin/federation/kubefed/)) (<a href="https://github.com/kubernetes/features/issues/97" target="_blank" rel="external">kubernetes/features#97</a>)</li>
</ul>
</li>
<li><strong>Network</strong><ul>
<li>[stable] Services can reference another service by DNS name, rather than being hosted in pods (<a href="https://github.com/kubernetes/features/issues/33" target="_blank" rel="external">kubernetes/features#33</a>)</li>
<li>[beta] Opt in source ip preservation for Services with Type NodePort or LoadBalancer (<a href="http://kubernetes.io/docs/tutorials/services/source-ip/" target="_blank" rel="external">docs</a>) (<a href="https://github.com/kubernetes/features/issues/27" target="_blank" rel="external">kubernetes/features#27</a>)</li>
<li>[stable] Enable DNS Horizontal Autoscaling with beta ConfigMap parameters support (<a href="http://kubernetes.io/docs/tasks/administer-cluster/dns-horizontal-autoscaling/" target="_blank" rel="external">docs</a>)</li>
</ul>
</li>
<li><strong>Node</strong><ul>
<li>[alpha] Added ability to preserve access to host userns when userns remapping is enabled in container runtime (<a href="https://github.com/kubernetes/features/issues/127" target="_blank" rel="external">kubernetes/features#127</a>)</li>
<li>[alpha] Introducing the v1alpha1 CRI API to allow pluggable container runtimes; an experimental docker-CRI integration is ready for testing and feedback. (<a href="https://github.com/kubernetes/community/blob/master/contributors/devel/container-runtime-interface.md" target="_blank" rel="external">docs</a>) (<a href="https://github.com/kubernetes/features/issues/54" target="_blank" rel="external">kubernetes/features#54</a>)</li>
<li>[alpha] Kubelet launches container in a per pod cgroup hiearchy based on quality of service tier (<a href="https://github.com/kubernetes/features/issues/126" target="_blank" rel="external">kubernetes/features#126</a>)</li>
<li>[beta] Kubelet integrates with memcg notification API to detect when a hard eviction threshold is crossed (<a href="https://github.com/kubernetes/features/issues/125" target="_blank" rel="external">kubernetes/features#125</a>)</li>
<li>[beta] Introducing the beta version containerized node conformance test gcr.io/google_containers/node-test:0.2 for users to verify node setup. (<a href="http://kubernetes.io/docs/admin/node-conformance/" target="_blank" rel="external">docs</a>) (<a href="https://github.com/kubernetes/features/issues/84" target="_blank" rel="external">kubernetes/features#84</a>)</li>
</ul>
</li>
<li><strong>Scheduling</strong><ul>
<li>[alpha] Added support for accounting opaque integer resources. (<a href="http://kubernetes.io/docs/user-guide/compute-resources/#opaque-integer-resources-alpha-feature" target="_blank" rel="external">docs</a>) (<a href="https://github.com/kubernetes/features/issues/76" target="_blank" rel="external">kubernetes/features#76</a>)</li>
<li>[beta] PodDisruptionBudget has been promoted to beta, can be used to safely drain nodes while respecting application SLOâ€™s (<a href="http://kubernetes.io/docs/tasks/administer-cluster/safely-drain-node/" target="_blank" rel="external">docs</a>) (<a href="https://github.com/kubernetes/features/issues/85" target="_blank" rel="external">kubernetes/features#85</a>)</li>
</ul>
</li>
<li><strong>UI</strong><ul>
<li>[stable] Dashboard UI now shows all user facing objects and their resource usage. (<a href="http://kubernetes.io/docs/user-guide/ui/" target="_blank" rel="external">docs</a>) (<a href="https://github.com/kubernetes/features/issues/136" target="_blank" rel="external">kubernetes/features#136</a>)</li>
</ul>
</li>
<li><strong>Windows</strong><ul>
<li>[alpha] Added support for Windows Server 2016 nodes and scheduling Windows Server Containers (<a href="http://kubernetes.io/docs/getting-started-guides/windows/" target="_blank" rel="external">docs</a>) (<a href="https://github.com/kubernetes/features/issues/116" target="_blank" rel="external">kubernetes/features#116</a>)</li>
</ul>
</li>
</ul>
<h2 id="Known-Issues"><a href="#Known-Issues" class="headerlink" title="Known Issues"></a>Known Issues</h2><p>Populated via <a href="https://github.com/kubernetes/kubernetes/issues/37134" target="_blank" rel="external">v1.5.0 known issues / FAQ accumulator</a></p>
<ul>
<li>CRI <a href="https://github.com/kubernetes/community/blob/master/contributors/devel/container-runtime-interface.md#kubernetes-v15-release-cri-v1alpha1" target="_blank" rel="external">known issues and<br>limitations</a></li>
<li>getDeviceNameFromMount() function doesnâ€™t return the volume path correctly when the volume path contains spaces <a href="https://github.com/kubernetes/kubernetes/issues/37712" target="_blank" rel="external"><a href="https://github.com/kubernetes/kubernetes/pull/37712" target="_blank" rel="external">#37712</a></a></li>
<li>Federation alpha features do not have feature gates defined and<br>are hence enabled by default. This will be fixed in a future release.<br><a href="https://github.com/kubernetes/kubernetes/issues/38593" target="_blank" rel="external"><a href="https://github.com/kubernetes/kubernetes/pull/38593" target="_blank" rel="external">#38593</a></a></li>
<li>Federation control plane can be upgraded by updating the image<br>fields in the <code>Deployment</code> specs of the control plane components.<br>However, federation control plane upgrades were not tested in this<br>release <a href="https://github.com/kubernetes/kubernetes/issues/38537" target="_blank" rel="external">38537</a></li>
</ul>
<h2 id="Notable-Changes-to-Existing-Behavior"><a href="#Notable-Changes-to-Existing-Behavior" class="headerlink" title="Notable Changes to Existing Behavior"></a>Notable Changes to Existing Behavior</h2><ul>
<li>Node controller no longer force-deletes pods from the api-server. (<a href="https://github.com/kubernetes/kubernetes/pull/35235" target="_blank" rel="external"><a href="https://github.com/kubernetes/kubernetes/pull/35235" target="_blank" rel="external">#35235</a></a>, <a href="https://github.com/foxish" target="_blank" rel="external"><a href="https://github.com/foxish" target="_blank" rel="external">@foxish</a></a>)<ul>
<li>For StatefulSet (previously PetSet), this change means creation of<br>replacement pods is blocked until old pods are definitely not running<br>(indicated either by the kubelet returning from partitioned state,<br>deletion of the Node object, deletion of the instance in the cloud provider,<br>or force deletion of the pod from the api-server).<br>This helps prevent â€œsplit brainâ€ scenarios in clustered applications by<br>ensuring that unreachable pods will not be presumed dead unless some<br>â€œfencingâ€ operation has provided one of the above indications.</li>
<li>For all other existing controllers except StatefulSet, this has no effect on<br>the ability of the controller to replace pods because the controllers do not<br>reuse pod names (they use generate-name).</li>
<li>User-written controllers that reuse names of pod objects should evaluate this change.</li>
<li>When deleting an object with <code>kubectl delete ... --grace-period=0</code>, the client will<br>begin a graceful deletion and wait until the resource is fully deleted.  To force<br>deletion immediately, use the <code>--force</code> flag. This prevents users from accidentally<br>allowing two Stateful Set pods to share the same persistent volume which could lead to data<br>corruption <a href="https://github.com/kubernetes/kubernetes/pull/37263" target="_blank" rel="external"><a href="https://github.com/kubernetes/kubernetes/pull/37263" target="_blank" rel="external">#37263</a></a></li>
</ul>
</li>
</ul>
<ul>
<li><p>Allow anonymous API server access, decorate authenticated users with system:authenticated group (<a href="https://github.com/kubernetes/kubernetes/pull/32386" target="_blank" rel="external"><a href="https://github.com/kubernetes/kubernetes/pull/32386" target="_blank" rel="external">#32386</a></a>, <a href="https://github.com/liggitt" target="_blank" rel="external"><a href="https://github.com/liggitt" target="_blank" rel="external">@liggitt</a></a>)</p>
<ul>
<li>kube-apiserver learned the â€˜â€”anonymous-authâ€™ flag, which defaults to true. When enabled, requests to the secure port that are not rejected by other configured authentication methods are treated as anonymous requests, and given a username of â€˜system:anonymousâ€™ and a group of â€˜system:unauthenticatedâ€™.</li>
<li>Authenticated users are decorated with a â€˜system:authenticatedâ€™ group.</li>
<li>NOTE: anonymous access is enabled by default. If you rely on authentication alone to authorize access, change to use an authorization mode other than AlwaysAllow, or or set â€˜â€”anonymous-auth=falseâ€™.</li>
</ul>
</li>
<li><p>kubectl get -o jsonpath=â€¦ will now throw an error if the path is to a field not present in the json, even if the path is for a field valid for the type.  This is a change from the pre-1.5 behavior, which would return the default value for some fields even if they were not present in the json. (<a href="https://github.com/kubernetes/kubernetes/issues/37991" target="_blank" rel="external"><a href="https://github.com/kubernetes/kubernetes/pull/37991" target="_blank" rel="external">#37991</a></a>, <a href="http://github.com/pwittrock" target="_blank" rel="external"><a href="https://github.com/pwittrock" target="_blank" rel="external">@pwittrock</a></a>)</p>
</li>
<li><p>The strategicmerge patchMergeKey for VolumeMounts was changed from â€œnameâ€ to â€œmountPathâ€.  This was necessary because the name field refers to the name of the Volume, and is not a unique key for the VolumeMount.  Multiple VolumeMounts will have the same Volume name if mounting the same volume more than once.  The â€œmountPathâ€ is verified to be unique and can act as the mergekey.  (<a href="https://github.coma/kubernetes/kubernetes/pull/35071" target="_blank" rel="external"><a href="https://github.com/kubernetes/kubernetes/pull/35071" target="_blank" rel="external">#35071</a></a>, <a href="http://github.com/pwittrock" target="_blank" rel="external"><a href="https://github.com/pwittrock" target="_blank" rel="external">@pwittrock</a></a>)</p>
</li>
</ul>
<h2 id="Deprecations"><a href="#Deprecations" class="headerlink" title="Deprecations"></a>Deprecations</h2><ul>
<li>extensions/v1beta1.Jobs is deprecated, use batch/v1.Job instead (<a href="https://github.com/kubernetes/kubernetes/pull/36355" target="_blank" rel="external"><a href="https://github.com/kubernetes/kubernetes/pull/36355" target="_blank" rel="external">#36355</a></a>, <a href="https://github.com/soltysh" target="_blank" rel="external"><a href="https://github.com/soltysh" target="_blank" rel="external">@soltysh</a></a>)</li>
<li>The kubelet â€”reconcile-cdir flag is deprecated because it has no function anymore. (<a href="https://github.com/kubernetes/kubernetes/pull/35523" target="_blank" rel="external"><a href="https://github.com/kubernetes/kubernetes/pull/35523" target="_blank" rel="external">#35523</a></a>, <a href="https://github.com/luxas" target="_blank" rel="external"><a href="https://github.com/luxas" target="_blank" rel="external">@luxas</a></a>)</li>
<li>Notice of deprecation for recycler <a href="https://github.com/kubernetes/kubernetes/pull/36760" target="_blank" rel="external"><a href="https://github.com/kubernetes/kubernetes/pull/36760" target="_blank" rel="external">#36760</a></a></li>
</ul>
<h2 id="Action-Required-Before-Upgrading"><a href="#Action-Required-Before-Upgrading" class="headerlink" title="Action Required Before Upgrading"></a>Action Required Before Upgrading</h2><ul>
<li>batch/v2alpha1.ScheduledJob has been renamed, use batch/v2alpha1.CronJob instead (<a href="https://github.com/kubernetes/kubernetes/pull/36021" target="_blank" rel="external"><a href="https://github.com/kubernetes/kubernetes/pull/36021" target="_blank" rel="external">#36021</a></a>, <a href="https://github.com/soltysh" target="_blank" rel="external"><a href="https://github.com/soltysh" target="_blank" rel="external">@soltysh</a></a>)</li>
<li>PetSet has been renamed to StatefulSet.<br>If you have existing PetSets, <strong>you must perform extra migration steps</strong> both<br>before and after upgrading to convert them to StatefulSets. (<a href="http://kubernetes.io/docs/tasks/manage-stateful-set/upgrade-pet-set-to-stateful-set/" target="_blank" rel="external">docs</a>) (<a href="https://github.com/kubernetes/kubernetes/pull/35663" target="_blank" rel="external"><a href="https://github.com/kubernetes/kubernetes/pull/35663" target="_blank" rel="external">#35663</a></a>, <a href="https://github.com/janetkuo" target="_blank" rel="external"><a href="https://github.com/janetkuo" target="_blank" rel="external">@janetkuo</a></a>)</li>
<li>If you are upgrading your Cluster Federation components from v1.4.x, please update your <code>federation-apiserver</code> and <code>federation-controller-manager</code> manifests to the new version (<a href="https://github.com/kubernetes/kubernetes/pull/30601" target="_blank" rel="external"><a href="https://github.com/kubernetes/kubernetes/pull/30601" target="_blank" rel="external">#30601</a></a>, <a href="https://github.com/madhusudancs" target="_blank" rel="external"><a href="https://github.com/madhusudancs" target="_blank" rel="external">@madhusudancs</a></a>)</li>
<li>The deprecated kubelet â€”configure-cbr0 flag has been removed, and with that the â€œclassicâ€ networking mode as well.  If you depend on this mode, please investigate whether the other network plugins <code>kubenet</code> or <code>cni</code> meet your needs. (<a href="https://github.com/kubernetes/kubernetes/pull/34906" target="_blank" rel="external"><a href="https://github.com/kubernetes/kubernetes/pull/34906" target="_blank" rel="external">#34906</a></a>, <a href="https://github.com/luxas" target="_blank" rel="external"><a href="https://github.com/luxas" target="_blank" rel="external">@luxas</a></a>)</li>
<li>New client-go structure, refer to kubernetes/client-go for versioning policy (<a href="https://github.com/kubernetes/kubernetes/pull/34989" target="_blank" rel="external"><a href="https://github.com/kubernetes/kubernetes/pull/34989" target="_blank" rel="external">#34989</a></a>, <a href="https://github.com/caesarxuchao" target="_blank" rel="external"><a href="https://github.com/caesarxuchao" target="_blank" rel="external">@caesarxuchao</a></a>)</li>
<li>The deprecated kube-scheduler â€”bind-pods-qps and â€”bind-pods burst flags have been removed, use â€”kube-api-qps and â€”kube-api-burst instead (<a href="https://github.com/kubernetes/kubernetes/pull/34471" target="_blank" rel="external"><a href="https://github.com/kubernetes/kubernetes/pull/34471" target="_blank" rel="external">#34471</a></a>, <a href="https://github.com/timothysc" target="_blank" rel="external"><a href="https://github.com/timothysc" target="_blank" rel="external">@timothysc</a></a>)</li>
<li>If you used the <a href="http://kubernetes.io/docs/admin/disruptions/" target="_blank" rel="external">PodDisruptionBudget</a> feature in 1.4 (i.e. created <code>PodDisruptionBudget</code> objects), then <strong>BEFORE</strong>  upgrading from 1.4 to 1.5, you must delete all <code>PodDisruptionBudget</code> objects (<code>policy/v1alpha1/PodDisruptionBudget</code>) that you have created. It is not possible to delete these objects after you upgrade, and their presence will prevent you from using the beta PodDisruptionBudget feature in 1.5 (which uses <code>policy/v1beta1/PodDisruptionBudget</code>). If you have already upgraded, you will need to downgrade the master to 1.4 to delete the <code>policy/v1alpha1/PodDisruptionBudget</code> objects.</li>
</ul>
<h2 id="External-Dependency-Version-Information"><a href="#External-Dependency-Version-Information" class="headerlink" title="External Dependency Version Information"></a>External Dependency Version Information</h2><p>Continuous integration builds have used the following versions of external dependencies, however, this is not a strong recommendation and users should consult an appropriate installation or upgrade guide before deciding what versions of etcd, docker or rkt to use.</p>
<ul>
<li>Docker versions 1.10.3 - 1.12.3<ul>
<li>Docker version 1.11.2 known issues<ul>
<li>Kernel crash with Aufs storage driver on Debian Jessie (<a href="https://github.com/kubernetes/kubernetes/issues/27885" target="_blank" rel="external"><a href="https://github.com/kubernetes/kubernetes/pull/27885" target="_blank" rel="external">#27885</a></a>)<br>which can be identified by the <a href="http://kubernetes.io/docs/admin/node-problem/" target="_blank" rel="external">node problem detector</a></li>
<li>Leaked File descriptors (<a href="https://github.com/docker/containerd/issues/275" target="_blank" rel="external">#275</a>)</li>
<li>Additional memory overhead per container (<a href="https://github.com/docker/docker/issues/21737" target="_blank" rel="external"><a href="https://github.com/kubernetes/kubernetes/pull/21737" target="_blank" rel="external">#21737</a></a>)</li>
</ul>
</li>
<li>Docker version 1.12.1 <a href="https://github.com/kubernetes/kubernetes/issues/28698" target="_blank" rel="external">has been validated</a> through the Kubernetes docker automated validation framework as has Docker version 1.12.3</li>
<li>Docker 1.10.3 contains <a href="https://github.com/docker/docker/compare/v1.10.3...runcom:docker-1.10.3-stable" target="_blank" rel="external">backports provided by RedHat</a> for known issues</li>
<li>Docker versions as old as may 1.9.1 work with <a href="CHANGELOG.md#191">known issues</a> but this is not guaranteed</li>
</ul>
</li>
<li>rkt version 1.21.0<ul>
<li>known issues with the rkt runtime are <a href="http://kubernetes.io/docs/getting-started-guides/rkt/notes/" target="_blank" rel="external">listed here</a></li>
</ul>
</li>
<li><p>etcd version 2.2.1</p>
<ul>
<li>etcd version 3.0.14 <a href="https://k8s-gubernator.appspot.com/builds/kubernetes-jenkins/logs/ci-kubernetes-e2e-gce-etcd3/" target="_blank" rel="external">has also been validated</a> but does require <a href="https://coreos.com/blog/migrating-applications-etcd-v3.html" target="_blank" rel="external">specific configuration steps</a></li>
</ul>
<p><a href="https://docs.k8s.io" target="_blank" rel="external">Documentation</a> &amp; <a href="https://releases.k8s.io/release-1.5/examples" target="_blank" rel="external">Examples</a></p>
<h2 id="Downloads-for-v1-5-0"><a href="#Downloads-for-v1-5-0" class="headerlink" title="Downloads for v1.5.0"></a>Downloads for v1.5.0</h2></li>
</ul>
<div class="table-container">
<table>
<thead>
<tr>
<th>filename</th>
<th>sha256 hash</th>
</tr>
</thead>
<tbody>
<tr>
<td>  <a href="https://dl.k8s.io/v1.5.0/kubernetes.tar.gz" target="_blank" rel="external">kubernetes.tar.gz</a></td>
<td><code>52b7df98ea05fb3ebbababf1ccb7f6d4e6f4cad00b8d09350f270aa7e3ad7e85</code></td>
</tr>
<tr>
<td>  <a href="https://dl.k8s.io/v1.5.0/kubernetes-src.tar.gz" target="_blank" rel="external">kubernetes-src.tar.gz</a></td>
<td><code>fbefb2544667f96045c346cee595b0f315282dfdbd41a8f2d5ccc74054a4078e</code></td>
</tr>
</tbody>
</table>
</div>
<h3 id="Client-Binaries"><a href="#Client-Binaries" class="headerlink" title="Client Binaries"></a>Client Binaries</h3><div class="table-container">
<table>
<thead>
<tr>
<th>filename</th>
<th>sha256 hash</th>
</tr>
</thead>
<tbody>
<tr>
<td>  <a href="https://dl.k8s.io/v1.5.0/kubernetes-client-darwin-386.tar.gz" target="_blank" rel="external">kubernetes-client-darwin-386.tar.gz</a></td>
<td><code>27d71bb6b16a26387ee30272bd4ee5758deccafafdc91b38f3d0dc19a34e129e</code></td>
</tr>
<tr>
<td>  <a href="https://dl.k8s.io/v1.5.0/kubernetes-client-darwin-amd64.tar.gz" target="_blank" rel="external">kubernetes-client-darwin-amd64.tar.gz</a></td>
<td><code>5fa8550235919568d7d839b19de00e9bdd72a97cfde21dbdbe07fefd6d6290dc</code></td>
</tr>
<tr>
<td>  <a href="https://dl.k8s.io/v1.5.0/kubernetes-client-linux-386.tar.gz" target="_blank" rel="external">kubernetes-client-linux-386.tar.gz</a></td>
<td><code>032a17701c014b8bbbb83c7da1046d8992a41031628cf7e1959a94378f5f195b</code></td>
</tr>
<tr>
<td>  <a href="https://dl.k8s.io/v1.5.0/kubernetes-client-linux-amd64.tar.gz" target="_blank" rel="external">kubernetes-client-linux-amd64.tar.gz</a></td>
<td><code>afae4fadb7bbb1532967f88fef1de6458abda17219f634cc2c41608fd83ae7f6</code></td>
</tr>
<tr>
<td>  <a href="https://dl.k8s.io/v1.5.0/kubernetes-client-linux-arm64.tar.gz" target="_blank" rel="external">kubernetes-client-linux-arm64.tar.gz</a></td>
<td><code>acca7607dae678a0165b7e10685e0eff0d418beebe7c25eaffe18c85717b5cc4</code></td>
</tr>
<tr>
<td>  <a href="https://dl.k8s.io/v1.5.0/kubernetes-client-linux-arm.tar.gz" target="_blank" rel="external">kubernetes-client-linux-arm.tar.gz</a></td>
<td><code>fbc182b6d9ae476c7c509486d773074fd1007032886a8177735e08010c43f89d</code></td>
</tr>
<tr>
<td>  <a href="https://dl.k8s.io/v1.5.0/kubernetes-client-windows-386.tar.gz" target="_blank" rel="external">kubernetes-client-windows-386.tar.gz</a></td>
<td><code>a8ddea329bc8d57267294464c163d8c2f7837f6353f8c685271864ed8b8bc54d</code></td>
</tr>
<tr>
<td>  <a href="https://dl.k8s.io/v1.5.0/kubernetes-client-windows-amd64.tar.gz" target="_blank" rel="external">kubernetes-client-windows-amd64.tar.gz</a></td>
<td><code>bc3a76f1414fa1f4b2fb92732de2100d346edb7b870ed5414ea062bb401a8ebd</code></td>
</tr>
</tbody>
</table>
</div>
<h3 id="Server-Binaries"><a href="#Server-Binaries" class="headerlink" title="Server Binaries"></a>Server Binaries</h3><div class="table-container">
<table>
<thead>
<tr>
<th>filename</th>
<th>sha256 hash</th>
</tr>
</thead>
<tbody>
<tr>
<td>  <a href="https://dl.k8s.io/v1.5.0/kubernetes-server-linux-amd64.tar.gz" target="_blank" rel="external">kubernetes-server-linux-amd64.tar.gz</a></td>
<td><code>b9c122d709c0556c1e19d31d98bf26ee530f91c0119f4454fb930cef5a0c1aa7</code></td>
</tr>
<tr>
<td>  <a href="https://dl.k8s.io/v1.5.0/kubernetes-server-linux-arm64.tar.gz" target="_blank" rel="external">kubernetes-server-linux-arm64.tar.gz</a></td>
<td><code>3bbba5c8dedc47db8f9ebdfac5468398cce2470617de9d550affef9702b724c9</code></td>
</tr>
<tr>
<td>  <a href="https://dl.k8s.io/v1.5.0/kubernetes-server-linux-arm.tar.gz" target="_blank" rel="external">kubernetes-server-linux-arm.tar.gz</a></td>
<td><code>3ff9ccdd641690fd1c8878408cd369beca1f9f8b212198e251862d40cf2dadc0</code></td>
</tr>
</tbody>
</table>
</div>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;Update on 2016.12.14:&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Due to a serious security problem, kubernetes v1.5.0 is not recommanded. Kubernetes v1.5.1 
    
    </summary>
    
    
      <category term="kubernetes" scheme="http://feisky.xyz/tags/kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Weekly reading list</title>
    <link href="http://feisky.xyz/2016/12/08/Weekly-reading-list/"/>
    <id>http://feisky.xyz/2016/12/08/Weekly-reading-list/</id>
    <published>2016-12-08T06:00:22.000Z</published>
    <updated>2016-12-15T00:14:54.373Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Dockeræ”¶è´­Infinit-PDF"><a href="#Dockeræ”¶è´­Infinit-PDF" class="headerlink" title="Dockeræ”¶è´­Infinit PDF"></a><a href="https://blog.docker.com/2016/12/docker-acquires-infinit/" target="_blank" rel="external">Dockeræ”¶è´­Infinit</a> <a href="/assets/infinit.pdf">PDF</a></h1><p><a href="https://infinit.sh/" target="_blank" rel="external">Infinit</a>ä¸ºå®¹å™¨æä¾›äº†åˆ†å¸ƒå¼å­˜å‚¨ï¼Œå…¶ç‰¹ç‚¹åŒ…æ‹¬</p>
<ul>
<li>åŸºäºè½¯ä»¶ï¼šå¯ä»¥éƒ¨ç½²åœ¨ä»»ä½•ç¡¬ä»¶ä¹‹ä¸Šï¼Œä»é—ç•™è®¾å¤‡åˆ°æ¶ˆè´¹çº§å®ä½“æœºã€è™šæ‹Ÿæœºï¼Œç”šè‡³å®¹å™¨ã€‚</li>
<li>å¯ç¼–ç¨‹ï¼šå¼€å‘è€…å¯ä»¥è½»æ¾åœ°å®Œæˆå¤šä¸ªå­˜å‚¨åŸºç¡€è®¾æ–½çš„è‡ªåŠ¨åŒ–åˆ›å»ºå’Œéƒ¨ç½²ï¼Œå¹¶ä¸”æ¯ä¸ªéƒ½èƒ½å€ŸåŠ©åŸºäºç­–ç•¥çš„èƒ½åŠ›è¿›è¡Œè‡ªå®šä¹‰ï¼Œé€‚é…ä¸Šå±‚åº”ç”¨çš„éœ€æ±‚ã€‚</li>
<li>å¯ä¼¸ç¼©ï¼šé€šè¿‡ä¾é ä¸€ä¸ªå»ä¸­å¿ƒåŒ–çš„æ¶æ„ï¼ˆå³ç‚¹å¯¹ç‚¹ï¼‰ï¼ŒInfinitæ²¡æœ‰ä½¿ç”¨leader/followeræ¨¡å‹ï¼Œå› è€Œä¸ä¼šæœ‰ç“¶é¢ˆå’Œå•ç‚¹å¤±æ•ˆçš„é—®é¢˜ã€‚</li>
<li>è‡ªæ„ˆåˆï¼šInfinitçš„å†å¹³è¡¡ç­–ç•¥èƒ½è®©ç³»ç»Ÿé€‚åº”å„ç§æ•…éšœï¼ŒåŒ…æ‹¬æ‹œå åº­å°†å†›é—®é¢˜ã€‚</li>
<li>å¤šç”¨é€”ï¼šInfinitå¹³å°æä¾›äº†å—ã€å¯¹è±¡å’Œæ–‡ä»¶å­˜å‚¨çš„æ¥å£ï¼šNFSã€SMBã€AWS S3ã€OpenStack Swiftã€iSCSIå’ŒFUSEç­‰ç­‰ã€‚</li>
</ul>
<p><img src="/images/14811775178610.png" alt=""></p>
<p>åŸºæœ¬åŸç†ï¼š</p>
<p>â€¢ Federate all nodes in an overlay network for lookup and routing.<br>â€¢ Store data as blocks in a distributed hashtable (key-value store) with a per-block consensus.<br>â€¢ Use cryptographic access control to dispense from any leader.<br>â€¢ Use symmetrical operations to ensure resilience and flexibility.</p>
<p><img src="/images/14811780770073.jpg" alt=""></p>
<p><img src="/images/14811782445452.jpg" alt=""></p>
<p>Infinitä»¥volumeçš„å½¢å¼æŒ‚è½½åˆ°dockerå®¹å™¨ä¸­ï¼š</p>
<p><img src="/images/14811779192673.jpg" alt=""></p>
<h2 id="Docker-Alibabaâ€”â€”è¶…å¤§è§„æ¨¡DockeråŒ–çš„å®æˆ˜ç»éªŒ"><a href="#Docker-Alibabaâ€”â€”è¶…å¤§è§„æ¨¡DockeråŒ–çš„å®æˆ˜ç»éªŒ" class="headerlink" title="Docker@Alibabaâ€”â€”è¶…å¤§è§„æ¨¡DockeråŒ–çš„å®æˆ˜ç»éªŒ"></a><a href="https://yq.aliyun.com/articles/64256" target="_blank" rel="external">Docker@Alibabaâ€”â€”è¶…å¤§è§„æ¨¡DockeråŒ–çš„å®æˆ˜ç»éªŒ</a></h2><ul>
<li>AliDockerï¼Œå¹¶éé˜¿é‡Œäº‘ï¼Œä¸»è¦æ˜¯é˜¿é‡Œå†…éƒ¨ä¸šåŠ¡åœ¨ç”¨</li>
<li>Swarmæ”¹é€ æ”¯æŒå•swarmå®ä¾‹health nodes 2w+<ul>
<li>ä¼˜åŒ–è¿æ¥ç®¡ç†ã€æœ€å°åŒ–é”ç²’åº¦ã€ä¿®æ”¹diffç®—æ³•å‡å°‘nodeåˆ·æ–°æ—¶çš„å¼€é”€ã€å‡å°‘è¿æ¥çº¿ç¨‹</li>
</ul>
</li>
<li>Docker Engineå¢å¼º<ul>
<li>ç£ç›˜é…é¢ã€å›ºå®šIPã€Hooksã€è§£å†³hyperdé‡å¯å®¹å™¨é”€æ¯é—®é¢˜ç­‰</li>
</ul>
</li>
<li>é•œåƒåˆ†å‘ï¼šæµå¼åˆ†å‘ã€é•œåƒåˆ†æ‰¹é¢„çƒ­ã€P2Pç­‰</li>
<li>swarm-proxy HA</li>
</ul>
<p><img src="/images/14811788194621.jpg" alt="">7</p>
<h2 id="å¾®æœåŠ¡åœ¨å¾®ä¿¡åå°çš„æ¶æ„å®è·µ"><a href="#å¾®æœåŠ¡åœ¨å¾®ä¿¡åå°çš„æ¶æ„å®è·µ" class="headerlink" title="å¾®æœåŠ¡åœ¨å¾®ä¿¡åå°çš„æ¶æ„å®è·µ"></a><a href="http://ppt.geekbang.org/slide/show/607" target="_blank" rel="external">å¾®æœåŠ¡åœ¨å¾®ä¿¡åå°çš„æ¶æ„å®è·µ</a></h2><ul>
<li>å¤šåœ°è‡ªæ²»ï¼Œå›­åŒºäº’å¤‡ï¼šåŸå¸‚é—´RTT 30ms-400msï¼Œå›­åŒºé—´å°äº2ms</li>
<li>RPCï¼šprotobuf/libco</li>
<li>è°ƒåº¦ï¼šYardï¼ŒåŒå±‚è°ƒåº¦å™¨ï¼ˆMesos+Yardï¼‰</li>
<li>è¿‡è½½ä¿æŠ¤ï¼šè½»é‡åˆ†ç¦»ã€é˜Ÿåˆ—å¼ã€ç»„åˆå‘½ä»¤å¼</li>
</ul>
<p><img src="/images/14811817178100.jpg" alt=""></p>
<ul>
<li>æ•°æ®å­˜å‚¨ï¼šPaxosStoreï¼ŒåŒæ­¥å¤åˆ¶ã€å¤šä¸»å¤šå†™</li>
</ul>
<p><img src="/images/14811818656014.jpg" alt=""></p>
<h2 id="Go-å¾®æœåŠ¡æ¶æ„çš„åŸºçŸ³"><a href="#Go-å¾®æœåŠ¡æ¶æ„çš„åŸºçŸ³" class="headerlink" title="Go:å¾®æœåŠ¡æ¶æ„çš„åŸºçŸ³"></a><a href="http://ppt.geekbang.org/slide/show/615" target="_blank" rel="external">Go:å¾®æœåŠ¡æ¶æ„çš„åŸºçŸ³</a></h2><ul>
<li>è´Ÿè½½å‡è¡¡ï¼šseesawã€caddy</li>
<li>æœåŠ¡ç½‘å…³ï¼štykã€fabioã€vulcand</li>
<li>è¿›ç¨‹é—´é€šä¿¡ï¼šRESTfulã€RPCã€è‡ªå®šä¹‰<ul>
<li>RESTæ¡†æ¶ï¼šbeegoã€ginã€Irisã€microã€go-kitã€goa</li>
<li>RPCæ¡†æ¶ï¼šgrpcã€thriftã€hprose</li>
<li>è‡ªå®šä¹‰ï¼šåè®®ï¼Œç¼–è§£ç </li>
</ul>
</li>
<li>æœåŠ¡å‘ç°ï¼šetcdã€consulã€serf</li>
<li>è°ƒåº¦ç³»ç»Ÿï¼škubernetesã€swarmã€mesos</li>
<li>æ¶ˆæ¯é˜Ÿåˆ—ï¼šNSQã€Nats</li>
<li>APMï¼ˆåº”ç”¨æ€§èƒ½ç›‘æ§ï¼‰ï¼šappdashã€Cloudinsightã€opentracing</li>
<li>é…ç½®ç®¡ç†ï¼šetcdã€consulã€mgmt</li>
<li>æ—¥å¿—åˆ†æï¼šBeatsã€Heka</li>
<li>æœåŠ¡ç›‘æ§ï¼šopen-falconã€prometheus</li>
<li>CI/CDï¼šDrone</li>
<li>ç†”æ–­å™¨ï¼šgatewayã€Hystrix-go</li>
</ul>
<h2 id="åŸºäºä¸‡èŠ‚ç‚¹Kubernetesæ”¯æ’‘å¤§è§„æ¨¡äº‘åº”ç”¨å®è·µ"><a href="#åŸºäºä¸‡èŠ‚ç‚¹Kubernetesæ”¯æ’‘å¤§è§„æ¨¡äº‘åº”ç”¨å®è·µ" class="headerlink" title="åŸºäºä¸‡èŠ‚ç‚¹Kubernetesæ”¯æ’‘å¤§è§„æ¨¡äº‘åº”ç”¨å®è·µ"></a><a href="http://ppt.geekbang.org/slide/show/586" target="_blank" rel="external">åŸºäºä¸‡èŠ‚ç‚¹Kubernetesæ”¯æ’‘å¤§è§„æ¨¡äº‘åº”ç”¨å®è·µ</a></h2><ul>
<li>åŸºäºOpenStackçš„IaaSï¼šè£å‰ªKVMé•œåƒã€ä¼˜åŒ–å¯åŠ¨æµç¨‹ï¼ŒOpenvswitch SDNã€Cephå­˜å‚¨</li>
<li>å®¹å™¨ä¸è™šæ‹Ÿæœºå…±ç”¨ä¸€å¥—è™šæ‹ŸåŒ–ç½‘ç»œ</li>
<li>Cephå­˜å‚¨ç›´æ¥æŒ‚è½½åˆ°å®¹å™¨</li>
<li>ç»Ÿä¸€çš„æ—¥å¿—æ”¶é›†ã€åˆ†æã€æœç´¢</li>
<li>Kubernetesè°ƒåº¦å™¨ä¼˜åŒ–ï¼šå°†åŸæ¥çš„ä¸²è¡Œé˜Ÿåˆ—æ”¹ä¸ºå¤šä¸ªä¼˜å…ˆçº§é˜Ÿåˆ—</li>
<li>etcdé›†ç¾¤æ‰©å±•ï¼šå°†Pod/Node/ReplicationControlleræ‹†åˆ†åˆ°ä¸åŒçš„etcdé›†ç¾¤</li>
</ul>
<p><img src="/images/14811811876614.jpg" alt=""></p>
<p><img src="/images/14811813670269.jpg" alt=""></p>
<h1 id="20-å¤©æŒç»­å‹æµ‹ï¼Œå‘Šè¯‰ä½ äº‘å­˜å‚¨æ€§èƒ½å“ªå®¶å¼º-ğŸ“ˆ"><a href="#20-å¤©æŒç»­å‹æµ‹ï¼Œå‘Šè¯‰ä½ äº‘å­˜å‚¨æ€§èƒ½å“ªå®¶å¼º-ğŸ“ˆ" class="headerlink" title="20 å¤©æŒç»­å‹æµ‹ï¼Œå‘Šè¯‰ä½ äº‘å­˜å‚¨æ€§èƒ½å“ªå®¶å¼º ğŸ“ˆ"></a><a href="https://www.v2ex.com/t/326038?from=timeline&amp;isappinstalled=0#reply7" target="_blank" rel="external">20 å¤©æŒç»­å‹æµ‹ï¼Œå‘Šè¯‰ä½ äº‘å­˜å‚¨æ€§èƒ½å“ªå®¶å¼º</a> <a href="http://www.codingpy.com/specials/cbs_test/" target="_blank" rel="external">ğŸ“ˆ</a></h1><p>å¯¹é˜¿é‡Œäº‘å’Œè…¾è®¯äº‘ä¸¤ç§äº‘å­˜å‚¨äº§å“ï¼ˆäº‘ç›˜ï¼‰çš„æ€§èƒ½å’Œä»·æ ¼å¯¹æ¯”ï¼š</p>
<ul>
<li>æµ‹è¯•æ–¹æ³•ï¼šSNIAå‘å¸ƒçš„<a href="http://snia.org/sites/default/files/SSS_PTS_Enterprise_v1.1.pdf" target="_blank" rel="external">ä¼ä¸šçº§SSDè¯„æµ‹è§„èŒƒ</a>åŠ<a href="https://github.com/cloudharmony/block-storage" target="_blank" rel="external">å®ç°</a></li>
<li>é˜¿é‡Œäº‘ SSD äº‘ç›˜å¿…é¡»æ­é… I/O ä¼˜åŒ–å®ä¾‹æ‰èƒ½ç»™å‘æŒ¥æœ€å¤§æ€§èƒ½</li>
<li>è…¾è®¯äº‘é«˜æ•ˆäº‘ç›˜çš„è¯»å†™æ“ä½œå¯åŒæ—¶è¾¾åˆ°é¢„æœŸæ€§èƒ½å³°å€¼ï¼ˆæ•°æ®å— 16KB ä»¥ä¸‹ï¼‰ï¼Œè€Œé˜¿é‡Œäº‘æ–¹é¢ï¼Œè¯»å†™æ— æ³•åŒæ—¶è¾¾åˆ°é¢„æœŸæ€§èƒ½å³°å€¼</li>
<li>è…¾è®¯äº‘è¾¾åˆ°äº†é¢„æœŸçš„æ€§èƒ½ï¼›é˜¿é‡Œäº‘éƒ¨åˆ†æ²¡æœ‰è¾¾åˆ°ï¼Œ 400GB å®¹é‡çš„æ—¶å»¶è¿‡é«˜</li>
<li>è…¾è®¯äº‘é«˜æ•ˆäº‘ç›˜çš„æ—¶å»¶åœ¨ 1ms ä»¥ä¸‹ï¼Œ IOPS ã€ååé‡çš„ä¼˜åŠ¿æ›´åŠ çªå‡º</li>
<li>ä¸¤å®¶é«˜æ•ˆäº‘ç›˜çš„ IOPS è¡¨ç°å‡æ¯”è¾ƒç¨³å®šï¼Œå‡ ä¹å‘ˆä¸€æ¡ç›´çº¿ï¼Œåªæœ‰é˜¿é‡Œäº‘çš„ 400GB äº‘ç›˜æœ‰äº›ç•¥å¾®æ³¢åŠ¨</li>
<li>å®¹é‡è¶Šå¤§ï¼Œä¼¼ä¹é—²ç½®æ—¶é—´å¯¹æ€§èƒ½æ¢å¤çš„å½±å“è¶Šæ˜æ˜¾ï¼›é˜¿é‡Œäº‘ 400GB é«˜æ•ˆäº‘ç›˜çš„æ€§èƒ½æ³¢åŠ¨å—é—²ç½®æ—¶é—´å½±å“è¾ƒæ˜æ˜¾</li>
</ul>
<p><img src="/images/14811840736214.jpg" alt=""></p>
<h2 id="å¤–å–çš„èƒŒå-é¥¿äº†ä¹ˆåŸºç¡€æ¶æ„ä»0åˆ°1çš„æ¼”è¿›"><a href="#å¤–å–çš„èƒŒå-é¥¿äº†ä¹ˆåŸºç¡€æ¶æ„ä»0åˆ°1çš„æ¼”è¿›" class="headerlink" title="å¤–å–çš„èƒŒå-é¥¿äº†ä¹ˆåŸºç¡€æ¶æ„ä»0åˆ°1çš„æ¼”è¿›"></a><a href="http://ppt.geekbang.org/slide/show/619" target="_blank" rel="external">å¤–å–çš„èƒŒå-é¥¿äº†ä¹ˆåŸºç¡€æ¶æ„ä»0åˆ°1çš„æ¼”è¿›</a></h2><ul>
<li>è´Ÿè½½å‡è¡¡<ul>
<li>æœ€åˆï¼šHAProxyéƒ¨ç½²åœ¨å®¢æˆ·ç«¯æœ¬åœ°ï¼Œä¸éœ€è¦è€ƒè™‘HAProxyçš„é«˜å¯ç”¨ï¼›é—®é¢˜æ˜¯éƒ¨ç½²è§„æ¨¡å¤§ï¼Œç»´æŠ¤å®¢æˆ·åˆ—è¡¨å¤æ‚ï¼Œå¹¶ä¸”é…ç½®ä¸ç»Ÿä¸€</li>
<li>è§£å†³ï¼š<ul>
<li>RPC+å†…ç½®LB SDKï¼ŒæœåŠ¡è‡ªæ³¨å†Œ/è‡ªå‘ç°ï¼Œé…ç½®å°‘ï¼Œéƒ¨ç½²ç®€å•</li>
<li>Redis/DBè§£å†³æ–¹æ¡ˆGoProxy: DAL/Corvusä½œä¸ºæœåŠ¡è‡ªæ³¨å†Œï¼ŒGoProxyè®¢é˜…æ³¨å†Œäº‹ä»¶å¹¶è‡ªå¸¦æœåŠ¡å‘ç°çš„Haproxy</li>
<li>å¥åº·æ£€æŸ¥ï¼šå¿ƒè·³æ£€æµ‹ï¼Œè¿›ç¨‹åœ¨ã€ç«¯å£æ´»ä¸ä»£è¡¨æœåŠ¡å¯ç”¨</li>
</ul>
</li>
</ul>
</li>
<li>æ— æŸå‡çº§<ul>
<li>æœ€åˆï¼šå‘å¸ƒå‰é€šçŸ¥å®¢æˆ·ç«¯åœæ­¢è¯·æ±‚ï¼ŒæœåŠ¡ç«¯å°†æ­£åœ¨å¤„ç†çš„è¯·æ±‚å¤„ç†å®Œæ¯•æ‰èƒ½å‡çº§</li>
<li>è§£å†³ï¼š<ul>
<li>RPCè°ƒç”¨ï¼šæœåŠ¡å‘ç°æœºåˆ¶ä¼šåœ¨æ³¨é”€æ—¶é€šçŸ¥å®¢æˆ·ç«¯ï¼Œç›´è¿æƒ…å†µä¸‹å®¢æˆ·ç«¯ä»å¯ç”¨åˆ—è¡¨ä¸­å‰”é™¤å‡†å¤‡ä¸‹çº¿çš„æœåŠ¡</li>
<li>æ•°æ®åº“è®¿é—®ï¼Œå®¢æˆ·ç«¯é™åˆ¶è¿æ¥å­˜æ´»æ—¶é—´ï¼ŒDALä¾§é‡è¿</li>
</ul>
</li>
</ul>
</li>
<li>åŸºç¡€æ¶æ„ï¼šå¼€æ”¾å¼æ¶æ„<ul>
<li>åŸºäºç»„ä»¶ï¼Œç»™ä¸šåŠ¡å¼€å‘å›¢é˜Ÿæœ€å¤§çš„è‡ªç”±</li>
<li>åŸºäºè¿è¡Œæ—¶ï¼Œç»™ä¸šåŠ¡å¼€å‘å›¢é˜Ÿæœ€å¤§é™åº¦çš„è‡ªç”±</li>
<li>å¼€æ”¾å°é—­åŸåˆ™ï¼šåŸºç¡€æ¡†æ¶åº”è¯¥æ˜¯å¯ä»¥æ‰©å±•çš„ï¼Œä½†æ˜¯ä¸å¯ä»¥â€œé€‰æ‹©â€çš„</li>
</ul>
</li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;Dockeræ”¶è´­Infinit-PDF&quot;&gt;&lt;a href=&quot;#Dockeræ”¶è´­Infinit-PDF&quot; class=&quot;headerlink&quot; title=&quot;Dockeræ”¶è´­Infinit PDF&quot;&gt;&lt;/a&gt;&lt;a href=&quot;https://blog.docker.
    
    </summary>
    
      <category term="Readings" scheme="http://feisky.xyz/categories/Readings/"/>
    
    
  </entry>
  
  <entry>
    <title>Weekly reading list</title>
    <link href="http://feisky.xyz/2016/12/04/Weekly-reading-list/"/>
    <id>http://feisky.xyz/2016/12/04/Weekly-reading-list/</id>
    <published>2016-12-04T23:59:01.000Z</published>
    <updated>2016-12-15T00:14:54.373Z</updated>
    
    <content type="html"><![CDATA[<h2 id="åˆ†å¸ƒå¼åå°æ¯«ç§’æœåŠ¡å¼•æ“"><a href="#åˆ†å¸ƒå¼åå°æ¯«ç§’æœåŠ¡å¼•æ“" class="headerlink" title="åˆ†å¸ƒå¼åå°æ¯«ç§’æœåŠ¡å¼•æ“"></a><a href="http://mp.weixin.qq.com/s?__biz=MjM5MDE0Mjc4MA==&amp;mid=2650994968&amp;idx=1&amp;sn=6713bb3b59e1fb38c70f7178de136cfc&amp;scene=0#wechat_redirect" target="_blank" rel="external">åˆ†å¸ƒå¼åå°æ¯«ç§’æœåŠ¡å¼•æ“</a></h2><blockquote>
<p>è…¾è®¯QQå›¢é˜Ÿäº12æœˆ4æ—¥å¼€æºäº†ä¸€ä¸ªæœåŠ¡å¼€å‘è¿è¥æ¡†æ¶ï¼Œå«åšæ¯«ç§’æœåŠ¡å¼•æ“ï¼ˆMass Service Engine in Clusterï¼ŒMSECï¼‰ï¼Œå®ƒé›†RPCã€åå­—å‘ç°æœåŠ¡ã€è´Ÿè½½å‡è¡¡ã€ä¸šåŠ¡ç›‘æ§ã€ç°åº¦å‘å¸ƒã€å®¹é‡ç®¡ç†ã€æ—¥å¿—ç®¡ç†ã€Key-Valueå­˜å‚¨äºä¸€ä½“ï¼Œç›®çš„æ˜¯æé«˜å¼€å‘ä¸è¿è¥çš„æ•ˆç‡å’Œè´¨é‡ã€‚</p>
</blockquote>
<p><img src="/images/14809236732969.jpg" alt=""></p>
<p><img src="/images/14809236897310.jpg" alt=""></p>
<ul>
<li>æœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡<ul>
<li>é›†ä¸­ç®¡ç†æ¯ä¸ªæœåŠ¡ï¼ˆåŒ…æ‹¬å¼‚æ„æœåŠ¡ï¼‰çš„IPåœ°å€</li>
<li>æœåŠ¡ä¹‹é—´RPCè°ƒç”¨ï¼šæœåŠ¡å+æ¥å£å</li>
<li>è·¯ç”±çš„åŒæ—¶ç»Ÿè®¡è¿‡å»ä¸€æ®µæ—¶é—´çš„æˆåŠŸç‡å’Œæ—¶å»¶</li>
</ul>
</li>
<li>æ”¯æŒå¤šç§ç¼–ç¨‹è¯­è¨€ï¼ˆé€šè¿‡Protocol bufferç”Ÿæˆä¸åŒè¯­è¨€çš„æ¥å£ï¼‰ï¼Œå¦‚C/C++ã€Javaã€PHPç­‰</li>
<li>WebåŒ–çš„ç®¡ç†ç•Œé¢(Tomcat)</li>
<li>å­˜å‚¨ï¼šRedis cluster</li>
<li>å®˜æ–¹ç½‘ç«™ï¼š<a href="http://haomiao.qq.com" target="_blank" rel="external">http://haomiao.qq.com</a></li>
<li>Githubï¼š<a href="https://github.com/Tencent/MSEC" target="_blank" rel="external">https://github.com/Tencent/MSEC</a></li>
</ul>
<h2 id="Understanding-SELinux-Roles"><a href="#Understanding-SELinux-Roles" class="headerlink" title="Understanding SELinux Roles"></a><a href="http://danwalsh.livejournal.com/75683.html" target="_blank" rel="external">Understanding SELinux Roles</a></h2><p>SELinux labelåŒ…å«4ä¸ªéƒ¨åˆ†<code>user_u:role_r:type_t:level</code>ï¼Œæ¯ä¸ªç”¨æˆ·å¯ä»¥è®¿é—®çš„è§’è‰²ï¼š</p>
<figure class="highlight armasm"><table><tr><td class="code"><pre><div class="line"><span class="symbol">semanage</span> user -l</div><div class="line"></div><div class="line">         Labeling   <span class="keyword">MLS/ </span>      <span class="keyword">MLS/ </span>                       </div><div class="line"><span class="keyword">SELinux </span>User    Prefix     MCS Level  MCS Range       <span class="keyword">SELinux </span>Roles</div><div class="line"></div><div class="line"><span class="symbol">guest_u</span>             user       <span class="built_in">s0</span>         <span class="built_in">s0</span>                             guest_r</div><div class="line"><span class="symbol">root</span>                    user       <span class="built_in">s0</span>         <span class="built_in">s0</span>-<span class="built_in">s0</span>:<span class="built_in">c0</span>.c1023        staff_r sysadm_r system_r unconfined_r</div><div class="line"><span class="symbol">staff_u</span>               user       <span class="built_in">s0</span>         <span class="built_in">s0</span>-<span class="built_in">s0</span>:<span class="built_in">c0</span>.c1023        staff_r sysadm_r system_r unconfined_r</div><div class="line"><span class="symbol">sysadm_u</span>         user       <span class="built_in">s0</span>         <span class="built_in">s0</span>-<span class="built_in">s0</span>:<span class="built_in">c0</span>.c1023        sysadm_r</div><div class="line"><span class="symbol">system_u</span>          user       <span class="built_in">s0</span>         <span class="built_in">s0</span>-<span class="built_in">s0</span>:<span class="built_in">c0</span>.c1023        system_r unconfined_r</div><div class="line"><span class="symbol">unconfined_u</span>    user       <span class="built_in">s0</span>         <span class="built_in">s0</span>-<span class="built_in">s0</span>:<span class="built_in">c0</span>.c1023        system_r unconfined_r</div><div class="line"><span class="symbol">user_u</span>               user       <span class="built_in">s0</span>         <span class="built_in">s0</span>                             user_r</div><div class="line"><span class="symbol">xguest_u</span>           user       <span class="built_in">s0</span>         <span class="built_in">s0</span>                             xguest_r</div></pre></td></tr></table></figure>
<ul>
<li>system_r role is the default role for all processes started at boot</li>
<li>You can not assign an SELinux user a role that is not listed</li>
<li>object_r is not really a role, but more of a place holder.  Roles only make sense for processes, not for files</li>
<li>on the file system.  But the SELinux label requires a role for all labels.  object_r is the role that we use to fill the objects on disks role.  Changing a process to run as object_r or trying to assign a different role to a file will always be denied by the kernel.</li>
</ul>
<h2 id="Kompose-a-tool-to-go-from-Docker-compose-to-Kubernetes"><a href="#Kompose-a-tool-to-go-from-Docker-compose-to-Kubernetes" class="headerlink" title="Kompose: a tool to go from Docker-compose to Kubernetes"></a><a href="http://blog.kubernetes.io/2016/11/kompose-tool-go-from-docker-compose-to-kubernetes.html" target="_blank" rel="external">Kompose: a tool to go from Docker-compose to Kubernetes</a></h2><ul>
<li>æŠŠdocker-compose.ymlæˆ–dabè½¬æ¢ä¸ºkubernetes service+deployment</li>
<li>Github: <a href="https://github.com/kubernetes-incubator/kompose" target="_blank" rel="external">https://github.com/kubernetes-incubator/kompose</a></li>
</ul>
<figure class="highlight applescript"><table><tr><td class="code"><pre><div class="line">$ kompose <span class="comment">--bundle docker-compose-bundle.dab convert</span></div><div class="line">WARN[<span class="number">0000</span>]: Unsupported key networks - <span class="keyword">ignoring</span></div><div class="line"><span class="built_in">file</span> <span class="string">"redis-svc.json"</span> created</div><div class="line"><span class="built_in">file</span> <span class="string">"web-svc.json"</span> created</div><div class="line"><span class="built_in">file</span> <span class="string">"web-deployment.json"</span> created</div><div class="line"><span class="built_in">file</span> <span class="string">"redis-deployment.json"</span> created</div><div class="line"></div><div class="line">$ kompose -f docker-compose.yml convert</div><div class="line">WARN[<span class="number">0000</span>]: Unsupported key networks - <span class="keyword">ignoring</span></div><div class="line"><span class="built_in">file</span> <span class="string">"redis-svc.json"</span> created</div><div class="line"><span class="built_in">file</span> <span class="string">"web-svc.json"</span> created</div><div class="line"><span class="built_in">file</span> <span class="string">"web-deployment.json"</span> created</div><div class="line"><span class="built_in">file</span> <span class="string">"redis-deployment.json"</span> created</div></pre></td></tr></table></figure>
<h2 id="2016å¹´ç½‘ç»œè™šæ‹ŸåŒ–è¶‹åŠ¿"><a href="#2016å¹´ç½‘ç»œè™šæ‹ŸåŒ–è¶‹åŠ¿" class="headerlink" title="2016å¹´ç½‘ç»œè™šæ‹ŸåŒ–è¶‹åŠ¿"></a><a href="http://www.sdnlab.com/18153.html" target="_blank" rel="external">2016å¹´ç½‘ç»œè™šæ‹ŸåŒ–è¶‹åŠ¿</a></h2><ul>
<li>å¸‚åœºæŒç»­å‡æ¸©ï¼šNVçš„å¸‚åœºå·²ç»æ˜¯ä¸€ä¸ªæ•°åäº¿ç¾å…ƒçš„å¸‚åœºï¼ŒCiscoã€Juniperã€Nuageã€VMwareæ˜¯NVå¸‚åœºçš„å››å¤§å·¨å¤´ï¼Œä»–ä»¬å æ®äº†NVå¸‚åœºçš„ç»å¤§å¤šæ•°æ”¶å…¥</li>
<li>æ€ç§‘å’ŒVMwareå…¬å¸ƒçš„æ•°æ®æ˜¾ç¤ºå…¶ä¸NVç›¸å…³çš„æŠ•èµ„ç»„åˆåœ¨2016å¹´å°†è¿‘30äº¿ç¾å…ƒ</li>
<li>å®¹å™¨åŒ–ï¼šæ€ç§‘æ”¶è´­ContainerXï¼ŒVMWareæ¨å‡ºvSphereé›†æˆå®¹å™¨ï¼ˆVICï¼‰</li>
</ul>
<p><img src="/images/14809260496846.jpg" alt=""></p>
<h2 id="Amazonå‘å¸ƒä¸€å¤§æ³¢æ–°äº§å“"><a href="#Amazonå‘å¸ƒä¸€å¤§æ³¢æ–°äº§å“" class="headerlink" title="Amazonå‘å¸ƒä¸€å¤§æ³¢æ–°äº§å“"></a>Amazonå‘å¸ƒä¸€å¤§æ³¢æ–°äº§å“</h2><ul>
<li><a href="https://amazonlightsail.com/" target="_blank" rel="external">Amazon Lightsail</a>ï¼šå»‰ä»·VPSï¼Œä»·æ ¼è·ŸLightSale, DO, VULTR, Linodeç›¸åŒã€‚</li>
<li><a href="https://aws.amazon.com/cn/blogs/aws/developer-preview-ec2-instances-f1-with-programmable-hardware/" target="_blank" rel="external">F1 instance with FPGA</a>ï¼šVHDLå’ŒVerilogç»ˆäºæœ‰å‡ºè·¯äº†</li>
<li>ä»Šå¹´æ˜¯æœºå™¨å­¦ä¹ å¤§ç«çš„ä¸€å¹´ï¼ŒAmazonä¹Ÿéšå¤§æµï¼ˆå¾®è½¯ã€Googleï¼‰æ¨å‡ºäº†AIæœåŠ¡ï¼š<ul>
<li>Amazon Rekognitionå›¾åƒå¤„ç†å’Œåˆ†æ</li>
<li>Amazon Lexè‡ªç„¶è¯­è¨€å¤„ç†</li>
<li>Amazon Pollyæ–‡æœ¬åˆ°è¯­éŸ³çš„è½¬æ¢</li>
</ul>
</li>
<li><a href="https://aws.amazon.com/cn/snowmobile/" target="_blank" rel="external">AWS Snowmobile</a>ï¼šå¸¦å®½ä»æ¥éƒ½ä¸æ˜¯é—®é¢˜<br>  <img src="/images/14809265679834.jpg" alt=""></li>
</ul>
<h2 id="Linux-bcc-BPF-tcplife"><a href="#Linux-bcc-BPF-tcplife" class="headerlink" title="Linux bcc/BPF tcplife"></a><a href="http://www.brendangregg.com/blog/2016-11-30/linux-bcc-tcplife.html" target="_blank" rel="external">Linux bcc/BPF tcplife</a></h2><figure class="highlight tap"><table><tr><td class="code"><pre><div class="line"><span class="comment"># ./tcplife -D 80</span></div><div class="line">PID   COMM       LADDR           LPORT RADDR           RPORT TX_KB RX_KB MS</div><div class="line">27448 curl       100.66.11.247  <span class="number"> 54146 </span>54.154.224.174 <span class="number"> 80 </span>      <span class="number"> 0 </span>   <span class="number"> 1 </span>263.85</div><div class="line">27450 curl       100.66.11.247  <span class="number"> 20618 </span>54.154.164.22  <span class="number"> 80 </span>      <span class="number"> 0 </span>   <span class="number"> 1 </span>243.62</div><div class="line">27452 curl       100.66.11.247  <span class="number"> 11480 </span>54.154.43.103  <span class="number"> 80 </span>      <span class="number"> 0 </span>   <span class="number"> 1 </span>231.16</div><div class="line">27454 curl       100.66.11.247  <span class="number"> 31382 </span>54.154.15.7    <span class="number"> 80 </span>      <span class="number"> 0 </span>   <span class="number"> 1 </span>249.95</div><div class="line">27456 curl       100.66.11.247  <span class="number"> 33416 </span>52.210.59.223  <span class="number"> 80 </span>      <span class="number"> 0 </span>   <span class="number"> 1 </span>545.72</div><div class="line">27458 curl       100.66.11.247  <span class="number"> 16406 </span>52.30.140.35   <span class="number"> 80 </span>      <span class="number"> 0 </span>   <span class="number"> 1 </span>222.29</div><div class="line">27460 curl       100.66.11.247  <span class="number"> 11634 </span>52.30.133.135  <span class="number"> 80 </span>      <span class="number"> 0 </span>   <span class="number"> 1 </span>217.52</div><div class="line">27462 curl       100.66.11.247  <span class="number"> 25660 </span>52.30.126.182  <span class="number"> 80 </span>      <span class="number"> 0 </span>   <span class="number"> 1 </span>250.81</div><div class="line">[...]</div><div class="line"></div><div class="line"><span class="comment"># ./tcplife -h</span></div><div class="line">usage: tcplife [-h] [-T] [-t] [-w] [-s] [-p PID] [-L LOCALPORT]</div><div class="line">               [-D REMOTEPORT]</div><div class="line"></div><div class="line">Trace the lifespan of TCP sessions and summarize</div><div class="line"></div><div class="line">optional arguments:</div><div class="line">  -h, --help            show this help message and exit</div><div class="line">  -T, --time            include time column on output (HH:MM:SS)</div><div class="line">  -t, --timestamp       include timestamp on output (seconds)</div><div class="line">  -w, --wide            wide column output (fits IPv6 addresses)</div><div class="line">  -s, --csv             comma seperated values output</div><div class="line">  -p PID, --pid PID     trace this PID only</div><div class="line">  -L LOCALPORT, --localport LOCALPORT</div><div class="line">                        comma-separated list of local ports to trace.</div><div class="line">  -D REMOTEPORT, --remoteport REMOTEPORT</div><div class="line">                        comma-separated list of remote ports to trace.</div><div class="line"></div><div class="line">examples:</div><div class="line">    ./tcplife           <span class="comment"># trace all TCP connect()s</span></div><div class="line">    ./tcplife -t        <span class="comment"># include time column (HH:MM:SS)</span></div><div class="line">    ./tcplife -w        <span class="comment"># wider colums (fit IPv6)</span></div><div class="line">    ./tcplife -stT      <span class="comment"># csv output, with times &amp; timestamps</span></div><div class="line">    ./tcplife -p<span class="number"> 181 </span>   <span class="comment"># only trace PID 181</span></div><div class="line">    ./tcplife -L<span class="number"> 80 </span>    <span class="comment"># only trace local port 80</span></div><div class="line">    ./tcplife -L 80,81  <span class="comment"># only trace local ports 80 and 81</span></div><div class="line">    ./tcplife -D<span class="number"> 80 </span>    <span class="comment"># only trace remote port 80</span></div></pre></td></tr></table></figure>
<h2 id="cgroup-namespace"><a href="#cgroup-namespace" class="headerlink" title="cgroup namespace"></a><a href="http://hustcat.github.io/cgroup-namespace/" target="_blank" rel="external">cgroup namespace</a></h2><p>ä¹‹å‰ï¼Œåœ¨ä¸€ä¸ªå®¹å™¨æŸ¥çœ‹/proc/$PID/cgroupï¼Œæˆ–è€…åœ¨å®¹å™¨æŒ‚è½½cgroupæ—¶ï¼Œä¼šçœ‹åˆ°æ•´ä¸ªç³»ç»Ÿçš„cgroupä¿¡æ¯ï¼›åœ¨å†…æ ¸ä»4.6å¼€å§‹ï¼Œæ”¯æŒcgroup namespace ï¼ˆ<a href="https://lwn.net/Articles/618873/" target="_blank" rel="external">https://lwn.net/Articles/618873/</a>ï¼‰ã€‚</p>
<blockquote>
<p>(1)å¯ä»¥é™åˆ¶å®¹å™¨çš„cgroup filesytemè§†å›¾ï¼Œä½¿å¾—åœ¨å®¹å™¨ä¸­ä¹Ÿå¯ä»¥å®‰å…¨çš„ä½¿ç”¨cgroupï¼›<br>(2)æ­¤å¤–ï¼Œä¼šä½¿å®¹å™¨è¿ç§»æ›´åŠ å®¹æ˜“ï¼›åœ¨è¿ç§»æ—¶ï¼Œ/proc/self/cgroupéœ€è¦å¤åˆ¶åˆ°ç›®æ ‡æœºå™¨ï¼Œè¿™è¦æ±‚å®¹å™¨çš„cgroupè·¯å¾„æ˜¯å”¯ä¸€çš„ï¼Œå¦åˆ™å¯èƒ½ä¼šä¸ç›®æ ‡æœºå™¨å†²çªã€‚æœ‰äº†cgroupnsï¼Œæ¯ä¸ªå®¹å™¨éƒ½æœ‰è‡ªå·±çš„cgroup filesystemè§†å›¾ï¼Œä¸ç”¨æ‹…å¿ƒè¿™ç§å†²çªã€‚</p>
</blockquote>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;åˆ†å¸ƒå¼åå°æ¯«ç§’æœåŠ¡å¼•æ“&quot;&gt;&lt;a href=&quot;#åˆ†å¸ƒå¼åå°æ¯«ç§’æœåŠ¡å¼•æ“&quot; class=&quot;headerlink&quot; title=&quot;åˆ†å¸ƒå¼åå°æ¯«ç§’æœåŠ¡å¼•æ“&quot;&gt;&lt;/a&gt;&lt;a href=&quot;http://mp.weixin.qq.com/s?__biz=MjM5MDE0Mjc4
    
    </summary>
    
      <category term="Readings" scheme="http://feisky.xyz/categories/Readings/"/>
    
    
  </entry>
  
  <entry>
    <title>KubeCon/CloudNativeCon 2016è§é—»</title>
    <link href="http://feisky.xyz/2016/11/14/KubeCon-2016%E8%A7%81%E9%97%BB/"/>
    <id>http://feisky.xyz/2016/11/14/KubeCon-2016è§é—»/</id>
    <published>2016-11-14T01:49:52.000Z</published>
    <updated>2016-12-15T00:14:54.373Z</updated>
    
    <content type="html"><![CDATA[<p>é¢˜è®°ï¼šä¸Šå‘¨å»è¥¿é›…å›¾å‚åŠ äº†<a href="http://events.linuxfoundation.org/events/kubecon" target="_blank" rel="external">KubeCon&amp;CloudNativeCon 2016</a>ï¼Œä¸ä»…è§åˆ°Dawnã€Brendanã€Timä»¥åŠSig Nodeçš„å„è·¯å¤§ç¥ï¼Œè¿˜å‚åŠ äº†ä¸å°‘æœ‰è¶£çš„sessionã€‚</p>
<h2 id="Compiling-to-Containers-Brendan-Burns-Microsoft"><a href="#Compiling-to-Containers-Brendan-Burns-Microsoft" class="headerlink" title="Compiling to Containers - Brendan Burns, Microsoft"></a><a href="https://cnkc16.sched.org/event/8K8y/compiling-to-containers-brendan-burns-microsoft?iframe=no&amp;w=100%&amp;sidebar=yes&amp;bg=no" target="_blank" rel="external">Compiling to Containers</a> - Brendan Burns, Microsoft</h2><p>Containerså¯ä»¥çœ‹ä½œæ˜¯ç°ä»£åˆ†å¸ƒå¼ç³»ç»Ÿçš„â€œæ±‡ç¼–è¯­è¨€â€ï¼Œè¿™æ ·åˆ†å¸ƒå¼ç³»ç»Ÿçš„ç®¡ç†å®é™…ä¸Šå°±æˆäº†å¼€å‘â€œContaineræ±‡ç¼–è¯­è¨€â€ã€‚Brendanè¿˜ä»¥JavaScriptä¸ºä¾‹ï¼Œæ¼”ç¤ºäº†å¦‚ä½•åŸºäº<a href="https://github.com/brendandburns/metaparticle" target="_blank" rel="external">Metaparticle</a>æ¥æ”¯æŒä¸åŒçš„service pattern:</p>
<ul>
<li>Simple Service: simply exposes a function as an HTTP service.</li>
<li>Scatter/Gather: fans all requests out to all leaf nodes (scatter phase), all responses are then aggregated in a root node (gather phase), this aggregate response is returned to the caller.</li>
<li>Shard: select a shard (replica) for a request.</li>
<li>Spread: similar to Shard, but uses a randomized shardingFunction.</li>
</ul>
<h2 id="Unik-Unikernel-Runtime-for-Kubernetes-Idit-Levine-EMC"><a href="#Unik-Unikernel-Runtime-for-Kubernetes-Idit-Levine-EMC" class="headerlink" title="Unik: Unikernel Runtime for Kubernetes - Idit Levine, EMC"></a><a href="https://cnkc16.sched.org/event/8K8v/unik-unikernel-runtime-for-kubernetes-idit-levine-emc?iframe=no&amp;w=100%&amp;sidebar=yes&amp;bg=no" target="_blank" rel="external">Unik: Unikernel Runtime for Kubernetes</a> - Idit Levine, EMC</h2><p><a href="https://github.com/emc-advanced-dev/unik" target="_blank" rel="external">Unik</a>æ˜¯ä¸€ä¸ªå°†åº”ç”¨ç¼–è¯‘æˆunikernelçš„å·¥å…·ï¼Œæ”¯æŒrump/OSv/IncludeOS/MirageOSç­‰ï¼Œç¼–è¯‘çš„ç»“æœå¯ä»¥ç›´æ¥è·‘åœ¨å…¬æœ‰äº‘æˆ–è€…æœ¬åœ°çš„è™šæ‹Ÿæœºä¸­ã€‚</p>
<p>Unikåœ¨Kubernetesä¸­å®ç°äº†ä¸€ä¸ªç‰¹æ®Šçš„<a href="https://github.com/emc-advanced-dev/kubernetes/tree/master/pkg/kubelet/unik" target="_blank" rel="external">runtime</a>ï¼Œå¹¶å¯ä»¥é€šè¿‡kubernetesæ¥ç®¡ç†unikï¼š</p>
<ul>
<li>é•œåƒç®¡ç†ï¼šå®é™…ä¸Šé€šè¿‡rktæ¥æ“ä½œé•œåƒ</li>
<li>Podç®¡ç†ï¼šone Pod == one VM == one Containerï¼Œé€šè¿‡è°ƒç”¨unik daemonæ¥æ“ä½œ</li>
</ul>
<h2 id="Technical-View-Comparison-of-Container-Orchestration-and-Management-Systems-Lei-Zhang-HyperHQ"><a href="#Technical-View-Comparison-of-Container-Orchestration-and-Management-Systems-Lei-Zhang-HyperHQ" class="headerlink" title="Technical View: Comparison of Container Orchestration and Management Systems - Lei Zhang, HyperHQ"></a><a href="https://cnkc16.sched.org/event/8K3x/technical-view-comparison-of-container-orchestration-and-management-systems-lei-zhang-hyperhq?iframe=no&amp;w=100%&amp;sidebar=yes&amp;bg=no" target="_blank" rel="external">Technical View: Comparison of Container Orchestration and Management Systems</a> - Lei Zhang, HyperHQ</h2><p>æˆ‘å¸å¼ ç£ŠåŒå­¦çš„å¤§ä½œï¼Œä»æ¶æ„ã€æ§åˆ¶å¹³é¢ã€æœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡ã€è°ƒåº¦ç­‰å„ä¸ªè§’åº¦å¯¹æ¯”Kubernetes/Swarmkit/Mesosç­‰å¸¸è§å®¹å™¨ç¼–æ’ç³»ç»Ÿï¼Œå¹¶ä»¥<a href="https://github.com/hyperhq/hypernetes" target="_blank" rel="external">hypernetes</a>å’Œ<a href="http://hyper.sh/" target="_blank" rel="external">Hyper Container Service</a>ä¸ºä¾‹è¯´æ˜ä¸ºä»€ä¹ˆkubernetesæ˜¯ä¸€ä¸ªæ›´å¥½çš„é€‰æ‹©ã€‚</p>
<p><img src="/images/1-4.png" alt="1"><br><img src="/images/2-3.png" alt="2"></p>
<h2 id="Everything-You-Ever-Wanted-to-Know-About-Resource-Scheduling-But-Were-Afraid-to-Ask-Tim-Hockin-Google"><a href="#Everything-You-Ever-Wanted-to-Know-About-Resource-Scheduling-But-Were-Afraid-to-Ask-Tim-Hockin-Google" class="headerlink" title="Everything You Ever Wanted to Know About Resource Scheduling, But Were Afraid to Ask - Tim Hockin, Google"></a><a href="https://cnkc16.sched.org/event/8K8l/everything-you-ever-wanted-to-know-about-resource-scheduling-but-were-afraid-to-ask-tim-hockin-google?iframe=no&amp;w=100%&amp;sidebar=yes&amp;bg=no" target="_blank" rel="external">Everything You Ever Wanted to Know About Resource Scheduling, But Were Afraid to Ask</a> - Tim Hockin, Google</h2><p>Kubernetes is fundamentally about resource management:</p>
<ul>
<li>CPU/Memory/Disk</li>
<li>Network/Ports/IP addresses</li>
<li>PIDs</li>
<li>GPUs</li>
<li>Storage</li>
<li>Power</li>
</ul>
<p>å…³äºèµ„æºç®¡ç†çš„ä¸‰æ–¹é¢:</p>
<ul>
<li>Isolationï¼šä¿è¯åº”ç”¨å¯ä»¥è·å–æƒ³è¦çš„èµ„æºå¹¶ä¸”ä¸å½±å“å…¶ä»–åº”ç”¨ï¼Œç›®å‰åŸºäºRequests/Limitsåªæ”¯æŒcpuå’Œå†…å­˜</li>
<li>Sizingï¼šåº”è¯¥ç»™ç”¨æˆ·åˆ†é…å¤šå°‘èµ„æºå‘¢ï¼Œæ²¡æœ‰ç»Ÿä¸€çš„æ–¹æ³•ï¼Œåªèƒ½é benchmarkï¼Œä½†ç²¾ç¡®çš„benchmarkå¾ˆéš¾ï¼Œæ‰€ä»¥Kubernetesæä¾›äº†Horizontal Pod Autoscalerï¼Œæœªæ¥å¯èƒ½è¿˜ä¼šæœ‰VerticalPodAutoscaler</li>
<li>Utilizationï¼šèµ„æºçš„å®é™…ä½¿ç”¨æƒ…å†µæ˜¯å•¥æ ·çš„ï¼Œæ¶‰åŠPriorityè°ƒåº¦ã€Quotaç®¡ç†ã€Overcommitç­‰ç­‰ã€‚</li>
</ul>
<p><img src="/images/3-4.png" alt="3"></p>
<p>Slideè§<a href="https://speakerdeck.com/thockin/everything-you-ever-wanted-to-know-about-resource-scheduling-dot-dot-dot-almost" target="_blank" rel="external">è¿™é‡Œ</a>.</p>
<h2 id="Self-hosted-Scale-and-Federation-with-Kubernetes-v1-4-and-Beyond-Brandon-Philips-CoreOS"><a href="#Self-hosted-Scale-and-Federation-with-Kubernetes-v1-4-and-Beyond-Brandon-Philips-CoreOS" class="headerlink" title="Self-hosted, Scale, and Federation with Kubernetes v1.4 and Beyond - Brandon Philips, CoreOS"></a><a href="https://cnkc16.sched.org/event/8K3v/self-hosted-scale-and-federation-with-kubernetes-v14-and-beyond-brandon-philips-coreos-inc?iframe=yes&amp;w=100%&amp;sidebar=yes&amp;bg=no#" target="_blank" rel="external">Self-hosted, Scale, and Federation with Kubernetes v1.4 and Beyond</a> - Brandon Philips, CoreOS</h2><p>åŸºæœ¬çš„ideaæ˜¯ç”¨Kubernetesæ¥ç®¡ç†Kubernetesçš„éƒ¨ç½²å’Œå‡çº§ï¼Œè¿™ä¹Ÿæ˜¯ä¸€ä¸ªå­µåŒ–çŠ¶æ€çš„é¡¹ç›®<a href="https://github.com/kubernetes-incubator/bootkube" target="_blank" rel="external">bootkube</a>ã€‚ç”±äºkubeletåˆå§‹åŒ–éœ€è¦æ§åˆ¶å¹³é¢çš„é…åˆï¼Œbootkubeä¼šåœ¨ä¸€å¼€å§‹çš„æ—¶å€™ä¼šå¯åŠ¨ä¸€ä¸ªæš‚æ—¶çš„æ§åˆ¶å¹³é¢ï¼ˆapi-server, scheduler, controller managerï¼‰ï¼Œéƒ¨ç½²å®Œæˆåå†æ›¿æ¢å›æ¥ã€‚</p>
<p>éƒ¨ç½²å‰å°†bootkubeä½œä¸ºæ§åˆ¶å¹³é¢ï¼š</p>
<p><img src="/images/bootkube-1.png" alt="bootkube-1"></p>
<p>éƒ¨ç½²åæ›¿æ¢æˆçœŸæ­£çš„æ§åˆ¶å¹³é¢ï¼š</p>
<p><img src="/images/bootkube-2.png" alt="bootkube-2"></p>
<p>ç›¸å…³æ–‡æ¡£</p>
<ul>
<li><a href="https://github.com/kubernetes-incubator/bootkube" target="_blank" rel="external">Incubator BootKube</a></li>
<li><a href="https://speakerdeck.com/philips/kubecon-2016-self-hosted-scale-and-federation-with-kubernetes-v1-dot-4-and-beyond" target="_blank" rel="external">Slide</a></li>
<li><a href="https://docs.google.com/document/d/1VNp4CMjPPHevh2_JQGMl-hpz9JSLq3s7HlI87CTjl-8/edit" target="_blank" rel="external">Design of bootkube</a></li>
<li><a href="https://coreos.com/blog/self-hosted-kubernetes.html" target="_blank" rel="external">Blog of self-booted kubernetes</a></li>
<li><a href="https://docs.google.com/document/d/1_I6xT0XHCoOqZUT-dtpxzwvYpTR5JmFQY0S4gL2PPkU/edit#heading=h.yeahbhtih70g" target="_blank" rel="external">Kubelet as a Container and Self-Hosted Kubernetes</a></li>
</ul>
<h2 id="F2F"><a href="#F2F" class="headerlink" title="F2F"></a>F2F</h2><p><strong><a href="https://docs.google.com/document/d/1ZVQIzLuHsBFDCw-QLO30rqRlSNSc1xynfs9GAFrjeVc/edit" target="_blank" rel="external">Sig-node F2F</a></strong></p>
<ul>
<li>Performance-Sensitive Application Platform<ul>
<li>é«˜æ€§èƒ½åº”ç”¨çš„åœºæ™¯ï¼Œæ¯”å¦‚telecom, HFTç­‰ï¼Œéœ€è¦NUMAã€GPUã€sysctlsã€hugepageã€cpusetç­‰ç­‰çš„æ”¯æŒã€‚</li>
<li>ä¸€ä¸ªideaæ˜¯é€šè¿‡daemonsetå¹¶é…åˆNodeAllocatable</li>
</ul>
</li>
<li>CRI blockers and progress<ul>
<li>1.5çš„featureåŸºæœ¬å®Œæˆï¼Œåªå‰©ä¸‹ä¸€äº›bug fixes</li>
<li>per-pod cgroups</li>
<li>monitoring</li>
<li>api versioning</li>
<li>hostport network</li>
<li>metrics</li>
<li>CRI validation tests</li>
<li>auth</li>
</ul>
</li>
<li>Runtime agnostic debugging tools<ul>
<li>CLI for CRI?</li>
</ul>
</li>
<li>NodeSpec standardization</li>
<li>Packaging</li>
</ul>
<p><strong><a href="https://docs.google.com/document/d/1wtJeXhiVOL7qdDK_zouZPjskTIrsOLmD-9Ij478y7_Y/edit" target="_blank" rel="external">OCI F2F</a></strong></p>
<p>æœ€ä¸»è¦çš„æ˜¯<code>Runtime CLI Spec</code>å’Œ<code>Image Spec rc3</code>ã€‚æ¯”è¾ƒæœ‰è¶£çš„æ˜¯<a href="https://github.com/vbatts/nspawn-oci" target="_blank" rel="external">systemd wrapper / rkt wrapper for OCI runtime-spec CLI</a>ï¼Œrktä¹Ÿè¦åŠ å…¥OCIçš„å¤§è¥ã€‚</p>
<h2 id="Developer-Summit"><a href="#Developer-Summit" class="headerlink" title="Developer Summit"></a>Developer Summit</h2><p><strong><a href="https://docs.google.com/presentation/d/1SD6a6eJl47t0qyTFE8GzaiytW4T_crdWgYAMCaLy1W8" target="_blank" rel="external">Scaling the Kubernetes CodeBase</a></strong></p>
<p>Kubernetesä½¿ç”¨githubæ¥ç®¡ç†ä»£ç åº“ï¼Œä½†ç°åœ¨ç¢°åˆ°äº†æ˜æ˜¾çš„ç“¶é¢ˆï¼šä»2015å¹´ä¸‹åŠå¹´å¼€å§‹<a href="http://velodrome.k8s.io/dashboard/db/kubernetes-developer-velocity" target="_blank" rel="external">mergeæ—¶é—´æ˜æ˜¾åŠ é•¿</a>ï¼Œopen issueså’ŒPRsä¸€ç›´å†å¢é•¿ï¼Œå¤§é‡æ— å…³ç´§è¦çš„githubé€šçŸ¥ç­‰ç­‰ã€‚æœªæ¥è®¡åˆ’å°†Kubernetesçš„ä»£ç æ‹†åˆ†åˆ°å¤šä¸ªrepoä¸­ï¼Œkuberentesä»£ç åº“åªä¿ç•™æ ¸å¿ƒä»£ç ï¼Œå¹¶é€šè¿‡Extension mechanismæ¥æ”¯æŒå„ç§åŠŸèƒ½ï¼š</p>
<ul>
<li>Apiserver federation</li>
<li>Authorization hooks</li>
<li>Admission-control hooks</li>
<li>Initializers and finalizers</li>
<li>ThirdPartyResource</li>
<li>Kubectl extensions</li>
<li>Service Broker, Operators</li>
<li>Controller pattern</li>
<li>External cloudproviders</li>
<li>CRI, network, and storage plugins</li>
<li>Cluster addons: UI, monitoring, logging</li>
<li>Feature gates, feature discovery, dependency management</li>
</ul>
<p>æ›´å¤šè®°å½•è§<a href="https://docs.google.com/document/d/1zN2DWKerXwbzxZTO52wBRqp_uHMdLp8P52xYOmp5WZ4/edit" target="_blank" rel="external">è¿™é‡Œ</a>.</p>
<p><strong>å…¶ä»–çš„Summitç®€ä»‹</strong></p>
<ul>
<li><a href="https://docs.google.com/presentation/d/1dFfN3_9VM4cRKknZB9_0wsM_1YLJToRTEx7dX6BoEhI" target="_blank" rel="external">Kubernetes 2017 Features &amp; Roadmaps</a> <a href="https://docs.google.com/spreadsheets/d/154cAee2mOn3LoQDgpgG2ZzAIdIlQ_KnMlghGjnGwQ1w" target="_blank" rel="external">Roadmap</a><ul>
<li>Scale the project (tablestakes)</li>
<li>Reference architectures for application workflows</li>
<li>Secure multi-tenancy with service catalog</li>
<li>Production ready cluster lifecycle</li>
<li>Multi-cloud support for AWS / Azure / on premises</li>
</ul>
</li>
<li><a href="https://docs.google.com/document/d/11kK39Zz3zxIY9-GFa8buqqWYOrctFQ7hvOw5NBFwJL0/edit#heading=h.n0vlwrfu65r1" target="_blank" rel="external">Cluster Lifecycle Deployment &amp; Upgrade Roadmap</a><ul>
<li>HA</li>
<li>Upgrades</li>
<li>Config Management</li>
<li>Toolbox vs. guided flow</li>
<li>Documentation</li>
<li>Conformance Testing</li>
<li>PKI</li>
</ul>
</li>
<li><a href="https://docs.google.com/presentation/d/1GFuKgN-1kMmcg41T9HsasP8YEWtMAipEibYnwGkQuHo" target="_blank" rel="external">Documentation</a> and <a href="https://docs.google.com/document/d/1VYoVl63Iq2QSKxpoV7HGXmWasxU5EQCAuoIItj-ODvM/edit" target="_blank" rel="external">here</a></li>
<li><a href="https://docs.google.com/document/d/1cJhpjRcXpTmTWQswEfBqSbrfqrawtD9ZlWW30Q3BWv4/edit" target="_blank" rel="external">K8s Dev Summit: Outstanding Issues and PRs</a><ul>
<li>Issues 4600+, PRs 600+ï¼Œè¿˜åœ¨ä¸æ–­å¢é•¿ä¸­</li>
<li><a href="https://github.com/kubernetes/community/tree/master/sig-contribx" target="_blank" rel="external">Sig Contribx</a>ä¼šè·Ÿè¿›å¤„ç†è¿™ä¸ªé—®é¢˜</li>
</ul>
</li>
<li><a href="https://docs.google.com/document/d/1WmRwT3nhLXTYRLKlj9rjZmEXv3BEu7TFX29nuaO3enA/edit#heading=h.w90umf5dyer3" target="_blank" rel="external">Multi-tenancy</a></li>
<li><a href="https://docs.google.com/document/d/1X5i-Z3GsFyknxq4LyB3cObXEm5ds7DTUYOKwHAMHK5A/edit" target="_blank" rel="external">Azure &amp; AWS Kubernetes Discussion</a></li>
<li><a href="https://docs.google.com/document/d/1klHgGFKtSPHGNlG24LDb5-ornBUtZLcUnEjF8XKXDes/edit" target="_blank" rel="external">Contrib notes</a> and <a href="https://docs.google.com/document/d/19B2vcK6Y3xE3JO7sd4n6lPF0m9bBVZpNucvcR3MwEXA/edit" target="_blank" rel="external">On developer onboarding</a></li>
<li><a href="https://docs.google.com/document/d/1p7scsTPzPyouktBFTxu4RhRwW8yUn5Lj7VGY9SaOo-8/edit" target="_blank" rel="external">Compute resource management</a></li>
<li><a href="https://docs.google.com/document/d/1K2hh7nQ9glYzGE-5J7oKBB7oK3S_MKqwCISXZK-sB2Q/edit" target="_blank" rel="external">Logging volumes</a></li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;é¢˜è®°ï¼šä¸Šå‘¨å»è¥¿é›…å›¾å‚åŠ äº†&lt;a href=&quot;http://events.linuxfoundation.org/events/kubecon&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;KubeCon&amp;amp;CloudNativeCon 2016&lt;/a&gt;
    
    </summary>
    
    
      <category term="kubernetes" scheme="http://feisky.xyz/tags/kubernetes/"/>
    
      <category term="kubecon" scheme="http://feisky.xyz/tags/kubecon/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes container runtime interface</title>
    <link href="http://feisky.xyz/2016/09/24/Kubernetes-container-runtime-interface/"/>
    <id>http://feisky.xyz/2016/09/24/Kubernetes-container-runtime-interface/</id>
    <published>2016-09-24T22:59:31.000Z</published>
    <updated>2016-12-15T00:14:54.373Z</updated>
    
    <content type="html"><![CDATA[<p>é¢˜è®°ï¼šæœ€è¿‘ä¸€æ®µæ—¶é—´åœ¨åšKuberneteså®¹å™¨å¼•æ“æ¥å£ï¼ˆContainer Runtime Interfaceï¼Œ CRIï¼‰çš„é‡æ„ï¼Œå¹¶æ”¯æŒä»¥æ’ä»¶çš„æ–¹å¼å¼•å…¥å¤–éƒ¨å®¹å™¨å¼•æ“ã€‚CRIè¿˜åœ¨ç´§å¼ æœ‰åºçš„å¼€å‘ä¸­ï¼Œé¢„è®¡åœ¨v1.5å‘å¸ƒç¬¬ä¸€ä¸ªalphaç‰ˆã€‚</p>
<h2 id="ä»€ä¹ˆæ˜¯CRI"><a href="#ä»€ä¹ˆæ˜¯CRI" class="headerlink" title="ä»€ä¹ˆæ˜¯CRI"></a>ä»€ä¹ˆæ˜¯CRI</h2><p>CRIæ˜¯Kubeletï¼ˆè´Ÿè´£ç®¡ç†å®¹å™¨ç”Ÿå‘½å‘¨æœŸçš„æœåŠ¡ï¼‰ä¸å®¹å™¨å¼•æ“ä¹‹é—´çš„æ¥å£ã€‚ä¸ºäº†é€‚åº”å¤šç§ä¸åŒçš„å®¹å™¨å¼•æ“ï¼ŒKubeletåœ¨åŠ å…¥rktçš„æ—¶å€™å°±å·²ç»åœ¨docker APIçš„åŸºç¡€ä¸ŠæŠ½è±¡äº†ä¸€ä¸ªRuntimeæ¥å£ï¼Œåªæ˜¯ç”±äºä¸€äº›ç‰¹å®šçš„ç¼ºé™·ï¼Œåœ¨è¿™ä¸ªæ¥å£ä¸Šä¸å¤ªå®¹æ˜“å¼•å…¥å…¶ä»–æ–°çš„å®¹å™¨å¼•æ“ï¼š</p>
<ul>
<li>Runtimeæ¥å£çš„æŠ½è±¡åº¦å¤ªé«˜ï¼Œå¯¼è‡´ä¸€äº›åŸæœ¬è¯¥åœ¨Kubeletæ§åˆ¶çš„é€»è¾‘è¢«æ”¾åˆ°äº†Runtimeå®ç°é‡Œé¢ã€‚æ¯”å¦‚åœ¨å½“å‰çš„å®ç°ä¸­ï¼Œrktå’Œdockerçš„<code>SyncPod</code>ï¼ˆè´Ÿè´£Podåˆ›å»ºçš„æ¥å£ï¼‰å­˜åœ¨å¤§é‡é‡å¤çš„é€»è¾‘ï¼Œæ¯æ¬¡ä¿®æ”¹dockeréƒ¨åˆ†çš„æ—¶ï¼Œéƒ½æœ‰å¯èƒ½éœ€è¦åŒæ—¶ä¿®æ”¹rktéƒ¨åˆ†ã€‚è¿™æ ·ï¼Œå¦‚æœå†åŠ å…¥æ–°çš„å®¹å™¨å¼•æ“çš„è¯ï¼ŒåŒæ—¶ä¿®æ”¹å¤šä¸ªRuntimeéƒ¨åˆ†çš„ä»£ç æ˜¯æ²¡æ³•ç»´æŠ¤çš„ã€‚</li>
<li>Runtimeæ¥å£æ˜¯é›†æˆåœ¨Kubeletå†…éƒ¨çš„ï¼Œé›†æˆå®¹å™¨å¼•æ“ç›¸å…³çš„ä»£ç éœ€è¦æ”¾åˆ°Kubernetesä»£ç åº“é‡Œé¢ï¼Œè¿™åŒæ ·å¸¦æ¥äº†ç»´æŠ¤çš„é—®é¢˜ï¼šä»£ç ç»´æŠ¤éº»çƒ¦ï¼Œä»»ä½•ä¸€ä¸ªå®¹å™¨å¼•æ“ä¿®æ”¹äº†ä»£ç éƒ½éœ€è¦å‘å¸ƒæ–°çš„kubeletï¼›é›†æˆæµ‹è¯•éº»çƒ¦ï¼Œè¦ä¸ºæ¯ä¸ªä¸åŒçš„å®¹å™¨å¼•æ“éƒ¨ç½²ä¸åŒçš„é›†æˆæµ‹è¯•ç¯å¢ƒã€‚</li>
<li>æ²¡æœ‰æä¾›å®¹å™¨åˆ›å»ºçš„æ¥å£ï¼Œæ— æ³•ç›´æ¥åœ¨Kubeleté‡Œé¢åšåˆ°å¯¹å®¹å™¨çš„ç²¾ç»†æ§åˆ¶ã€‚</li>
<li>è€¦åˆäº†é•œåƒå’Œå®¹å™¨ç®¡ç†ï¼Œè€Œå®ƒä»¬çš„ç”Ÿå‘½å‘¨æœŸæœ¬æ¥å°±æ˜¯ç‹¬ç«‹çš„ã€‚</li>
</ul>
<p>æ—¢ç„¶Runtimeæ¥å£æœ‰å¾ˆå¤šé—®é¢˜ï¼Œå¹¶ä¸”æœ‰å¾ˆå¤šå®¹å™¨å¼•æ“æƒ³è¦é›†æˆåˆ°Kubernetesä¸­ï¼Œæ‰€ä»¥æœ‰å¿…è¦é‡æ–°å®šä¹‰CRIï¼Œå¹¶ä¸”æä¾›ä¸€ç§æ’ä»¶æœºåˆ¶ï¼Œå…è®¸å®¹å™¨å¼•æ“ä»¥å¤–éƒ¨ç‹¬ç«‹è¿›ç¨‹çš„æ–¹å¼æ¥å…¥ã€‚æ‰€ä»¥ï¼ŒBrendan Burnsåœ¨<a href="http://hypercontainer.io" target="_blank" rel="external">Hyper</a>é›†æˆçš„æ—¶å€™å°±æä¾›äº†ä¸€ç§ä»¥å®¢æˆ·ç«¯/æœåŠ¡å™¨æ–¹å¼æ¥å…¥å¤–éƒ¨å®¹å™¨å¼•æ“çš„æ€è·¯ã€‚åœ¨å¤§é‡çš„ç¤¾åŒºè®¨è®ºåï¼ŒNode teamé‡æ–°æŠ½è±¡äº†å®¹å™¨å¼•æ“æ¥å£ï¼ˆä¹Ÿå°±æ˜¯CRIï¼‰ï¼Œå¹¶å†³å®šä»¥gRPCçš„æ–¹å¼æ¥å…¥å¤–éƒ¨å®¹å™¨å¼•æ“ã€‚</p>
<h2 id="CRIæ˜¯å¦‚ä½•å·¥ä½œçš„"><a href="#CRIæ˜¯å¦‚ä½•å·¥ä½œçš„" class="headerlink" title="CRIæ˜¯å¦‚ä½•å·¥ä½œçš„"></a>CRIæ˜¯å¦‚ä½•å·¥ä½œçš„</h2><p>CRIæ¯”Runtimeæ¥å£æä¾›äº†æ›´ç»†ç²’åº¦çš„æŠ½è±¡ï¼Œè§£è€¦äº†é•œåƒç®¡ç†å’Œå®¹å™¨ç®¡ç†ï¼Œå¹¶ä¸ºPodå’ŒContaineræä¾›äº†ç‹¬ç«‹çš„æ“ä½œæ¥å£ã€‚CRIä»¥gRPCçš„æ–¹å¼æ¥å…¥ï¼ŒKubeletæ˜¯gPRC APIçš„å®¢æˆ·ç«¯ï¼Œè€Œå®¹å™¨å¼•æ“åˆ™æ˜¯gRPC APIçš„æœåŠ¡ç«¯ã€‚gRPCå·²ç»è‡ªåŠ¨å®ç°äº†å®ƒä»¬ä¹‹é—´äº¤äº’çš„ç»†èŠ‚ï¼Œå®¹å™¨å¼•æ“åªéœ€è¦å®ç°æ¯ä¸ªå…·ä½“çš„APIã€‚</p>
<p>ä¸€ä¸ªå…¸å‹çš„å¯åŠ¨Podçš„æµç¨‹ä¸º</p>
<p><img src="/images/createpod.png" alt="createpod"></p>
<p>è€Œåœæ­¢Podçš„æµç¨‹ä¸º</p>
<p><img src="/images/killpod.png" alt="killpod"></p>
<h2 id="CRIå¸¦äº†ä»€ä¹ˆ"><a href="#CRIå¸¦äº†ä»€ä¹ˆ" class="headerlink" title="CRIå¸¦äº†ä»€ä¹ˆ"></a>CRIå¸¦äº†ä»€ä¹ˆ</h2><p>CRIè§£å†³äº†ä¸Šè¿°æåˆ°çš„Runtimeæ¥å£çš„é—®é¢˜ï¼Œä½¿å¾—æ–°çš„å®¹å™¨å¼•æ“å¯ä»¥æ›´æ–¹ä¾¿çš„é›†æˆåˆ°Kubernetesä¸­æ¥ï¼Œè¿™å¿…å°†ç»™Kubernetesç¤¾åŒºå¸¦æ¥æ–°ä¸€è½®çš„å˜é©ï¼Œå¹¶ä¿ƒè¿›Kubernetesèµ°å…¥æ›´å¤šçš„åº”ç”¨åœºæ™¯ä¸­ã€‚æ¯”å¦‚ï¼ŒRedhatå€ŸåŠ©OCIå®¹å™¨å¼•æ“runcæ‘†è„±å¯¹dockerä¾èµ–ï¼ŒHyperä»¥è™šæ‹ŸåŒ–çš„æ–¹å¼è§£å†³å¤šç§Ÿæˆ·åœºæ™¯ä¸‹çš„å®¹å™¨éš”ç¦»é—®é¢˜ï¼Œç”šè‡³Mirantisç›´æ¥ç”¨Kubernetesæ¥ç®¡ç†åŸç”Ÿçš„è™šæ‹Ÿæœºã€‚</p>
<p>CRIä¹Ÿè§£è€¦äº†å®¹å™¨å’Œé•œåƒçš„ç®¡ç†ï¼Œå¯ä»¥æ–¹ä¾¿çš„æ‰©å±•å…¶ä»–é•œåƒæ ¼å¼ï¼Œæ¯”å¦‚ACIç­‰ã€‚</p>
<p>CRIè¿˜åœ¨ç€åŠ›è§£å†³ä¸€äº›å¾ˆæœ‰æŒ‘æˆ˜çš„é—®é¢˜ï¼Œæ¯”å¦‚</p>
<ul>
<li>å®¹å™¨æ—¥å¿—çš„ç®¡ç†ï¼ŒåŒ…æ‹¬æ—¥å¿—æ ¼å¼åŒ–è§„èŒƒã€æ—¥å¿—æ–‡ä»¶rotateã€æ—¥å¿—æ–‡ä»¶ç£ç›˜IOæ§åˆ¶ä»¥åŠæ—¥å¿—çš„ç»Ÿä¸€æ”¶é›†å¤„ç†ç­‰ã€‚</li>
<li>è§£é™¤streaming APIï¼ˆexecã€attachã€logsç­‰ï¼‰å¯¹kubeletçš„ç½‘ç»œå‹åŠ›ã€‚å½“å‰æ‰€æœ‰çš„streaming APIéƒ½æ˜¯ä»<code>apiserver-&gt;kubelet-&gt;runtime</code>ï¼Œapiserveræ˜¯æ— çŠ¶æ€çš„ï¼Œå¯ä»¥æ°´å¹³æ‰©å±•ï¼Œä½†kubeletå’Œruntimeåˆ™æ˜¯æ¯å°æœºå™¨åªèƒ½æœ‰ä¸€ä¸ªï¼Œstreaming APIæœ‰å¯èƒ½ä¼šç»™ä»–ä»¬å¸¦æ¥å¤„ç†çš„ç“¶é¢ˆã€‚æ‰€ä»¥åœ¨CRIä¸­ï¼Œå°†ä¼šè€ƒè™‘ä½¿ç”¨ä¸€ä¸ªç‹¬ç«‹è¿›ç¨‹ï¼ˆéœ€è¦å¯¹apiserverå¼€æ”¾ç«¯å£ï¼‰æ¥å•ç‹¬å¤„ç†è¿™äº›è¯·æ±‚<code>apiserver-&gt;newStreamProcess</code>ï¼Œé‡Šæ”¾kubeletæ¥åšæ›´æ ¸å¿ƒçš„äº‹æƒ…ã€‚</li>
<li>æ›´çµæ´»çš„ç½‘ç»œé…ç½®ï¼Œå°†Podç½‘ç»œçš„é…ç½®å®Œå…¨äº¤ç»™å®¹å™¨å¼•æ“ï¼Œè€ŒKubernetesåªéœ€è¦æœ€ç»ˆçš„ç½‘ç»œçŠ¶æ€ã€‚</li>
</ul>
<h2 id="CRIçš„æœªæ¥"><a href="#CRIçš„æœªæ¥" class="headerlink" title="CRIçš„æœªæ¥"></a>CRIçš„æœªæ¥</h2><p>è™½ç„¶CRIè¿˜åœ¨æŒç»­å¼€å‘ä¸­ï¼ˆç›®å‰è¿˜æ²¡æœ‰ä»»ä½•releaseï¼‰ï¼Œä½†å·²ç»æœ‰å¾ˆå¤šå‚å•†å·²ç»å¼€å§‹äº†å¼•å…¥æ–°å®¹å™¨å¼•æ“çš„è¿›ç¨‹ï¼š</p>
<ul>
<li>Fraktiï¼šä¸ºè§£å†³å¤šç§Ÿæˆ·åœºæ™¯ä¸‹çš„å®¹å™¨éš”ç¦»é—®é¢˜ï¼ŒHyperä»¥è™šæ‹ŸåŒ–çš„æ–¹å¼è¿è¡Œå®¹å™¨ã€‚å…³äºfraktiçš„æ›´å¤šç»†èŠ‚è§<a href="https://github.com/kubernetes/fraktiã€‚" target="_blank" rel="external">https://github.com/kubernetes/fraktiã€‚</a></li>
<li>OCI-Oï¼šä¸ºè§£è€¦å¯¹dockerçš„ä¾èµ–ï¼ŒRedhatæä¾›å¯¹OCIå®¹å™¨å¼•æ“çš„æ”¯æŒï¼ˆç›®å‰ä¸»è¦æ˜¯runcï¼‰ã€‚å…³äºoci-oçš„æ›´å¤šç»†èŠ‚è§<a href="https://github.com/kubernetes-incubator/oci-oã€‚" target="_blank" rel="external">https://github.com/kubernetes-incubator/oci-oã€‚</a></li>
<li>Rktletï¼šä¸ºäº†åŠ é€Ÿrktå®¹å™¨å¼•æ“çš„å¼€å‘ç»´æŠ¤ï¼ŒCoreOSæè®®å°†rkté›†æˆçš„ä»£ç ç‹¬ç«‹å‡ºKubeletï¼ˆvendoråˆ°kubeletï¼ŒåŒé›†æˆåˆ°kubeletå†…éƒ¨ä¾¿äºå‘å¸ƒï¼‰ï¼Œå¹¶é‡æ„rktä»¥é€‚åº”CRIçš„å˜åŒ–ã€‚å…³äºrktletçš„æ›´å¤šç»†èŠ‚è§<a href="https://github.com/kubernetes-incubator/rktletã€‚" target="_blank" rel="external">https://github.com/kubernetes-incubator/rktletã€‚</a></li>
<li>Virtletï¼šä¸ºäº†æ”¯æŒåŸç”Ÿçš„è™šæ‹Ÿæœºç®¡ç†ï¼ŒMirantisæè®®ç›´æ¥ç”¨Kubernetesæ¥ç®¡ç†åŸç”Ÿçš„è™šæ‹Ÿæœºï¼ˆéœ€è¦å°†dockeré•œåƒæ›¿æ¢æˆqcow2é•œåƒï¼‰ã€‚å…³äºvirtletçš„æ›´å¤šç»†èŠ‚è§<a href="https://github.com/Mirantis/virtletã€‚" target="_blank" rel="external">https://github.com/Mirantis/virtletã€‚</a></li>
<li>å½“ç„¶ï¼Œdockerç›¸å…³çš„ä»£ç è¿˜ä¼šç»§ç»­ä¿ç•™åœ¨kubeletå†…éƒ¨ï¼Œåªä¸è¿‡è¦é‡æ„åˆ°CRIä¸Šé¢æ¥ã€‚</li>
</ul>
<p>CRIé¢„è®¡åœ¨Kubernetes v1.5å‘å¸ƒç¬¬ä¸€ä¸ªalphaç‰ˆã€‚å±Šæ—¶ï¼Œä¸Šé¢å„ä¸ªå®¹å™¨å¼•æ“çš„å®ç°ä¹Ÿå°†ä¼šå‘å¸ƒç¬¬ä¸€ä¸ªreleaseã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;é¢˜è®°ï¼šæœ€è¿‘ä¸€æ®µæ—¶é—´åœ¨åšKuberneteså®¹å™¨å¼•æ“æ¥å£ï¼ˆContainer Runtime Interfaceï¼Œ CRIï¼‰çš„é‡æ„ï¼Œå¹¶æ”¯æŒä»¥æ’ä»¶çš„æ–¹å¼å¼•å…¥å¤–éƒ¨å®¹å™¨å¼•æ“ã€‚CRIè¿˜åœ¨ç´§å¼ æœ‰åºçš„å¼€å‘ä¸­ï¼Œé¢„è®¡åœ¨v1.5å‘å¸ƒç¬¬ä¸€ä¸ªalphaç‰ˆã€‚&lt;/p&gt;
&lt;h2 id=&quot;ä»€ä¹ˆæ˜¯CRI&quot;&gt;
    
    </summary>
    
    
      <category term="kubernetes" scheme="http://feisky.xyz/tags/kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetesä¸­çš„æœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡</title>
    <link href="http://feisky.xyz/2016/09/11/Kubernetes%E4%B8%AD%E7%9A%84%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0%E4%B8%8E%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/"/>
    <id>http://feisky.xyz/2016/09/11/Kubernetesä¸­çš„æœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡/</id>
    <published>2016-09-11T01:48:09.000Z</published>
    <updated>2016-12-15T00:14:54.373Z</updated>
    
    <content type="html"><![CDATA[<p>Kubernetesåœ¨è®¾è®¡ä¹‹åˆå°±å……åˆ†è€ƒè™‘äº†é’ˆå¯¹å®¹å™¨çš„æœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡æœºåˆ¶ï¼Œæä¾›äº†Serviceèµ„æºï¼Œå¹¶é€šè¿‡kube-proxyé…åˆcloud provideræ¥é€‚åº”ä¸åŒçš„åº”ç”¨åœºæ™¯ã€‚éšç€kubernetesç”¨æˆ·çš„æ¿€å¢ï¼Œç”¨æˆ·åœºæ™¯çš„ä¸æ–­ä¸°å¯Œï¼Œåˆäº§ç”Ÿäº†ä¸€äº›æ–°çš„è´Ÿè½½å‡è¡¡æœºåˆ¶ã€‚ç›®å‰ï¼Œkubernetesä¸­çš„è´Ÿè½½å‡è¡¡å¤§è‡´å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ç§æœºåˆ¶ï¼Œæ¯ç§æœºåˆ¶éƒ½æœ‰å…¶ç‰¹å®šçš„åº”ç”¨åœºæ™¯ï¼š</p>
<ul>
<li>Serviceï¼šç›´æ¥ç”¨Serviceæä¾›clusterå†…éƒ¨çš„è´Ÿè½½å‡è¡¡ï¼Œå¹¶å€ŸåŠ©cloud provideræä¾›çš„LBæä¾›å¤–éƒ¨è®¿é—®</li>
<li>Ingress Controllerï¼šè¿˜æ˜¯ç”¨Serviceæä¾›clusterå†…éƒ¨çš„è´Ÿè½½å‡è¡¡ï¼Œä½†æ˜¯é€šè¿‡è‡ªå®šä¹‰LBæä¾›å¤–éƒ¨è®¿é—®</li>
<li>Service Load Balancerï¼šæŠŠload balancerç›´æ¥è·‘åœ¨å®¹å™¨ä¸­ï¼Œå®ç°Bare Metalçš„Service Load Balancer</li>
<li>Custom Load Balancerï¼šè‡ªå®šä¹‰è´Ÿè½½å‡è¡¡ï¼Œå¹¶æ›¿ä»£kube-proxyï¼Œä¸€èˆ¬åœ¨ç‰©ç†éƒ¨ç½²Kubernetesæ—¶ä½¿ç”¨ï¼Œæ–¹ä¾¿æ¥å…¥å…¬å¸å·²æœ‰çš„å¤–éƒ¨æœåŠ¡</li>
</ul>
<h2 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h2><p><img src="/images/k8s-service.png" alt=""></p>
<p>Serviceæ˜¯å¯¹ä¸€ç»„æä¾›ç›¸åŒåŠŸèƒ½çš„Podsçš„æŠ½è±¡ï¼Œå¹¶ä¸ºå®ƒä»¬æä¾›ä¸€ä¸ªç»Ÿä¸€çš„å…¥å£ã€‚å€ŸåŠ©Serviceï¼Œåº”ç”¨å¯ä»¥æ–¹ä¾¿çš„å®ç°æœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡ï¼Œå¹¶å®ç°åº”ç”¨çš„é›¶å®•æœºå‡çº§ã€‚Serviceé€šè¿‡æ ‡ç­¾æ¥é€‰å–æœåŠ¡åç«¯ï¼Œä¸€èˆ¬é…åˆReplication Controlleræˆ–è€…Deploymentæ¥ä¿è¯åç«¯å®¹å™¨çš„æ­£å¸¸è¿è¡Œã€‚</p>
<p>Serviceæœ‰ä¸‰ç§ç±»å‹ï¼š</p>
<ul>
<li>ClusterIPï¼šé»˜è®¤ç±»å‹ï¼Œè‡ªåŠ¨åˆ†é…ä¸€ä¸ªä»…clusterå†…éƒ¨å¯ä»¥è®¿é—®çš„è™šæ‹ŸIP</li>
<li>NodePortï¼šåœ¨ClusterIPåŸºç¡€ä¸Šä¸ºServiceåœ¨æ¯å°æœºå™¨ä¸Šç»‘å®šä¸€ä¸ªç«¯å£ï¼Œè¿™æ ·å°±å¯ä»¥é€šè¿‡<code>&lt;NodeIP&gt;:NodePort</code>æ¥è®¿é—®æ”¹æœåŠ¡</li>
<li>LoadBalancerï¼šåœ¨NodePortçš„åŸºç¡€ä¸Šï¼Œå€ŸåŠ©cloud provideråˆ›å»ºä¸€ä¸ªå¤–éƒ¨çš„è´Ÿè½½å‡è¡¡å™¨ï¼Œå¹¶å°†è¯·æ±‚è½¬å‘åˆ°<code>&lt;NodeIP&gt;:NodePort</code></li>
</ul>
<p>å¦å¤–ï¼Œä¹Ÿå¯ä»¥è®²å·²æœ‰çš„æœåŠ¡ä»¥Serviceçš„å½¢å¼åŠ å…¥åˆ°Kubernetesé›†ç¾¤ä¸­æ¥ï¼Œåªéœ€è¦åœ¨åˆ›å»ºServiceçš„æ—¶å€™ä¸æŒ‡å®šLabel selectorï¼Œè€Œæ˜¯åœ¨Serviceåˆ›å»ºå¥½åæ‰‹åŠ¨ä¸ºå…¶æ·»åŠ endpointã€‚</p>
<h2 id="Ingress-Controller"><a href="#Ingress-Controller" class="headerlink" title="Ingress Controller"></a>Ingress Controller</h2><p>Serviceè™½ç„¶è§£å†³äº†æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡çš„é—®é¢˜ï¼Œä½†å®ƒåœ¨ä½¿ç”¨ä¸Šè¿˜æ˜¯æœ‰ä¸€äº›é™åˆ¶ï¼Œæ¯”å¦‚</p>
<p>ï¼ åªæ”¯æŒ4å±‚è´Ÿè½½å‡è¡¡ï¼Œæ²¡æœ‰7å±‚åŠŸèƒ½<br>ï¼ å¯¹å¤–è®¿é—®çš„æ—¶å€™ï¼ŒNodePortç±»å‹éœ€è¦åœ¨å¤–éƒ¨æ­å»ºé¢å¤–çš„è´Ÿè½½å‡è¡¡ï¼Œè€ŒLoadBalancerè¦æ±‚kuberneteså¿…é¡»è·‘åœ¨æ”¯æŒçš„cloud providerä¸Šé¢</p>
<p>Ingresså°±æ˜¯ä¸ºäº†è§£å†³è¿™äº›é™åˆ¶è€Œå¼•å…¥çš„æ–°èµ„æºï¼Œä¸»è¦ç”¨æ¥å°†æœåŠ¡æš´éœ²åˆ°clusterå¤–é¢ï¼Œå¹¶ä¸”å¯ä»¥è‡ªå®šä¹‰æœåŠ¡çš„è®¿é—®ç­–ç•¥ã€‚æ¯”å¦‚æƒ³è¦é€šè¿‡è´Ÿè½½å‡è¡¡å™¨å®ç°ä¸åŒå­åŸŸååˆ°ä¸åŒæœåŠ¡çš„è®¿é—®ï¼š</p>
<figure class="highlight gherkin"><table><tr><td class="code"><pre><div class="line">foo.bar.com --|<span class="string">                 </span>|<span class="string">-&gt; foo.bar.com s1:80</span></div><div class="line">              |<span class="string"> 178.91.123.132  </span>|</div><div class="line">bar.foo.com --|<span class="string">                 </span>|<span class="string">-&gt; bar.foo.com s2:80</span></div></pre></td></tr></table></figure>
<p>å¯ä»¥è¿™æ ·æ¥å®šä¹‰Ingressï¼š</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><div class="line"><span class="attr">apiVersion:</span> extensions/v1beta1</div><div class="line"><span class="attr">kind:</span> Ingress</div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> test</div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  rules:</span></div><div class="line"><span class="attr">  - host:</span> foo.bar.com</div><div class="line"><span class="attr">    http:</span></div><div class="line"><span class="attr">      paths:</span></div><div class="line"><span class="attr">      - backend:</span></div><div class="line"><span class="attr">          serviceName:</span> s1</div><div class="line"><span class="attr">          servicePort:</span> <span class="number">80</span></div><div class="line"><span class="attr">  - host:</span> bar.foo.com</div><div class="line"><span class="attr">    http:</span></div><div class="line"><span class="attr">      paths:</span></div><div class="line"><span class="attr">      - backend:</span></div><div class="line"><span class="attr">          serviceName:</span> s2</div><div class="line"><span class="attr">          servicePort:</span> <span class="number">80</span></div></pre></td></tr></table></figure>
<p>æ³¨æ„Ingressæœ¬èº«å¹¶ä¸ä¼šè‡ªåŠ¨åˆ›å»ºè´Ÿè½½å‡è¡¡å™¨ï¼Œclusterä¸­éœ€è¦è¿è¡Œä¸€ä¸ªingress controlleræ¥æ ¹æ®Ingressçš„å®šä¹‰æ¥ç®¡ç†è´Ÿè½½å‡è¡¡å™¨ã€‚ç›®å‰ç¤¾åŒºæä¾›äº†nginxå’Œgceçš„å‚è€ƒå®ç°ã€‚</p>
<h2 id="Service-Load-Balancer"><a href="#Service-Load-Balancer" class="headerlink" title="Service Load Balancer"></a>Service Load Balancer</h2><p>åœ¨Ingresså‡ºç°ä»¥å‰ï¼ŒService Load Balanceræ˜¯æ¨èçš„è§£å†³Serviceå±€é™æ€§çš„æ–¹å¼ã€‚Service Load Balancerå°†haproxyè·‘åœ¨å®¹å™¨ä¸­ï¼Œå¹¶ç›‘æ§serviceå’Œendpointçš„å˜åŒ–ï¼Œé€šè¿‡å®¹å™¨IPå¯¹å¤–æä¾›4å±‚å’Œ7å±‚è´Ÿè½½å‡è¡¡æœåŠ¡ã€‚</p>
<p>ç¤¾åŒºæä¾›çš„Service Load Balanceræ”¯æŒå››ç§è´Ÿè½½å‡è¡¡åè®®ï¼šTCPã€HTTPã€HTTPSå’ŒSSL TERMINATIONï¼Œå¹¶æ”¯æŒACLè®¿é—®æ§åˆ¶ã€‚</p>
<h2 id="Custom-Load-Balancer"><a href="#Custom-Load-Balancer" class="headerlink" title="Custom Load Balancer"></a>Custom Load Balancer</h2><p>è™½ç„¶Kubernetesæä¾›äº†ä¸°å¯Œçš„è´Ÿè½½å‡è¡¡æœºåˆ¶ï¼Œä½†åœ¨å®é™…ä½¿ç”¨çš„æ—¶å€™ï¼Œè¿˜æ˜¯ä¼šç¢°åˆ°ä¸€äº›å¤æ‚çš„åœºæ™¯æ˜¯å®ƒä¸èƒ½æ”¯æŒçš„ï¼Œæ¯”å¦‚</p>
<ul>
<li>æ¥å…¥å·²æœ‰çš„è´Ÿè½½å‡è¡¡è®¾å¤‡</li>
<li>å¤šç§Ÿæˆ·ç½‘ç»œæƒ…å†µä¸‹ï¼Œå®¹å™¨ç½‘ç»œå’Œä¸»æœºç½‘ç»œæ˜¯éš”ç¦»çš„ï¼Œè¿™æ ·<code>kube-proxy</code>å°±ä¸èƒ½æ­£å¸¸å·¥ä½œ</li>
</ul>
<p>è¿™ä¸ªæ—¶å€™å°±å¯ä»¥è‡ªå®šä¹‰ç»„ä»¶ï¼Œå¹¶ä»£æ›¿kube-proxyæ¥åšè´Ÿè½½å‡è¡¡ã€‚åŸºæœ¬çš„æ€è·¯æ˜¯ç›‘æ§kubernetesä¸­serviceå’Œendpointsçš„å˜åŒ–ï¼Œå¹¶æ ¹æ®è¿™äº›å˜åŒ–æ¥é…ç½®è´Ÿè½½å‡è¡¡å™¨ã€‚æ¯”å¦‚weave fluxã€nginx plusã€kube2haproxyç­‰</p>
<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul>
<li><a href="http://kubernetes.io/docs/user-guide/services/" target="_blank" rel="external">http://kubernetes.io/docs/user-guide/services/</a></li>
<li><a href="http://kubernetes.io/docs/user-guide/ingress/" target="_blank" rel="external">http://kubernetes.io/docs/user-guide/ingress/</a></li>
<li><a href="https://github.com/kubernetes/contrib/tree/master/service-loadbalancer" target="_blank" rel="external">https://github.com/kubernetes/contrib/tree/master/service-loadbalancer</a></li>
<li><a href="https://www.nginx.com/blog/load-balancing-kubernetes-services-nginx-plus/" target="_blank" rel="external">https://www.nginx.com/blog/load-balancing-kubernetes-services-nginx-plus/</a></li>
<li><a href="https://github.com/weaveworks/flux" target="_blank" rel="external">https://github.com/weaveworks/flux</a></li>
<li><a href="https://github.com/AdoHe/kube2haproxy" target="_blank" rel="external">https://github.com/AdoHe/kube2haproxy</a></li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Kubernetesåœ¨è®¾è®¡ä¹‹åˆå°±å……åˆ†è€ƒè™‘äº†é’ˆå¯¹å®¹å™¨çš„æœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡æœºåˆ¶ï¼Œæä¾›äº†Serviceèµ„æºï¼Œå¹¶é€šè¿‡kube-proxyé…åˆcloud provideræ¥é€‚åº”ä¸åŒçš„åº”ç”¨åœºæ™¯ã€‚éšç€kubernetesç”¨æˆ·çš„æ¿€å¢ï¼Œç”¨æˆ·åœºæ™¯çš„ä¸æ–­ä¸°å¯Œï¼Œåˆäº§ç”Ÿäº†ä¸€äº›æ–°çš„è´Ÿè½½å‡è¡¡æœºåˆ¶ã€‚ç›®å‰ï¼Œ
    
    </summary>
    
    
      <category term="kubernetes" scheme="http://feisky.xyz/tags/kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>å¦‚ä½•å¿«é€Ÿå¯åŠ¨ä¸€ä¸ªKubernetesé›†ç¾¤</title>
    <link href="http://feisky.xyz/2016/08/24/%E5%A6%82%E4%BD%95%E5%BF%AB%E9%80%9F%E5%90%AF%E5%8A%A8%E4%B8%80%E4%B8%AAKubernetes%E9%9B%86%E7%BE%A4/"/>
    <id>http://feisky.xyz/2016/08/24/å¦‚ä½•å¿«é€Ÿå¯åŠ¨ä¸€ä¸ªKubernetesé›†ç¾¤/</id>
    <published>2016-08-24T06:48:44.000Z</published>
    <updated>2016-12-15T00:14:54.373Z</updated>
    
    <content type="html"><![CDATA[<p>ç›¸æ¯”Dockerä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶è§£å†³æ‰€æœ‰é—®é¢˜ï¼ŒKubernetesåˆ™ä¸ºä¸åŒçš„æœåŠ¡æä¾›äº†ä¸åŒçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¹¶å°†ä¸€äº›æœåŠ¡æ”¾åˆ°äº†addonsä¸­ã€‚æ•…è€Œï¼ŒKubernetesçš„éƒ¨ç½²ç›¸å¯¹è¦éº»çƒ¦çš„å¤šã€‚å€ŸåŠ©<a href="https://github.com/kubernetes/minikube" target="_blank" rel="external">minikube</a>é¡¹ç›®ï¼Œç°åœ¨å¯ä»¥å¾ˆæ–¹ä¾¿çš„åœ¨æœ¬æœºå¿«é€Ÿå¯åŠ¨ä¸€ä¸ªå•èŠ‚ç‚¹çš„Kubernetesé›†ç¾¤ã€‚</p>
<h2 id="å®‰è£…minikube"><a href="#å®‰è£…minikube" class="headerlink" title="å®‰è£…minikube"></a>å®‰è£…minikube</h2><p>minikubeæœ€æ–°releaseç‰ˆæœ¬ä¸ºv0.8.0ï¼Œæ”¯æŒKubernetes v1.3.0åˆ°v1.3.5çš„å„ä¸ªç‰ˆæœ¬ï¼Œé»˜è®¤å¯åŠ¨Kubernetes v1.3.5ã€‚</p>
<p>OSX</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><div class="line">curl -Lo minikube https:<span class="regexp">//</span>storage.googleapis.com<span class="regexp">/minikube/</span>releases<span class="regexp">/v0.8.0/mi</span>nikube-darwin-amd64 &amp;&amp; chmod +x minikube &amp;&amp; sudo mv minikube <span class="regexp">/usr/</span>local<span class="regexp">/bin/</span></div></pre></td></tr></table></figure>
<p>Linux</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><div class="line">curl -Lo minikube https:<span class="regexp">//</span>storage.googleapis.com<span class="regexp">/minikube/</span>releases<span class="regexp">/v0.8.0/mi</span>nikube-linux-amd64 &amp;&amp; chmod +x minikube &amp;&amp; sudo mv minikube <span class="regexp">/usr/</span>local<span class="regexp">/bin/</span></div></pre></td></tr></table></figure>
<p>Windows</p>
<figure class="highlight vim"><table><tr><td class="code"><pre><div class="line">ä¸‹è½½http<span class="variable">s:</span>//storage.googleapis.<span class="keyword">com</span>/minikube/releases/v0.<span class="number">8.0</span>/minikube-windows-amd64.<span class="keyword">exe</span>ï¼Œå¹¶é‡å‘½åä¸ºminikube.<span class="keyword">exe</span></div></pre></td></tr></table></figure>
<p>minikubeæ”¯æŒxhyve(on OSX)ã€VirtualBoxã€VMWare Fusionç­‰å¤šç§ä¸åŒçš„driverï¼Œè¿™äº›driverä¹Ÿéœ€è¦å•ç‹¬å®‰è£…ï¼Œæ¯”å¦‚åœ¨OSXä¸Šå®‰è£…xhyve driver:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><div class="line">brew install docker-machine-driver-xhyve</div><div class="line"><span class="comment"># docker-machine-driver-xhyve need root owner and uid</span></div><div class="line">sudo chown root:wheel $(brew --prefix)/opt/docker-machine-driver-xhyve/bin/docker-machine-driver-xhyve</div><div class="line">sudo chmod u+s $(brew --prefix)/opt/docker-machine-driver-xhyve/bin/docker-machine-driver-xhyve</div></pre></td></tr></table></figure>
<p>å¦å¤–ï¼Œè¿˜éœ€è¦å®‰è£…ä¸€ä¸ª<code>kubectl</code>å®¢æˆ·ç«¯ï¼Œç”¨æ¥è·Ÿkubernetesäº¤äº’ï¼š</p>
<figure class="highlight cmake"><table><tr><td class="code"><pre><div class="line">gcloud components <span class="keyword">install</span> kubectl</div></pre></td></tr></table></figure>
<h2 id="å¯åŠ¨Kubernetes-Cluster"><a href="#å¯åŠ¨Kubernetes-Cluster" class="headerlink" title="å¯åŠ¨Kubernetes Cluster"></a>å¯åŠ¨Kubernetes Cluster</h2><p>å¯åŠ¨Kubernetes Clusterå°±éå¸¸ç®€å•äº†ï¼Œä¸€ä¸ªå‘½ä»¤å³å¯ï¼š</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><div class="line">$ minikube <span class="keyword">start</span></div><div class="line"><span class="keyword">Starting</span> <span class="keyword">local</span> Kubernetes cluster...</div><div class="line">Kubectl <span class="keyword">is</span> <span class="keyword">now</span> configured <span class="keyword">to</span> <span class="keyword">use</span> the cluster.</div></pre></td></tr></table></figure>
<p>å½“ç„¶äº†ï¼Œå›½å†…ç¯å¢ƒä¸‹ï¼Œæœ€å¥½åŠ ä¸Šä»£ç†ï¼š</p>
<figure class="highlight armasm"><table><tr><td class="code"><pre><div class="line"><span class="symbol">minikube</span> start --docker-env HTTP_PROXY<span class="symbol">=http</span>://proxy-<span class="built_in">ip</span>:port --docker-env HTTPS_PROXY<span class="symbol">=http</span>://proxy-<span class="built_in">ip</span>:port</div></pre></td></tr></table></figure>
<p>ç„¶åå°±å¯ä»¥é€šè¿‡kubectlæ¥ç©Kubernetesäº†ï¼Œæ¯”å¦‚å¯åŠ¨ä¸€ä¸ªç®€å•çš„nginxæœåŠ¡ï¼š</p>
<figure class="highlight livecodeserver"><table><tr><td class="code"><pre><div class="line">$ kubectl run nginx <span class="comment">--image=nginx --port=80</span></div><div class="line">deployment <span class="string">"nginx"</span> created</div><div class="line">$ kubectl expose deployment nginx <span class="comment">--port=80 --type=NodePort --name=nginx-http</span></div><div class="line">service <span class="string">"nginx-http"</span> exposed</div><div class="line">$ kubectl <span class="built_in">get</span> pods</div><div class="line">NAME                     READY     STATUS    RESTARTS   AGE</div><div class="line">nginx<span class="number">-2032906785</span><span class="number">-81</span>t56   <span class="number">1</span>/<span class="number">1</span>       Running   <span class="number">0</span>          <span class="number">2</span>m</div><div class="line">$ kubectl <span class="built_in">get</span> services</div><div class="line">NAME         CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE</div><div class="line">kubernetes   <span class="number">10.0</span><span class="number">.0</span><span class="number">.1</span>     &lt;<span class="literal">none</span>&gt;        <span class="number">443</span>/TCP   <span class="number">20</span>m</div><div class="line">nginx-<span class="keyword">http</span>   <span class="number">10.0</span><span class="number">.0</span><span class="number">.146</span>   &lt;<span class="literal">none</span>&gt;        <span class="number">80</span>/TCP    <span class="number">2</span>m</div><div class="line">$ minikube service nginx-<span class="keyword">http</span> <span class="comment">--url</span></div><div class="line"><span class="keyword">http</span>://<span class="number">192.168</span><span class="number">.64</span><span class="number">.10</span>:<span class="number">30569</span></div></pre></td></tr></table></figure>
<p>è¿™æ ·å°±å¯ä»¥é€šè¿‡<code>http://192.168.64.10:30569</code>æ¥ç›´æ¥è®¿é—®nginxæœåŠ¡ã€‚</p>
<p>minikubeé»˜è®¤è¿˜éƒ¨ç½²äº†æœ€æ–°çš„dashboardï¼Œå¯ä»¥é€šè¿‡<code>minikube dashboard</code>å‘½ä»¤åœ¨é»˜è®¤æµè§ˆå™¨ä¸­æ‰“å¼€ï¼š</p>
<p><img src="/images/k8s-dashboard.png" alt="k8s-dashboard"></p>
<p>æ›´å¤šçš„ç©æ³•å¯ä»¥å‚è€ƒminikubeçš„å¸®åŠ©æ–‡æ¡£ï¼š</p>
<pre><code>Usage:
  minikube [command]

Available Commands:
  dashboard        Opens/displays the kubernetes dashboard URL for your local cluster
  delete           Deletes a local kubernetes cluster.
  docker-env       sets up docker env variables; similar to &#39;$(docker-machine env)&#39;
  get-k8s-versions Gets the list of available kubernetes versions available for minikube.
  ip               Retrieve the IP address of the running cluster.
  logs             Gets the logs of the running localkube instance, used for debugging minikube, not user code.
  service          Gets the kubernetes URL for the specified service in your local cluster
  ssh              Log into or run a command on a machine with SSH; similar to &#39;docker-machine ssh&#39;
  start            Starts a local kubernetes cluster.
  status           Gets the status of a local kubernetes cluster.
  stop             Stops a running local kubernetes cluster.
  version          Print the version of minikube.
</code></pre><p>æ›´å¤šè¯·å‚è€ƒ<a href="https://github.com/kubernetes/minikubeã€‚" target="_blank" rel="external">https://github.com/kubernetes/minikubeã€‚</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ç›¸æ¯”Dockerä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶è§£å†³æ‰€æœ‰é—®é¢˜ï¼ŒKubernetesåˆ™ä¸ºä¸åŒçš„æœåŠ¡æä¾›äº†ä¸åŒçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¹¶å°†ä¸€äº›æœåŠ¡æ”¾åˆ°äº†addonsä¸­ã€‚æ•…è€Œï¼ŒKubernetesçš„éƒ¨ç½²ç›¸å¯¹è¦éº»çƒ¦çš„å¤šã€‚å€ŸåŠ©&lt;a href=&quot;https://github.com/kubernetes/mini
    
    </summary>
    
    
      <category term="docker" scheme="http://feisky.xyz/tags/docker/"/>
    
      <category term="Kubernetes" scheme="http://feisky.xyz/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Setup hyperd with flannel network</title>
    <link href="http://feisky.xyz/2016/07/19/Setup-hyperd-with-flannel-network/"/>
    <id>http://feisky.xyz/2016/07/19/Setup-hyperd-with-flannel-network/</id>
    <published>2016-07-19T07:58:26.000Z</published>
    <updated>2016-12-15T00:14:54.373Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Flannel"><a href="#Flannel" class="headerlink" title="Flannel"></a>Flannel</h1><p>Flannel is a virtual network that gives a subnet to each host for use with container runtimes.</p>
<p>Platforms like Googleâ€™s Kubernetes assume that each container (pod) has a unique, routable IP inside the cluster. The advantage of this model is that it reduces the complexity of doing port mapping.</p>
<p>flannel runs an agent, flanneld, on each host and is responsible for allocating a subnet lease out of a preconfigured address space. flannel uses etcd to store the network configuration, allocated subnets, and auxiliary data (such as hostâ€™s IP). The forwarding of packets is achieved using one of several strategies that are known as backends. The simplest backend is udp and uses a TUN device to encapsulate every IP fragment in a UDP packet, forming an overlay network. The following diagram demonstrates the path a packet takes as it traverses the overlay network:</p>
<p><img src="/images/14689151388980.jpg" alt=""></p>
<h1 id="Flannel-install"><a href="#Flannel-install" class="headerlink" title="Flannel install"></a>Flannel install</h1><p>First install etcd:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><div class="line">curl -L https://github.com/coreos/etcd/releases/download/v3.0.3/etcd-v3.0.3-linux-amd64.tar.gz -o etcd-v3.0.3-linux-amd64.tar.gz</div><div class="line">tar xzvf etcd-v3.0.3-linux-amd64.tar.gz</div><div class="line">cp etcd-v3.0.3-linux-amd64/&#123;etcd,etcdctl&#125; /usr/bin</div><div class="line">rm -rf etcd-v3.0.3-linux-amd64 etcd-v3.0.3-linux-amd64.tar.gz</div></pre></td></tr></table></figure>
<p>Then, install flannel:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><div class="line">curl -L https://github.com/coreos/flannel/releases/download/v0.5.5/flannel-0.5.5-linux-amd64.tar.gz -o flannel-0.5.5-linux-amd64.tar.gz</div><div class="line">tar zxvf flannel-0.5.5-linux-amd64.tar.gz</div><div class="line">cp flannel-0.5.5/flanneld /usr/bin</div><div class="line">rm -rf flannel-0.5.5*</div></pre></td></tr></table></figure>
<p>Start etcd and setup default network:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><div class="line">nohup etcd --advertise-client-urls <span class="string">'http://192.168.33.10:2379'</span> --listen-client-urls <span class="string">'http://192.168.33.10:2379'</span> &amp;</div><div class="line">etcdctl --endpoints=192.168.33.10:2379 <span class="built_in">set</span> /coreos.com/network/config  <span class="string">'&#123; "Network": "172.168.0.0/16", "Backend": &#123; "Type": "vxlan", "VNI": 2000 &#125; &#125;'</span></div></pre></td></tr></table></figure>
<p>Start flanneld on all nodes:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><div class="line">nohup flanneld -etcd-endpoints=http://192.168.33.10:2379 -iface=eth1 &amp;</div></pre></td></tr></table></figure>
<h1 id="Hyperd-install"><a href="#Hyperd-install" class="headerlink" title="Hyperd install"></a>Hyperd install</h1><figure class="highlight sh"><table><tr><td class="code"><pre><div class="line">apt-get install qemu-system-x86 -y</div><div class="line">curl <span class="_">-s</span>SL http://hypercontainer.io/install | bash</div></pre></td></tr></table></figure>
<p>Configure hyperd to use subnet provided by flannelï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><div class="line"><span class="built_in">source</span> /run/flannel/subnet.env</div><div class="line">brctl addbr docker0</div><div class="line">ip addr add dev docker0 <span class="variable">$&#123;FLANNEL_SUBNET&#125;</span></div><div class="line">ip link <span class="built_in">set</span> docker0 up</div><div class="line"></div><div class="line">cat &gt;/etc/hyper/config &lt;&lt;EOF</div><div class="line">Kernel=/var/lib/hyper/kernel</div><div class="line">Initrd=/var/lib/hyper/hyper-initrd.img</div><div class="line">Hypervisor=qemu</div><div class="line">StorageDriver=devicemapper</div><div class="line">Bridge=docker0</div><div class="line">BridgeIP=<span class="variable">$&#123;FLANNEL_SUBNET&#125;</span></div><div class="line">EOF</div><div class="line"></div><div class="line">nohup hyperd --nondaemon --v=3 &amp;</div></pre></td></tr></table></figure>
<h1 id="Test"><a href="#Test" class="headerlink" title="Test"></a>Test</h1><figure class="highlight sh"><table><tr><td class="code"><pre><div class="line">root@s2:~<span class="comment"># hyper run -d busybox</span></div><div class="line">POD id is pod-hZviZLulsb</div><div class="line">Time to run a POD is 3648 ms</div><div class="line">root@s2:~<span class="comment"># hyper exec pod-hZviZLulsb ip addr</span></div><div class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue</div><div class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</div><div class="line">    inet 127.0.0.1/8 scope host lo</div><div class="line">       valid_lft forever preferred_lft forever</div><div class="line">    inet6 ::1/128 scope host</div><div class="line">       valid_lft forever preferred_lft forever</div><div class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast qlen 1000</div><div class="line">    link/ether 52:54:51:e5:db:2f brd ff:ff:ff:ff:ff:ff</div><div class="line">    inet 172.168.12.3/24 scope global eth0</div><div class="line">       valid_lft forever preferred_lft forever</div><div class="line">    inet6 fe80::5054:51ff:fee5:db2f/64 scope link</div><div class="line">       valid_lft forever preferred_lft forever</div><div class="line"></div><div class="line">root@s1:~<span class="comment"># hyper run -d busybox</span></div><div class="line">POD id is pod-GbccOdYKjK</div><div class="line">Time to run a POD is 3631 ms</div><div class="line">root@s1:~<span class="comment"># hyper exec pod-GbccOdYKjK ip addr</span></div><div class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue</div><div class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</div><div class="line">    inet 127.0.0.1/8 scope host lo</div><div class="line">       valid_lft forever preferred_lft forever</div><div class="line">    inet6 ::1/128 scope host</div><div class="line">       valid_lft forever preferred_lft forever</div><div class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast qlen 1000</div><div class="line">    link/ether 52:54:da:0c:b6:<span class="built_in">cd</span> brd ff:ff:ff:ff:ff:ff</div><div class="line">    inet 172.168.95.3/24 scope global eth0</div><div class="line">       valid_lft forever preferred_lft forever</div><div class="line">    inet6 fe80::5054:daff:fe0c:b6<span class="built_in">cd</span>/64 scope link</div><div class="line">       valid_lft forever preferred_lft forever</div><div class="line">root@s1:~<span class="comment"># hyper exec pod-GbccOdYKjK ping -c3 172.168.12.3</span></div><div class="line">PING 172.168.12.3 (172.168.12.3): 56 data bytes</div><div class="line">64 bytes from 172.168.12.3: seq=0 ttl=62 time=57.400 ms</div><div class="line">64 bytes from 172.168.12.3: seq=1 ttl=62 time=6.563 ms</div><div class="line">64 bytes from 172.168.12.3: seq=2 ttl=62 time=1.580 ms</div><div class="line"></div><div class="line">--- 172.168.12.3 ping statistics ---</div><div class="line">3 packets transmitted, 3 packets received, 0% packet loss</div><div class="line">round-trip min/avg/max = 1.580/21.847/57.400 ms</div></pre></td></tr></table></figure>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ul>
<li><a href="https://github.com/coreos/flannel" target="_blank" rel="external">https://github.com/coreos/flannel</a></li>
<li><a href="http://docs.hypercontainer.io/get_started/install/linux.html" target="_blank" rel="external">http://docs.hypercontainer.io/get_started/install/linux.html</a></li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;Flannel&quot;&gt;&lt;a href=&quot;#Flannel&quot; class=&quot;headerlink&quot; title=&quot;Flannel&quot;&gt;&lt;/a&gt;Flannel&lt;/h1&gt;&lt;p&gt;Flannel is a virtual network that gives a subnet t
    
    </summary>
    
    
      <category term="hyper" scheme="http://feisky.xyz/tags/hyper/"/>
    
      <category term="container" scheme="http://feisky.xyz/tags/container/"/>
    
      <category term="flannel" scheme="http://feisky.xyz/tags/flannel/"/>
    
  </entry>
  
  <entry>
    <title>Play with docker v1.12</title>
    <link href="http://feisky.xyz/2016/06/24/Play-with-docker-v1-12/"/>
    <id>http://feisky.xyz/2016/06/24/Play-with-docker-v1-12/</id>
    <published>2016-06-24T04:39:49.000Z</published>
    <updated>2016-12-15T00:14:54.373Z</updated>
    
    <content type="html"><![CDATA[<p>[TOC]</p>
<p>Docker v1.12 brings in its integrated orchestration into docker engine.</p>
<blockquote>
<p>Starting with Docker 1.12, we have added features to the core Docker Engine to make multi-host and multi-container orchestration easy.  Weâ€™ve added new API objects, like Service and Node, that will let you use the Docker API to deploy and manage apps on a group of Docker Engines called a swarm. With Docker 1.12, the best way to orchestrate Docker is Docker!</p>
</blockquote>
<p><img src="https://cloud.githubusercontent.com/assets/676637/16327966/a4f34346-3a07-11e6-8d21-153509596cec.png" alt="docker-v1 12"></p>
<h2 id="Playing-on-GCE"><a href="#Playing-on-GCE" class="headerlink" title="Playing on GCE"></a>Playing on GCE</h2><p>Create swarm-manager:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><div class="line">gcloud init</div><div class="line">docker-machine create swarm-manager --engine-install-url experimental.docker.com <span class="_">-d</span> google --google-machine-type n1-standard-1 --google-zone us-central1<span class="_">-f</span> --google-disk-size <span class="string">"500"</span> --google-tags swarm-cluster --google-project k8s-dev-prj</div></pre></td></tr></table></figure>
<p>Check what version has been installed:</p>
<figure class="highlight vim"><table><tr><td class="code"><pre><div class="line">$ <span class="built_in">eval</span> $(docker-machine env swarm-manager)</div><div class="line">$ docker <span class="keyword">version</span></div><div class="line">Clien<span class="variable">t:</span></div><div class="line"> Version:      <span class="number">1.12</span>.<span class="number">0</span>-rc2</div><div class="line"> API <span class="keyword">version</span>:  <span class="number">1.24</span></div><div class="line"> Go <span class="keyword">version</span>:   go1.<span class="number">6.2</span></div><div class="line"> Git commi<span class="variable">t:</span>   <span class="number">906</span>eacd</div><div class="line"> Buil<span class="variable">t:</span>        Fri Jun <span class="number">17</span> <span class="number">20</span>:<span class="number">35</span>:<span class="number">33</span> <span class="number">2016</span></div><div class="line"> OS/Arch:      darwin/amd64</div><div class="line"> Experimenta<span class="variable">l:</span> true</div><div class="line"></div><div class="line">Server:</div><div class="line"> Version:      <span class="number">1.12</span>.<span class="number">0</span>-rc2</div><div class="line"> API <span class="keyword">version</span>:  <span class="number">1.24</span></div><div class="line"> Go <span class="keyword">version</span>:   go1.<span class="number">6.2</span></div><div class="line"> Git commi<span class="variable">t:</span>   <span class="number">906</span>eacd</div><div class="line"> Buil<span class="variable">t:</span>        Fri Jun <span class="number">17</span> <span class="number">21</span>:<span class="number">07</span>:<span class="number">35</span> <span class="number">2016</span></div><div class="line"> OS/Arch:      linux/amd64</div><div class="line"> Experimenta<span class="variable">l:</span> true</div></pre></td></tr></table></figure>
<p>Create worker node:</p>
<figure class="highlight haml"><table><tr><td class="code"><pre><div class="line">docker-machine create swarm-worker-1 \</div><div class="line">    -<span class="ruby">-engine-install-url experimental.docker.com \</span></div><div class="line">    -<span class="ruby">d google \</span></div><div class="line">    -<span class="ruby">-google-machine-type n1-standard-<span class="number">1</span> \</span></div><div class="line">    -<span class="ruby">-google-zone us-central1-f \</span></div><div class="line">    -<span class="ruby">-google-disk-size <span class="string">"500"</span> \</span></div><div class="line">    -<span class="ruby">-google-tags swarm-cluster \</span></div><div class="line">    -<span class="ruby">-google-project k8s-dev-prj</span></div></pre></td></tr></table></figure>
<p>Initialize swarm</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><div class="line"><span class="comment"># init manager</span></div><div class="line"><span class="built_in">eval</span> $(docker-machine env swarm-manager)</div><div class="line">docker swarm init</div></pre></td></tr></table></figure>
<blockquote>
<p>Under the hood this creates a Raft consensus group of one node.  This first node has the role of manager, meaning it accepts commands and schedule tasks.  As you join more nodes to the swarm, they will by default be workers, which simply execute containers dispatched by the manager.  You can optionally add additional manager nodes.  The manager nodes will be part of the Raft consensus group. We use an optimized Raft store in which reads are serviced directly from memory which makes scheduling performance fast.</p>
</blockquote>
<figure class="highlight mel"><table><tr><td class="code"><pre><div class="line"># join worker</div><div class="line"><span class="keyword">eval</span> $(docker-machine <span class="keyword">env</span> swarm-worker<span class="number">-1</span>)</div><div class="line">manager_ip=$(gcloud compute instances list | awk <span class="string">'/swarm-manager/&#123;print $4&#125;'</span>)</div><div class="line">docker swarm join $&#123;manager_ip&#125;:<span class="number">2377</span></div></pre></td></tr></table></figure>
<p>List all nodes:</p>
<figure class="highlight crmsh"><table><tr><td class="code"><pre><div class="line">$ eval $(docker-machine env swarm-manager)</div><div class="line">$ docker <span class="keyword">node</span> <span class="title">ls</span></div><div class="line">ID                           NAME            MEMBERSHIP  STATUS  AVAILABILITY  MANAGER STATUS</div><div class="line"><span class="number">0m</span>2qy40ch1nqfpmhnsvj8jzch *  swarm-manager   Accepted    Ready   Active        Leader</div><div class="line"><span class="number">4</span>v1oo055unqiz9fy14u8wg3fn    swarm-worker-<span class="number">1</span>  Accepted    Ready   Active</div></pre></td></tr></table></figure>
<h2 id="Playing-with-service"><a href="#Playing-with-service" class="headerlink" title="Playing with service"></a>Playing with service</h2><figure class="highlight sh"><table><tr><td class="code"><pre><div class="line"><span class="built_in">eval</span> $(docker-machine env swarm-manager)</div><div class="line">docker service create --replicas 2 -p 80:80/tcp --name nginx nginx</div></pre></td></tr></table></figure>
<blockquote>
<p>This command declares a desired state on your swarm of 2 nginx containers, reachable as a single, internally load balanced service on port 80 of any node in your swarm.  Internally, we make this work using Linux IPVS, an in-kernel Layer 4 multi-protocol load balancer thatâ€™s been in the Linux kernel for more than 15 years.  With IPVS routing packets inside the kernel, swarmâ€™s routing mesh delivers high performance container-aware load-balancing.</p>
<p>When you create services, can optionally create replicated or global services.  Replicated services mean any number of containers that you define will be spread across the available hosts.  Global services, by contrast, schedule one instance the same container on every host in the swarm.</p>
<p>Letâ€™s turn to how Docker provides resiliency.  Swarm mode enabled engines are self-healing, meaning that they are aware of the application you defined and will continuously check and reconcile the environment when things go awry.  For example, if you unplug one of the machines running an nginx instance, a new container will come up on another node.  Unplug the network switch for half the machines in your swarm, and the other half will take over, redistributing the containers amongst themselves.  For updates, you now have flexibility in how you re-deploy services once you make a change. You can set a rolling or parallel update of the containers on your swarm.</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><div class="line">docker service scale nginx=3</div><div class="line"></div><div class="line">$ docker ps</div><div class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS               NAMES</div><div class="line">b51a902db8bc        nginx:latest        <span class="string">"nginx -g 'daemon off"</span>   2 minutes ago       Up 2 minutes        80/tcp, 443/tcp     nginx.1.8yvwxbquvz1ptuqsc8hewwbau</div></pre></td></tr></table></figure>
<figure class="highlight vbscript"><table><tr><td class="code"><pre><div class="line"># switch <span class="keyword">to</span> worker</div><div class="line">$ <span class="built_in">eval</span> $(docker-machine env swarm-worker<span class="number">-1</span>)</div><div class="line">$ docker ps</div><div class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED              STATUS              PORTS               NAMES</div><div class="line">da6a8250bef4        nginx:latest        <span class="string">"nginx -g 'daemon off"</span>   About a <span class="built_in">minute</span> ago   Up About a <span class="built_in">minute</span>   <span class="number">80</span>/tcp, <span class="number">443</span>/tcp     nginx<span class="number">.2</span>.bqko7fyj1nowwj1flxva3ur0g</div><div class="line"><span class="number">54</span>d9ffd07894        nginx:latest        <span class="string">"nginx -g 'daemon off"</span>   About a <span class="built_in">minute</span> ago   Up About a <span class="built_in">minute</span>   <span class="number">80</span>/tcp, <span class="number">443</span>/tcp     nginx<span class="number">.3</span><span class="number">.02</span>k4d34gjooa9f8m6yhfi5hyu</div></pre></td></tr></table></figure>
<p>As seen above, one container runs on swarm-manager, and the others run on swarm-worker-1.</p>
<h2 id="Expose-services"><a href="#Expose-services" class="headerlink" title="Expose services"></a>Expose services</h2><h3 id="Visit-by-node-node-ip"><a href="#Visit-by-node-node-ip" class="headerlink" title="Visit by node node ip"></a>Visit by node node ip</h3><figure class="highlight haml"><table><tr><td class="code"><pre><div class="line">gcloud compute firewall-rules create nginx-swarm \</div><div class="line">  -<span class="ruby">-allow <span class="symbol">tcp:</span><span class="number">80</span> \</span></div><div class="line">  -<span class="ruby">-description <span class="string">"nginx swarm service"</span> \</span></div><div class="line">  -<span class="ruby">-target-tags swarm-cluster</span></div></pre></td></tr></table></figure>
<p>Then use external IP (get by exec <code>gcloud compute instances list</code>) to visit nginx service.</p>
<h3 id="GCP-Load-Balancer-tcp"><a href="#GCP-Load-Balancer-tcp" class="headerlink" title="GCP Load Balancer (tcp)"></a>GCP Load Balancer (tcp)</h3><figure class="highlight sql"><table><tr><td class="code"><pre><div class="line">gcloud compute addresses <span class="keyword">create</span> network-lb-ip<span class="number">-1</span> <span class="comment">--region us-central1</span></div><div class="line">gcloud <span class="keyword">compute</span> <span class="keyword">http</span>-health-checks <span class="keyword">create</span> basic-<span class="keyword">check</span></div><div class="line">gcloud <span class="keyword">compute</span> target-pools <span class="keyword">create</span> www-pool <span class="comment">--region us-central1 --health-check basic-check</span></div><div class="line">gcloud <span class="keyword">compute</span> target-pools <span class="keyword">add</span>-instances www-pool <span class="comment">--instances swarm-manager,swarm-worker-1 --zone us-central1-f</span></div><div class="line"></div><div class="line"># <span class="keyword">Get</span> lb addresses</div><div class="line">STATIC_EXTERNAL_IP=$(gcloud <span class="keyword">compute</span> addresses <span class="keyword">list</span> | awk <span class="string">'/network-lb-ip-1/&#123;print $3&#125;'</span>)</div><div class="line"># <span class="keyword">create</span> forwarding <span class="keyword">rules</span></div><div class="line">gcloud <span class="keyword">compute</span> forwarding-<span class="keyword">rules</span> <span class="keyword">create</span> www-rule <span class="comment">--region us-central1 --port-range 80 --address $&#123;STATIC_EXTERNAL_IP&#125; --target-pool www-pool</span></div></pre></td></tr></table></figure>
<p>Now you could visit <a href="http://${STATIC_EXTERNAL_IP}" target="_blank" rel="external">http://${STATIC_EXTERNAL_IP}</a> for nginx service.</p>
<p>BTW, <a href="https://blog.docker.com/2016/06/azure-aws-beta/" target="_blank" rel="external">Docker for aws and azure</a> will do this more easily as integrated:</p>
<ul>
<li>Use an SSH key already associated with your IaaS account for access control</li>
<li>Provision infrastructure load balancers and update them dynamically as apps are created and updated</li>
<li>Configure security groups and virtual networks to create secure Docker setups that are easy for operations to understand and manage</li>
</ul>
<blockquote>
<p>By default, apps deployed with bundles do not have ports publicly exposed. Update port mappings for services, and Docker will automatically wire up the underlying platform loadbalancers:<code>docker service update -p 80:80 &lt;example-service&gt;</code></p>
</blockquote>
<h3 id="Networking"><a href="#Networking" class="headerlink" title="Networking"></a>Networking</h3><h4 id="Local-networking"><a href="#Local-networking" class="headerlink" title="Local networking"></a>Local networking</h4><p><img width="1239" alt="2016-06-24 12 05 13" src="https://cloud.githubusercontent.com/assets/676637/16327964/9dfd842a-3a07-11e6-9031-c79c9c43ec83.png"></p>
<p>Create local scope network and place containers in existing vlans:</p>
<figure class="highlight lsl"><table><tr><td class="code"><pre><div class="line">docker network create -d macvlan --subnet=<span class="number">192.168</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">16</span> --ip-range=<span class="number">192.168</span><span class="number">.41</span><span class="number">.0</span>/<span class="number">24</span> --aux-address=<span class="string">"favoriate_ip_ever=192.168.41.2"</span> --gateway=<span class="number">192.168</span><span class="number">.41</span><span class="number">.1</span> -o parent=eth0<span class="number">.41</span> macnet41</div><div class="line">docker run --net=macnet41 -it --rm alpine /bin/sh</div></pre></td></tr></table></figure>
<h4 id="Multi-host-networking"><a href="#Multi-host-networking" class="headerlink" title="Multi-host networking"></a>Multi-host networking</h4><p>A typical two-tier (web+db) application runs on swarm scope network would be created like this:</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><div class="line">docker network <span class="keyword">create</span> -d overlay mynet</div><div class="line">docker service <span class="keyword">create</span> â€“<span class="keyword">name</span> frontend â€“replicas <span class="number">5</span> -p <span class="number">80</span>:<span class="number">80</span>/tcp â€“network mynet mywebapp</div><div class="line">docker service <span class="keyword">create</span> â€“<span class="keyword">name</span> redis â€“network mynet redis:latest</div></pre></td></tr></table></figure>
<p><img width="1133" alt="2016-06-26 10 27 20" src="https://cloud.githubusercontent.com/assets/676637/16362920/7dbd339e-3bed-11e6-9987-8d425480ba59.png"></p>
<p><img width="1169" alt="2016-06-24 12 05 30" src="https://cloud.githubusercontent.com/assets/676637/16327980/c4af9432-3a07-11e6-93ed-9e94d12f0c9b.png"><br><img width="1228" alt="2016-06-24 12 05 58" src="https://cloud.githubusercontent.com/assets/676637/16327982/c4b2a906-3a07-11e6-8e97-70a26c5fc701.png"><br><img width="1235" alt="2016-06-24 12 06 11" src="https://cloud.githubusercontent.com/assets/676637/16327981/c4b14fc0-3a07-11e6-84f0-260a716044cb.png"></p>
<h3 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h3><p>Docker v1.12 indeeds introduced easy-of-use interface for orchestrating containers, but Iâ€™m concerned whether this way could scale for large clusters. Maybe we could see it on Dockerâ€™s further iterations.</p>
<h3 id="Further-more"><a href="#Further-more" class="headerlink" title="Further more"></a>Further more</h3><ul>
<li><a href="https://blog.docker.com/2016/06/docker-1-12-built-in-orchestration/" target="_blank" rel="external">https://blog.docker.com/2016/06/docker-1-12-built-in-orchestration/</a></li>
<li><a href="http://www.slideshare.net/MadhuVenugopal2/dockercon-us-2016-docker-networking-deep-dive" target="_blank" rel="external">http://www.slideshare.net/MadhuVenugopal2/dockercon-us-2016-docker-networking-deep-dive</a></li>
<li><a href="https://medium.com/google-cloud/docker-swarm-on-google-cloud-platform-c9925bd7863c#.3plkwmxss" target="_blank" rel="external">https://medium.com/google-cloud/docker-swarm-on-google-cloud-platform-c9925bd7863c#.3plkwmxss</a></li>
<li><a href="https://beta.docker.com/docs/" target="_blank" rel="external">https://beta.docker.com/docs/</a></li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;[TOC]&lt;/p&gt;
&lt;p&gt;Docker v1.12 brings in its integrated orchestration into docker engine.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Starting with Docker 1.12, we ha
    
    </summary>
    
    
      <category term="docker" scheme="http://feisky.xyz/tags/docker/"/>
    
  </entry>
  
  <entry>
    <title>Playing docker with hypervisor container runtime runV</title>
    <link href="http://feisky.xyz/2016/06/17/Playing-docker-with-hypervisor-container-runtime-runV/"/>
    <id>http://feisky.xyz/2016/06/17/Playing-docker-with-hypervisor-container-runtime-runV/</id>
    <published>2016-06-17T09:12:38.000Z</published>
    <updated>2016-12-15T00:14:54.373Z</updated>
    
    <content type="html"><![CDATA[<p>Table of contents:</p>
<p>[TOC]</p>
<hr>
<p>The latest master branch of <a href="https://github.com/hyperhq/runv" target="_blank" rel="external">runV</a> has already supported running as an runtime in docker. Since v1.11, docker introduced OCI contain runtime (runc) integration via containerd. Since runc and runV are both <a href="https://github.com/opencontainers/runtime-spec/blob/master/implementations.md" target="_blank" rel="external">recommended implementation of OCI</a>, it is natural to make runV working with containerd. </p>
<p>Now letâ€™s have a try.</p>
<h3 id="Install-runv-and-docker"><a href="#Install-runv-and-docker" class="headerlink" title="Install runv and docker"></a>Install runv and docker</h3><p>Docker could be installed via <a href="https://docs.docker.com/engine/installation/" target="_blank" rel="external">https://docs.docker.com/engine/installation/</a>.</p>
<p>Since only master branch of runV supports running integrated with docker, we should compile runV by source.</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><div class="line">sudo apt-get install -y autoconf automake pkg-config libdevmapper-dev libsqlite3-dev libvirt-dev qemu libvirt-bin</div><div class="line">mkdir -p <span class="variable">$GOPATH</span>/src/github.com/hyperhq</div><div class="line"><span class="built_in">cd</span> <span class="variable">$GOPATH</span>/src/github.com/hyperhq</div><div class="line">git <span class="built_in">clone</span> https://github.com/hyperhq/runv</div><div class="line"><span class="built_in">cd</span> runv</div><div class="line">./autogen.sh</div><div class="line">./configure</div><div class="line">make</div><div class="line">make install</div></pre></td></tr></table></figure>
<h3 id="Start-docker-with-runV-runtime"><a href="#Start-docker-with-runV-runtime" class="headerlink" title="Start docker with runV runtime"></a>Start docker with runV runtime</h3><p>Stop docker first since it is running with runc by default.</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><div class="line">systemctl stop docker</div></pre></td></tr></table></figure>
<p>Now start docker with runV:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><div class="line"><span class="comment"># start containerd</span></div><div class="line">systemd-run --unit=containerd-runv docker-containerd --debug <span class="_">-l</span> /var/run/docker/libcontainerd/docker-containerd.sock --runtime /usr/<span class="built_in">local</span>/bin/runv --runtime-args --debug --runtime-args --driver=libvirt --runtime-args --kernel=/var/lib/hyper/kernel --runtime-args --initrd=/var/lib/hyper/hyper-initrd.img --start-timeout 2m</div><div class="line"></div><div class="line"><span class="comment"># start docker</span></div><div class="line">systemd-run --unit=docker-runv docker daemon -D <span class="_">-l</span> debug --containerd=/var/run/docker/libcontainerd/docker-containerd.sock</div><div class="line"></div><div class="line"><span class="comment"># check status</span></div><div class="line">[root@linux ~]<span class="comment"># systemctl status containerd-runv</span></div><div class="line">â— containerd-runv.service - /usr/bin/docker-containerd --debug <span class="_">-l</span> /var/run/docker/libcontainerd/docker-containerd.sock --runtime /usr/<span class="built_in">local</span>/bin/runv --runtime-args --debug --runtime-args --driver=libvirt --runtime-args --kernel=/var/lib/hyper/kernel --runtime-args --initrd=/var/lib/hyper/hyper-initrd.img --start-timeout 2m</div><div class="line">   Loaded: loaded (/run/systemd/system/containerd-runv.service; static; vendor preset: disabled)</div><div class="line">  Drop-In: /run/systemd/system/containerd-runv.service.d</div><div class="line">           â””â”€50-Description.conf, 50-ExecStart.conf</div><div class="line">   Active: active (running) since äº” 2016-06-17 09:47:57 UTC; 10s ago</div><div class="line"> Main PID: 12650 (docker-containe)</div><div class="line">   Memory: 1.8M</div><div class="line">   CGroup: /system.slice/containerd-runv.service</div><div class="line">           â””â”€12650 /usr/bin/docker-containerd --debug <span class="_">-l</span> /var/run/docker/libcontainerd/docker-containerd.sock --run...</div><div class="line"></div><div class="line">6æœˆ 17 09:47:57 linux systemd[1]: Started /usr/bin/docker-containerd --debug <span class="_">-l</span> /var/run/docker/libcontainerd/docker...</div><div class="line">6æœˆ 17 09:47:57 linux systemd[1]: Starting /usr/bin/docker-containerd --debug <span class="_">-l</span> /var/run/docker/libcontainerd/docke...</div><div class="line">6æœˆ 17 09:47:57 linux docker-containerd[12650]: time=<span class="string">"2016-06-17T09:47:57Z"</span> level=warning msg=<span class="string">"containerd: low ...=4096</span></div><div class="line">6æœˆ 17 09:47:57 linux docker-containerd[12650]: time="2016-06-17T09:47:57Z<span class="string">" level=debug msg="</span>containerd: <span class="built_in">read</span> p...unt=0</div><div class="line">6æœˆ 17 09:47:57 linux docker-containerd[12650]: time=<span class="string">"2016-06-17T09:47:57Z"</span> level=debug msg=<span class="string">"containerd: superv...nerd"</span></div><div class="line">6æœˆ 17 09:47:57 linux docker-containerd[12650]: time=<span class="string">"2016-06-17T09:47:57Z"</span> level=debug msg=<span class="string">"containerd: grpc a...sock"</span></div><div class="line">Hint: Some lines were ellipsized, use <span class="_">-l</span> to show <span class="keyword">in</span> full.</div><div class="line"></div><div class="line">[root@linux ~]<span class="comment"># systemctl status docker-runv</span></div><div class="line">â— docker-runv.service - /usr/bin/docker daemon -D <span class="_">-l</span> debug --containerd=/var/run/docker/libcontainerd/docker-containerd.sock</div><div class="line">   Loaded: loaded (/run/systemd/system/docker-runv.service; static; vendor preset: disabled)</div><div class="line">  Drop-In: /run/systemd/system/docker-runv.service.d</div><div class="line">           â””â”€50-Description.conf, 50-ExecStart.conf</div><div class="line">   Active: active (running) since äº” 2016-06-17 09:34:11 UTC; 25s ago</div><div class="line"> Main PID: 11120 (docker)</div><div class="line">   Memory: 20.8M</div><div class="line">   CGroup: /system.slice/docker-runv.service</div><div class="line">           â””â”€11120 /usr/bin/docker daemon -D <span class="_">-l</span> debug --containerd=/var/run/docker/libcontainerd/docker-containerd.sock</div><div class="line"></div><div class="line">6æœˆ 17 09:34:13 linux docker[11120]: time=<span class="string">"2016-06-17T09:34:13.019309548Z"</span> level=debug msg=<span class="string">"Registering POST, /volumes/create"</span></div><div class="line">6æœˆ 17 09:34:13 linux docker[11120]: time=<span class="string">"2016-06-17T09:34:13.019448115Z"</span> level=debug msg=<span class="string">"Registering DELETE, /volumes/&#123;name:.*&#125;"</span></div><div class="line">6æœˆ 17 09:34:13 linux docker[11120]: time=<span class="string">"2016-06-17T09:34:13.019551244Z"</span> level=debug msg=<span class="string">"Registering POST, /build"</span></div><div class="line">6æœˆ 17 09:34:13 linux docker[11120]: time=<span class="string">"2016-06-17T09:34:13.019607895Z"</span> level=debug msg=<span class="string">"Registering GET, /networks"</span></div><div class="line">6æœˆ 17 09:34:13 linux docker[11120]: time=<span class="string">"2016-06-17T09:34:13.019675700Z"</span> level=debug msg=<span class="string">"Registering GET, /networks/&#123;id:.*&#125;"</span></div><div class="line">6æœˆ 17 09:34:13 linux docker[11120]: time=<span class="string">"2016-06-17T09:34:13.019771551Z"</span> level=debug msg=<span class="string">"Registering POST, /networks/create"</span></div><div class="line">6æœˆ 17 09:34:13 linux docker[11120]: time=<span class="string">"2016-06-17T09:34:13.020256142Z"</span> level=debug msg=<span class="string">"Registering POST, /networks/&#123;id:.*&#125;/connect"</span></div><div class="line">6æœˆ 17 09:34:13 linux docker[11120]: time=<span class="string">"2016-06-17T09:34:13.020369131Z"</span> level=debug msg=<span class="string">"Registering POST, /networks/&#123;id:.*&#125;/disconnect"</span></div><div class="line">6æœˆ 17 09:34:13 linux docker[11120]: time=<span class="string">"2016-06-17T09:34:13.020463042Z"</span> level=debug msg=<span class="string">"Registering DELETE, /networks/&#123;id:.*&#125;"</span></div><div class="line">6æœˆ 17 09:34:13 linux docker[11120]: time=<span class="string">"2016-06-17T09:34:13.021491071Z"</span> level=info msg=<span class="string">"API listen on /var/run/docker.sock"</span></div></pre></td></tr></table></figure>
<h3 id="Create-container"><a href="#Create-container" class="headerlink" title="Create container"></a>Create container</h3><p>Letâ€™s create a nginx container.</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><div class="line">[root@linux ~]<span class="comment"># docker run -i -d  nginx</span></div><div class="line">6a34a0513ebbdb2c57d828bf4e814773c8a5cf6af8c35e4376f2028769a7c35c</div><div class="line">[root@linux ~]<span class="comment"># docker ps</span></div><div class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS               NAMES</div><div class="line">6a34a0513ebb        nginx               <span class="string">"nginx -g 'daemon off"</span>   9 seconds ago       Up 3 seconds        80/tcp, 443/tcp     berserk_mcnulty</div><div class="line"></div><div class="line"><span class="comment"># Is it working</span></div><div class="line">[root@linux ~]<span class="comment"># docker inspect --format '&#123;&#123; .NetworkSettings.IPAddress &#125;&#125;' 6a34a0513ebb</span></div><div class="line">172.17.0.2</div><div class="line">[root@linux ~]<span class="comment"># curl -I 172.17.0.2</span></div><div class="line">HTTP/1.1 200 OK</div><div class="line">Server: nginx/1.11.1</div><div class="line">Date: Fri, 17 Jun 2016 09:52:37 GMT</div><div class="line">Content-Type: text/html</div><div class="line">Content-Length: 612</div><div class="line">Last-Modified: Tue, 31 May 2016 14:40:22 GMT</div><div class="line">Connection: keep-alive</div><div class="line">ETag: <span class="string">"574da256-264"</span></div><div class="line">Accept-Ranges: bytes</div></pre></td></tr></table></figure>
<p>Is the container really running in runV with hypervisor?</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><div class="line">root@linux ~]<span class="comment"># runv list</span></div><div class="line">ID                                                                 PID         STATUS      BUNDLE                                                                                           CREATED</div><div class="line">6a34a0513ebbdb2c57d828bf4e814773c8a5cf6af8c35e4376f2028769a7c35c   12756       running     /var/run/docker/libcontainerd/6a34a0513ebbdb2c57d828bf4e814773c8a5cf6af8c35e4376f2028769a7c35c   2016-06-17T09:48:38.324839156Z</div><div class="line"></div><div class="line">[root@linux ~]<span class="comment"># runv state 6a34a0513ebbdb2c57d828bf4e814773c8a5cf6af8c35e4376f2028769a7c35c</span></div><div class="line">&#123;</div><div class="line">  <span class="string">"ociVersion"</span>: <span class="string">"0.6.0-dev"</span>,</div><div class="line">  <span class="string">"id"</span>: <span class="string">"6a34a0513ebbdb2c57d828bf4e814773c8a5cf6af8c35e4376f2028769a7c35c"</span>,</div><div class="line">  <span class="string">"pid"</span>: 12756,</div><div class="line">  <span class="string">"bundlePath"</span>: <span class="string">"/var/run/docker/libcontainerd/6a34a0513ebbdb2c57d828bf4e814773c8a5cf6af8c35e4376f2028769a7c35c"</span>,</div><div class="line">  <span class="string">"rootfsPath"</span>: <span class="string">"/var/run/docker/libcontainerd/6a34a0513ebbdb2c57d828bf4e814773c8a5cf6af8c35e4376f2028769a7c35c/rootfs"</span>,</div><div class="line">  <span class="string">"status"</span>: <span class="string">"running"</span>,</div><div class="line">  <span class="string">"created"</span>: <span class="string">"2016-06-17T09:48:38.324839156Z"</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">[root@linux ~]<span class="comment"># virsh list</span></div><div class="line"> Id    åç§°                         çŠ¶æ€</div><div class="line">----------------------------------------------------</div><div class="line"> 919   vm-CeaKLvbPEg                  running</div><div class="line"></div><div class="line">[root@linux ~]<span class="comment"># ps -ef | grep vm-CeaKLvbPEg | grep -v grep</span></div><div class="line">root     12743     1  1 09:48 ?        00:00:06 /usr/bin/qemu-system-x86_64 -name vm-CeaKLvbPEg -S -machine pc-i440fx-2.0,accel=tcg,usb=off -cpu Haswell-noTSX,+abm,+hypervisor,+rdrand,+f16c,+osxsave,+ht,+vme -m 128 -realtime mlock=off -smp 1,sockets=1,cores=1,threads=1 -uuid 4f158103-bd5e-4fd1<span class="_">-a</span>62f-9e18093ceaf4 -nographic -no-user-config -nodefaults -chardev socket,id=charmonitor,path=/var/lib/libvirt/qemu/domain-vm-CeaKLvbPEg/monitor.sock,server,nowait -mon chardev=charmonitor,id=monitor,mode=control -rtc base=utc -no-reboot -boot strict=on -kernel /var/lib/hyper/kernel -initrd /var/lib/hyper/hyper-initrd.img -append console=ttyS0 panic=1 no_timer_check -device virtio-scsi-pci,id=scsi0,bus=pci.0,addr=0x3 -device virtio-serial-pci,id=virtio-serial0,bus=pci.0,addr=0x2 -fsdev <span class="built_in">local</span>,security_model=none,id=fsdev-fs0,path=/var/run/hyper/vm-CeaKLvbPEg/share_dir -device virtio-9p-pci,id=fs0,fsdev=fsdev-fs0,mount_tag=share_dir,bus=pci.0,addr=0x4 -chardev socket,id=charserial0,path=/var/run/hyper/vm-CeaKLvbPEg/console.sock,server,nowait -device isa-serial,chardev=charserial0,id=serial0 -chardev socket,id=charchannel0,path=/var/run/hyper/vm-CeaKLvbPEg/hyper.sock,server,nowait -device virtserialport,bus=virtio-serial0.0,nr=1,chardev=charchannel0,id=channel0,name=sh.hyper.channel.0 -chardev socket,id=charchannel1,path=/var/run/hyper/vm-CeaKLvbPEg/tty.sock,server,nowait -device virtserialport,bus=virtio-serial0.0,nr=2,chardev=charchannel1,id=channel1,name=sh.hyper.channel.1 -device virtio-balloon-pci,id=balloon0,bus=pci.0,addr=0x5 -msg timestamp=on</div></pre></td></tr></table></figure>
<h3 id="Is-it-stable"><a href="#Is-it-stable" class="headerlink" title="Is it stable?"></a>Is it stable?</h3><p>Of course not, runV is still under quick development and features are not complete now. For example, there are a lot of commands not supported now:</p>
<ul>
<li><code>docker stop</code></li>
<li><code>docker stats</code></li>
<li><code>docker exec</code></li>
</ul>
<p>Although there are still problems, Iâ€™m exited by what runV has done. Looking forward to its release.</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Table of contents:&lt;/p&gt;
&lt;p&gt;[TOC]&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;The latest master branch of &lt;a href=&quot;https://github.com/hyperhq/runv&quot; target=&quot;_blank&quot; rel=&quot;ex
    
    </summary>
    
    
      <category term="docker" scheme="http://feisky.xyz/tags/docker/"/>
    
      <category term="runV" scheme="http://feisky.xyz/tags/runV/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes-mesos architecture</title>
    <link href="http://feisky.xyz/2016/06/07/Kubernetes-mesos-architecture/"/>
    <id>http://feisky.xyz/2016/06/07/Kubernetes-mesos-architecture/</id>
    <published>2016-06-07T05:21:07.000Z</published>
    <updated>2016-12-15T00:14:54.373Z</updated>
    
    <content type="html"><![CDATA[<p><img src="/images/kubernetes_mesos_architecture.png" alt=""></p>
<p>From <a href="http://cdn.yongbok.net/ruo91/architecture/k8s/kubernetes_mesos_architecture_v1.x.png" target="_blank" rel="external">http://cdn.yongbok.net/ruo91/architecture/k8s/kubernetes_mesos_architecture_v1.x.png</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;/images/kubernetes_mesos_architecture.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;From &lt;a href=&quot;http://cdn.yongbok.net/ruo91/architecture/k8s/kubernete
    
    </summary>
    
    
      <category term="mesos" scheme="http://feisky.xyz/tags/mesos/"/>
    
      <category term="kubernetes" scheme="http://feisky.xyz/tags/kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Hypernetes: Bringing Security and Multi-tenancy to Kubernetes</title>
    <link href="http://feisky.xyz/2016/06/06/Hypernetes-Bringing-Security-and-Multi-tenancy-to-Kubernetes/"/>
    <id>http://feisky.xyz/2016/06/06/Hypernetes-Bringing-Security-and-Multi-tenancy-to-Kubernetes/</id>
    <published>2016-06-06T08:10:25.000Z</published>
    <updated>2016-12-15T00:14:54.373Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>Notes: this post is copied from <a href="http://blog.kubernetes.io/2016/05/hypernetes-security-and-multi-tenancy-in-kubernetes.html" target="_blank" rel="external">http://blog.kubernetes.io/2016/05/hypernetes-security-and-multi-tenancy-in-kubernetes.html</a>.</p>
</blockquote>
<p><em>Todayâ€™s guest post is written by Harry Zhang and Pengfei Ni, engineers at HyperHQ, describing a new hypervisor based container called HyperContainer</em>  </p>
<p>While many developers and security professionals are comfortable with Linux containers as an effective boundary, many users need a stronger degree of isolation, particularly for those running in a multi-tenant environment. Sadly, today, those users are forced to run their containers inside virtual machines, even one VM per container.  </p>
<p>Unfortunately, this results in the loss of many of the benefits of a cloud-native deployment: slow startup time of VMs; a memory tax for every container; low utilization resulting in wasting resources.  </p>
<p>In this post, we will introduce HyperContainer, a hypervisor based container and see how it naturally fits into the Kubernetes design, and enables users to serve their customers directly with virtualized containers, instead of wrapping them inside of full blown VMs.  </p>
<p><strong>HyperContainer</strong>  </p>
<p><a href="http://hypercontainer.io/" target="_blank" rel="external">HyperContainer</a> is a hypervisor-based container, which allows you to launch Docker images with standard hypervisors (KVM, Xen, etc.). As an open-source project, HyperContainer consists of an <a href="https://github.com/opencontainers/runtime-spec" target="_blank" rel="external">OCI</a> compatible runtime implementation, named <a href="https://github.com/hyperhq/runv/" target="_blank" rel="external">runV</a>, and a management daemon named <a href="https://github.com/hyperhq/hyperd" target="_blank" rel="external">hyperd</a>. The idea behind HyperContainer is quite straightforward: to combine the best of both virtualization and container.  </p>
<p>We can consider containers as two parts (as Kubernetes does). The first part is the container runtime, where HyperContainer uses virtualization to achieve execution isolation and resource limitation instead of namespaces and cgroups. The second part is the application data, where HyperContainer leverages Docker images. So in HyperContainer, virtualization technology makes it possible to build a fully isolated sandbox with an independent guest kernel (so things like <code>top</code> and /proc all work), but from developerâ€™s view, itâ€™s portable and behaves like a standard container.  </p>
<p><strong>HyperContainer as Pod</strong>  </p>
<p>The interesting part of HyperContainer is not only that it is secure enough for multi-tenant environments (such as a public cloud), but also how well it fits into the Kubernetes philosophy.  </p>
<p>One of the most important concepts in Kubernetes is Pods. The design of Pods is a lesson learned (<a href="http://static.googleusercontent.com/media/research.google.com/zh-CN//pubs/archive/43438.pdf" target="_blank" rel="external">Borg paper section 8.1</a>) from real world workloads, where in many cases people want an atomic scheduling unit composed of multiple containers (please check this <a href="https://github.com/kubernetes/kubernetes/tree/master/examples/javaweb-tomcat-sidecar" target="_blank" rel="external">example</a> for further information). In the context of Linux containers, a Pod wraps and encapsulates several containers into a logical group. But in HyperContainer, the hypervisor serves as a natural boundary, and Pods are introduced as first-class objects:  </p>
<p><img src="https://lh6.googleusercontent.com/8DjNb9IE0HjinFxkaoGbPaaKbts5_Osbj-8NVWQMgY_8D32643Aum0SaMc2OedV2gECG3EXov8qj_f8XDe0IfpptZt61HxfJEonLo3RA5xkr5zSmd2nxqVc8yESc423nPEZTj1H3" alt=""></p>
<p>HyperContainer wraps a Pod of light-weight application containers and exposes the container interface at Pod level. Inside the Pod, a minimalist Linux kernel called HyperKernel is booted. This HyperKernel is built with a tiny Init service called HyperStart. It will act as the PID 1 process and creates the Pod, setup Mount namespace, and launch apps from the loaded images. </p>
<p>This model works nicely with Kubernetes. The integration of HyperContainer with Kubernetes, as we indicated in the title, is what makes up the <a href="https://github.com/hyperhq/hypernetes" target="_blank" rel="external">Hypernetes</a> project. </p>
<p><strong>Hypernetes</strong></p>
<p>One of the best parts of Kubernetes is that it is designed to support multiple container runtimes, meaning users are not locked-in to a single vendor. We are very pleased to announce that we have already begun working with the Kubernetes team to integrate HyperContainer into Kubernetes upstream. This integration involves:</p>
<ol>
<li>container runtime optimizing and refactoring</li>
<li>new client-server mode runtime interface</li>
<li>containerd integration to support runV</li>
</ol>
<p>The OCI standard and kubeletâ€™s multiple runtime architecture make this integration much easier even though HyperContainer is not based on Linux container technology stack.</p>
<p>On the other hand, in order to run HyperContainers in multi-tenant environment, we also created a new network plugin and modified an existing volume plugin. Since Hypernetes runs Pod as their own VMs, it can make use of your existing IaaS layer technologies for multi-tenant network and persistent volumes. The current Hypernetes implementation uses standard Openstack components.</p>
<p>Below we go into further details about how all those above are implemented.</p>
<p><strong>Identity and Authentication</strong></p>
<hr>
<p>In Hypernetes we chose <a href="http://docs.openstack.org/developer/keystone/" target="_blank" rel="external">Keystone</a> to manage different tenants and perform identification and authentication for tenants during any administrative operation. Since Keystone comes from the OpenStack ecosystem, it works seamlessly with the network and storage plugins we used in Hypernetes.</p>
<p><strong>Multi-tenant Network Model</strong></p>
<p>For a multi-tenant container cluster, each tenant needs to have strong network isolation from each other tenant. In Hypernetes, each tenant has its own Network. Instead of configuring a new network using OpenStack, which is complex, with Hypernetes, you just create a Network object like below.  </p>
<p>apiVersion: v1  kind: Network  metadata:    name: net1  spec:    tenantID: 065f210a2ca9442aad898ab129426350    subnets:      subnet1:        cidr: 192.168.0.0/24        gateway: 192.168.0.1</p>
<p>Note that the tenantID is supplied by Keystone. This yaml will automatically create a new Neutron network with a default router and a subnet 192.168.0.0/24. </p>
<p>A Network controller will be responsible for the life-cycle management of any Network instance created by the user. This Network can be assigned to one or more Namespaces, and any Pods belonging to the same Network can reach each other directly through IP address.  </p>
<p>apiVersion: v1  kind: Namespace  metadata:    name: ns1  spec:    network: net1  </p>
<p>If a Namespace does not have a Network spec, it will use the default Kubernetes network model instead, including the default kube-proxy. So if a user creates a Pod in a Namespace with an associated Network, Hypernetes will follow the <a href="http://kubernetes.io/docs/admin/network-plugins/" target="_blank" rel="external">Kubernetes Network Plugin Model</a> to set up a Neutron network for this Pod. Here is a high level example:</p>
<p><img src="https://lh4.googleusercontent.com/ij88fHWT3wDSxDh4W7S0sARfjdRd5oTJTZGT_r8oQoqoGGjZWmHLJtPG8TT3U_tZ2rFqK7lwK56l3UIq3csSUxSdgGvfzORaAEAkl9fChxiLzVgz-mExTMi8sxUlfsesS59G0Fsa" alt="A Hypernetes Network Workflow.png"></p>
<p>Hypernetes uses a standalone gRPC handler named kubestack to translate the Kubernetes Pod request into the Neutron network API. Moreover, kubestack is also responsible for handling another important networking feature: a multi-tenant Service proxy.</p>
<p>In a multi-tenant environment, the default iptables-based kube-proxy can not reach the individual Pods, because they are isolated into different networks. Instead, Hypernetes uses a <a href="https://github.com/hyperhq/hyperd/blob/2072dd8e28a02a25ae6a819f81029b47a579e683/servicediscovery/servicediscovery.go" target="_blank" rel="external">built-in HAproxy in every HyperContainer</a> as the portal. This HAproxy will proxy all the Service instances in the namespace of that Pod. Kube-proxy will be responsible for updating these backend servers by following the standard OnServiceUpdate and OnEndpointsUpdate processes, so that users will not notice any difference. A downside of this method is that HAproxy has to listen to some specific ports which may conflicts with userâ€™s containers.Thatâ€™s why we are planning to use LVS to replace this proxy in the next release.</p>
<p>With the help of the Neutron based network plugin, the Hypernetes Service is able to provide an OpenStack load balancer, just like how the â€œexternalâ€ load balancer does on GCE. When user creates a Service with external IPs, an OpenStack load balancer will be created and endpoints will be automatically updated through the kubestack workflow above.</p>
<p><strong>Persistent Storage</strong></p>
<p>When considering storage, we are actually building a tenant-aware persistent volume in Kubernetes. The reason we decided not to use existing Cinder volume plugin of Kubernetes is that its model does not work in the virtualization case. Specifically:</p>
<p>The Cinder volume plugin requires OpenStack as the Kubernetes provider.</p>
<p>The OpenStack provider will find on which VM the target Pod is running on</p>
<p>Cinder volume plugin will mount a Cinder volume to a path inside the host VM of Kubernetes.</p>
<p>The kubelet will bind mount this path as a volume into containers of target Pod.</p>
<p>But in Hypernetes, things become much simpler. Thanks to the physical boundary of Pods, HyperContainer can mount Cinder volumes directly as block devices into Pods, just like a normal VM. This mechanism eliminates extra time to query Nova to find out the VM of target Pod in the existing Cinder volume workflow listed above.</p>
<p>The current implementation of the Cinder plugin in Hypernetes is based on Ceph RBD backend, and it works the same as all other Kubernetes volume plugins, one just needs to remember to create the Cinder volume (referenced by volumeID below) beforehand.  </p>
<p>apiVersion: v1  kind: Pod  metadata:    name: nginx    labels:      app: nginx  spec:    containers:    - name: nginx      image: nginx      ports:      - containerPort: 80      volumeMounts:      - name: nginx-persistent-storage        mountPath: /var/lib/nginx    volumes:    - name: nginx-persistent-storage      cinder:        volumeID: 651b2a7b-683e-47e1-bdd6-e3c62e8f91c0        fsType: ext4  </p>
<p>So when the user provides a Pod yaml with a Cinder volume, Hypernetes will check if kubelet is using the Hyper container runtime. If so, the Cinder volume can be mounted directly to the Pod without any extra path mapping. Then the volume metadata will be passed to the Kubelet RunPod process as part of HyperContainer spec. Done!</p>
<p>Thanks to the plugin model of Kubernetes network and volume, we can easily build our own solutions above for HyperContainer though it is essentially different from the traditional Linux container. We also plan to propose these solutions to Kubernetes upstream by following the CNI model and volume plugin standard after the runtime integration is completed.</p>
<p>We believe all of these <a href="https://github.com/hyperhq/" target="_blank" rel="external">open source projects</a> are important components of the container ecosystem, and their growth depends greatly on the open source spirit and technical vision of the Kubernetes team. </p>
<p><strong>Conclusion</strong></p>
<p>This post introduces some of the technical details about HyperContainer and the Hypernetes project. We hope that people will be interested in this new category of secure container and its integration with Kubernetes. If you are looking to try out Hypernetes and HyperContainer, we have just announced the public beta of our new secure container cloud service (<a href="https://hyper.sh/" target="_blank" rel="external">Hyper_</a>), which is built on these technologies. But even if you are running on-premise, we believe that Hypernetes and HyperContainer will let you run Kubernetes in a more secure way.</p>
<p><em>~Harry Zhang and Pengfei Ni, engineers at HyperHQ</em></p>
]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;Notes: this post is copied from &lt;a href=&quot;http://blog.kubernetes.io/2016/05/hypernetes-security-and-multi-tenancy-in-kubernet
    
    </summary>
    
    
      <category term="Kubernetes" scheme="http://feisky.xyz/tags/Kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>How docker 1.11 share network accross containers</title>
    <link href="http://feisky.xyz/2016/05/11/How-docker-1-11-share-network-accross-containers/"/>
    <id>http://feisky.xyz/2016/05/11/How-docker-1-11-share-network-accross-containers/</id>
    <published>2016-05-11T02:25:06.000Z</published>
    <updated>2016-12-15T00:14:54.373Z</updated>
    
    <content type="html"><![CDATA[<p>Docker 1.11 has moved to runc with containerd, I am interested in how it processing shared netns accross containers.</p>
<p>For example, I have already running a container 75599a6f387b7842c6da57efd38f9742b2ca621782f891402f83852c66dbd706. A new container within same netns can be created with cmd:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><div class="line">docker run -itd --net=container:75599a6f387b alpine sh</div></pre></td></tr></table></figure>
<p>This will generate a runc <code>config.json</code> as follows:</p>
<figure class="highlight json"><table><tr><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="attr">"ociVersion"</span>: <span class="string">"0.6.0-dev"</span>,</div><div class="line">    <span class="attr">"platform"</span>: &#123;</div><div class="line">        <span class="attr">"os"</span>: <span class="string">"linux"</span>,</div><div class="line">        <span class="attr">"arch"</span>: <span class="string">"amd64"</span></div><div class="line">    &#125;,</div><div class="line">    <span class="attr">"process"</span>: &#123;</div><div class="line">        <span class="attr">"terminal"</span>: <span class="literal">true</span>,</div><div class="line">        <span class="attr">"user"</span>: &#123;</div><div class="line">            <span class="attr">"additionalGids"</span>: [</div><div class="line">                <span class="number">0</span>,</div><div class="line">                <span class="number">1</span>,</div><div class="line">                <span class="number">2</span>,</div><div class="line">                <span class="number">3</span>,</div><div class="line">                <span class="number">4</span>,</div><div class="line">                <span class="number">6</span>,</div><div class="line">                <span class="number">10</span>,</div><div class="line">                <span class="number">11</span>,</div><div class="line">                <span class="number">20</span>,</div><div class="line">                <span class="number">26</span>,</div><div class="line">                <span class="number">27</span></div><div class="line">            ]</div><div class="line">        &#125;,</div><div class="line">        <span class="attr">"args"</span>: [</div><div class="line">            <span class="string">"sh"</span></div><div class="line">        ],</div><div class="line">        <span class="attr">"env"</span>: [</div><div class="line">            <span class="string">"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"</span>,</div><div class="line">            <span class="string">"HOSTNAME=75599a6f387b"</span>,</div><div class="line">            <span class="string">"TERM=xterm"</span></div><div class="line">        ],</div><div class="line">        <span class="attr">"cwd"</span>: <span class="string">"/"</span>,</div><div class="line">        <span class="attr">"capabilities"</span>: [</div><div class="line">            <span class="string">"CAP_CHOWN"</span>,</div><div class="line">            <span class="string">"CAP_DAC_OVERRIDE"</span>,</div><div class="line">            <span class="string">"CAP_FSETID"</span>,</div><div class="line">            <span class="string">"CAP_FOWNER"</span>,</div><div class="line">            <span class="string">"CAP_MKNOD"</span>,</div><div class="line">            <span class="string">"CAP_NET_RAW"</span>,</div><div class="line">            <span class="string">"CAP_SETGID"</span>,</div><div class="line">            <span class="string">"CAP_SETUID"</span>,</div><div class="line">            <span class="string">"CAP_SETFCAP"</span>,</div><div class="line">            <span class="string">"CAP_SETPCAP"</span>,</div><div class="line">            <span class="string">"CAP_NET_BIND_SERVICE"</span>,</div><div class="line">            <span class="string">"CAP_SYS_CHROOT"</span>,</div><div class="line">            <span class="string">"CAP_KILL"</span>,</div><div class="line">            <span class="string">"CAP_AUDIT_WRITE"</span></div><div class="line">        ]</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">"root"</span>: &#123;</div><div class="line">        <span class="attr">"path"</span>: <span class="string">"/var/lib/docker/devicemapper/mnt/d33c7932917e64bde482b437fc3ccaad9a00a04e0cf49e39f9d3be5d71991db6/rootfs"</span>,</div><div class="line">        <span class="attr">"readonly"</span>: <span class="literal">false</span></div><div class="line">    &#125;,</div><div class="line">    <span class="attr">"hostname"</span>: <span class="string">"75599a6f387b"</span>,</div><div class="line">    <span class="attr">"mounts"</span>: [</div><div class="line">        &#123;</div><div class="line">            <span class="attr">"destination"</span>: <span class="string">"/proc"</span>,</div><div class="line">            <span class="attr">"type"</span>: <span class="string">"proc"</span>,</div><div class="line">            <span class="attr">"source"</span>: <span class="string">"proc"</span>,</div><div class="line">            <span class="attr">"options"</span>: [</div><div class="line">                <span class="string">"nosuid"</span>,</div><div class="line">                <span class="string">"noexec"</span>,</div><div class="line">                <span class="string">"nodev"</span></div><div class="line">            ]</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            <span class="attr">"destination"</span>: <span class="string">"/dev"</span>,</div><div class="line">            <span class="attr">"type"</span>: <span class="string">"tmpfs"</span>,</div><div class="line">            <span class="attr">"source"</span>: <span class="string">"tmpfs"</span>,</div><div class="line">            <span class="attr">"options"</span>: [</div><div class="line">                <span class="string">"nosuid"</span>,</div><div class="line">                <span class="string">"strictatime"</span>,</div><div class="line">                <span class="string">"mode=755"</span></div><div class="line">            ]</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            <span class="attr">"destination"</span>: <span class="string">"/dev/pts"</span>,</div><div class="line">            <span class="attr">"type"</span>: <span class="string">"devpts"</span>,</div><div class="line">            <span class="attr">"source"</span>: <span class="string">"devpts"</span>,</div><div class="line">            <span class="attr">"options"</span>: [</div><div class="line">                <span class="string">"nosuid"</span>,</div><div class="line">                <span class="string">"noexec"</span>,</div><div class="line">                <span class="string">"newinstance"</span>,</div><div class="line">                <span class="string">"ptmxmode=0666"</span>,</div><div class="line">                <span class="string">"mode=0620"</span>,</div><div class="line">                <span class="string">"gid=5"</span></div><div class="line">            ]</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            <span class="attr">"destination"</span>: <span class="string">"/sys"</span>,</div><div class="line">            <span class="attr">"type"</span>: <span class="string">"sysfs"</span>,</div><div class="line">            <span class="attr">"source"</span>: <span class="string">"sysfs"</span>,</div><div class="line">            <span class="attr">"options"</span>: [</div><div class="line">                <span class="string">"nosuid"</span>,</div><div class="line">                <span class="string">"noexec"</span>,</div><div class="line">                <span class="string">"nodev"</span>,</div><div class="line">                <span class="string">"ro"</span></div><div class="line">            ]</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            <span class="attr">"destination"</span>: <span class="string">"/sys/fs/cgroup"</span>,</div><div class="line">            <span class="attr">"type"</span>: <span class="string">"cgroup"</span>,</div><div class="line">            <span class="attr">"source"</span>: <span class="string">"cgroup"</span>,</div><div class="line">            <span class="attr">"options"</span>: [</div><div class="line">                <span class="string">"ro"</span>,</div><div class="line">                <span class="string">"nosuid"</span>,</div><div class="line">                <span class="string">"noexec"</span>,</div><div class="line">                <span class="string">"nodev"</span></div><div class="line">            ]</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            <span class="attr">"destination"</span>: <span class="string">"/dev/mqueue"</span>,</div><div class="line">            <span class="attr">"type"</span>: <span class="string">"mqueue"</span>,</div><div class="line">            <span class="attr">"source"</span>: <span class="string">"mqueue"</span>,</div><div class="line">            <span class="attr">"options"</span>: [</div><div class="line">                <span class="string">"nosuid"</span>,</div><div class="line">                <span class="string">"noexec"</span>,</div><div class="line">                <span class="string">"nodev"</span></div><div class="line">            ]</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            <span class="attr">"destination"</span>: <span class="string">"/etc/resolv.conf"</span>,</div><div class="line">            <span class="attr">"type"</span>: <span class="string">"bind"</span>,</div><div class="line">            <span class="attr">"source"</span>: <span class="string">"/var/lib/docker/containers/75599a6f387b7842c6da57efd38f9742b2ca621782f891402f83852c66dbd706/resolv.conf"</span>,</div><div class="line">            <span class="attr">"options"</span>: [</div><div class="line">                <span class="string">"rbind"</span>,</div><div class="line">                <span class="string">"rprivate"</span></div><div class="line">            ]</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            <span class="attr">"destination"</span>: <span class="string">"/etc/hostname"</span>,</div><div class="line">            <span class="attr">"type"</span>: <span class="string">"bind"</span>,</div><div class="line">            <span class="attr">"source"</span>: <span class="string">"/var/lib/docker/containers/75599a6f387b7842c6da57efd38f9742b2ca621782f891402f83852c66dbd706/hostname"</span>,</div><div class="line">            <span class="attr">"options"</span>: [</div><div class="line">                <span class="string">"rbind"</span>,</div><div class="line">                <span class="string">"rprivate"</span></div><div class="line">            ]</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            <span class="attr">"destination"</span>: <span class="string">"/etc/hosts"</span>,</div><div class="line">            <span class="attr">"type"</span>: <span class="string">"bind"</span>,</div><div class="line">            <span class="attr">"source"</span>: <span class="string">"/var/lib/docker/containers/75599a6f387b7842c6da57efd38f9742b2ca621782f891402f83852c66dbd706/hosts"</span>,</div><div class="line">            <span class="attr">"options"</span>: [</div><div class="line">                <span class="string">"rbind"</span>,</div><div class="line">                <span class="string">"rprivate"</span></div><div class="line">            ]</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            <span class="attr">"destination"</span>: <span class="string">"/dev/shm"</span>,</div><div class="line">            <span class="attr">"type"</span>: <span class="string">"bind"</span>,</div><div class="line">            <span class="attr">"source"</span>: <span class="string">"/var/lib/docker/containers/d8230e57e88d15515a94138ef512a4271e31d03bb6fb257b3d57a847e70b5c68/shm"</span>,</div><div class="line">            <span class="attr">"options"</span>: [</div><div class="line">                <span class="string">"rbind"</span>,</div><div class="line">                <span class="string">"rprivate"</span></div><div class="line">            ]</div><div class="line">        &#125;</div><div class="line">    ],</div><div class="line">    <span class="attr">"hooks"</span>: &#123;&#125;,</div><div class="line">    <span class="attr">"linux"</span>: &#123;</div><div class="line">        <span class="attr">"resources"</span>: &#123;</div><div class="line">            <span class="attr">"devices"</span>: [</div><div class="line">                &#123;</div><div class="line">                    <span class="attr">"allow"</span>: <span class="literal">false</span>,</div><div class="line">                    <span class="attr">"access"</span>: <span class="string">"rwm"</span></div><div class="line">                &#125;,</div><div class="line">                &#123;</div><div class="line">                    <span class="attr">"allow"</span>: <span class="literal">true</span>,</div><div class="line">                    <span class="attr">"type"</span>: <span class="string">"c"</span>,</div><div class="line">                    <span class="attr">"major"</span>: <span class="number">1</span>,</div><div class="line">                    <span class="attr">"minor"</span>: <span class="number">5</span>,</div><div class="line">                    <span class="attr">"access"</span>: <span class="string">"rwm"</span></div><div class="line">                &#125;,</div><div class="line">                &#123;</div><div class="line">                    <span class="attr">"allow"</span>: <span class="literal">true</span>,</div><div class="line">                    <span class="attr">"type"</span>: <span class="string">"c"</span>,</div><div class="line">                    <span class="attr">"major"</span>: <span class="number">1</span>,</div><div class="line">                    <span class="attr">"minor"</span>: <span class="number">3</span>,</div><div class="line">                    <span class="attr">"access"</span>: <span class="string">"rwm"</span></div><div class="line">                &#125;,</div><div class="line">                &#123;</div><div class="line">                    <span class="attr">"allow"</span>: <span class="literal">true</span>,</div><div class="line">                    <span class="attr">"type"</span>: <span class="string">"c"</span>,</div><div class="line">                    <span class="attr">"major"</span>: <span class="number">1</span>,</div><div class="line">                    <span class="attr">"minor"</span>: <span class="number">9</span>,</div><div class="line">                    <span class="attr">"access"</span>: <span class="string">"rwm"</span></div><div class="line">                &#125;,</div><div class="line">                &#123;</div><div class="line">                    <span class="attr">"allow"</span>: <span class="literal">true</span>,</div><div class="line">                    <span class="attr">"type"</span>: <span class="string">"c"</span>,</div><div class="line">                    <span class="attr">"major"</span>: <span class="number">1</span>,</div><div class="line">                    <span class="attr">"minor"</span>: <span class="number">8</span>,</div><div class="line">                    <span class="attr">"access"</span>: <span class="string">"rwm"</span></div><div class="line">                &#125;,</div><div class="line">                &#123;</div><div class="line">                    <span class="attr">"allow"</span>: <span class="literal">true</span>,</div><div class="line">                    <span class="attr">"type"</span>: <span class="string">"c"</span>,</div><div class="line">                    <span class="attr">"major"</span>: <span class="number">5</span>,</div><div class="line">                    <span class="attr">"minor"</span>: <span class="number">0</span>,</div><div class="line">                    <span class="attr">"access"</span>: <span class="string">"rwm"</span></div><div class="line">                &#125;,</div><div class="line">                &#123;</div><div class="line">                    <span class="attr">"allow"</span>: <span class="literal">true</span>,</div><div class="line">                    <span class="attr">"type"</span>: <span class="string">"c"</span>,</div><div class="line">                    <span class="attr">"major"</span>: <span class="number">5</span>,</div><div class="line">                    <span class="attr">"minor"</span>: <span class="number">1</span>,</div><div class="line">                    <span class="attr">"access"</span>: <span class="string">"rwm"</span></div><div class="line">                &#125;,</div><div class="line">                &#123;</div><div class="line">                    <span class="attr">"allow"</span>: <span class="literal">false</span>,</div><div class="line">                    <span class="attr">"type"</span>: <span class="string">"c"</span>,</div><div class="line">                    <span class="attr">"major"</span>: <span class="number">10</span>,</div><div class="line">                    <span class="attr">"minor"</span>: <span class="number">229</span>,</div><div class="line">                    <span class="attr">"access"</span>: <span class="string">"rwm"</span></div><div class="line">                &#125;</div><div class="line">            ],</div><div class="line">            <span class="attr">"disableOOMKiller"</span>: <span class="literal">false</span>,</div><div class="line">            <span class="attr">"oomScoreAdj"</span>: <span class="number">0</span>,</div><div class="line">            <span class="attr">"memory"</span>: &#123;</div><div class="line">                <span class="attr">"kernelTCP"</span>: <span class="literal">null</span>,</div><div class="line">                <span class="attr">"swappiness"</span>: <span class="number">18446744073709551615</span></div><div class="line">            &#125;,</div><div class="line">            <span class="attr">"cpu"</span>: &#123;&#125;,</div><div class="line">            <span class="attr">"pids"</span>: &#123;</div><div class="line">                <span class="attr">"limit"</span>: <span class="number">0</span></div><div class="line">            &#125;,</div><div class="line">            <span class="attr">"blockIO"</span>: &#123;</div><div class="line">                <span class="attr">"blkioWeight"</span>: <span class="number">0</span></div><div class="line">            &#125;</div><div class="line">        &#125;,</div><div class="line">        <span class="attr">"cgroupsPath"</span>: <span class="string">"/docker/d8230e57e88d15515a94138ef512a4271e31d03bb6fb257b3d57a847e70b5c68"</span>,</div><div class="line">        <span class="attr">"namespaces"</span>: [</div><div class="line">            &#123;</div><div class="line">                <span class="attr">"type"</span>: <span class="string">"mount"</span></div><div class="line">            &#125;,</div><div class="line">            &#123;</div><div class="line">                <span class="attr">"type"</span>: <span class="string">"network"</span>,</div><div class="line">                <span class="attr">"path"</span>: <span class="string">"/proc/14702/ns/net"</span></div><div class="line">            &#125;,</div><div class="line">            &#123;</div><div class="line">                <span class="attr">"type"</span>: <span class="string">"uts"</span></div><div class="line">            &#125;,</div><div class="line">            &#123;</div><div class="line">                <span class="attr">"type"</span>: <span class="string">"pid"</span></div><div class="line">            &#125;,</div><div class="line">            &#123;</div><div class="line">                <span class="attr">"type"</span>: <span class="string">"ipc"</span></div><div class="line">            &#125;</div><div class="line">        ],</div><div class="line">        <span class="attr">"devices"</span>: [</div><div class="line">            &#123;</div><div class="line">                <span class="attr">"path"</span>: <span class="string">"/dev/zero"</span>,</div><div class="line">                <span class="attr">"type"</span>: <span class="string">"c"</span>,</div><div class="line">                <span class="attr">"major"</span>: <span class="number">1</span>,</div><div class="line">                <span class="attr">"minor"</span>: <span class="number">5</span>,</div><div class="line">                <span class="attr">"fileMode"</span>: <span class="number">438</span>,</div><div class="line">                <span class="attr">"uid"</span>: <span class="number">0</span>,</div><div class="line">                <span class="attr">"gid"</span>: <span class="number">0</span></div><div class="line">            &#125;,</div><div class="line">            &#123;</div><div class="line">                <span class="attr">"path"</span>: <span class="string">"/dev/null"</span>,</div><div class="line">                <span class="attr">"type"</span>: <span class="string">"c"</span>,</div><div class="line">                <span class="attr">"major"</span>: <span class="number">1</span>,</div><div class="line">                <span class="attr">"minor"</span>: <span class="number">3</span>,</div><div class="line">                <span class="attr">"fileMode"</span>: <span class="number">438</span>,</div><div class="line">                <span class="attr">"uid"</span>: <span class="number">0</span>,</div><div class="line">                <span class="attr">"gid"</span>: <span class="number">0</span></div><div class="line">            &#125;,</div><div class="line">            &#123;</div><div class="line">                <span class="attr">"path"</span>: <span class="string">"/dev/urandom"</span>,</div><div class="line">                <span class="attr">"type"</span>: <span class="string">"c"</span>,</div><div class="line">                <span class="attr">"major"</span>: <span class="number">1</span>,</div><div class="line">                <span class="attr">"minor"</span>: <span class="number">9</span>,</div><div class="line">                <span class="attr">"fileMode"</span>: <span class="number">438</span>,</div><div class="line">                <span class="attr">"uid"</span>: <span class="number">0</span>,</div><div class="line">                <span class="attr">"gid"</span>: <span class="number">0</span></div><div class="line">            &#125;,</div><div class="line">            &#123;</div><div class="line">                <span class="attr">"path"</span>: <span class="string">"/dev/random"</span>,</div><div class="line">                <span class="attr">"type"</span>: <span class="string">"c"</span>,</div><div class="line">                <span class="attr">"major"</span>: <span class="number">1</span>,</div><div class="line">                <span class="attr">"minor"</span>: <span class="number">8</span>,</div><div class="line">                <span class="attr">"fileMode"</span>: <span class="number">438</span>,</div><div class="line">                <span class="attr">"uid"</span>: <span class="number">0</span>,</div><div class="line">                <span class="attr">"gid"</span>: <span class="number">0</span></div><div class="line">            &#125;,</div><div class="line">            &#123;</div><div class="line">                <span class="attr">"path"</span>: <span class="string">"/dev/fuse"</span>,</div><div class="line">                <span class="attr">"type"</span>: <span class="string">"c"</span>,</div><div class="line">                <span class="attr">"major"</span>: <span class="number">10</span>,</div><div class="line">                <span class="attr">"minor"</span>: <span class="number">229</span>,</div><div class="line">                <span class="attr">"fileMode"</span>: <span class="number">438</span>,</div><div class="line">                <span class="attr">"uid"</span>: <span class="number">0</span>,</div><div class="line">                <span class="attr">"gid"</span>: <span class="number">0</span></div><div class="line">            &#125;</div><div class="line">        ],</div><div class="line">        <span class="attr">"maskedPaths"</span>: [</div><div class="line">            <span class="string">"/proc/kcore"</span>,</div><div class="line">            <span class="string">"/proc/latency_stats"</span>,</div><div class="line">            <span class="string">"/proc/timer_stats"</span>,</div><div class="line">            <span class="string">"/proc/sched_debug"</span></div><div class="line">        ],</div><div class="line">        <span class="attr">"readonlyPaths"</span>: [</div><div class="line">            <span class="string">"/proc/asound"</span>,</div><div class="line">            <span class="string">"/proc/bus"</span>,</div><div class="line">            <span class="string">"/proc/fs"</span>,</div><div class="line">            <span class="string">"/proc/irq"</span>,</div><div class="line">            <span class="string">"/proc/sys"</span>,</div><div class="line">            <span class="string">"/proc/sysrq-trigger"</span></div><div class="line">        ]</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>So, it is very clear how it works:</p>
<ul>
<li>New container mounts same network namespace <code>/proc/14702/ns/net</code></li>
<li>New container mounts same network related configs, such as <code>/etc/resolv.conf</code>, <code>/etc/hosts</code> and <code>/etc/hostname</code></li>
</ul>
<p>There is still a little problem when first container is deleted: it could be deleted without any warning, but after delete operation, the second container will become not functional:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><div class="line">[~]<span class="comment"># docker ps</span></div><div class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES</div><div class="line">d8230e57e88d        alpine              <span class="string">"sh"</span>                14 minutes ago      Up 14 minutes                           focused_spence</div><div class="line">[~]<span class="comment"># docker exec d8230e57e88d echo aaa</span></div><div class="line">rpc error: code = 2 desc = <span class="string">"oci runtime error: exec failed: lstat /proc/14702/ns/net: no such file or directory"</span></div></pre></td></tr></table></figure>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Docker 1.11 has moved to runc with containerd, I am interested in how it processing shared netns accross containers.&lt;/p&gt;
&lt;p&gt;For example, 
    
    </summary>
    
    
      <category term="docker" scheme="http://feisky.xyz/tags/docker/"/>
    
  </entry>
  
  <entry>
    <title>Go performance optimize</title>
    <link href="http://feisky.xyz/2016/05/06/Go-performance-optimize/"/>
    <id>http://feisky.xyz/2016/05/06/Go-performance-optimize/</id>
    <published>2016-05-06T12:40:06.000Z</published>
    <updated>2016-12-15T00:14:54.373Z</updated>
    
    <content type="html"><![CDATA[<p><em>*[Goæ€§èƒ½ä¼˜åŒ–æŠ€å·§(By é›¨ç—•)](<a href="http://mp.weixin.qq.com/s?src=3&amp;timestamp=1461920086&amp;ver=1&amp;signature=dvsw--b6KnMYdRt43I2g4kMRIN37-tbcl2AnwpG58mxVaoZpqG24Aou2amIcFH1aIgXelirKZ0iSYJnPud" target="_blank" rel="external">http://mp.weixin.qq.com/s?src=3&amp;timestamp=1461920086&amp;ver=1&amp;signature=dvsw--b6KnMYdRt43I2g4kMRIN37-tbcl2AnwpG58mxVaoZpqG24Aou2amIcFH1aIgXelirKZ0iSYJnPud</a></em>qh3uzFrbmeM<em>bcDNCVC0t</em>m4oEblW1GOp0FHTsG-lSzRzE67RaskRf7u4<em>B5NZlkmYhTbWJNF44Bvwz9D58</em>D-54=)</p>
<ol>
<li>å­—ç¬¦ä¸²ï¼ˆstringï¼‰ä½œä¸ºä¸€ç§ä¸å¯å˜ç±»å‹ï¼Œåœ¨ä¸å­—èŠ‚æ•°ç»„ï¼ˆslice, [ ]byteï¼‰è½¬æ¢æ—¶éœ€ä»˜å‡º â€œæ²‰é‡â€ ä»£ä»·ï¼Œæ ¹æœ¬åŸå› æ˜¯å¯¹åº•å±‚å­—èŠ‚æ•°ç»„çš„å¤åˆ¶ã€‚</li>
</ol>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"unsafe"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">str2bytes</span><span class="params">(s <span class="keyword">string</span>)</span> []<span class="title">byte</span></span> &#123;</div><div class="line">    ptr := (*[<span class="number">2</span>]<span class="keyword">uintptr</span>)(unsafe.Pointer(&amp;s))</div><div class="line">    btr := [<span class="number">3</span>]<span class="keyword">uintptr</span>&#123;ptr[<span class="number">0</span>], ptr[<span class="number">1</span>], ptr[<span class="number">1</span>]&#125;</div><div class="line">    <span class="keyword">return</span> *(*[]<span class="keyword">byte</span>)(unsafe.Pointer(&amp;btr))</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">bytes2str</span><span class="params">(b []<span class="keyword">byte</span>)</span> <span class="title">string</span></span> &#123;</div><div class="line">    <span class="keyword">return</span> *(*<span class="keyword">string</span>)(unsafe.Pointer(&amp;b))</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    s := <span class="string">"abcdefghi"</span></div><div class="line">    b := str2bytes(s)</div><div class="line">    s2 := bytes2str(b)</div><div class="line"></div><div class="line">    fmt.Println(s, b, s2)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li><p>Go Proverbs: A little copying is better than a little dependency. å¯¹äºä¸€äº›çŸ­å°çš„å¯¹è±¡ï¼Œå¤åˆ¶æˆæœ¬è¿œå°äºåœ¨å †ä¸Šåˆ†é…å’Œå›æ”¶æ“ä½œã€‚</p>
</li>
<li><p>mapé¢„è®¾å®¹é‡ï¼šmap ä¼šæŒ‰éœ€æ‰©å¼ ï¼Œä½†é¡»ä»˜å‡ºæ•°æ®æ‹·è´å’Œé‡æ–°å“ˆå¸Œæˆæœ¬ã€‚å¦‚æœ‰å¯èƒ½ï¼Œåº”å°½å¯èƒ½é¢„è®¾è¶³å¤Ÿå®¹é‡ç©ºé—´ï¼Œé¿å…æ­¤ç±»è¡Œä¸ºå‘ç”Ÿã€‚</p>
</li>
<li><p>mapç›´æ¥å­˜å‚¨ï¼Œå¯¹äºå°å¯¹è±¡ï¼Œç›´æ¥å°†æ•°æ®äº¤ç”± map ä¿å­˜ï¼Œè¿œæ¯”ç”¨æŒ‡é’ˆé«˜æ•ˆã€‚è¿™ä¸ä½†å‡å°‘äº†å †å†…å­˜åˆ†é…ï¼Œå…³é”®è¿˜åœ¨äºåƒåœ¾å›æ”¶å™¨ä¸ä¼šæ‰«æéæŒ‡é’ˆç±»å‹ key/value å¯¹è±¡ã€‚</p>
</li>
<li><p>deferçš„ä»£ä»·:ç¼–è¯‘å™¨é€šè¿‡ runtime.deferproc â€œæ³¨å†Œâ€ å»¶è¿Ÿè°ƒç”¨ï¼Œé™¤ç›®æ ‡å‡½æ•°åœ°å€å¤–ï¼Œè¿˜ä¼šå¤åˆ¶ç›¸å…³å‚æ•°ï¼ˆåŒ…æ‹¬ receiverï¼‰ã€‚åœ¨å‡½æ•°è¿”å›å‰ï¼Œæ‰§è¡Œ runtime.deferreturn æå–ç›¸å…³ä¿¡æ¯æ‰§è¡Œå»¶è¿Ÿè°ƒç”¨ã€‚è¿™å…¶ä¸­çš„ä»£ä»·è‡ªç„¶ä¸æ˜¯æ™®é€šå‡½æ•°è°ƒç”¨ä¸€æ¡ CALL æŒ‡ä»¤æ‰€èƒ½æ¯”æ‹Ÿçš„ã€‚å¯ä»¥è€ƒè™‘å°†å†…å±‚å¤„ç†é€»è¾‘è½¬æ¢ä¸ºåŒ¿åå‡½æ•°.</p>
</li>
<li><p>ä¸åˆç†çš„é—­åŒ…ä¼šé€ æˆæ€§èƒ½é—®é¢˜ï¼Œæ¯”å¦‚é—­åŒ…å¼•ç”¨åŸç¯å¢ƒå˜é‡ä¼šå¯¼è‡´Data Raceå¹¶å˜é‡é€ƒé€¸åˆ°å †ä¸Šï¼Œå¢åŠ GCæ‰«æå’Œå›æ”¶çš„è´Ÿæ‹….</p>
</li>
<li><p>Channelï¼š Donâ€™t communicate by sharing memory, share memory by communicating.</p>
</li>
</ol>
<blockquote>
<p>å¦‚æœè¯´ channel é€‚ç”¨äºç»“æ„å±‚é¢è§£è€¦ï¼Œé‚£ä¹ˆ mutex åˆ™é€‚åˆä¿æŠ¤è¯­å¥çº§åˆ«çš„æ•°æ®å®‰å…¨ã€‚è‡³äº atomicï¼Œè™½ç„¶ä¹Ÿå¯å®ç° lock-free ç»“æ„ï¼Œä½†å¤„ç†èµ·æ¥è¦å¤æ‚å¾—å¤šï¼ˆæ¯”å¦‚ ABA ç­‰é—®é¢˜ï¼‰ï¼Œä¹Ÿæœªå¿…å°±æ¯” mutex å¿«å¾ˆå¤šã€‚è¿˜æœ‰ï¼Œsync.Mutex æœ¬å°±æ²¡æœ‰ä½¿ç”¨å†…æ ¸å®ç°ï¼Œè€Œæ˜¯åƒ Futex é‚£æ ·ï¼Œç›´æ¥åœ¨ç”¨æˆ·ç©ºé—´ä»¥ atomic æ“ä½œå®Œæˆï¼Œå› ä¸º runtime æ²¡æœ‰ä»»ä½•ç†ç”±å°†å‰©ä½™ CPU æ—¶é—´ç‰‡è¿˜ç»™å†…æ ¸ã€‚</p>
</blockquote>
<ol>
<li>å…³äºinterface:</li>
</ol>
<blockquote>
<p>æ¥å£çš„ç”¨é€”æ— éœ€å¤šè¨€ã€‚ä½†è¿™å¹¶ä¸æ„å‘³ç€å¯åœ¨ä»»ä½•åœºåˆä½¿ç”¨æ¥å£ï¼Œè¦çŸ¥é“é€šè¿‡æ¥å£è°ƒç”¨å’Œæ™®é€šè°ƒç”¨å­˜åœ¨å¾ˆå¤§å·®åˆ«ã€‚é¦–å…ˆï¼Œç›¸æ¯”é™æ€ç»‘å®šï¼ŒåŠ¨æ€ç»‘å®šæ€§èƒ½è¦å·®å¾ˆå¤šï¼›å…¶æ¬¡ï¼Œè¿è¡ŒæœŸéœ€é¢å¤–å¼€é”€ï¼Œæ¯”å¦‚æ¥å£ä¼šå¤åˆ¶å¯¹è±¡ï¼Œå“ªæ€•ä»…æ˜¯ä¸ªæŒ‡é’ˆï¼Œä¹Ÿä¼šåœ¨å †ä¸Šå¢åŠ ä¸€ä¸ªéœ€ GC å¤„ç†çš„ç›®æ ‡ã€‚</p>
</blockquote>
<ol>
<li><p>å°½ç®¡åå°„ï¼ˆreflectï¼‰å­˜åœ¨æ€§èƒ½é—®é¢˜ï¼Œä½†ä¾ç„¶è¢«é¢‘ç¹ä½¿ç”¨ï¼Œä»¥å¼¥è¡¥é™æ€è¯­è¨€åœ¨åŠ¨æ€è¡Œä¸ºä¸Šçš„ä¸è¶³ã€‚åªæ˜¯æŸäº›æ—¶å€™ï¼Œæˆ‘ä»¬é¡»å¯¹æ­¤åšäº›å˜é€šï¼Œä»¥æå‡æ€§èƒ½ã€‚åˆ©ç”¨æŒ‡é’ˆç±»å‹è½¬æ¢å®ç°æ€§èƒ½ä¼˜åŒ–ï¼Œæœ¬å°±æ˜¯ â€œéå¸¸æ‰‹æ®µâ€ï¼Œæ˜¯ä¸€ç§ä¸ºäº†æ€§èƒ½è€Œæ”¾å¼ƒ â€œå…¶ä»–â€ çš„åšæ³•ã€‚ä¸å…¶æ‹…å¿ƒä»£ç æ˜¯å¦é€‚åº”æœªæ¥çš„å˜åŒ–ï¼Œä¸å¦‚å†™ä¸ªå•å…ƒæµ‹è¯•ï¼Œç¡®ä¿åœ¨å‡çº§æ—¶åšå‡ºå¿…è¦çš„å®‰å…¨æ£€æŸ¥ã€‚ <a href="http://mp.weixin.qq.com/s?timestamp=1462538257&amp;src=3&amp;ver=1&amp;signature=dth4TWXJxgxWRCAQDVFbKniJE-JCeVdqp0eMklk4f0kgrbb7QuS7xs5KDDFwmZg0ba6tMcn41JsyNZceCzyp5nErTGnWK-K9wlgOp9wAw5S3bbeBa3-BkGp3r*kN-ORevh9Iuo1UnjtFWtOoEoSX0vTH6uxMcP7*Ts0r0f4yhzE=" target="_blank" rel="external">Link</a></p>
</li>
<li><p>ä½œä¸ºå†…ç½®ç±»å‹ï¼Œé€šé“ï¼ˆchannelï¼‰ä»è¿è¡Œæ—¶å¾—åˆ°å¾ˆå¤šæ”¯æŒï¼Œå…¶è‡ªèº«è®¾è®¡ä¹Ÿç®—å¾—ä¸Šç²¾å·§ã€‚ä½†ä¸ç®¡æ€ä¹ˆè¯´ï¼Œå®ƒæœ¬è´¨ä¸Šä¾æ—§æ˜¯ä¸€ç§é˜Ÿåˆ—ï¼Œå½“å¤šä¸ª goroutine å¹¶å‘æ“ä½œæ—¶ï¼Œå…ä¸äº†è¦ä½¿ç”¨é”ã€‚æŸäº›æ—¶å€™ï¼Œè¿™ç§ç«äº‰æœºåˆ¶ï¼Œä¼šå¯¼è‡´æ€§èƒ½é—®é¢˜ã€‚[åœ¨ç ”ç©¶ go runtime æºç å®ç°è¿‡ç¨‹ä¸­ï¼Œä¼šçœ‹åˆ°å¤§é‡åˆ©ç”¨ â€œæ‰¹æ“ä½œâ€ æ¥æå‡æ€§èƒ½çš„æ ·ä¾‹)(<a href="http://mp.weixin.qq.com/s?timestamp=1462538257&amp;src=3&amp;ver=1&amp;signature=dth4TWXJxgxWRCAQDVFbKniJE-JCeVdqp0eMklk4f0kgrbb7QuS7xs5KDDFwmZg0ba6tMcn41JsyNZceCzyp5pZfVq*Q5bYXUHM1nH0kMNsPL3e92xy5a0zTraWNTSnQ9u8Ie3b9rjnbg0blEE3NEoenRnmCV3MpZdqseFiuy*A=" target="_blank" rel="external">http://mp.weixin.qq.com/s?timestamp=1462538257&amp;src=3&amp;ver=1&amp;signature=dth4TWXJxgxWRCAQDVFbKniJE-JCeVdqp0eMklk4f0kgrbb7QuS7xs5KDDFwmZg0ba6tMcn41JsyNZceCzyp5pZfVq*Q5bYXUHM1nH0kMNsPL3e92xy5a0zTraWNTSnQ9u8Ie3b9rjnbg0blEE3NEoenRnmCV3MpZdqseFiuy*A=</a>)</p>
</li>
<li><p>Goroutine Leak: æç®€å•çš„æ¼”ç¤ºï¼Œæˆ‘ä»¬æ³¨é‡Šæ‰æ•°æ®è¯»å–æ–¹ï¼Œè®©å‘é€æ–¹å…¨éƒ¨è¿›å…¥ä¼‘çœ ç­‰å¾…çŠ¶æ€ã€‚æŒ‰ç†è¯´ï¼Œå½“ test æ‰§è¡Œç»“æŸåï¼Œé€šé“ c å·²è¶…å‡ºä½œç”¨åŸŸï¼Œç†åº”è¢«é‡Šæ”¾å›æ”¶ï¼Œä½†å®é™…æƒ…å†µæ˜¯ï¼šè¿™äº›å¤„äº â€œchan sendâ€ çŠ¶æ€çš„ G å¯¹è±¡ï¼ˆgoroutineï¼‰ä¼šä¸€ç›´å­˜åœ¨ï¼Œç›´åˆ°å”¤é†’æˆ–è¿›ç¨‹ç»“æŸï¼Œè¿™å°±æ˜¯æ‰€è°“çš„ â€œGoroutine Leakâ€ã€‚è§£å†³æ–¹æ³•å¾ˆç®€å•ï¼Œå¯è®¾ç½® timeoutã€‚æˆ–å®šæœŸç”¨ runtime.Stack æ‰«ææ‰€æœ‰ goroutine è°ƒç”¨æ ˆï¼Œå¦‚æœå‘ç°æŸä¸ª goroutine é•¿æ—¶é—´ï¼ˆé˜ˆå€¼ï¼‰å¤„äº â€œchan sendâ€ çŠ¶æ€ï¼Œå¯ç”¨ä¸€ä¸ªç±»ä¼¼ â€œ/dev/null holeâ€ çš„æ¥æ”¶å™¨è´Ÿè´£å”¤é†’å¹¶ â€œå¤„ç†â€ æ‰ç›¸å…³æ•°æ®ã€‚ <a href="http://mp.weixin.qq.com/s?timestamp=1462538257&amp;src=3&amp;ver=1&amp;signature=dth4TWXJxgxWRCAQDVFbKniJE-JCeVdqp0eMklk4f0kgrbb7QuS7xs5KDDFwmZg0ba6tMcn41JsyNZceCzyp5o9mcQPs7Eqi*KhEEPKyOoiDvyJHFBWSxCetuDBLPPTsdi-SZQypc24ZMdm5qRs13Je5vyZgLwIlLqhUsErg9oI=" target="_blank" rel="external">Link</a></p>
</li>
</ol>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;em&gt;*[Goæ€§èƒ½ä¼˜åŒ–æŠ€å·§(By é›¨ç—•)](&lt;a href=&quot;http://mp.weixin.qq.com/s?src=3&amp;amp;timestamp=1461920086&amp;amp;ver=1&amp;amp;signature=dvsw--b6KnMYdRt43I2g4kMR
    
    </summary>
    
    
      <category term="go" scheme="http://feisky.xyz/tags/go/"/>
    
  </entry>
  
  <entry>
    <title>The Rise of Cloud Computing Systems - Jeff Dean</title>
    <link href="http://feisky.xyz/2016/05/05/The-Rise-of-Cloud-Computing-Systems-Jeff-Dean/"/>
    <id>http://feisky.xyz/2016/05/05/The-Rise-of-Cloud-Computing-Systems-Jeff-Dean/</id>
    <published>2016-05-05T09:16:46.000Z</published>
    <updated>2016-12-15T00:14:54.373Z</updated>
    
    <content type="html"><![CDATA[

	<div class="row">
	  <iframe src="http://nagland.github.io/viewer/web/viewer.html?val=http://feiskyer.github.io/assets/ccs.pdf" style="width:100%; height:550px"></iframe>
	</div>



]]></content>
    
    <summary type="html">
    
      

	&lt;div class=&quot;row&quot;&gt;
	  &lt;iframe src=&quot;http://nagland.github.io/viewer/web/viewer.html?val=http://feiskyer.github.io/assets/ccs.pdf&quot; style=&quot;wi
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Reading notes of week 17</title>
    <link href="http://feisky.xyz/2016/04/29/Reading-notes-of-week-17/"/>
    <id>http://feisky.xyz/2016/04/29/Reading-notes-of-week-17/</id>
    <published>2016-04-29T08:50:14.000Z</published>
    <updated>2016-12-15T00:14:54.373Z</updated>
    
    <content type="html"><![CDATA[<p><strong><a href="http://blog.kubernetes.io/2016/04/Kubernetes-Network-Policy-APIs.html" target="_blank" rel="external">SIG-Networking: Kubernetes Network Policy APIs Coming in 1.3</a></strong></p>
<blockquote>
<p>One problem many users have is that the open access network policy of Kubernetes is not suitable for applications that need more precise control over the traffic that accesses a pod or service. Today, this could be a multi-tier application where traffic is only allowed from a tierâ€™s neighbor. But as new Cloud Native applications are built by composing microservices, the ability to control traffic as it flows among these services becomes even more critical.</p>
<p>From these scenarios several possible approaches were considered and a minimal policy specification was defined. The basic idea is that if isolation were enabled on a per namespace basis, then specific pods would be selected where specific traffic types would be allowed.</p>
</blockquote>
<p>Network isolation is enabled by defining the network-isolation annotation on namespaces as shown below:</p>
<pre><code>    net.alpha.kubernetes.io/network-isolation: [ on | off ]
</code></pre><p>Once network isolation is enabled, explicit network policies must be applied to enable pod communication.</p>
<p>A policy specification can be applied to a namespace to define the details of the policy as shown below:</p>
<figure class="highlight xquery"><table><tr><td class="code"><pre><div class="line">POST /apis/net.alpha.kubernetes.io/v1alpha1/namespaces/tenant-a/networkpolicys/</div><div class="line"></div><div class="line">&#123;</div><div class="line"><span class="string">"kind"</span>: <span class="string">"NetworkPolicy"</span>,</div><div class="line"><span class="string">"metadata"</span>: &#123;</div><div class="line"><span class="string">"name"</span>: <span class="string">"pol1"</span></div><div class="line">&#125;,</div><div class="line"><span class="string">"spec"</span>: &#123;</div><div class="line"><span class="string">"allowIncoming"</span>: &#123;</div><div class="line"><span class="string">"from"</span>: [</div><div class="line">&#123; <span class="string">"pods"</span>: &#123; <span class="string">"segment"</span>: <span class="string">"frontend"</span> &#125; &#125;</div><div class="line">],</div><div class="line"><span class="string">"toPorts"</span>: [</div><div class="line">&#123; <span class="string">"port"</span>: <span class="number">80</span>, <span class="string">"protocol"</span>: <span class="string">"TCP"</span> &#125;</div><div class="line">]</div><div class="line">&#125;,</div><div class="line"><span class="string">"podSelector"</span>: &#123; <span class="string">"segment"</span>: <span class="string">"backend"</span> &#125;</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><img src="https://lh5.googleusercontent.com/zMEpLMYmask-B-rYWnbMyGb0M7YusPQFPS6EfpNOSLbkf-cM49V7rTDBpA6k9-Zdh2soMul39rz9rHFJfL-jnEn_mHbpg0E1WlM-wjU-qvQu9KDTQqQ9uBmdaeWynDDNhcT3UjX5" alt=""></p>
<p><a href="https://docs.google.com/document/d/1qAm-_oSap-f1d6a-xRTj6xaH1sYQBfK36VyjB5XOZug/edit" target="_blank" rel="external">https://docs.google.com/document/d/1qAm-_oSap-f1d6a-xRTj6xaH1sYQBfK36VyjB5XOZug/edit</a></p>
<p>**<a href="http://www.infoq.com/articles/build-a-container-golang?utm_source=golangweekly&amp;utm_medium=email" target="_blank" rel="external">Build Your Own Container Using Less than 100 Lines of Go</a></p>
<blockquote>
<p>a super super simple container, in (way) less than 100 lines of go</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"os"</span></div><div class="line">    <span class="string">"os/exec"</span></div><div class="line">    <span class="string">"syscall"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="keyword">switch</span> os.Args[<span class="number">1</span>] &#123;</div><div class="line">    <span class="keyword">case</span> <span class="string">"run"</span>:</div><div class="line">        parent()</div><div class="line">    <span class="keyword">case</span> <span class="string">"child"</span>:</div><div class="line">        child()</div><div class="line">    <span class="keyword">default</span>:</div><div class="line">        <span class="built_in">panic</span>(<span class="string">"wat should I do"</span>)</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">parent</span><span class="params">()</span></span> &#123;</div><div class="line">    cmd := exec.Command(<span class="string">"/proc/self/exe"</span>, <span class="built_in">append</span>([]<span class="keyword">string</span>&#123;<span class="string">"child"</span>&#125;, os.Args[<span class="number">2</span>:]...)...)</div><div class="line">    cmd.SysProcAttr = &amp;syscall.SysProcAttr&#123;</div><div class="line">        Cloneflags: syscall.CLONE_NEWUTS | syscall.CLONE_NEWPID | syscall.CLONE_NEWNS,</div><div class="line">    &#125;</div><div class="line">    cmd.Stdin = os.Stdin</div><div class="line">    cmd.Stdout = os.Stdout</div><div class="line">    cmd.Stderr = os.Stderr</div><div class="line"></div><div class="line">    <span class="keyword">if</span> err := cmd.Run(); err != <span class="literal">nil</span> &#123;</div><div class="line">        fmt.Println(<span class="string">"ERROR"</span>, err)</div><div class="line">        os.Exit(<span class="number">1</span>)</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">child</span><span class="params">()</span></span> &#123;</div><div class="line">    must(syscall.Mount(<span class="string">"rootfs"</span>, <span class="string">"rootfs"</span>, <span class="string">""</span>, syscall.MS_BIND, <span class="string">""</span>))</div><div class="line">    must(os.MkdirAll(<span class="string">"rootfs/oldrootfs"</span>, <span class="number">0700</span>))</div><div class="line">    must(syscall.PivotRoot(<span class="string">"rootfs"</span>, <span class="string">"rootfs/oldrootfs"</span>))</div><div class="line">    must(os.Chdir(<span class="string">"/"</span>))</div><div class="line"></div><div class="line">    cmd := exec.Command(os.Args[<span class="number">2</span>], os.Args[<span class="number">3</span>:]...)</div><div class="line">    cmd.Stdin = os.Stdin</div><div class="line">    cmd.Stdout = os.Stdout</div><div class="line">    cmd.Stderr = os.Stderr</div><div class="line"></div><div class="line">    <span class="keyword">if</span> err := cmd.Run(); err != <span class="literal">nil</span> &#123;</div><div class="line">        fmt.Println(<span class="string">"ERROR"</span>, err)</div><div class="line">        os.Exit(<span class="number">1</span>)</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">must</span><span class="params">(err error)</span></span> &#123;</div><div class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">        <span class="built_in">panic</span>(err)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><em>*[Goæ€§èƒ½ä¼˜åŒ–æŠ€å·§(By é›¨ç—•)](<a href="http://mp.weixin.qq.com/s?src=3&amp;timestamp=1461920086&amp;ver=1&amp;signature=dvsw--b6KnMYdRt43I2g4kMRIN37-tbcl2AnwpG58mxVaoZpqG24Aou2amIcFH1aIgXelirKZ0iSYJnPud" target="_blank" rel="external">http://mp.weixin.qq.com/s?src=3&amp;timestamp=1461920086&amp;ver=1&amp;signature=dvsw--b6KnMYdRt43I2g4kMRIN37-tbcl2AnwpG58mxVaoZpqG24Aou2amIcFH1aIgXelirKZ0iSYJnPud</a></em>qh3uzFrbmeM<em>bcDNCVC0t</em>m4oEblW1GOp0FHTsG-lSzRzE67RaskRf7u4<em>B5NZlkmYhTbWJNF44Bvwz9D58</em>D-54=)</p>
<ol>
<li>å­—ç¬¦ä¸²ï¼ˆstringï¼‰ä½œä¸ºä¸€ç§ä¸å¯å˜ç±»å‹ï¼Œåœ¨ä¸å­—èŠ‚æ•°ç»„ï¼ˆslice, [ ]byteï¼‰è½¬æ¢æ—¶éœ€ä»˜å‡º â€œæ²‰é‡â€ ä»£ä»·ï¼Œæ ¹æœ¬åŸå› æ˜¯å¯¹åº•å±‚å­—èŠ‚æ•°ç»„çš„å¤åˆ¶ã€‚</li>
</ol>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"unsafe"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">str2bytes</span><span class="params">(s <span class="keyword">string</span>)</span> []<span class="title">byte</span></span> &#123;</div><div class="line">    ptr := (*[<span class="number">2</span>]<span class="keyword">uintptr</span>)(unsafe.Pointer(&amp;s))</div><div class="line">    btr := [<span class="number">3</span>]<span class="keyword">uintptr</span>&#123;ptr[<span class="number">0</span>], ptr[<span class="number">1</span>], ptr[<span class="number">1</span>]&#125;</div><div class="line">    <span class="keyword">return</span> *(*[]<span class="keyword">byte</span>)(unsafe.Pointer(&amp;btr))</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">bytes2str</span><span class="params">(b []<span class="keyword">byte</span>)</span> <span class="title">string</span></span> &#123;</div><div class="line">    <span class="keyword">return</span> *(*<span class="keyword">string</span>)(unsafe.Pointer(&amp;b))</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    s := <span class="string">"abcdefghi"</span></div><div class="line">    b := str2bytes(s)</div><div class="line">    s2 := bytes2str(b)</div><div class="line"></div><div class="line">    fmt.Println(s, b, s2)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li><p>Go Proverbs: A little copying is better than a little dependency. å¯¹äºä¸€äº›çŸ­å°çš„å¯¹è±¡ï¼Œå¤åˆ¶æˆæœ¬è¿œå°äºåœ¨å †ä¸Šåˆ†é…å’Œå›æ”¶æ“ä½œã€‚</p>
</li>
<li><p>mapé¢„è®¾å®¹é‡ï¼šmap ä¼šæŒ‰éœ€æ‰©å¼ ï¼Œä½†é¡»ä»˜å‡ºæ•°æ®æ‹·è´å’Œé‡æ–°å“ˆå¸Œæˆæœ¬ã€‚å¦‚æœ‰å¯èƒ½ï¼Œåº”å°½å¯èƒ½é¢„è®¾è¶³å¤Ÿå®¹é‡ç©ºé—´ï¼Œé¿å…æ­¤ç±»è¡Œä¸ºå‘ç”Ÿã€‚</p>
</li>
<li><p>mapç›´æ¥å­˜å‚¨ï¼Œå¯¹äºå°å¯¹è±¡ï¼Œç›´æ¥å°†æ•°æ®äº¤ç”± map ä¿å­˜ï¼Œè¿œæ¯”ç”¨æŒ‡é’ˆé«˜æ•ˆã€‚è¿™ä¸ä½†å‡å°‘äº†å †å†…å­˜åˆ†é…ï¼Œå…³é”®è¿˜åœ¨äºåƒåœ¾å›æ”¶å™¨ä¸ä¼šæ‰«æéæŒ‡é’ˆç±»å‹ key/value å¯¹è±¡ã€‚</p>
</li>
<li><p>deferçš„ä»£ä»·:ç¼–è¯‘å™¨é€šè¿‡ runtime.deferproc â€œæ³¨å†Œâ€ å»¶è¿Ÿè°ƒç”¨ï¼Œé™¤ç›®æ ‡å‡½æ•°åœ°å€å¤–ï¼Œè¿˜ä¼šå¤åˆ¶ç›¸å…³å‚æ•°ï¼ˆåŒ…æ‹¬ receiverï¼‰ã€‚åœ¨å‡½æ•°è¿”å›å‰ï¼Œæ‰§è¡Œ runtime.deferreturn æå–ç›¸å…³ä¿¡æ¯æ‰§è¡Œå»¶è¿Ÿè°ƒç”¨ã€‚è¿™å…¶ä¸­çš„ä»£ä»·è‡ªç„¶ä¸æ˜¯æ™®é€šå‡½æ•°è°ƒç”¨ä¸€æ¡ CALL æŒ‡ä»¤æ‰€èƒ½æ¯”æ‹Ÿçš„ã€‚å¯ä»¥è€ƒè™‘å°†å†…å±‚å¤„ç†é€»è¾‘è½¬æ¢ä¸ºåŒ¿åå‡½æ•°.</p>
</li>
<li><p>ä¸åˆç†çš„é—­åŒ…ä¼šé€ æˆæ€§èƒ½é—®é¢˜ï¼Œæ¯”å¦‚é—­åŒ…å¼•ç”¨åŸç¯å¢ƒå˜é‡ä¼šå¯¼è‡´Data Raceå¹¶å˜é‡é€ƒé€¸åˆ°å †ä¸Šï¼Œå¢åŠ GCæ‰«æå’Œå›æ”¶çš„è´Ÿæ‹….</p>
</li>
</ol>
<p><strong><a href="http://www.sdnlab.com/16646.html" target="_blank" rel="external">åŸºäºç»„çš„ç­–ç•¥ï¼ˆGBPï¼‰å¼€å¯æ–°å‹ç½‘ç»œè®¾è®¡æ—¶ä»£</a></strong></p>
<p>å¾ˆæ—©å°±ç©è¿‡GBPï¼Œå½“æ—¶è¿˜æ˜¯åŸºäºæ€ç§‘ACIçš„ã€‚GBPè¿™ä¸ªä¸œè¥¿ä»æ¦‚å¿µä¸Šå®Œå…¨ç…§æ¬äº†ACIçš„é‚£å¥—ç†è®ºï¼Œå°†åŸæœ‰ç½‘ç»œçš„æ¦‚å¿µè½¬æ¢æˆäº†é¢å‘åº”ç”¨çš„ç½‘ç»œç­–ç­–ç•¥ã€‚å¯¹å¤§éƒ¨åˆ†åšç½‘ç»œçš„äººæ¥è¯´ï¼Œæœ‰ä¸€å®šçš„æ¥å—éš¾åº¦ï¼›ä½†å¯¹åº”ç”¨å¼€å‘äººå‘˜æŒºå‹å¥½çš„ã€‚ä¸è¿‡ACIéœ€è¦å¢åŠ è·¯ç”±å™¨çš„æ§åˆ¶ï¼Œæ‰èƒ½ç®—æ˜¯ä¸€ä¸ªå®Œæ•´çš„æ–¹æ¡ˆã€‚</p>
<p>ç°åœ¨GBPä¹Ÿé›†æˆäº†ODLï¼Œç»ˆäºæœ‰æ›´å¤šçš„ç©å®¶è¿›æ¥ã€‚</p>
<p>é¡ºä¾¿è¯´ä¸‹ï¼ŒKubernetes Network Policyè·ŸGBPçš„æ¦‚å¿µå¾ˆåƒï¼Œéƒ½æ˜¯é¢å‘åº”ç”¨çš„æ¥å£.</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;&lt;a href=&quot;http://blog.kubernetes.io/2016/04/Kubernetes-Network-Policy-APIs.html&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;SIG-Networking: Ku
    
    </summary>
    
    
      <category term="docker" scheme="http://feisky.xyz/tags/docker/"/>
    
      <category term="container" scheme="http://feisky.xyz/tags/container/"/>
    
      <category term="blockchain" scheme="http://feisky.xyz/tags/blockchain/"/>
    
  </entry>
  
  <entry>
    <title>runc and runV</title>
    <link href="http://feisky.xyz/2016/04/28/runc/"/>
    <id>http://feisky.xyz/2016/04/28/runc/</id>
    <published>2016-04-28T03:15:03.000Z</published>
    <updated>2016-12-15T00:14:54.373Z</updated>
    
    <content type="html"><![CDATA[<p>runc is a CLI tool for spawning and running containers according to the OCI specification, while runV is a hypervisor-based runtime for OCI. Both of them are recommanded (implementations](<a href="https://github.com/opencontainers/runtime-spec/blob/master/implementations.md" target="_blank" rel="external">https://github.com/opencontainers/runtime-spec/blob/master/implementations.md</a>) of OCI.</p>
<h2 id="Playing-with-runc"><a href="#Playing-with-runc" class="headerlink" title="Playing with runc"></a>Playing with runc</h2><p>Install runc:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><div class="line">yum install -y libseccomp-devel</div><div class="line">mkdir -p <span class="variable">$GOPATH</span>/src/github.com/opencontainers</div><div class="line"><span class="built_in">cd</span> <span class="variable">$GOPATH</span>/src/github.com/opencontainers</div><div class="line">git <span class="built_in">clone</span> https://github.com/opencontainers/runc</div><div class="line"><span class="built_in">cd</span> runc</div><div class="line">make</div><div class="line">sudo make install</div></pre></td></tr></table></figure>
<p>Run busybox:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><div class="line">$ docker pull busybox</div><div class="line">$ mkdir rootfs</div><div class="line">$ docker <span class="built_in">export</span> $(docker create busybox) | tar -C rootfs -xvf -</div><div class="line">$ runc spec .</div><div class="line">$ runc start <span class="built_in">test</span></div><div class="line">/ <span class="comment"># ps</span></div><div class="line">PID   USER     COMMAND</div><div class="line">1 root     sh</div><div class="line">9 root     ps</div></pre></td></tr></table></figure>
<h2 id="Playing-with-docker-containerd"><a href="#Playing-with-docker-containerd" class="headerlink" title="Playing with docker-containerd"></a>Playing with docker-containerd</h2><p>docker-containerd is installed togather with docker 1.11.</p>
<figure class="highlight llvm"><table><tr><td class="code"><pre><div class="line">$ docker-containerd-ctr --address <span class="string">"/var/run/docker/libcontainerd/docker-containerd.sock"</span> containers</div><div class="line">ID                                                                 PATH                                                                                             STATUS              PROCESSES</div><div class="line"><span class="number">346</span><span class="keyword">c</span><span class="number">1</span>b<span class="number">7</span>bbb<span class="number">04</span>b<span class="number">760032557e1324</span>a<span class="number">4027</span>ec<span class="number">0055</span>ea<span class="number">84</span>dca<span class="number">109134</span><span class="keyword">c</span><span class="number">02e03</span>dc<span class="number">1242</span><span class="keyword">c</span>   /var/run/docker/libcontainerd/<span class="number">346</span><span class="keyword">c</span><span class="number">1</span>b<span class="number">7</span>bbb<span class="number">04</span>b<span class="number">760032557e1324</span>a<span class="number">4027</span>ec<span class="number">0055</span>ea<span class="number">84</span>dca<span class="number">109134</span><span class="keyword">c</span><span class="number">02e03</span>dc<span class="number">1242</span><span class="keyword">c</span>   running             init</div><div class="line">bca<span class="number">15</span>f<span class="number">3420e3218987314</span>e<span class="number">1</span>cbbf<span class="number">440120</span>ff<span class="number">880</span>af<span class="number">44844778293</span><span class="keyword">c</span><span class="number">4130526</span><span class="keyword">c</span><span class="number">85</span><span class="keyword">cc</span>   /var/run/docker/libcontainerd/bca<span class="number">15</span>f<span class="number">3420e3218987314</span>e<span class="number">1</span>cbbf<span class="number">440120</span>ff<span class="number">880</span>af<span class="number">44844778293</span><span class="keyword">c</span><span class="number">4130526</span><span class="keyword">c</span><span class="number">85</span><span class="keyword">cc</span>   running             init</div><div class="line">$ docker-containerd-ctr --address <span class="string">"/var/run/docker/libcontainerd/docker-containerd.sock"</span> containers exec --id=<span class="number">346</span><span class="keyword">c</span><span class="number">1</span>b<span class="number">7</span>bbb<span class="number">04</span>b<span class="number">760032557e1324</span>a<span class="number">4027</span>ec<span class="number">0055</span>ea<span class="number">84</span>dca<span class="number">109134</span><span class="keyword">c</span><span class="number">02e03</span>dc<span class="number">1242</span><span class="keyword">c</span> --pid=<span class="number">20</span> --cwd=/ -a /bin/ps aux</div><div class="line">PID   USER     TIME   COMMAND</div><div class="line">    <span class="number">1</span> root       <span class="number">0</span>:<span class="number">00</span> sh</div><div class="line">   <span class="number">51</span> root       <span class="number">0</span>:<span class="number">00</span> /bin/ps aux</div><div class="line">$ docker-containerd-ctr --address <span class="string">"/var/run/docker/libcontainerd/docker-containerd.sock"</span> state <span class="number">346</span><span class="keyword">c</span><span class="number">1</span>b<span class="number">7</span>bbb<span class="number">04</span>b<span class="number">760032557e1324</span>a<span class="number">4027</span>ec<span class="number">0055</span>ea<span class="number">84</span>dca<span class="number">109134</span><span class="keyword">c</span><span class="number">02e03</span>dc<span class="number">1242</span><span class="keyword">c</span></div><div class="line">&#123;<span class="string">"containers"</span>:[&#123;<span class="string">"id"</span>:<span class="string">"346c1b7bbb04b760032557e1324a4027ec0055ea84dca109134c02e03dc1242c"</span>,<span class="string">"bundlePath"</span>:<span class="string">"/var/run/docker/libcontainerd/346c1b7bbb04b760032557e1324a4027ec0055ea84dca109134c02e03dc1242c"</span>,<span class="string">"processes"</span>:[&#123;<span class="string">"pid"</span>:<span class="string">"init"</span>,<span class="string">"terminal"</span>:<span class="keyword">true</span>,<span class="string">"user"</span>:&#123;<span class="string">"additionalGids"</span>:[<span class="number">10</span>]&#125;,<span class="string">"args"</span>:[<span class="string">"sh"</span>],<span class="string">"env"</span>:[<span class="string">"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"</span>,<span class="string">"HOSTNAME=346c1b7bbb04"</span>,<span class="string">"TERM=xterm"</span>],<span class="string">"cwd"</span>:<span class="string">"/"</span>,<span class="string">"systemPid"</span>:<span class="number">3716</span>,<span class="string">"stdin"</span>:<span class="string">"/var/run/docker/libcontainerd/346c1b7bbb04b760032557e1324a4027ec0055ea84dca109134c02e03dc1242c/init-stdin"</span>,<span class="string">"stdout"</span>:<span class="string">"/var/run/docker/libcontainerd/346c1b7bbb04b760032557e1324a4027ec0055ea84dca109134c02e03dc1242c/init-stdout"</span>,<span class="string">"stderr"</span>:<span class="string">"/var/run/docker/libcontainerd/346c1b7bbb04b760032557e1324a4027ec0055ea84dca109134c02e03dc1242c/init-stderr"</span>,<span class="string">"capabilities"</span>:[<span class="string">"CAP_CHOWN"</span>,<span class="string">"CAP_DAC_OVERRIDE"</span>,<span class="string">"CAP_FSETID"</span>,<span class="string">"CAP_FOWNER"</span>,<span class="string">"CAP_MKNOD"</span>,<span class="string">"CAP_NET_RAW"</span>,<span class="string">"CAP_SETGID"</span>,<span class="string">"CAP_SETUID"</span>,<span class="string">"CAP_SETFCAP"</span>,<span class="string">"CAP_SETPCAP"</span>,<span class="string">"CAP_NET_BIND_SERVICE"</span>,<span class="string">"CAP_SYS_CHROOT"</span>,<span class="string">"CAP_KILL"</span>,<span class="string">"CAP_AUDIT_WRITE"</span>]&#125;],<span class="string">"status"</span>:<span class="string">"running"</span>,<span class="string">"pids"</span>:[<span class="number">3716</span>],<span class="string">"runtime"</span>:<span class="string">"docker-runc"</span>&#125;],<span class="string">"machine"</span>:&#123;<span class="string">"cpus"</span>:<span class="number">2</span>,<span class="string">"memory"</span>:<span class="number">7982</span>&#125;&#125;</div></pre></td></tr></table></figure>
<h2 id="Playing-with-runV"><a href="#Playing-with-runV" class="headerlink" title="Playing with runV"></a>Playing with runV</h2><p>Install runV:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><div class="line">mkdir -p <span class="variable">$GOPATH</span>/src/github.com/hyperhq</div><div class="line"><span class="built_in">cd</span> <span class="variable">$GOPATH</span>/src/github.com/hyperhq</div><div class="line">git <span class="built_in">clone</span> https://github.com/hyperhq/runv/</div><div class="line"><span class="built_in">cd</span> runv</div><div class="line">./autogen.sh</div><div class="line">./configure</div><div class="line">make</div><div class="line">sudo make install</div></pre></td></tr></table></figure>
<p>To run container in runV, kernel and initrd are needed since runV is based on hypervisor. They could be compiled from <a href="https://github.com/hyperhq/hyperstart" target="_blank" rel="external">hyperstart</a>.</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><div class="line">$ docker pull busybox</div><div class="line">$ mkdir rootfs</div><div class="line">$ docker <span class="built_in">export</span> $(docker create busybox) | tar -C rootfs -xvf -</div><div class="line">$ runv spec .</div><div class="line">$ runv --kernel=/var/lib/hyper/kernel --initrd=/var/lib/hyper/hyper-initrd.img start <span class="built_in">test</span></div></pre></td></tr></table></figure>
<h2 id="Playing-with-runv-containerd"><a href="#Playing-with-runv-containerd" class="headerlink" title="Playing with runv-containerd"></a>Playing with runv-containerd</h2><p>Install ctr CLI from containerd</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><div class="line"><span class="built_in">cd</span> <span class="variable">$GOPATH</span>/src/github.com/docker</div><div class="line">git <span class="built_in">clone</span> https://github.com/docker/containerd.git</div><div class="line"><span class="built_in">cd</span> containerd</div><div class="line">make</div><div class="line">make install</div></pre></td></tr></table></figure>
<p>Start runv containerd</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><div class="line">runv-containerd --kernel=/var/lib/hyper/kernel --initrd=/var/lib/hyper/hyper-initrd.img</div></pre></td></tr></table></figure>
<p>Run ctr command now:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><div class="line">ctr --address=unix:///run/runv-containerd/containerd.sock containers</div></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="code"><pre><div class="line"><span class="comment"># Creating OCI bundles</span></div><div class="line">mkdir -p busybox/rootfs</div><div class="line">docker <span class="built_in">export</span> $(docker create busybox) | tar -C busybox/rootfs -xvf -</div><div class="line"><span class="built_in">cd</span> busybox</div><div class="line">runv spec .</div></pre></td></tr></table></figure>
<p>Change the contents of config.json to </p>
<figure class="highlight json"><table><tr><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"ociVersion"</span>: <span class="string">"0.5.0-dev"</span>,</div><div class="line">  <span class="attr">"platform"</span>: &#123;</div><div class="line">    <span class="attr">"os"</span>: <span class="string">"linux"</span>,</div><div class="line">    <span class="attr">"arch"</span>: <span class="string">"amd64"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="attr">"process"</span>: &#123;</div><div class="line">    <span class="attr">"terminal"</span>: <span class="literal">true</span>,</div><div class="line">    <span class="attr">"user"</span>: &#123;&#125;,</div><div class="line">    <span class="attr">"args"</span>: [</div><div class="line">      <span class="string">"sh"</span></div><div class="line">    ],</div><div class="line">    <span class="attr">"env"</span>: [</div><div class="line">      <span class="string">"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"</span>,</div><div class="line">      <span class="string">"TERM=xterm"</span></div><div class="line">    ],</div><div class="line">    <span class="attr">"cwd"</span>: <span class="string">"/"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="attr">"root"</span>: &#123;</div><div class="line">    <span class="attr">"path"</span>: <span class="string">"rootfs"</span>,</div><div class="line">    <span class="attr">"readonly"</span>: <span class="literal">false</span></div><div class="line">  &#125;,</div><div class="line">  <span class="attr">"hostname"</span>: <span class="string">"shell"</span>,</div><div class="line">  <span class="attr">"mounts"</span>: [</div><div class="line">    &#123;</div><div class="line">      <span class="attr">"destination"</span>: <span class="string">"/proc"</span>,</div><div class="line">      <span class="attr">"type"</span>: <span class="string">"proc"</span>,</div><div class="line">      <span class="attr">"source"</span>: <span class="string">"proc"</span></div><div class="line">    &#125;,</div><div class="line">    &#123;</div><div class="line">      <span class="attr">"destination"</span>: <span class="string">"/dev"</span>,</div><div class="line">      <span class="attr">"type"</span>: <span class="string">"tmpfs"</span>,</div><div class="line">      <span class="attr">"source"</span>: <span class="string">"tmpfs"</span>,</div><div class="line">      <span class="attr">"options"</span>: [</div><div class="line">        <span class="string">"nosuid"</span>,</div><div class="line">        <span class="string">"strictatime"</span>,</div><div class="line">        <span class="string">"mode=755"</span>,</div><div class="line">        <span class="string">"size=65536k"</span></div><div class="line">      ]</div><div class="line">    &#125;,</div><div class="line">    &#123;</div><div class="line">      <span class="attr">"destination"</span>: <span class="string">"/dev/pts"</span>,</div><div class="line">      <span class="attr">"type"</span>: <span class="string">"devpts"</span>,</div><div class="line">      <span class="attr">"source"</span>: <span class="string">"devpts"</span>,</div><div class="line">      <span class="attr">"options"</span>: [</div><div class="line">        <span class="string">"nosuid"</span>,</div><div class="line">        <span class="string">"noexec"</span>,</div><div class="line">        <span class="string">"newinstance"</span>,</div><div class="line">        <span class="string">"ptmxmode=0666"</span>,</div><div class="line">        <span class="string">"mode=0620"</span>,</div><div class="line">        <span class="string">"gid=5"</span></div><div class="line">      ]</div><div class="line">    &#125;,</div><div class="line">    &#123;</div><div class="line">      <span class="attr">"destination"</span>: <span class="string">"/dev/shm"</span>,</div><div class="line">      <span class="attr">"type"</span>: <span class="string">"tmpfs"</span>,</div><div class="line">      <span class="attr">"source"</span>: <span class="string">"shm"</span>,</div><div class="line">      <span class="attr">"options"</span>: [</div><div class="line">        <span class="string">"nosuid"</span>,</div><div class="line">        <span class="string">"noexec"</span>,</div><div class="line">        <span class="string">"nodev"</span>,</div><div class="line">        <span class="string">"mode=1777"</span>,</div><div class="line">        <span class="string">"size=65536k"</span></div><div class="line">      ]</div><div class="line">    &#125;,</div><div class="line">    &#123;</div><div class="line">      <span class="attr">"destination"</span>: <span class="string">"/dev/mqueue"</span>,</div><div class="line">      <span class="attr">"type"</span>: <span class="string">"mqueue"</span>,</div><div class="line">      <span class="attr">"source"</span>: <span class="string">"mqueue"</span>,</div><div class="line">      <span class="attr">"options"</span>: [</div><div class="line">        <span class="string">"nosuid"</span>,</div><div class="line">        <span class="string">"noexec"</span>,</div><div class="line">        <span class="string">"nodev"</span></div><div class="line">      ]</div><div class="line">    &#125;,</div><div class="line">    &#123;</div><div class="line">      <span class="attr">"destination"</span>: <span class="string">"/sys"</span>,</div><div class="line">      <span class="attr">"type"</span>: <span class="string">"sysfs"</span>,</div><div class="line">      <span class="attr">"source"</span>: <span class="string">"sysfs"</span>,</div><div class="line">      <span class="attr">"options"</span>: [</div><div class="line">        <span class="string">"nosuid"</span>,</div><div class="line">        <span class="string">"noexec"</span>,</div><div class="line">        <span class="string">"nodev"</span>,</div><div class="line">        <span class="string">"ro"</span></div><div class="line">      ]</div><div class="line">    &#125;,</div><div class="line">    &#123;</div><div class="line">      <span class="attr">"destination"</span>: <span class="string">"/sys/fs/cgroup"</span>,</div><div class="line">      <span class="attr">"type"</span>: <span class="string">"cgroup"</span>,</div><div class="line">      <span class="attr">"source"</span>: <span class="string">"cgroup"</span>,</div><div class="line">      <span class="attr">"options"</span>: [</div><div class="line">        <span class="string">"nosuid"</span>,</div><div class="line">        <span class="string">"noexec"</span>,</div><div class="line">        <span class="string">"nodev"</span>,</div><div class="line">        <span class="string">"relatime"</span>,</div><div class="line">        <span class="string">"ro"</span></div><div class="line">      ]</div><div class="line">    &#125;</div><div class="line">  ],</div><div class="line">  <span class="attr">"hooks"</span>: &#123;&#125;,</div><div class="line">  <span class="attr">"linux"</span>: &#123;</div><div class="line">    <span class="attr">"resources"</span>: &#123;</div><div class="line">      <span class="attr">"devices"</span>: [</div><div class="line">				&#123;</div><div class="line">          <span class="attr">"allow"</span>: <span class="literal">false</span>,</div><div class="line">          <span class="attr">"access"</span>: <span class="string">"rwm"</span></div><div class="line">        &#125;</div><div class="line">			]</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">"namespaces"</span>: [</div><div class="line">      &#123;</div><div class="line">        <span class="attr">"type"</span>: <span class="string">"pid"</span></div><div class="line">      &#125;,</div><div class="line">      &#123;</div><div class="line">        <span class="attr">"type"</span>: <span class="string">"ipc"</span></div><div class="line">      &#125;,</div><div class="line">      &#123;</div><div class="line">        <span class="attr">"type"</span>: <span class="string">"uts"</span></div><div class="line">      &#125;,</div><div class="line">      &#123;</div><div class="line">        <span class="attr">"type"</span>: <span class="string">"mount"</span></div><div class="line">      &#125;</div><div class="line">    ],</div><div class="line">		<span class="attr">"devices"</span>: <span class="literal">null</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Start container:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><div class="line">ctr --address=unix:///run/runv-containerd/containerd.sock containers start <span class="built_in">test</span> /root/busybox</div></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="code"><pre><div class="line">$ ctr --address=unix:///run/runv-containerd/containerd.sock containers</div><div class="line">ID                  PATH                STATUS              PROCESSES</div><div class="line"><span class="built_in">test</span>                /root/busybox       running             init</div><div class="line"></div><div class="line">$ ctr --address=unix:///run/runv-containerd/containerd.sock containers <span class="built_in">exec</span> --id=<span class="built_in">test</span> --pid=20 --cwd=/ <span class="_">-a</span>  ps aux</div><div class="line">PID   USER     TIME   COMMAND</div><div class="line">    1 root       0:00 /init</div><div class="line">    2 root       0:00 sh</div><div class="line">    4 root       0:00 ps aux</div><div class="line"></div><div class="line">ps -ef | grep qemu</div><div class="line">qemu-system-x86_64 -machine pc-i440fx-2.0,usb=off -cpu core2duo -kernel /var/lib/hyper/kernel -initrd /var/lib/hyper/hyper-initrd.img -append <span class="string">"console=ttyS0 panic=1 no_timer_check"</span> -realtime mlock=off -no-user-config -nodefaults -no-hpet -rtc base=utc,driftfix=slew -no-reboot -display none -boot strict=on -m 128 -smp 1 -qmp unix:/var/run/hyper/vm-JRPdDUOkqA/qmp.sock,server,nowait -serial unix:/var/run/hyper/vm-JRPdDUOkqA/console.sock,server,nowait -device virtio-serial-pci,id=virtio-serial0,bus=pci.0,addr=0x2 -device virtio-scsi-pci,id=scsi0,bus=pci.0,addr=0x3 -chardev socket,id=charch0,path=/var/run/hyper/vm-JRPdDUOkqA/hyper.sock,server,nowait -device virtserialport,bus=virtio-serial0.0,nr=1,chardev=charch0,id=channel0,name=sh.hyper.channel.0 -chardev socket,id=charch1,path=/var/run/hyper/vm-JRPdDUOkqA/tty.sock,server,nowait -device virtserialport,bus=virtio-serial0.0,nr=2,chardev=charch1,id=channel1,name=sh.hyper.channel.1 -fsdev <span class="built_in">local</span>,id=virtio9p,path=/var/run/hyper/vm-JRPdDUOkqA/share_dir,security_model=none -device virtio-9p-pci,fsdev=virtio9p,mount_tag=share_dir</div></pre></td></tr></table></figure>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;runc is a CLI tool for spawning and running containers according to the OCI specification, while runV is a hypervisor-based runtime for O
    
    </summary>
    
    
      <category term="docker" scheme="http://feisky.xyz/tags/docker/"/>
    
      <category term="container" scheme="http://feisky.xyz/tags/container/"/>
    
  </entry>
  
  <entry>
    <title>Container runtime in Docker v1.11</title>
    <link href="http://feisky.xyz/2016/04/28/Docker-1-11-Runtime/"/>
    <id>http://feisky.xyz/2016/04/28/Docker-1-11-Runtime/</id>
    <published>2016-04-28T02:07:23.000Z</published>
    <updated>2016-12-15T00:14:54.373Z</updated>
    
    <content type="html"><![CDATA[<p>Docker v1.11æ­£å¼é›†æˆäº†runcï¼ˆç»ˆäºæ”¯æŒOCIäº†ï¼‰ï¼Œå¹¶å°†åŸæ¥çš„ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶æ‹†åˆ†ä¸ºå¤šä¸ªï¼ŒåŒæ—¶è¿˜ä¿æŒdocker CLIå’ŒAPIä¸å˜ï¼š</p>
<ul>
<li>docker</li>
<li>docker-containerd</li>
<li>docker-containerd-shim</li>
<li>docker-runc</li>
<li>docker-containerd-ctr</li>
</ul>
<p><img src="/images/docker-v11.png" alt=""></p>
<p>è¿™ä¹ˆåšçš„å¥½å¤„å¾ˆæ˜æ˜¾ï¼š</p>
<ul>
<li>æœ€é‡è¦çš„å¯ä»¥åœ¨dockeræˆ–è€…containerdé‡å¯çš„æ—¶å€™containerè¿˜ä¿æŒrunning</li>
<li>container runtime pluggableï¼Œæ¯”å¦‚ä»¥åå¯ä»¥é€‰æ‹©ç”¨runVï¼ˆå½“ç„¶é»˜è®¤è‚¯å®šæ˜¯runcï¼‰</li>
<li>æ€§èƒ½ï¼Œæ–°çš„containerdæ²¡æœ‰å†å²åŒ…è¢±ï¼Œä¸€å¼€å§‹å°±é’ˆå¯¹æ€§èƒ½åšäº†ä¼˜åŒ–ï¼ˆ100 containers in 1.64 secondsï¼‰</li>
<li>docker daemonçš„è§’è‰²å˜åŒ–ï¼Œdockeråªéœ€è¦åšå°‘é‡çš„å‡†å¤‡å·¥ä½œï¼ŒæŠŠçœŸæ­£è¿è¡Œå®¹å™¨çš„å·¥ä½œäº¤ç»™containerdï¼š<ul>
<li>Image management</li>
<li>Generate OCI bundle for containers</li>
<li>Mount the containerâ€™s root filesystem inside the bundle</li>
<li>Call containerd to start container</li>
</ul>
</li>
</ul>
<p><strong><a href="https://github.com/docker/containerd" target="_blank" rel="external">Containerd</a></strong></p>
<p>containerd is a daemon to control runC, built for performance and density. containerd leverages runCâ€™s advanced features such as seccomp and user namespace support as well as checkpoint and restore for cloning and live migration of containers:</p>
<p><img src="/images/containerd.png" alt=""></p>
<p><strong>docker-containerd-ctr</strong></p>
<p>docker-containerd-ctr is the CLI for docker-containerd, which is based on gPRC APIs.</p>
<figure class="highlight llvm"><table><tr><td class="code"><pre><div class="line">$ docker-containerd-ctr --address <span class="string">"/var/run/docker/libcontainerd/docker-containerd.sock"</span> containers</div><div class="line">ID                                                                 PATH                                                                                             STATUS              PROCESSES</div><div class="line"><span class="number">346</span><span class="keyword">c</span><span class="number">1</span>b<span class="number">7</span>bbb<span class="number">04</span>b<span class="number">760032557e1324</span>a<span class="number">4027</span>ec<span class="number">0055</span>ea<span class="number">84</span>dca<span class="number">109134</span><span class="keyword">c</span><span class="number">02e03</span>dc<span class="number">1242</span><span class="keyword">c</span>   /var/run/docker/libcontainerd/<span class="number">346</span><span class="keyword">c</span><span class="number">1</span>b<span class="number">7</span>bbb<span class="number">04</span>b<span class="number">760032557e1324</span>a<span class="number">4027</span>ec<span class="number">0055</span>ea<span class="number">84</span>dca<span class="number">109134</span><span class="keyword">c</span><span class="number">02e03</span>dc<span class="number">1242</span><span class="keyword">c</span>   running             init</div><div class="line">bca<span class="number">15</span>f<span class="number">3420e3218987314</span>e<span class="number">1</span>cbbf<span class="number">440120</span>ff<span class="number">880</span>af<span class="number">44844778293</span><span class="keyword">c</span><span class="number">4130526</span><span class="keyword">c</span><span class="number">85</span><span class="keyword">cc</span>   /var/run/docker/libcontainerd/bca<span class="number">15</span>f<span class="number">3420e3218987314</span>e<span class="number">1</span>cbbf<span class="number">440120</span>ff<span class="number">880</span>af<span class="number">44844778293</span><span class="keyword">c</span><span class="number">4130526</span><span class="keyword">c</span><span class="number">85</span><span class="keyword">cc</span>   running             init</div><div class="line">$ docker-containerd-ctr --address <span class="string">"/var/run/docker/libcontainerd/docker-containerd.sock"</span> containers exec --id=<span class="number">346</span><span class="keyword">c</span><span class="number">1</span>b<span class="number">7</span>bbb<span class="number">04</span>b<span class="number">760032557e1324</span>a<span class="number">4027</span>ec<span class="number">0055</span>ea<span class="number">84</span>dca<span class="number">109134</span><span class="keyword">c</span><span class="number">02e03</span>dc<span class="number">1242</span><span class="keyword">c</span> --pid=<span class="number">20</span> --cwd=/ -a /bin/ps aux</div><div class="line">PID   USER     TIME   COMMAND</div><div class="line">    <span class="number">1</span> root       <span class="number">0</span>:<span class="number">00</span> sh</div><div class="line">   <span class="number">51</span> root       <span class="number">0</span>:<span class="number">00</span> /bin/ps aux</div><div class="line">$ docker-containerd-ctr --address <span class="string">"/var/run/docker/libcontainerd/docker-containerd.sock"</span> state <span class="number">346</span><span class="keyword">c</span><span class="number">1</span>b<span class="number">7</span>bbb<span class="number">04</span>b<span class="number">760032557e1324</span>a<span class="number">4027</span>ec<span class="number">0055</span>ea<span class="number">84</span>dca<span class="number">109134</span><span class="keyword">c</span><span class="number">02e03</span>dc<span class="number">1242</span><span class="keyword">c</span></div><div class="line">&#123;<span class="string">"containers"</span>:[&#123;<span class="string">"id"</span>:<span class="string">"346c1b7bbb04b760032557e1324a4027ec0055ea84dca109134c02e03dc1242c"</span>,<span class="string">"bundlePath"</span>:<span class="string">"/var/run/docker/libcontainerd/346c1b7bbb04b760032557e1324a4027ec0055ea84dca109134c02e03dc1242c"</span>,<span class="string">"processes"</span>:[&#123;<span class="string">"pid"</span>:<span class="string">"init"</span>,<span class="string">"terminal"</span>:<span class="keyword">true</span>,<span class="string">"user"</span>:&#123;<span class="string">"additionalGids"</span>:[<span class="number">10</span>]&#125;,<span class="string">"args"</span>:[<span class="string">"sh"</span>],<span class="string">"env"</span>:[<span class="string">"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"</span>,<span class="string">"HOSTNAME=346c1b7bbb04"</span>,<span class="string">"TERM=xterm"</span>],<span class="string">"cwd"</span>:<span class="string">"/"</span>,<span class="string">"systemPid"</span>:<span class="number">3716</span>,<span class="string">"stdin"</span>:<span class="string">"/var/run/docker/libcontainerd/346c1b7bbb04b760032557e1324a4027ec0055ea84dca109134c02e03dc1242c/init-stdin"</span>,<span class="string">"stdout"</span>:<span class="string">"/var/run/docker/libcontainerd/346c1b7bbb04b760032557e1324a4027ec0055ea84dca109134c02e03dc1242c/init-stdout"</span>,<span class="string">"stderr"</span>:<span class="string">"/var/run/docker/libcontainerd/346c1b7bbb04b760032557e1324a4027ec0055ea84dca109134c02e03dc1242c/init-stderr"</span>,<span class="string">"capabilities"</span>:[<span class="string">"CAP_CHOWN"</span>,<span class="string">"CAP_DAC_OVERRIDE"</span>,<span class="string">"CAP_FSETID"</span>,<span class="string">"CAP_FOWNER"</span>,<span class="string">"CAP_MKNOD"</span>,<span class="string">"CAP_NET_RAW"</span>,<span class="string">"CAP_SETGID"</span>,<span class="string">"CAP_SETUID"</span>,<span class="string">"CAP_SETFCAP"</span>,<span class="string">"CAP_SETPCAP"</span>,<span class="string">"CAP_NET_BIND_SERVICE"</span>,<span class="string">"CAP_SYS_CHROOT"</span>,<span class="string">"CAP_KILL"</span>,<span class="string">"CAP_AUDIT_WRITE"</span>]&#125;],<span class="string">"status"</span>:<span class="string">"running"</span>,<span class="string">"pids"</span>:[<span class="number">3716</span>],<span class="string">"runtime"</span>:<span class="string">"docker-runc"</span>&#125;],<span class="string">"machine"</span>:&#123;<span class="string">"cpus"</span>:<span class="number">2</span>,<span class="string">"memory"</span>:<span class="number">7982</span>&#125;&#125;</div></pre></td></tr></table></figure>
<p><strong>containerd-shim</strong></p>
<p>containerd-shim is a small shim that sits in front of a runtime implementation that allows it to be repartented to init and handle reattach from the caller.</p>
<p>The cwd of the shim should be the bundle for the container.  Arg1 should be the path to the state directory where the shim can locate fifos and other information.</p>
<p><strong><a href="https://github.com/opencontainers/runc.git" target="_blank" rel="external">runc</a></strong></p>
<p>runc is a CLI tool for spawning and running containers according to the OCI specification.</p>
<p><strong>cgroupsç»“æ„</strong></p>
<p>ä»cgroupsé‡Œé¢å¯ä»¥ç›´æ¥çœ‹åˆ°è¿™å‡ ä¸ªè¿›ç¨‹ä¹‹é—´çš„ç®¡ç†å…³ç³»ï¼Œæ¯”å¦‚å¯åŠ¨ä¸¤ä¸ªcontainerä¹‹åï¼š</p>
<figure class="highlight llvm"><table><tr><td class="code"><pre><div class="line">â”‚ â”œâ”€docker.service</div><div class="line">â”‚ â”‚ â”œâ”€ <span class="number">961</span> /usr/bin/docker daemon -H fd://</div><div class="line">â”‚ â”‚ â”œâ”€ <span class="number">967</span> docker-containerd -l /var/run/docker/libcontainerd/docker-containerd.sock --runtime docker-runc</div><div class="line">â”‚ â”‚ â”œâ”€<span class="number">1063</span> docker-proxy -proto tcp -host-ip <span class="number">0.0</span>.<span class="number">0.0</span> -host-port <span class="number">27017</span> -container-ip <span class="number">172.17</span>.<span class="number">0.2</span> -container-port <span class="number">27017</span></div><div class="line">â”‚ â”‚ â”œâ”€<span class="number">1070</span> docker-containerd-shim bca<span class="number">15</span>f<span class="number">3420e3218987314</span>e<span class="number">1</span>cbbf<span class="number">440120</span>ff<span class="number">880</span>af<span class="number">44844778293</span><span class="keyword">c</span><span class="number">4130526</span><span class="keyword">c</span><span class="number">85</span><span class="keyword">cc</span> /var/run/docker/libcontainerd/bca<span class="number">15</span>f<span class="number">3420e3218987314</span>e<span class="number">1</span>cbbf<span class="number">440120</span>ff<span class="number">880</span>af<span class="number">44844778293</span><span class="keyword">c</span><span class="number">4130526</span><span class="keyword">c</span><span class="number">85</span><span class="keyword">cc</span> docker-runc</div><div class="line">â”‚ â”‚ â””â”€<span class="number">3703</span> docker-containerd-shim <span class="number">346</span><span class="keyword">c</span><span class="number">1</span>b<span class="number">7</span>bbb<span class="number">04</span>b<span class="number">760032557e1324</span>a<span class="number">4027</span>ec<span class="number">0055</span>ea<span class="number">84</span>dca<span class="number">109134</span><span class="keyword">c</span><span class="number">02e03</span>dc<span class="number">1242</span><span class="keyword">c</span> /var/run/docker/libcontainerd/<span class="number">346</span><span class="keyword">c</span><span class="number">1</span>b<span class="number">7</span>bbb<span class="number">04</span>b<span class="number">760032557e1324</span>a<span class="number">4027</span>ec<span class="number">0055</span>ea<span class="number">84</span>dca<span class="number">109134</span><span class="keyword">c</span><span class="number">02e03</span>dc<span class="number">1242</span><span class="keyword">c</span> docker-runc</div></pre></td></tr></table></figure>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Docker v1.11æ­£å¼é›†æˆäº†runcï¼ˆç»ˆäºæ”¯æŒOCIäº†ï¼‰ï¼Œå¹¶å°†åŸæ¥çš„ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶æ‹†åˆ†ä¸ºå¤šä¸ªï¼ŒåŒæ—¶è¿˜ä¿æŒdocker CLIå’ŒAPIä¸å˜ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;docker&lt;/li&gt;
&lt;li&gt;docker-containerd&lt;/li&gt;
&lt;li&gt;docker-c
    
    </summary>
    
    
      <category term="docker" scheme="http://feisky.xyz/tags/docker/"/>
    
      <category term="runc" scheme="http://feisky.xyz/tags/runc/"/>
    
      <category term="container" scheme="http://feisky.xyz/tags/container/"/>
    
  </entry>
  
  <entry>
    <title>DPDK Introduction</title>
    <link href="http://feisky.xyz/2016/04/24/DPDK-Introduction/"/>
    <id>http://feisky.xyz/2016/04/24/DPDK-Introduction/</id>
    <published>2016-04-24T11:43:07.000Z</published>
    <updated>2016-12-15T00:14:54.373Z</updated>
    
    <content type="html"><![CDATA[<h2 id="DPDK-Introduction"><a href="#DPDK-Introduction" class="headerlink" title="DPDK Introduction"></a>DPDK Introduction</h2><p>Intel DPDKå…¨ç§°Intel Data Plane Development Kitï¼Œæ˜¯intelæä¾›çš„æ•°æ®å¹³é¢å¼€å‘å·¥å…·é›†ï¼Œä¸ºIntel architectureï¼ˆIAï¼‰å¤„ç†å™¨æ¶æ„ä¸‹ç”¨æˆ·ç©ºé—´é«˜æ•ˆçš„æ•°æ®åŒ…å¤„ç†æä¾›åº“å‡½æ•°å’Œé©±åŠ¨çš„æ”¯æŒï¼Œå®ƒä¸åŒäºLinuxç³»ç»Ÿä»¥é€šç”¨æ€§è®¾è®¡ä¸ºç›®çš„ï¼Œè€Œæ˜¯ä¸“æ³¨äºç½‘ç»œåº”ç”¨ä¸­æ•°æ®åŒ…çš„é«˜æ€§èƒ½å¤„ç†ã€‚DPDKåº”ç”¨ç¨‹åºæ˜¯è¿è¡Œåœ¨ç”¨æˆ·ç©ºé—´ä¸Šåˆ©ç”¨è‡ªèº«æä¾›çš„æ•°æ®å¹³é¢åº“æ¥æ”¶å‘æ•°æ®åŒ…ï¼Œç»•è¿‡äº†Linuxå†…æ ¸åè®®æ ˆå¯¹æ•°æ®åŒ…å¤„ç†è¿‡ç¨‹ã€‚Linuxå†…æ ¸å°†DPDKåº”ç”¨ç¨‹åºçœ‹ä½œæ˜¯ä¸€ä¸ªæ™®é€šçš„ç”¨æˆ·æ€è¿›ç¨‹ï¼ŒåŒ…æ‹¬å®ƒçš„ç¼–è¯‘ã€è¿æ¥å’ŒåŠ è½½æ–¹å¼å’Œæ™®é€šç¨‹åºæ²¡æœ‰ä»€ä¹ˆä¸¤æ ·ã€‚DPDKç¨‹åºå¯åŠ¨ååªèƒ½æœ‰ä¸€ä¸ªä¸»çº¿ç¨‹ï¼Œç„¶ååˆ›å»ºä¸€äº›å­çº¿ç¨‹å¹¶ç»‘å®šåˆ°æŒ‡å®šCPUæ ¸å¿ƒä¸Šè¿è¡Œã€‚</p>
<p>DPDKå®˜æ–¹ç½‘ç«™ä¸º<a href="http://dpdk.org/" target="_blank" rel="external">http://dpdk.org/</a>ï¼Œå®˜æ–¹æ–‡æ¡£ä¸º<a href="http://dpdk.org/doc/guides/index.html" target="_blank" rel="external">http://dpdk.org/doc/guides/index.html</a></p>
<p>DPDKåŸºæœ¬ç»„ä»¶åŒ…æ‹¬ï¼š</p>
<p><img src="https://cloud.githubusercontent.com/assets/676637/14767274/70bb59c0-0a54-11e6-862d-2f19c721c45d.png" alt="dpdk_lib"></p>
<ul>
<li>EALï¼ˆEnvironment Abstraction Layerï¼‰å³ç¯å¢ƒæŠ½è±¡å±‚ï¼Œä¸ºåº”ç”¨æä¾›äº†ä¸€ä¸ªé€šç”¨æ¥å£ï¼Œéšè—äº†ä¸åº•å±‚åº“ä¸è®¾å¤‡æ‰“äº¤é“çš„ç›¸å…³ç»†èŠ‚ã€‚EALå®ç°äº†DPDKè¿è¡Œçš„åˆå§‹åŒ–å·¥ä½œï¼ŒåŸºäºå¤§é¡µè¡¨çš„å†…å­˜åˆ†é…ï¼Œå¤šæ ¸äº²ç¼˜æ€§è®¾ç½®ï¼ŒåŸå­å’Œé”æ“ä½œï¼Œå¹¶å°†PCIè®¾å¤‡åœ°å€æ˜ å°„åˆ°ç”¨æˆ·ç©ºé—´ï¼Œæ–¹ä¾¿åº”ç”¨ç¨‹åºè®¿é—®ã€‚</li>
<li>Buffer Manager APIé€šè¿‡é¢„å…ˆä»EALä¸Šåˆ†é…å›ºå®šå¤§å°çš„å¤šä¸ªå†…å­˜å¯¹è±¡ï¼Œé¿å…äº†åœ¨è¿è¡Œè¿‡ç¨‹ä¸­åŠ¨æ€è¿›è¡Œå†…å­˜åˆ†é…å’Œå›æ”¶æ¥æé«˜æ•ˆç‡ï¼Œå¸¸å¸¸ç”¨ä½œæ•°æ®åŒ…bufferæ¥ä½¿ç”¨ã€‚</li>
<li>Queue Manager APIä»¥é«˜æ•ˆçš„æ–¹å¼å®ç°äº†æ— é”çš„FIFOç¯å½¢é˜Ÿåˆ—ï¼Œé€‚åˆä¸ä¸€ä¸ªç”Ÿäº§è€…å¤šä¸ªæ¶ˆè´¹è€…ã€ä¸€ä¸ªæ¶ˆè´¹è€…å¤šä¸ªç”Ÿäº§è€…æ¨¡å‹æ¥é¿å…ç­‰å¾…ï¼Œå¹¶ä¸”æ”¯æŒæ‰¹é‡æ— é”çš„æ“ä½œã€‚</li>
<li>Flow Classification APIé€šè¿‡Intel SSEåŸºäºå¤šå…ƒç»„å®ç°äº†é«˜æ•ˆçš„hashç®—æ³•ï¼Œä»¥ä¾¿å¿«é€Ÿçš„å°†æ•°æ®åŒ…è¿›è¡Œåˆ†ç±»å¤„ç†ã€‚è¯¥APIä¸€èˆ¬ç”¨äºè·¯ç”±æŸ¥æ‰¾è¿‡ç¨‹ä¸­çš„æœ€é•¿å‰ç¼€åŒ¹é…ä¸­ï¼Œå®‰å…¨äº§å“ä¸­æ ¹æ®Flowäº”å…ƒç»„æ¥æ ‡è®°ä¸åŒç”¨æˆ·çš„åœºæ™¯ä¹Ÿå¯ä»¥ä½¿ç”¨ã€‚</li>
<li>PMDåˆ™å®ç°äº†Intel 1GbEã€10GbEå’Œ40GbEç½‘å¡ä¸‹åŸºäºè½®è¯¢æ”¶å‘åŒ…çš„å·¥ä½œæ¨¡å¼ï¼Œå¤§å¤§åŠ é€Ÿç½‘å¡æ”¶å‘åŒ…æ€§èƒ½ã€‚</li>
</ul>
<p>DPDKæ ¸å¿ƒæ€æƒ³ï¼š</p>
<ul>
<li>PMD: DPDKé’ˆå¯¹Intelç½‘å¡å®ç°äº†åŸºäºè½®è¯¢æ–¹å¼çš„PMDï¼ˆPoll Mode Driversï¼‰é©±åŠ¨ï¼Œè¯¥é©±åŠ¨ç”±APIã€ç”¨æˆ·ç©ºé—´è¿è¡Œçš„é©±åŠ¨ç¨‹åºæ„æˆï¼Œè¯¥é©±åŠ¨ä½¿ç”¨æ— ä¸­æ–­æ–¹å¼ç›´æ¥æ“ä½œç½‘å¡çš„æ¥æ”¶å’Œå‘é€é˜Ÿåˆ—ï¼ˆé™¤äº†é“¾è·¯çŠ¶æ€é€šçŸ¥ä»å¿…é¡»é‡‡ç”¨ä¸­æ–­æ–¹å¼ä»¥å¤–ï¼‰ã€‚ç›®å‰PMDé©±åŠ¨æ”¯æŒIntelçš„å¤§éƒ¨åˆ†1Gã€10Gå’Œ40Gçš„ç½‘å¡ã€‚PMDé©±åŠ¨ä»ç½‘å¡ä¸Šæ¥æ”¶åˆ°æ•°æ®åŒ…åï¼Œä¼šç›´æ¥é€šè¿‡DMAæ–¹å¼ä¼ è¾“åˆ°é¢„åˆ†é…çš„å†…å­˜ä¸­ï¼ŒåŒæ—¶æ›´æ–°æ— é”ç¯å½¢é˜Ÿåˆ—ä¸­çš„æ•°æ®åŒ…æŒ‡é’ˆï¼Œä¸æ–­è½®è¯¢çš„åº”ç”¨ç¨‹åºå¾ˆå¿«å°±èƒ½æ„ŸçŸ¥æ”¶åˆ°æ•°æ®åŒ…ï¼Œå¹¶åœ¨é¢„åˆ†é…çš„å†…å­˜åœ°å€ä¸Šç›´æ¥å¤„ç†æ•°æ®åŒ…ï¼Œè¿™ä¸ªè¿‡ç¨‹éå¸¸ç®€æ´ã€‚å¦‚æœè¦æ˜¯è®©Linuxæ¥å¤„ç†æ”¶åŒ…è¿‡ç¨‹ï¼Œé¦–å…ˆç½‘å¡é€šè¿‡ä¸­æ–­æ–¹å¼é€šçŸ¥åè®®æ ˆå¯¹æ•°æ®åŒ…è¿›è¡Œå¤„ç†ï¼Œåè®®æ ˆå…ˆä¼šå¯¹æ•°æ®åŒ…è¿›è¡Œåˆæ³•æ€§è¿›è¡Œå¿…è¦çš„æ ¡éªŒï¼Œç„¶ååˆ¤æ–­æ•°æ®åŒ…ç›®æ ‡æ˜¯å¦æœ¬æœºçš„socketï¼Œæ»¡è¶³æ¡ä»¶åˆ™ä¼šå°†æ•°æ®åŒ…æ‹·è´ä¸€ä»½å‘ä¸Šé€’äº¤ç»™ç”¨æˆ·socketæ¥å¤„ç†ï¼Œä¸ä»…å¤„ç†è·¯å¾„å†—é•¿ï¼Œè¿˜éœ€è¦ä»å†…æ ¸åˆ°åº”ç”¨å±‚çš„ä¸€æ¬¡æ‹·è´è¿‡ç¨‹ã€‚</li>
<li>hugetlbfs: è¿™æ ·æœ‰ä¸¤ä¸ªå¥½å¤„ï¼šç¬¬ä¸€æ˜¯ä½¿ç”¨hugepageçš„å†…å­˜æ‰€éœ€çš„é¡µè¡¨é¡¹æ¯”è¾ƒå°‘ï¼Œå¯¹äºéœ€è¦å¤§é‡å†…å­˜çš„è¿›ç¨‹æ¥è¯´èŠ‚çœäº†å¾ˆå¤šå¼€é”€ï¼Œåƒoracleä¹‹ç±»çš„å¤§å‹æ•°æ®åº“ä¼˜åŒ–éƒ½ä½¿ç”¨äº†å¤§é¡µé¢é…ç½®ï¼›ç¬¬äºŒæ˜¯TLBå†²çªæ¦‚ç‡é™ä½ï¼ŒTLBæ˜¯cpuä¸­å•ç‹¬çš„ä¸€å—é«˜é€Ÿcacheï¼Œé‡‡ç”¨hugepageå¯ä»¥å¤§å¤§é™ä½TLB missçš„å¼€é”€ã€‚DPDKç›®å‰æ”¯æŒäº†2Må’Œ1Gä¸¤ç§æ–¹å¼çš„hugepageã€‚é€šè¿‡ä¿®æ”¹é»˜è®¤/etc/grub.confä¸­hugepageé…ç½®ä¸ºâ€œdefault_hugepagesz=1G hugepagesz=1G hugepages=32 isolcpus=0-22â€ï¼Œç„¶åé€šè¿‡<code>mount â€“t hugetlbfs nodev /mnt/huge</code>å°±å°†hugepageæ–‡ä»¶ç³»ç»ŸhugetlbfsæŒ‚åœ¨/mnt/hugeç›®å½•ä¸‹ï¼Œç„¶åç”¨æˆ·è¿›ç¨‹å°±å¯ä»¥ä½¿ç”¨mmapæ˜ å°„hugepageç›®æ ‡æ–‡ä»¶æ¥ä½¿ç”¨å¤§é¡µé¢äº†ã€‚æµ‹è¯•è¡¨æ˜åº”ç”¨ä½¿ç”¨å¤§é¡µè¡¨æ¯”ä½¿ç”¨4Kçš„é¡µè¡¨æ€§èƒ½æé«˜10%~15%ã€‚</li>
<li>CPUäº²ç¼˜æ€§: å¤šæ ¸åˆ™æ˜¯æ¯ä¸ªCPUæ ¸ä¸€ä¸ªçº¿ç¨‹ï¼Œæ ¸å¿ƒä¹‹é—´è®¿é—®æ•°æ®æ— éœ€ä¸Šé”ã€‚ä¸ºäº†æœ€å¤§é™åº¦å‡å°‘çº¿ç¨‹è°ƒåº¦çš„èµ„æºæ¶ˆè€—ï¼Œéœ€è¦å°†Linuxç»‘å®šåœ¨ç‰¹å®šçš„æ ¸ä¸Šï¼Œé‡Šæ”¾å…¶ä½™æ ¸å¿ƒæ¥ä¸“ä¾›åº”ç”¨ç¨‹åºä½¿ç”¨ã€‚ åŒæ—¶è¿˜éœ€è¦è€ƒè™‘CPUç‰¹æ€§å’Œç³»ç»Ÿæ˜¯å¦æ”¯æŒNUMAæ¶æ„ï¼Œå¦‚æœæ”¯æŒçš„è¯ï¼Œä¸åŒæ’æ§½ä¸ŠCPUçš„è¿›ç¨‹è¦é¿å…è®¿é—®è¿œç«¯å†…å­˜ï¼Œå°½é‡è®¿é—®æœ¬ç«¯å†…å­˜ã€‚</li>
<li>å‡å°‘å†…å­˜è®¿é—®: å°‘ç”¨æ•°ç»„å’ŒæŒ‡é’ˆï¼Œå¤šç”¨å±€éƒ¨å˜é‡ï¼›å°‘ç”¨å…¨å±€å˜é‡ï¼›ä¸€æ¬¡å¤šè®¿é—®ä¸€äº›æ•°æ®ï¼›è‡ªå·±ç®¡ç†å†…å­˜åˆ†é…ï¼›è¿›ç¨‹é—´ä¼ é€’æŒ‡é’ˆè€Œéæ•´ä¸ªæ•°æ®å—</li>
<li>Cacheæœ‰æ•ˆæ€§å¾—ç›Šäºç©ºé—´å±€éƒ¨æ€§ï¼ˆé™„è¿‘çš„æ•°æ®ä¹Ÿä¼šè¢«ç”¨åˆ°ï¼‰å’Œæ—¶é—´å±€éƒ¨æ€§ï¼ˆä»Šåä¸€æ®µæ—¶é—´å†…ä¼šè¢«å¤šæ¬¡è®¿é—®ï¼‰åŸç†ï¼Œé€šè¿‡åˆç†çš„ä½¿ç”¨cacheï¼Œèƒ½å¤Ÿä½¿å¾—åº”ç”¨ç¨‹åºæ€§èƒ½å¾—åˆ°å¤§å¹…æå‡</li>
<li>é¿å…False Sharing: å¤šæ ¸CPUä¸­æ¯ä¸ªæ ¸éƒ½æ‹¥æœ‰è‡ªå·±çš„L1/L2 cacheï¼Œå½“è¿è¡Œå¤šçº¿ç¨‹ç¨‹åºæ—¶ï¼Œå°½ç®¡ç®—æ³•ä¸Šä¸éœ€è¦å…±äº«å˜é‡ï¼Œä½†å®é™…æ‰§è¡Œä¸­ä¸¤ä¸ªçº¿ç¨‹è®¿é—®åŒä¸€cache lineçš„æ•°æ®æ—¶å°±ä¼šå¼•èµ·å†²çªï¼Œæ¯ä¸ªçº¿ç¨‹åœ¨è¯»å–è‡ªå·±çš„æ•°æ®æ—¶ä¹Ÿä¼šæŠŠåˆ«äººçš„cachelineè¯»è¿›æ¥ï¼Œè¿™æ—¶ä¸€ä¸ªæ ¸ä¿®æ”¹æ”¹å˜é‡ï¼ŒCPUçš„cacheä¸€è‡´æ€§ç®—æ³•ä¼šè¿«ä½¿å¦ä¸€ä¸ªæ ¸çš„cacheä¸­åŒ…å«è¯¥å˜é‡æ‰€åœ¨çš„cache lineæ— æ•ˆï¼Œè¿™å°±äº§ç”Ÿäº†false sharingï¼ˆä¼ªå…±äº«ï¼‰é—®é¢˜. Falsing sharingä¼šå¯¼è‡´å¤§é‡çš„cacheå†²çªï¼Œåº”è¯¥å°½é‡é¿å…ã€‚ è®¿é—®å…¨å±€å˜é‡å’ŒåŠ¨æ€åˆ†é…å†…å­˜æ˜¯falsesharingé—®é¢˜äº§ç”Ÿçš„æ ¹æºï¼Œå½“ç„¶è®¿é—®åœ¨å†…å­˜ä¸­ç›¸é‚»çš„ä½†å®Œå…¨ä¸åŒçš„å…¨å±€å˜é‡ä¹Ÿå¯èƒ½ä¼šå¯¼è‡´false sharingï¼Œå¤šä½¿ç”¨çº¿ç¨‹æœ¬åœ°å˜é‡æ˜¯è§£å†³false sharingçš„æ ¹æºåŠæ³•ã€‚</li>
<li>å†…å­˜å¯¹é½ï¼šæ ¹æ®ä¸åŒå­˜å‚¨ç¡¬ä»¶çš„é…ç½®æ¥ä¼˜åŒ–ç¨‹åºï¼Œæ€§èƒ½ä¹Ÿèƒ½å¤Ÿå¾—åˆ°æå¤§çš„æå‡ã€‚åœ¨ç¡¬ä»¶å±‚æ¬¡ï¼Œç¡®ä¿å¯¹è±¡ä½äºä¸åŒchannelå’Œrankçš„èµ·å§‹åœ°å€ï¼Œè¿™æ ·èƒ½ä¿è¯å¯¹è±¡å¹¶å¹¶è¡ŒåŠ è½½ã€‚å­—èŠ‚å¯¹é½ï¼šä¼—æ‰€å‘¨çŸ¥ï¼Œå†…å­˜æœ€å°çš„å­˜å‚¨å•å…ƒä¸ºå­—èŠ‚ï¼Œåœ¨32ä½CPUä¸­ï¼Œå¯„å­˜å™¨ä¹Ÿæ˜¯32ä½çš„ï¼Œä¸ºäº†ä¿è¯è®¿é—®æ›´åŠ é«˜æ•ˆï¼Œåœ¨32ä½ç³»ç»Ÿä¸­å˜é‡å­˜å‚¨çš„èµ·å§‹åœ°å€é»˜è®¤æ˜¯4çš„å€æ•°ï¼ˆ64ä½ç³»ç»Ÿåˆ™æ˜¯8çš„å€æ•°ï¼‰ï¼Œå®šä¹‰ä¸€ä¸ª32ä½å˜é‡æ—¶ï¼Œåªéœ€è¦ä¸€æ¬¡å†…å­˜è®¿é—®å³å¯å°†å˜é‡åŠ è½½åˆ°å¯„å­˜å™¨ä¸­ï¼Œè¿™äº›å·¥ä½œéƒ½æ˜¯ç¼–è¯‘å™¨å®Œæˆçš„ï¼Œä¸éœ€äººå·¥å¹²é¢„ï¼Œå½“ç„¶æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<strong>attribute</strong>((aligned(n)))æ¥æ”¹å˜å¯¹é½çš„é»˜è®¤å€¼ã€‚</li>
<li>cacheå¯¹é½ï¼Œè¿™ä¹Ÿæ˜¯ç¨‹åºå¼€å‘ä¸­éœ€è¦å…³æ³¨çš„ã€‚Cache lineæ˜¯CPUä»å†…å­˜åŠ è½½æ•°æ®çš„æœ€å°å•ä½ï¼Œä¸€èˆ¬L1 cacheçš„cache lineå¤§å°ä¸º64å­—èŠ‚ã€‚å¦‚æœCPUè®¿é—®çš„å˜é‡ä¸åœ¨cacheä¸­ï¼Œå°±éœ€è¦å…ˆä»å†…å­˜è°ƒå…¥åˆ°cacheï¼Œè°ƒåº¦çš„æœ€å°å•ä½å°±æ˜¯cache lineã€‚å› æ­¤ï¼Œå†…å­˜è®¿é—®å¦‚æœæ²¡æœ‰æŒ‰ç…§cache lineè¾¹ç•Œå¯¹é½ï¼Œå°±ä¼šå¤šè¯»å†™ä¸€æ¬¡å†…å­˜å’Œcacheäº†ã€‚</li>
<li>NUMA: NUMAç³»ç»ŸèŠ‚ç‚¹ä¸€èˆ¬æ˜¯ç”±ä¸€ç»„CPUå’Œæœ¬åœ°å†…å­˜ç»„æˆã€‚NUMAè°ƒåº¦å™¨è´Ÿè´£å°†è¿›ç¨‹åœ¨åŒä¸€èŠ‚ç‚¹çš„CPUé—´è°ƒåº¦ï¼Œé™¤éè´Ÿè½½å¤ªé«˜ï¼Œæ‰è¿ç§»åˆ°å…¶å®ƒèŠ‚ç‚¹ï¼Œä½†è¿™ä¼šå¯¼è‡´æ•°æ®è®¿é—®å»¶æ—¶å¢å¤§ã€‚</li>
<li>å‡å°‘è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢: éœ€è¦äº†è§£å“ªäº›åœºæ™¯ä¼šè§¦å‘CSæ“ä½œã€‚é¦–å…ˆå°±ä»‹ç»çš„å°±æ˜¯ä¸å¯æ§çš„åœºæ™¯ï¼šè¿›ç¨‹æ—¶é—´ç‰‡åˆ°æœŸï¼›æ›´é«˜ä¼˜å…ˆçº§è¿›ç¨‹æŠ¢å CPUã€‚å…¶æ¬¡æ˜¯å¯æ§åœºæ™¯ï¼šä¼‘çœ å½“å‰è¿›ç¨‹(pthread_cond_wait)ï¼›å”¤é†’å…¶å®ƒè¿›ç¨‹(pthread_cond_signal)ï¼›åŠ é”å‡½æ•°ã€äº’æ–¥é‡ã€ä¿¡å·é‡ã€selectã€sleepç­‰éå¸¸å¤šå‡½æ•°éƒ½æ˜¯å¯æ§çš„ã€‚å¯¹äºå¯æ§åœºæ™¯æ˜¯åœ¨åº”ç”¨ç¼–ç¨‹éœ€è¦è€ƒè™‘çš„é—®é¢˜ï¼Œåªè¦ç¨‹åºé€»è¾‘è®¾è®¡åˆç†å°±èƒ½è¾ƒå°‘CSçš„æ¬¡æ•°ã€‚å¯¹äºä¸å¯æ§åœºæ™¯ï¼Œé¦–å…ˆæƒ³åˆ°çš„æ˜¯é€‚å½“å‡å°‘æ´»è·ƒè¿›ç¨‹æˆ–çº¿ç¨‹æ•°é‡ï¼Œå› æ­¤ä¿è¯æ´»è·ƒè¿›ç¨‹æ•°ç›®ä¸è¶…è¿‡CPUä¸ªæ•°æ˜¯ä¸€ä¸ªæ˜æ™ºçš„é€‰æ‹©ï¼›ç„¶åæœ‰äº›åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬å¹¶ä¸çŸ¥é“æœ‰å¤šå°‘ä¸ªæ´»è·ƒçº¿ç¨‹çš„æ—¶å€™æ€ä¹ˆæ¥ä¿è¯ä¸Šä¸‹æ–‡åˆ‡æ¢æ¬¡æ•°æœ€å°‘å‘¢ï¼Ÿè¿™æ˜¯æˆ‘ä»¬å°±éœ€è¦ä½¿ç”¨çº¿ç¨‹æ± æ¨¡å‹ï¼šè®©æ¯ä¸ªçº¿ç¨‹å·¥ä½œå‰éƒ½æŒæœ‰å¸¦è®¡æ•°å™¨çš„ä¿¡å·é‡ï¼Œåœ¨ä¿¡å·é‡è¾¾åˆ°æœ€å¤§å€¼ä¹‹å‰ï¼Œæ¯ä¸ªçº¿ç¨‹è¢«å”¤é†’æ—¶ä»…è¿›è¡Œä¸€æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå½“ä¿¡å·é‡è¾¾åˆ°æœ€å¤§å€¼æ—¶ï¼Œå…¶å®ƒçº¿ç¨‹éƒ½ä¸ä¼šå†ç«äº‰èµ„æºäº†ã€‚</li>
<li>åˆ†ç»„é¢„æµ‹æœºåˆ¶ï¼Œå¦‚æœé¢„æµ‹çš„ä¸€ä¸ªåˆ†æ”¯æŒ‡ä»¤åŠ å…¥æµæ°´çº¿ï¼Œä¹‹åå´å‘ç°å®ƒæ˜¯é”™è¯¯çš„åˆ†æ”¯ï¼Œå¤„ç†å™¨è¦å›é€€è¯¥é”™è¯¯é¢„æµ‹æ‰§è¡Œçš„å·¥ä½œï¼Œå†ç”¨æ­£ç¡®çš„æŒ‡ä»¤å¡«å……æµæ°´çº¿ã€‚è¿™æ ·ä¸€ä¸ªé”™è¯¯çš„é¢„æµ‹ä¼šä¸¥é‡æµªè´¹æ—¶é’Ÿå‘¨æœŸï¼Œå¯¼è‡´ç¨‹åºæ€§èƒ½ä¸‹é™ã€‚ã€Šè®¡ç®—æœºä½“ç³»ç»“æ„ï¼šé‡åŒ–ç ”ç©¶æ–¹æ³•ã€‹æŒ‡å‡ºåˆ†æ”¯æŒ‡ä»¤äº§ç”Ÿçš„æ€§èƒ½å½±å“ä¸º10%~30%ï¼Œæµæ°´çº¿è¶Šé•¿ï¼Œæ€§èƒ½å½±å“è¶Šå¤§ã€‚Core i7å’ŒXenç­‰è¾ƒæ–°çš„å¤„ç†å™¨å½“åˆ†æ”¯é¢„æµ‹å¤±æ•ˆæ—¶æ— éœ€åˆ·æ–°å…¨éƒ¨æµæ°´ï¼Œå½“é”™è¯¯æŒ‡ä»¤åŠ è½½å’Œè®¡ç®—ä»ä¼šå¯¼è‡´ä¸€éƒ¨åˆ†å¼€é”€ã€‚åˆ†æ”¯é¢„æµ‹ä¸­æœ€æ ¸å¿ƒçš„æ˜¯åˆ†æ”¯ç›®æ ‡ç¼“å†²åŒºï¼ˆBranch Target Bufferï¼Œç®€ç§°BTBï¼‰ï¼Œæ¯æ¡åˆ†æ”¯æŒ‡ä»¤æ‰§è¡Œåï¼Œéƒ½ä¼šBTBéƒ½ä¼šè®°å½•æŒ‡ä»¤çš„åœ°å€åŠå®ƒçš„è·³è½¬ä¿¡æ¯ã€‚BTBä¸€èˆ¬æ¯”è¾ƒå°ï¼Œå¹¶ä¸”é‡‡ç”¨Hashè¡¨çš„æ–¹å¼å­˜å…¥ï¼Œåœ¨CPUå–å€¼æ—¶ï¼Œç›´æ¥å°†PCæŒ‡é’ˆå’ŒBTBä¸­è®°å½•å¯¹æ¯”æ¥æŸ¥æ‰¾ï¼Œå¦‚æœæ‰¾åˆ°äº†ï¼Œå°±ç›´æ¥ä½¿ç”¨é¢„æµ‹çš„è·³è½¬åœ°å€ï¼Œå¦‚æœæ²¡æœ‰è®°å½•ï¼Œå¿…é¡»é€šè¿‡cacheæˆ–å†…å­˜å–ä¸‹ä¸€æ¡æŒ‡ä»¤ã€‚</li>
<li>åˆ©ç”¨æµæ°´çº¿å¹¶å‘: åƒPentiumå¤„ç†å™¨å°±æœ‰U/Vä¸¤æ¡æµæ°´ï¼Œå¹¶ä¸”å¯ä»¥ç‹¬è‡ªç‹¬ç«‹è¯»å†™ç¼“å­˜ï¼Œå¾ªç¯2å¯ä»¥å°†ä¸¤æ¡æŒ‡ä»¤å®‰æ’åœ¨ä¸åŒæµæ°´çº¿ä¸Šæ‰§è¡Œï¼Œæ€§èƒ½å¾—åˆ°æå¤§æå‡ã€‚å¦å¤–ä¸¤æ¡æµæ°´çº¿æ˜¯éå¯¹ç§°çš„ï¼Œç®€å•æŒ‡ä»¤ï¼ˆmpv,add,push,inc,cmp,leaç­‰ï¼‰å¯ä»¥åœ¨ä¸¤æ¡æµæ°´ä¸Šå¹¶è¡Œæ‰§è¡Œã€ä½æ“ä½œå’Œè·³è½¬æ“ä½œå¹¶å‘çš„å‰ææ˜¯åœ¨ç‰¹å®šæµæ°´çº¿ä¸Šå·¥ä½œã€è€ŒæŸäº›å¤æ‚æŒ‡ä»¤å´åªèƒ½ç‹¬å CPUã€‚</li>
<li>ä¸ºäº†åˆ©ç”¨ç©ºé—´å±€éƒ¨æ€§ï¼ŒåŒæ—¶ä¹Ÿä¸ºäº†è¦†ç›–æ•°æ®ä»å†…å­˜ä¼ è¾“åˆ°CPUçš„å»¶è¿Ÿï¼Œå¯ä»¥åœ¨æ•°æ®è¢«ç”¨åˆ°ä¹‹å‰å°±å°†å…¶è°ƒå…¥ç¼“å­˜ï¼Œè¿™ä¸€æŠ€æœ¯ç§°ä¸ºé¢„å–Prefetchï¼ŒåŠ è½½æ•´ä¸ªcacheå³æ˜¯ä¸€ç§é¢„å–ã€‚CPUåœ¨è¿›è¡Œè®¡ç®—è¿‡ç¨‹ä¸­å¯ä»¥å¹¶è¡Œçš„å¯¹æ•°æ®è¿›è¡Œé¢„å–æ“ä½œï¼Œå› æ­¤é¢„å–ä½¿å¾—æ•°æ®/æŒ‡ä»¤åŠ è½½ä¸CPUæ‰§è¡ŒæŒ‡ä»¤å¯ä»¥å¹¶è¡Œè¿›è¡Œã€‚</li>
</ul>
<h2 id="æ¶æ„"><a href="#æ¶æ„" class="headerlink" title="æ¶æ„"></a>æ¶æ„</h2><p><img src="https://cloud.githubusercontent.com/assets/676637/14767276/7dfb9ed8-0a54-11e6-914f-b041ddcdd40d.png" alt="dpdk"></p>
<p>åœ¨æœ€åº•éƒ¨çš„å†…æ ¸æ€(Linux Kernel)DPDK æœ‰ä¸¤ä¸ªæ¨¡å—:KNI ä¸ IGB_UIOã€‚ å…¶ä¸­,KNI æä¾›ç»™ç”¨æˆ·ä¸€ä¸ªä½¿ç”¨ Linux å†…æ ¸æ€çš„åè®®æ ˆ,ä»¥åŠä¼ ç»Ÿçš„ Linux ç½‘ç»œå·¥å…·(å¦‚ethtool, ifconfig)ã€‚IGB_UIO(igb_uio.ko å’Œ kni.ko. IGB_UIO)åˆ™å€ŸåŠ©äº† UIO æŠ€æœ¯,åœ¨åˆå§‹åŒ–è¿‡ç¨‹ä¸­å°†ç½‘å¡ç¡¬ä»¶å¯„å­˜å™¨æ˜ å°„åˆ°ç”¨æˆ·æ€ã€‚</p>
<p>DPDK çš„ä¸Šå±‚ç”¨æˆ·æ€ç”±å¾ˆå¤šåº“ç»„æˆ,ä¸»è¦åŒ…æ‹¬æ ¸å¿ƒéƒ¨ä»¶åº“(Core Libraries)ã€å¹³å°ç›¸å…³æ¨¡å—(Platform)ã€ç½‘å¡è½®è¯¢æ¨¡å¼é©±åŠ¨æ¨¡å—(PMD-Natives&amp; Virtual)ã€QoS åº“ã€æŠ¥æ–‡è½¬å‘åˆ†ç±»ç®—æ³•(Classify)ç­‰å‡ å¤§ç±»,ç”¨æˆ·åº”ç”¨ç¨‹åºå¯ä»¥ä½¿ç”¨è¿™äº›åº“è¿›è¡ŒäºŒæ¬¡å¼€å‘.</p>
<h2 id="ivshmem"><a href="#ivshmem" class="headerlink" title="ivshmem"></a>ivshmem</h2><p>The DPDK IVSHMEM library facilitates fast zero-copy data sharing among virtual machines (host-to-guest or guest-to-guest) by means of QEUMUâ€™s IVSHMEM mechanism.</p>
<p>The library works by providing a command line for QEMU to map several hugepages into a single IVSHMEM device. For the guest to know what is inside any given IVSHMEM device (and to distinguish between DPDK and non-DPDK IVSHMEM devices), a metadata file is also mapped into the IVSHMEM segment. No work needs to be done by the guest application to map IVSHMEM devices into memory; they are automatically recognized by the DPDK Environment Abstraction Layer (EAL).</p>
<p>See <a href="http://dpdk.org/doc/guides/prog_guide/ivshmem_lib.html" target="_blank" rel="external">http://dpdk.org/doc/guides/prog_guide/ivshmem_lib.html</a></p>
<h2 id="vhost"><a href="#vhost" class="headerlink" title="vhost"></a>vhost</h2><p>The vhost library implements a user space vhost driver. It supports both vhost-cuse (cuse: user space character device) and vhost-user(user space socket server). It also creates, manages and destroys vhost devices for corresponding virtio devices in the guest. Vhost supported vSwitch could register callbacks to this library, which will be called when a vhost device is activated or deactivated by guest virtual machine.</p>
<p>See <a href="http://dpdk.org/doc/guides/prog_guide/vhost_lib.html" target="_blank" rel="external">http://dpdk.org/doc/guides/prog_guide/vhost_lib.html</a></p>
<h2 id="dpdk-model"><a href="#dpdk-model" class="headerlink" title="dpdk model"></a>dpdk model</h2><p>The DPDK implements a run to completion model for packet processing, where all resources must be allocated prior to calling Data Plane applications, running as execution units on logical processing cores. The model does not support a scheduler and all devices are accessed by polling. The primary reason for not using interrupts is the performance overhead imposed by interrupt processing.</p>
<p>In addition to the run-to-completion model, a pipeline model may also be used by passing packets or messages between cores via the rings. This allows work to be performed in stages and may allow more efficient use of code on cores.</p>
<p>æ›´å¤šå‚è€ƒ</p>
<ul>
<li><a href="http://dpdk.org" target="_blank" rel="external">http://dpdk.org</a></li>
<li><a href="http://dpdk.org/doc/guides/" target="_blank" rel="external">http://dpdk.org/doc/guides/</a></li>
<li><a href="https://github.com/yanwushuang/mospan-hugo-blog/blob/d81411e1121ee94301e59ba78039c0efdf96b367/content/post/2016/2016-03-14-xns-on-dpdk.md" target="_blank" rel="external">https://github.com/yanwushuang/mospan-hugo-blog/blob/d81411e1121ee94301e59ba78039c0efdf96b367/content/post/2016/2016-03-14-xns-on-dpdk.md</a></li>
<li><a href="http://intel.com/go/dpdk" target="_blank" rel="external">http://intel.com/go/dpdk</a></li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;DPDK-Introduction&quot;&gt;&lt;a href=&quot;#DPDK-Introduction&quot; class=&quot;headerlink&quot; title=&quot;DPDK Introduction&quot;&gt;&lt;/a&gt;DPDK Introduction&lt;/h2&gt;&lt;p&gt;Intel DPDK
    
    </summary>
    
    
      <category term="dpdk" scheme="http://feisky.xyz/tags/dpdk/"/>
    
  </entry>
  
  <entry>
    <title>Tips for cgo</title>
    <link href="http://feisky.xyz/2016/04/24/Tips-for-cgo/"/>
    <id>http://feisky.xyz/2016/04/24/Tips-for-cgo/</id>
    <published>2016-04-24T00:29:02.000Z</published>
    <updated>2016-12-15T00:14:54.373Z</updated>
    
    <content type="html"><![CDATA[<p>cgoçš„ä¸€äº›tips</p>
<h2 id="åŸºæœ¬ç±»å‹"><a href="#åŸºæœ¬ç±»å‹" class="headerlink" title="åŸºæœ¬ç±»å‹"></a>åŸºæœ¬ç±»å‹</h2><p>The standard C numeric types are available under the names C.char, C.schar (signed char), C.uchar (unsigned char), C.short, C.ushort (unsigned short), C.int, C.uint (unsigned int), C.long, C.ulong (unsigned long), C.longlong (long long), C.ulonglong (unsigned long long), C.float, C.double, C.complexfloat (complex float), and C.complexdouble (complex double). The C type void* is represented by Goâ€™s unsafe.Pointer. The C types <code>__int128_t</code> and <code>__uint128_t</code> are represented by [16]byte.</p>
<p>To access a struct, union, or enum type directly, prefix it with struct<em>, union</em>, or enum_, as in C.struct_stat.</p>
<p>The size of any C type T is available as C.sizeof_T, as in C.sizeof_struct_stat.</p>
<p>As Go doesnâ€™t have support for Câ€™s union type in the general case, Câ€™s union types are represented as a Go byte array with the same length.</p>
<p>Go structs cannot embed fields with C types.</p>
<p>Any C function (even void functions) may be called in a multiple assignment context to retrieve both the return value (if any) and the C errno variable as an error (use _ to skip the result value if the function returns void). For example:</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><div class="line"><span class="keyword">n</span>, <span class="keyword">err</span> := C.<span class="built_in">sqrt</span>(-1)</div><div class="line">_, <span class="keyword">err</span> := C.voidFunc()</div></pre></td></tr></table></figure>
<h2 id="å­—ç¬¦ä¸²ç±»å‹è½¬æ¢"><a href="#å­—ç¬¦ä¸²ç±»å‹è½¬æ¢" class="headerlink" title="å­—ç¬¦ä¸²ç±»å‹è½¬æ¢"></a>å­—ç¬¦ä¸²ç±»å‹è½¬æ¢</h2><p><code>C.CString</code>å’Œ<code>C.GoString</code>éƒ½ä¼šå¯¹åŸå§‹æ•°æ®åšæ‹·è´ï¼Œä¸è¦å¿˜è®°é‡Šæ”¾CStringåˆ›å»ºçš„å†…å­˜ï¼š</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="comment">// Go string to C string</span></div><div class="line"><span class="comment">// The C string is allocated in the C heap using malloc.</span></div><div class="line"><span class="comment">// It is the caller's responsibility to arrange for it to be</span></div><div class="line"><span class="comment">// freed, such as by calling C.free (be sure to include stdlib.h</span></div><div class="line"><span class="comment">// if C.free is needed).</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">C</span>.<span class="title">CString</span><span class="params">(<span class="keyword">string</span>)</span> *<span class="title">C</span>.<span class="title">char</span></span></div><div class="line"></div><div class="line">// <span class="title">C</span> <span class="title">string</span> <span class="title">to</span> <span class="title">Go</span> <span class="title">string</span></div><div class="line"><span class="title">func</span> <span class="title">C</span>.<span class="title">GoString</span><span class="params">(*C.char)</span> <span class="title">string</span></div><div class="line"></div><div class="line">// <span class="title">C</span> <span class="title">data</span> <span class="title">with</span> <span class="title">explicit</span> <span class="title">length</span> <span class="title">to</span> <span class="title">Go</span> <span class="title">string</span></div><div class="line"><span class="title">func</span> <span class="title">C</span>.<span class="title">GoStringN</span><span class="params">(*C.char, C.<span class="keyword">int</span>)</span> <span class="title">string</span></div><div class="line"></div><div class="line">// <span class="title">C</span> <span class="title">data</span> <span class="title">with</span> <span class="title">explicit</span> <span class="title">length</span> <span class="title">to</span> <span class="title">Go</span> []<span class="title">byte</span></div><div class="line"><span class="title">func</span> <span class="title">C</span>.<span class="title">GoBytes</span><span class="params">(unsafe.Pointer, C.<span class="keyword">int</span>)</span> []<span class="title">byte</span></div></pre></td></tr></table></figure>
<p><code>C.CString</code>ä½¿ç”¨ç¤ºä¾‹ï¼š</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line">ch := C.CString(str)</div><div class="line"><span class="keyword">defer</span> C.free(unsafe.Pointer(ch))</div><div class="line">....</div></pre></td></tr></table></figure>
<h2 id="æ•°ç»„çš„ä½¿ç”¨"><a href="#æ•°ç»„çš„ä½¿ç”¨" class="headerlink" title="æ•°ç»„çš„ä½¿ç”¨"></a>æ•°ç»„çš„ä½¿ç”¨</h2><p>Goåˆ‡ç‰‡è½¬ä¸ºCæ•°ç»„ï¼š</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="comment">/*</span></div><div class="line">#include &lt;stdio.h&gt;</div><div class="line">void foo(double *arr, int len) &#123;</div><div class="line">	for(int i=0;i&lt;len;i++) &#123;</div><div class="line">		printf("%f\n", arr[i]);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line">*/</div><div class="line"><span class="keyword">import</span> <span class="string">"C"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	arr := []<span class="keyword">float64</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;</div><div class="line">	carr := (*C.double)(unsafe.Pointer(&amp;arr[<span class="number">0</span>]))</div><div class="line">	C.foo(carr, C.<span class="keyword">int</span>(<span class="built_in">len</span>(arr)))</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Cæ•°ç»„è½¬ä¸ºGoåˆ‡ç‰‡</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line"><span class="keyword">import</span> <span class="string">"unsafe"</span></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line">#include &lt;stdio.h&gt;</div><div class="line">#include &lt;stdlib.h&gt;</div><div class="line">double* get_array(int n) &#123;</div><div class="line">	double *arr;</div><div class="line">	arr = (double*)malloc(n*sizeof(arr));</div><div class="line">	for(int i=0;i&lt;n;i++)</div><div class="line">	&#123;</div><div class="line">		arr[i]=i;</div><div class="line">	&#125;</div><div class="line">	return arr;</div><div class="line">&#125;</div><div class="line">*/</div><div class="line"><span class="keyword">import</span> <span class="string">"C"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	size := <span class="number">10</span></div><div class="line">	carr := C.get_array(C.<span class="keyword">int</span>(size))</div><div class="line">	<span class="keyword">defer</span> C.free(unsafe.Pointer(carr))</div><div class="line">	arr := (*[<span class="number">1</span> &lt;&lt; <span class="number">30</span>]<span class="keyword">float64</span>)(unsafe.Pointer(carr))[:size:size]</div><div class="line">	fmt.Println(arr)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>CæŒ‡é’ˆæ“ä½œ</p>
<figure class="highlight go"><table><tr><td class="code"><pre><div class="line">size := <span class="number">10</span></div><div class="line">carr := C.get_array(C.<span class="keyword">int</span>(size))</div><div class="line"><span class="keyword">defer</span> C.free(unsafe.Pointer(carr))</div><div class="line"></div><div class="line"><span class="comment">// To go slice</span></div><div class="line">arr := (*[<span class="number">1</span> &lt;&lt; <span class="number">30</span>]<span class="keyword">float64</span>)(unsafe.Pointer(carr))[:size:size]</div><div class="line"><span class="keyword">for</span> index := <span class="number">0</span>; index &lt; size; index++ &#123;</div><div class="line">    <span class="comment">// get value by C pointer operation</span></div><div class="line">    value := *(*C.double)(unsafe.Pointer(<span class="keyword">uintptr</span>(unsafe.Pointer(carr)) + <span class="keyword">uintptr</span>(index)*unsafe.Sizeof(carr)))</div><div class="line">    <span class="comment">// get value by Go slice index</span></div><div class="line">    gvalue := arr[index]</div><div class="line">    fmt.Println(value, <span class="string">" == "</span>, gvalue)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ›´å¤šæ–‡æ¡£è§<a href="https://golang.org/cmd/cgo/" target="_blank" rel="external">https://golang.org/cmd/cgo/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;cgoçš„ä¸€äº›tips&lt;/p&gt;
&lt;h2 id=&quot;åŸºæœ¬ç±»å‹&quot;&gt;&lt;a href=&quot;#åŸºæœ¬ç±»å‹&quot; class=&quot;headerlink&quot; title=&quot;åŸºæœ¬ç±»å‹&quot;&gt;&lt;/a&gt;åŸºæœ¬ç±»å‹&lt;/h2&gt;&lt;p&gt;The standard C numeric types are available u
    
    </summary>
    
    
      <category term="go" scheme="http://feisky.xyz/tags/go/"/>
    
  </entry>
  
</feed>
