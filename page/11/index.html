<!doctype html>



  


<html class="theme-next pisces use-motion">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Cloud, Container, Kubernetes, SDN, Docker" />





  <link rel="alternate" href="/atom.xml" title="Feisky's Blog" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.2" />






<meta name="description" content="Notes about anything.">
<meta property="og:type" content="website">
<meta property="og:title" content="Feisky's Blog">
<meta property="og:url" content="http://feisky.xyz/page/11/index.html">
<meta property="og:site_name" content="Feisky's Blog">
<meta property="og:description" content="Notes about anything.">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Feisky's Blog">
<meta name="twitter:description" content="Notes about anything.">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"always"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    }
  };
</script>




  <link rel="canonical" href="http://feisky.xyz/page/11/"/>


  <title> Feisky's Blog </title><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>

<body itemscope itemtype="//schema.org/WebPage" lang="zh-Hans">

  


<!-- hexo-inject:begin --><!-- hexo-inject:end --><script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-69699206-1', 'auto');
  ga('send', 'pageview');
</script>









  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="//schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Feisky's Blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">Notes about anything.</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-pages">
          <a href="/pages" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            笔记
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404.html" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />
            
            公益404
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>


    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/03/03/linux-kernel-network-call-flow/" itemprop="url">
                  Linux kernel network call flow
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-03-04T00:00:00+08:00" content="2015-03-04">
              2015-03-04
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="/images/network_flow.jpg" alt=""></p>
<p>Refer <a href="http://blog.csdn.net/night_elf_1020/article/details/19935813" target="_blank" rel="external">http://blog.csdn.net/night_elf_1020/article/details/19935813</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/03/03/ovs-20-call-flow/" itemprop="url">
                  OVS 2.0 call flow
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-03-04T00:00:00+08:00" content="2015-03-04">
              2015-03-04
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="/images/ovs_flow.jpg" alt=""></p>
<p>Refer <a href="http://blog.csdn.net/night_elf_1020/article/details/37600791" target="_blank" rel="external">http://blog.csdn.net/night_elf_1020/article/details/37600791</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/03/02/dive-in-linux-capabilites/" itemprop="url">
                  Dive in Linux capabilites
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-03-03T00:00:00+08:00" content="2015-03-03">
              2015-03-03
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h3><p>Capabilities in Linux are flags that tell the kernel what the application is allowed to do, If you have no additional security mechanism in place, the Linux root user has all capabilities assigned to it. As capabilities are a way for running processes with some privileges, without having the need to grant them root privileges, it is important to understand that they exist.</p>
<p>Consider the ping utility. It is marked setuid root on some distributions, because the utility requires the (cap)ability to send raw packets. This capability is known as CAP_NET_RAW. However, thanks to capabilities, you can now mark the ping application with this capability and drop the setuid from the file. As a result, the application does not run with full root privileges anymore, but with the restricted privileges of the user plus one capability, namely the CAP_NET_RAW.</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><div class="line">➜  ~  cp /bin/ping .</div><div class="line">➜  ~  ll ping</div><div class="line">-rwxr-xr-x <span class="number">1</span> fei fei <span class="number">44</span>K  <span class="number">3</span>月  <span class="number">3</span> <span class="number">14</span>:<span class="number">42</span> ping</div><div class="line">➜  ~  ll /bin/ping</div><div class="line">-rwsr-xr-x <span class="number">1</span> root root <span class="number">44</span>K  <span class="number">5</span>月  <span class="number">8</span>  <span class="number">2014</span> /bin/ping</div><div class="line">➜  ~  ./ping -c <span class="number">1</span> www<span class="selector-class">.baidu</span><span class="selector-class">.com</span></div><div class="line">ping: icmp open socket: Operation not permitted</div><div class="line">➜  ~  sudo setcap cap_net_raw+<span class="selector-tag">p</span> ping</div><div class="line">➜  ~  getcap ping</div><div class="line">ping = cap_net_raw+<span class="selector-tag">p</span></div><div class="line">➜  ~  ./ping -c <span class="number">1</span> www<span class="selector-class">.baidu</span><span class="selector-class">.com</span></div><div class="line">PING www<span class="selector-class">.a</span><span class="selector-class">.shifen</span><span class="selector-class">.com</span> (<span class="number">115.239</span>.<span class="number">211.112</span>) <span class="number">56</span>(<span class="number">84</span>) bytes of data.</div><div class="line"><span class="number">64</span> bytes from <span class="number">115.239</span>.<span class="number">211.112</span>: icmp_seq=<span class="number">1</span> ttl=<span class="number">51</span> time=<span class="number">6.83</span> ms</div><div class="line"></div><div class="line">--- www<span class="selector-class">.a</span><span class="selector-class">.shifen</span><span class="selector-class">.com</span> ping statistics ---</div><div class="line"><span class="number">1</span> packets transmitted, <span class="number">1</span> received, <span class="number">0%</span> packet loss, <span class="selector-tag">time</span> <span class="number">0ms</span></div><div class="line">rtt min/avg/max/mdev = <span class="number">6.833</span>/<span class="number">6.833</span>/<span class="number">6.833</span>/<span class="number">0.000</span> ms</div></pre></td></tr></table></figure>
<h3 id="Useful-Tools"><a href="#Useful-Tools" class="headerlink" title="Useful Tools"></a>Useful Tools</h3><p>Install capability tools by <code>sudo apt-get install libcap-ng-utils</code>.</p>
<ul>
<li>filecap - a program to see file capabilities</li>
<li>pscap - a program to see process capabilities</li>
<li>netcap - a program to see network capabilities</li>
</ul>
<h3 id="Another-exmaple"><a href="#Another-exmaple" class="headerlink" title="Another exmaple"></a>Another exmaple</h3><p>Use following program for test cap_setuid and cap_setgid.</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><div class="line"><span class="comment">/*</span></div><div class="line"> * gcc cap_test.c -o test -lcap</div><div class="line">**/</div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/capability.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"cap_setuid and cap_setgid: %d\n"</span>, prctl(PR_CAPBSET_READ, CAP_SETUID | CAP_SETGID, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>));</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"File cap: %s\n"</span>, cap_to_text(cap_get_file(argv[<span class="number">0</span>]), <span class="literal">NULL</span>));</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"Process cap: %s\n"</span>, cap_to_text(cap_get_proc(), <span class="literal">NULL</span>));</div><div class="line">    <span class="keyword">if</span> (setresuid(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>))</div><div class="line">    &#123;</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"setresuid(): %s\n"</span>, strerror(errno));</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">char</span> *args[] = &#123;<span class="literal">NULL</span>&#125;;</div><div class="line">        <span class="keyword">char</span> *env[] = &#123;<span class="literal">NULL</span>&#125;;</div><div class="line">        execve(<span class="string">"/bin/sh"</span>, args, env);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Since <code>test</code> has no capabilities of cap_setuid and cap_setgid, <code>test</code> program is not permitted to setresuid().</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><div class="line">➜  gcc cap_test.c -o <span class="keyword">test</span> -lcap</div><div class="line">➜  ./<span class="keyword">test</span></div><div class="line">cap_setuid and cap_setgid: 1</div><div class="line"><span class="keyword">File</span> <span class="keyword">cap</span>: (null)</div><div class="line">Process <span class="keyword">cap</span>: =</div><div class="line">setresuid(): Operation not permitted</div></pre></td></tr></table></figure>
<p>Now, we add cap_setuid and cap_setgid to <code>test</code>:</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><div class="line">➜  sudo setcap cap_setuid,cap_setgid+ep <span class="keyword">test</span></div><div class="line">➜  ./<span class="keyword">test</span></div><div class="line">cap_setuid and cap_setgid: 1</div><div class="line"><span class="keyword">File</span> <span class="keyword">cap</span>: = cap_setgid,cap_setuid+ep</div><div class="line">Process <span class="keyword">cap</span>: = cap_setgid,cap_setuid+ep</div><div class="line"># <span class="keyword">cat</span> /etc/shadow   # We are <span class="keyword">in</span> <span class="keyword">sh</span> now and we have root priviledge</div><div class="line">root:!:11111:0:99999:7:::</div><div class="line">daemon:*:12232:0:99999:7:::</div><div class="line">...</div></pre></td></tr></table></figure>
<h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h3><p>See more at <a href="http://man7.org/linux/man-pages/man7/capabilities.7.html" target="_blank" rel="external">man</a> and <a href="https://www.kernel.org/pub/linux/libs/security/linux-privs/kernel-2.2/capfaq-0.2.txt" target="_blank" rel="external">faq</a>.</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/03/01/setting-up-gre-for-kubernetes/" itemprop="url">
                  Setting up GRE for Kubernetes
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-03-02T00:00:00+08:00" content="2015-03-02">
              2015-03-02
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>首先修改Docker的默认网桥：</p>
<figure class="highlight vala"><table><tr><td class="code"><pre><div class="line"><span class="meta">#停止Docker Daemon进程</span></div><div class="line">systemctl stop docker</div><div class="line"></div><div class="line"><span class="meta">#设置默认网桥docker0为down，并删除</span></div><div class="line">ip link <span class="keyword">set</span> dev docker0 down</div><div class="line">brctl delbr docker0</div><div class="line"></div><div class="line"><span class="meta">#新建Linux网桥localbr0</span></div><div class="line">brctl addbr localbr0</div><div class="line"></div><div class="line"><span class="meta">#在每台主机上更改10.10.x.0/24，注意各台主机之间不要重复</span></div><div class="line">ip addr add <span class="number">10.10</span><span class="number">.2</span><span class="number">.1</span>/<span class="number">24</span> dev localbr0</div><div class="line">ip link <span class="keyword">set</span> dev localbr0 up</div><div class="line"></div><div class="line">echo <span class="string">'OPTIONS="--bridge localbr0 --iptables=false"'</span>&gt;&gt;/etc/sysconfig/docker</div><div class="line">systemctl start Docker</div></pre></td></tr></table></figure>
<p>为上述网桥添加GRE连接</p>
<figure class="highlight smali"><table><tr><td class="code"><pre><div class="line"><span class="comment">#新建Openvswitch网桥</span></div><div class="line">ovs-vsctl<span class="built_in"> add-br </span>ovsbr</div><div class="line"></div><div class="line"><span class="comment">#启用STP协议防止网桥环路</span></div><div class="line">ovs-vsctl set<span class="keyword"> bridge</span> ovsbr stp_enable=true</div><div class="line"></div><div class="line"><span class="comment">#添加ovsbr到本地localbr0，使得容器流量通过OVS流经GRE Tunnel</span></div><div class="line">brctl addif localbr0 ovsbr</div><div class="line">ip link set dev ovsbr up</div><div class="line"></div><div class="line"><span class="comment">#创建GRE</span></div><div class="line">ovs-vsctl<span class="built_in"> add-port </span>ovsbr tep0 -- set interface tep0 type=internal</div><div class="line"></div><div class="line"><span class="comment">#需在每个主机上修改tep0 IP地址</span></div><div class="line">ip addr<span class="built_in"> add </span>192.168.1.1/24 dev tep0</div><div class="line">ip addr<span class="built_in"> add </span>192.168.1.2/24 dev tep0</div><div class="line">ip link set dev tep0 up</div><div class="line"></div><div class="line"><span class="comment">#使用GRE隧道连接每个主机上的Openvswitch网桥</span></div><div class="line"><span class="comment">#192.168.0.127</span></div><div class="line">ovs-vsctl<span class="built_in"> add-port </span>ovsbr gre0 -- set interface gre0 type=gre options:remote_ip=192.168.0.128</div><div class="line"></div><div class="line"><span class="comment">#192.168.0.128</span></div><div class="line">ovs-vsctl<span class="built_in"> add-port </span>ovsbr gre0 -- set interface gre0 type=gre options:remote_ip=192.168.0.127</div><div class="line"></div><div class="line"><span class="comment">#配置路由使得跨主机间容器的通信</span></div><div class="line">ip route<span class="built_in"> add </span>10.10.0.0/16 dev tep0</div><div class="line"></div><div class="line"><span class="comment">#为了使得容器访问Internet，在两台主机上配置NAT</span></div><div class="line">iptables -t nat -A POSTROUTING -s 10.10.0.0/16 -o eth0 -j MASQUERADE</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/03/01/open-vswitch-over-dpdk-on-ubuntu/" itemprop="url">
                  Open vSwitch over DPDK on Ubuntu
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-03-02T00:00:00+08:00" content="2015-03-02">
              2015-03-02
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>There are two approaches for using DPDK acceleration in DPDK. One is the openvswitch fork from intel, called dpdk-ovs the other is done directly in openvswitch with a different approach from intel. <span class="anchor" id="line-10">&lt;/span&gt;<br><span class="anchor" id="line-11"></span><span class="anchor" id="line-12"></span></span></p>
<ul>
<li><a href="http://dpdk.org/ml/archives/dev/2014-March/001770.html" target="_blank" rel="external">http://dpdk.org/ml/archives/dev/2014-March/001770.html</a> <span class="anchor" id="line-13">&lt;/span&gt;<br><span class="anchor" id="line-14"></span>- <a href="https://github.com/01org/dpdk-ovs" target="_blank" rel="external">https://github.com/01org/dpdk-ovs</a> <span class="anchor" id="line-15">&lt;/span&gt;<span class="anchor" id="line-16"></span></span></span></li>
</ul>
<h2 id="VirtualBox-preparations"><a href="#VirtualBox-preparations" class="headerlink" title="VirtualBox preparations"></a>VirtualBox preparations<span class="anchor" id="line-17"></span></h2><p>To run openvswitch with DPDK I used a virtual machine (<a href="https://wiki.linaro.org/VirtualBox" target="_blank" rel="external">VirtualBox</a>) because the NIC I had on my laptop was not supported. I created three virtual NICs for my vm, one behind NAT to use it to ssh into the vm from the host, and two in host-only mode, to be use for testing. <span class="anchor" id="line-18">&lt;/span&gt;<span class="anchor" id="line-19"></span></span></p>
<p>If you happen to go down this road too, then it’s a good advice to do a few things before starting the test application. <span class="anchor" id="line-20">&lt;/span&gt;<span class="anchor" id="line-21"></span></span></p>
<p>First I would recommend configuring two virtual processors on the virtual machine, it makes possible to use most of the DPDK test apps, like testpmd. I would also recommend reserving about 4 GB of RAM to make sure DPDK works properly. <span class="anchor" id="line-22">&lt;/span&gt;<span class="anchor" id="line-23"></span></span></p>
<p>Then, to configure a network interface in host-only mode you need to create a host-only adapter (this applies to VirtualBox). Here is a link on how to do that:<br><span class="anchor" id="line-24">&lt;/span&gt;<br><span class="anchor" id="line-25"></span><a href="http://ubuntuforums.org/showthread.php?t=1873650" target="_blank" rel="external">http://ubuntuforums.org/showthread.php?t=1873650</a> <span class="anchor" id="line-26">&lt;/span&gt;<span class="anchor" id="line-27"></span></span></span></p>
<p>Then you need to make sure that the interface is assigned an IP address (dhcp should work and you should be able to ping the guest from the host but you may need to configure dhcp on the virtual network if virtual box doesn’t do that). <span class="anchor" id="line-28">&lt;/span&gt;<span class="anchor" id="line-29"></span></span></p>
<p>Ping the two guest interfaces in order to populate the ARP table: <span class="anchor" id="line-30">&lt;/span&gt;<span class="anchor" id="line-31"></span></span></p>
<p><span class="anchor" id="line-32">&lt;/span&gt;<span class="anchor" id="line-33"></span><span class="anchor" id="line-34"></span></span></p>
<pre>
<span class="anchor" id="line-1"></span>ping 192.168.56.101
<span class="anchor" id="line-2"></span>ping 192.168.57.101
</pre><span class="anchor" id="line-35"></span><span class="anchor" id="line-36"></span>

Find the arp entries an make them persistent: <span class="anchor" id="line-37"></span><span class="anchor" id="line-38"></span>

<span class="anchor" id="line-39"></span><span class="anchor" id="line-40"></span><span class="anchor" id="line-41"></span><span class="anchor" id="line-42"></span><span class="anchor" id="line-43"></span><span class="anchor" id="line-44"></span><span class="anchor" id="line-45"></span><span class="anchor" id="line-46"></span><span class="anchor" id="line-47"></span><span class="anchor" id="line-48"></span>

<pre>
<span class="anchor" id="line-1-1"></span>arp -n | grep 192.168.56.101
<span class="anchor" id="line-2-1"></span>sudo arp -s 192.168.56.101 08:00:27:20:88:10
<span class="anchor" id="line-3"></span>arp -n | grep 192.168.56.101 # now you should see flags CM to your arp entry
<span class="anchor" id="line-4"></span>192.168.56.101           ether   08:00:27:20:88:10   CM                    vboxnet0
<span class="anchor" id="line-5"></span>
<span class="anchor" id="line-6"></span>arp -n | grep 192.168.57.101
<span class="anchor" id="line-7"></span>sudo arp -s 192.168.57.1 08:00:27:85:40:f6
<span class="anchor" id="line-8"></span>arp -n | grep 192.168.57.101 # now you should see flags CM to your arp entry
<span class="anchor" id="line-9"></span>192.168.57.101           ether   08:00:27:85:40:f6   CM                    vboxnet1
</pre><span class="anchor" id="line-49"></span><span class="anchor" id="line-50"></span><span class="anchor" id="line-51"></span>

## Installing DPDK<span class="anchor" id="line-52"></span><span class="anchor" id="line-53"></span>

There is good information from intel on DPDK, quickstarts, howtos etc. But for the sake of simplicity, here is selected useful information needed when starting with DPDK for the first time. <span class="anchor" id="line-54"></span>
<span class="anchor" id="line-55"></span>http://dpdk.org/doc <span class="anchor" id="line-56"></span><span class="anchor" id="line-57"></span>

### Getting the code<span class="anchor" id="line-58"></span>

Simply
<tt>&nbsp;git&nbsp;clone&nbsp;git://dpdk.org/dpdk&nbsp;</tt><span class="anchor" id="line-59"></span><span class="anchor" id="line-60"></span>

Note: At the moment I'm writing this, openvswitch doesn't compile with latest version of dpdk so I went with version 1.7.0rc0. Unfortunately there is no tag for it, so you will have to: <span class="anchor" id="line-61"></span><span class="anchor" id="line-62"></span>

<span class="anchor" id="line-63"></span><span class="anchor" id="line-64"></span>

<pre>
<span class="anchor" id="line-1-2"></span>git checkout 536ba2d8a867ecf4331673d4c45475e552d57e27 -b version-1.7
</pre><span class="anchor" id="line-65"></span><span class="anchor" id="line-66"></span><span class="anchor" id="line-67"></span>

### Hardware requirements<span class="anchor" id="line-68"></span>

DPDK works only on a select range of intel devices. It seems that most of the x86 NICs should work just fine, but I couldn't get it working on my HP ProBook 6560b laptop containing an Intel 82540EM Gigabit Ethernet Controller (rev 02) <span class="anchor" id="line-69"></span><span class="anchor" id="line-70"></span>

To check if your NIC is supported first you need to get the device id and then look it up in the list of supported devices. <span class="anchor" id="line-71"></span><span class="anchor" id="line-72"></span>

lspci - lists all the pci devices; look for your network card here and get the PCI vendor and device ID in the square brackets after the type string. For example: <span class="anchor" id="line-73"></span><span class="anchor" id="line-74"></span>

<span class="anchor" id="line-75"></span><span class="anchor" id="line-76"></span><span class="anchor" id="line-77"></span><span class="anchor" id="line-78"></span>

<pre>
<span class="anchor" id="line-1-3"></span># lspci -nn|grep Ethernet
<span class="anchor" id="line-2-2"></span>00:19.0 Ethernet controller [0200]: Intel Corporation Ethernet Connection I217-LM [8086:153a] (rev 05)
</pre><span class="anchor" id="line-79"></span><span class="anchor" id="line-80"></span>

The list of known and supported devices can be found in the dpdk repository, under: <span class="anchor" id="line-81"></span><span class="anchor" id="line-82"></span>

<span class="anchor" id="line-83"></span><span class="anchor" id="line-84"></span><span class="anchor" id="line-85"></span><span class="anchor" id="line-86"></span><span class="anchor" id="line-87"></span><span class="anchor" id="line-88"></span>

<pre>
<span class="anchor" id="line-1-4"></span>lib/librte_eal/common/include/rte_pci_dev_ids.h
<span class="anchor" id="line-2-3"></span>
<span class="anchor" id="line-3-1"></span>...
<span class="anchor" id="line-4-1"></span>#define E1000_DEV_ID_PCH_LPT_I217_LM                0x153A
<span class="anchor" id="line-5-1"></span>...
</pre><span class="anchor" id="line-89"></span><span class="anchor" id="line-90"></span>

**If the device is supported then there will be a subsequent line declaring it as supported, for instance:** <span class="anchor" id="line-91"></span><span class="anchor" id="line-92"></span>

<span class="anchor" id="line-93"></span><span class="anchor" id="line-94"></span>

<pre>
<span class="anchor" id="line-1-5"></span>RTE_PCI_DEV_ID_DECL_EM(PCI_VENDOR_ID_INTEL, E1000_DEV_ID_82540EM)
</pre><span class="anchor" id="line-95"></span><span class="anchor" id="line-96"></span>

If you have no supported NICs then you can always try a hypervisor (VirtualBox for instance) that can emulate one of the supported NICs (like the one above for example). <span class="anchor" id="line-97"></span><span class="anchor" id="line-98"></span>

### Compiling DPDK<span class="anchor" id="line-99"></span>

Before even trying to compile openvswitch you need the dpdk code built in a single library. See INSTALL.DPDK for details. Basically you need to open <span class="anchor" id="line-100"></span>$DPDK/config/defconfig_x86_64-default-linuxapp-gcc and change <span class="anchor" id="line-101"></span><span class="anchor" id="line-102"></span>

<span class="anchor" id="line-103"></span><span class="anchor" id="line-104"></span>

<pre>
<span class="anchor" id="line-1-6"></span>CONFIG_RTE_BUILD_COMBINE_LIBS=n
</pre><span class="anchor" id="line-105"></span>

to <span class="anchor" id="line-106"></span><span class="anchor" id="line-107"></span><span class="anchor" id="line-108"></span>

<pre>
<span class="anchor" id="line-1-7"></span>CONFIG_RTE_BUILD_COMBINE_LIBS=y
</pre><span class="anchor" id="line-109"></span><span class="anchor" id="line-110"></span>

Then compile: <span class="anchor" id="line-111"></span><span class="anchor" id="line-112"></span>

<span class="anchor" id="line-113"></span><span class="anchor" id="line-114"></span>

<pre>
<span class="anchor" id="line-1-8"></span>make install T=x86_64-default-linuxapp-gcc
</pre><span class="anchor" id="line-115"></span><span class="anchor" id="line-116"></span>

### Bind interfaces to DPDK<span class="anchor" id="line-117"></span>

DPDK uses a specialized kernel module to allow userspace applications to control the network card. <span class="anchor" id="line-118"></span><span class="anchor" id="line-119"></span>

<span class="anchor" id="line-120"></span><span class="anchor" id="line-121"></span><span class="anchor" id="line-122"></span><span class="anchor" id="line-123"></span>

<pre>
<span class="anchor" id="line-1-9"></span>cd $DPDK
<span class="anchor" id="line-2-4"></span>sudo modprobe uio
<span class="anchor" id="line-3-2"></span>sudo insmod x86_64-default-linuxapp-gcc/kmod/igb_uio.ko
</pre><span class="anchor" id="line-124"></span><span class="anchor" id="line-125"></span>

Check that igb_uio is supported <span class="anchor" id="line-126"></span><span class="anchor" id="line-127"></span><span class="anchor" id="line-128"></span>

<pre>
<span class="anchor" id="line-1-10"></span>./tools/igb_uio_bind.py --status
</pre>

<p>You should get something like this:</p>
<pre>
<span class="anchor" id="line-1-11"></span>Network devices using IGB_UIO driver
<span class="anchor" id="line-2-5"></span>====================================
<span class="anchor" id="line-3-3"></span>
<span class="anchor" id="line-4-2"></span>
<span class="anchor" id="line-5-2"></span>Network devices using kernel driver
<span class="anchor" id="line-6-1"></span>===================================
<span class="anchor" id="line-7-1"></span>0000:00:03.0 '82540EM Gigabit Ethernet Controller' if=eth0 drv=e1000 unused=igb_uio *Active*
<span class="anchor" id="line-8-1"></span>0000:00:08.0 '82540EM Gigabit Ethernet Controller' if=eth1 drv=e1000 unused=igb_uio *Active*
<span class="anchor" id="line-9-1"></span>0000:00:09.0 '82540EM Gigabit Ethernet Controller' if=eth2 drv=e1000 unused=igb_uio *Active*
<span class="anchor" id="line-10"></span>
<span class="anchor" id="line-11"></span>Other network devices
<span class="anchor" id="line-12"></span>=====================
<span class="anchor" id="line-13"></span>
</pre>

<p>To bind an “active” NIC (one that is being used by Linux already) you will need to force it: <span class="anchor" id="line-148">&lt;/span&gt;<span class="anchor" id="line-149"></span></span></p>
<p><span class="anchor" id="line-150">&lt;/span&gt;<span class="anchor" id="line-151"></span></span></p>
<pre>
<span class="anchor" id="line-1-12"></span>sudo ./tools/igb_uio_bind.py --force --bind=igb_uio eth1
</pre><span class="anchor" id="line-152"></span><span class="anchor" id="line-153"></span>

Do the same for the other interface <span class="anchor" id="line-154"></span><span class="anchor" id="line-155"></span><span class="anchor" id="line-156"></span>

<pre>
<span class="anchor" id="line-1-13"></span>sudo ./tools/igb_uio_bind.py --force --bind=igb_uio eth2
</pre><span class="anchor" id="line-157"></span><span class="anchor" id="line-158"></span>

You can bind the interface back to it's original driver with the same tool, i.e. <span class="anchor" id="line-159"></span><span class="anchor" id="line-160"></span><span class="anchor" id="line-161"></span>

<pre>
<span class="anchor" id="line-1-14"></span>sudo ./tools/igb_uio_bind.py --force --bind=e1000 eth1
</pre><span class="anchor" id="line-162"></span><span class="anchor" id="line-163"></span>

### Quick test of DPDK using l2fwd<span class="anchor" id="line-164"></span><span class="anchor" id="line-165"></span>

<span class="anchor" id="line-166"></span><span class="anchor" id="line-167"></span><span class="anchor" id="line-168"></span>

<pre>
<span class="anchor" id="line-1-15"></span>cd examples/l2fwd
<span class="anchor" id="line-2-6"></span>make RTE_SDK=$DPDK RTE_TARGET=x86_64-default-linuxapp-gcc
</pre><span class="anchor" id="line-169"></span><span class="anchor" id="line-170"></span>

To run it you will also need to mount hugetlbfs. <span class="anchor" id="line-171"></span><span class="anchor" id="line-172"></span>

<span class="anchor" id="line-173"></span><span class="anchor" id="line-174"></span><span class="anchor" id="line-175"></span><span class="anchor" id="line-176"></span><span class="anchor" id="line-177"></span><span class="anchor" id="line-178"></span><span class="anchor" id="line-179"></span>

<pre>
<span class="anchor" id="line-1-16"></span>sudo sysctl -w vm.nr_hugepages=320
<span class="anchor" id="line-2-7"></span>sudo mkdir -p /mnt/huge
<span class="anchor" id="line-3-4"></span>sudo mount -t hugetlbfs hugetlbfs /mnt/huge
<span class="anchor" id="line-4-3"></span>
<span class="anchor" id="line-5-3"></span>cd examples/l2fwd/build/
<span class="anchor" id="line-6-2"></span>sudo ./l2fwd -c 0x3 -n 4 -- -p 0x3 -T 1
</pre><span class="anchor" id="line-180"></span><span class="anchor" id="line-181"></span>

You can also specify the number of queues per lcore but the default value 1 is ok. The -p 0x3 is important, it selects the DPDK 'ports' aka network devices that will be used. In this case ports 1 and 2 are selected. The -T parameter is used to updates the counters once a second. <span class="anchor" id="line-182"></span><span class="anchor" id="line-183"></span>

Now to test that it actually works we will use Wireshark and good old ping. <span class="anchor" id="line-184"></span><span class="anchor" id="line-185"></span>

Start Wireshark on the host and make it capture traffic on the second host only network interface (in my case this was vboxnet1). <span class="anchor" id="line-186"></span><span class="anchor" id="line-187"></span>

From the shell run: <span class="anchor" id="line-188"></span><span class="anchor" id="line-189"></span>

<span class="anchor" id="line-190"></span><span class="anchor" id="line-191"></span>

<pre>
<span class="anchor" id="line-1-17"></span>ping 192.168.56.101 -i 0.2
</pre><span class="anchor" id="line-192"></span><span class="anchor" id="line-193"></span>

Wireshark should now show packets coming from 192.168.56.1 and with destination 192.168.56.101. The counters in the l2fwd applications should also be updated once a second. <span class="anchor" id="line-194"></span><span class="anchor" id="line-195"></span>

Then try to close the l2fwd application and observe that wireshark doesn't get packets anymore. <span class="anchor" id="line-196"></span><span class="anchor" id="line-197"></span>

### Other DPDK examples<span class="anchor" id="line-198"></span>

There are other examples included, I tried test-pmd just out of curiosity. Detailed information about running them can be found on:
<span class="anchor" id="line-199"></span>http://www.intel.com/content/dam/www/public/us/en/documents/guides/intel-dpdk-sample-applications-user-guide.pdf <span class="anchor" id="line-200"></span><span class="anchor" id="line-201"></span>

## Installing Openvswitch with DPDK<span class="anchor" id="line-202"></span>

After installing and running dpdk successfully you can start working on getting openvswitch up and running with DPDK. I've used commit [b596218aa8acafd64a4c7d1c3e761f00e50c0c53](http://git.openvswitch.org/cgi-bin/gitweb.cgi?p=openvswitch;a=commit;h=b596218aa8acafd64a4c7d1c3e761f00e50c0c53) and it worked for me. <span class="anchor" id="line-203"></span><span class="anchor" id="line-204"></span>

### Compiling OVS with DPDK<span class="anchor" id="line-205"></span>

Official information can be found here:
<span class="anchor" id="line-206"></span>http://git.openvswitch.org/cgi-bin/gitweb.cgi?p=openvswitch;a=blob_plain;f=INSTALL.DPDK;hb=HEAD <span class="anchor" id="line-207"></span><span class="anchor" id="line-208"></span>

I followed the exact same steps, but I added the -ldl to LIBS since my x86_64 Ubuntu didn't link with the default options. <span class="anchor" id="line-209"></span><span class="anchor" id="line-210"></span>

cd openvswitch <span class="anchor" id="line-211"></span>./boot.sh <span class="anchor" id="line-212"></span>./configure --with-dpdk=$DPDK LIBS=-ldl <span class="anchor" id="line-213"></span>make <span class="anchor" id="line-214"></span>sudo make install <span class="anchor" id="line-215"></span><span class="anchor" id="line-216"></span>

### Database initialization<span class="anchor" id="line-217"></span>

To manually initialize the database you need to do: <span class="anchor" id="line-218"></span><span class="anchor" id="line-219"></span>

<span class="anchor" id="line-220"></span><span class="anchor" id="line-221"></span><span class="anchor" id="line-222"></span>

<pre>
<span class="anchor" id="line-1-18"></span>sudo mkdir -p /usr/local/etc/openvswitch
<span class="anchor" id="line-2-8"></span>sudo ovsdb-tool create /usr/local/etc/openvswitch/conf.db vswitchd/vswitch.ovsschema
</pre><span class="anchor" id="line-223"></span><span class="anchor" id="line-224"></span>

### Preparing DPDK<span class="anchor" id="line-225"></span>

For the DPDK part you need to configure hugetables, insert the kernel modules (uio and igb_uio) and bind the network interfaces to igb_uio. <span class="anchor" id="line-226"></span>These need to be done pretty much once after the computer is started. <span class="anchor" id="line-227"></span><span class="anchor" id="line-228"></span>

<span class="anchor" id="line-229"></span><span class="anchor" id="line-230"></span><span class="anchor" id="line-231"></span><span class="anchor" id="line-232"></span><span class="anchor" id="line-233"></span><span class="anchor" id="line-234"></span><span class="anchor" id="line-235"></span><span class="anchor" id="line-236"></span><span class="anchor" id="line-237"></span><span class="anchor" id="line-238"></span>

<pre>
<span class="anchor" id="line-1-19"></span>sudo sysctl -w vm.nr_hugepages=2000
<span class="anchor" id="line-2-9"></span>sudo mkdir -p /mnt/huge
<span class="anchor" id="line-3-5"></span>sudo mount -t hugetlbfs hugetlbfs /mnt/huge
<span class="anchor" id="line-4-4"></span>
<span class="anchor" id="line-5-4"></span>sudo modprobe uio.ko
<span class="anchor" id="line-6-3"></span>cd $DPDK
<span class="anchor" id="line-7-2"></span>sudo insmod x86_64-default-linuxapp-gcc/kmod/igb_uio.ko
<span class="anchor" id="line-8-2"></span>sudo ./tools/igb_uio_bind.py --force --bind=igb_uio eth1
<span class="anchor" id="line-9-2"></span>sudo ./tools/igb_uio_bind.py --force --bind=igb_uio eth2
</pre><span class="anchor" id="line-239"></span><span class="anchor" id="line-240"></span>

### Permanent startup configuration<span class="anchor" id="line-241"></span>

Here is how to setup hugetables and have the kernel modules loaded at startup. I haven't looked for a solution to bind the wanted interfaces to DPDK on startup, but there should be a way to do that. <span class="anchor" id="line-242"></span><span class="anchor" id="line-243"></span>

To have hugetables mounted by default at startup you need to add an entry to /etc/fstab <span class="anchor" id="line-244"></span><span class="anchor" id="line-245"></span>

<span class="anchor" id="line-246"></span><span class="anchor" id="line-247"></span>

<pre>
<span class="anchor" id="line-1-20"></span>hugetlbfs       /mnt/huge       hugetlbfs       rw,mode=0777    0       0
</pre><span class="anchor" id="line-248"></span><span class="anchor" id="line-249"></span>

To have the igb_uio.ko module loaded at boot time you need to make it known to modprobe. One good option is to make a symlink to it somewhere in the linux kernel structure: <span class="anchor" id="line-250"></span><span class="anchor" id="line-251"></span>

<span class="anchor" id="line-252"></span><span class="anchor" id="line-253"></span><span class="anchor" id="line-254"></span>

<pre>
<span class="anchor" id="line-1-21"></span>sudo ln -s $DPDK/x86_64-default-linuxapp-gcc/kmod/igb_uio.ko /lib/modules/`uname -r`/kernel/drivers/uio/igb_uio.ko
<span class="anchor" id="line-2-10"></span>sudo depmod -a
</pre><span class="anchor" id="line-255"></span><span class="anchor" id="line-256"></span>

Then you need to add both uio and igb_uio to /etc/modules so that they are loaded at boot time. <span class="anchor" id="line-257"></span><span class="anchor" id="line-258"></span>

My Ubuntu 13.10 installation failed to start the desktop manager properly when one of the cards didn't get IP from dhcp. If that happens to you and you want the desktop manager, just log on to console 1 (Alt + Ctrl + F1) and run: <span class="anchor" id="line-259"></span>sudo service lightdm restart <span class="anchor" id="line-260"></span><span class="anchor" id="line-261"></span><span class="anchor" id="line-262"></span>

<pre>
<span class="anchor" id="line-1-22"></span>sudo service lightdm restart
</pre><span class="anchor" id="line-263"></span><span class="anchor" id="line-264"></span>

However disabling the X server altogether should result in better performance overall. <span class="anchor" id="line-265"></span><span class="anchor" id="line-266"></span>

### Running openvswitch with DPDK<span class="anchor" id="line-267"></span>

To manually run openvswitch you must do these each time: <span class="anchor" id="line-268"></span><span class="anchor" id="line-269"></span>

<span class="anchor" id="line-270"></span><span class="anchor" id="line-271"></span><span class="anchor" id="line-272"></span><span class="anchor" id="line-273"></span><span class="anchor" id="line-274"></span><span class="anchor" id="line-275"></span><span class="anchor" id="line-276"></span><span class="anchor" id="line-277"></span><span class="anchor" id="line-278"></span><span class="anchor" id="line-279"></span>

<pre>
<span class="anchor" id="line-1-23"></span>sudo ovsdb-server --remote=punix:/usr/local/var/run/openvswitch/db.sock \
<span class="anchor" id="line-2-11"></span>                                        --remote=db:Open_vSwitch,Open_vSwitch,manager_options \
<span class="anchor" id="line-3-6"></span>                                        --private-key=db:Open_vSwitch,SSL,private_key \
<span class="anchor" id="line-4-5"></span>                                        --certificate=db:Open_vSwitch,SSL,certificate \
<span class="anchor" id="line-5-5"></span>                                        --bootstrap-ca-cert=db:Open_vSwitch,SSL,ca_cert \
<span class="anchor" id="line-6-4"></span>                                        --pidfile --detach
<span class="anchor" id="line-7-3"></span>
<span class="anchor" id="line-8-3"></span>sudo ovs-vsctl --no-wait init
<span class="anchor" id="line-9-3"></span>sudo ovs-vswitchd --dpdk -c 0x3 -n 4 -- unix:/usr/local/var/run/openvswitch/db.sock --log-file=/usr/local/var/log/openvswitch/ovs-vswitchd.log --pidfile --detach
</pre><span class="anchor" id="line-280"></span><span class="anchor" id="line-281"></span>

### Bridge configuration<span class="anchor" id="line-282"></span>

You need to add a netdev type bridge in order to make ovs running with DPDK. This means that all datapath switching will be done in userspace. <span class="anchor" id="line-283"></span><span class="anchor" id="line-284"></span>

You may get an error like "ovs-vsctl: Error detected while setting up 'ovsbr0'. See ovs-vswitchd log for details." in case you don't have the openvswitch module inserted. But the bridge will be created so you ignore the warning and continue. <span class="anchor" id="line-285"></span><span class="anchor" id="line-286"></span>

<span class="anchor" id="line-287"></span><span class="anchor" id="line-288"></span><span class="anchor" id="line-289"></span><span class="anchor" id="line-290"></span><span class="anchor" id="line-291"></span><span class="anchor" id="line-292"></span>

<pre>
<span class="anchor" id="line-1-24"></span>sudo ovs-vsctl add-br ovsbr0
<span class="anchor" id="line-2-12"></span>sudo ovs-vsctl set bridge ovsbr0 datapath_type=netdev
<span class="anchor" id="line-3-7"></span>
<span class="anchor" id="line-4-6"></span>sudo ovs-vsctl add-port ovsbr0 dpdk0 -- set Interface dpdk0 type=dpdk
<span class="anchor" id="line-5-6"></span>sudo ovs-vsctl add-port ovsbr0 dpdk1 -- set Interface dpdk1 type=dpdk
</pre><span class="anchor" id="line-293"></span><span class="anchor" id="line-294"></span>

### Testing with ping and tcpdump<span class="anchor" id="line-295"></span><span class="anchor" id="line-296"></span>

A simple test to see that packets arrive at the bridge could be the following. First add an internal port to the bridge and bring it up: <span class="anchor" id="line-297"></span><span class="anchor" id="line-298"></span>

<span class="anchor" id="line-299"></span><span class="anchor" id="line-300"></span><span class="anchor" id="line-301"></span>

<pre>
<span class="anchor" id="line-1-25"></span>sudo ovs-vsctl add-port br0 br0p1 -- set Interface br0p1 type=internal
<span class="anchor" id="line-2-13"></span>sudo ifconfig br0p1 up
</pre><span class="anchor" id="line-302"></span><span class="anchor" id="line-303"></span>

On the guest machine then start tcpdump <span class="anchor" id="line-304"></span><span class="anchor" id="line-305"></span><span class="anchor" id="line-306"></span>

<pre>
<span class="anchor" id="line-1-26"></span>sudo tcpdump -i br0p1
</pre><span class="anchor" id="line-307"></span><span class="anchor" id="line-308"></span>

From the host try to ping the guest. With the virtual machine configuration described you can try to ping something inside the subnet of one of the host-only interfaces. Linux will route the requests to the host-only adapter which in turn will be relayed by VirtualBox and then broadcasted in the virtual switch, including the port br0p1. <span class="anchor" id="line-309"></span><span class="anchor" id="line-310"></span><span class="anchor" id="line-311"></span>

<pre>
<span class="anchor" id="line-1-27"></span>ping 192.168.56.102
</pre><span class="anchor" id="line-312"></span><span class="anchor" id="line-313"></span>

### Testing with mirroring port<span class="anchor" id="line-314"></span><span class="anchor" id="line-315"></span>

<span class="anchor" id="line-316"></span><span class="anchor" id="line-317"></span><span class="anchor" id="line-318"></span>

<pre>
<span class="anchor" id="line-1-28"></span>sudo ovs-vsctl -- set Bridge br0 mirrors=@m -- --id=@eth1 get Port eth1 -- --id=@eth2 get Port eth2 -- --id=@m create Mirror name=mymirror select-dst-port=@eth2 select-src-port=@eth1 output-port=@eth2
<span class="anchor" id="line-2-14"></span>sudo ovs-vsctl -- set Bridge ovsbr0 mirrors=@m -- --id=@dpdk0 get Port dpdk0 -- --id=@dpdk1 get Port dpdk1 -- --id=@m create Mirror name=mymirror select-dst-port=@dpdk1 select-src-port=@dpdk0 output-port=@dpdk1
</pre>


<p>备注：本文转自 <a href="https://wiki.linaro.org/LNG/Engineering/OVSDPDKOnUbuntu" target="_blank" rel="external">https://wiki.linaro.org/LNG/Engineering/OVSDPDKOnUbuntu</a>。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/10/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><span class="page-number current">11</span><a class="page-number" href="/page/12/">12</a><span class="space">&hellip;</span><a class="page-number" href="/page/18/">18</a><a class="extend next" rel="next" href="/page/12/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="//schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/qrcode.jpg"
               alt="Feisky" />
          <p class="site-author-name" itemprop="name">Feisky</p>
          <p class="site-description motion-element" itemprop="description">Notes about anything.</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">89</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">14</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">28</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/feiskyer" target="_blank" title="Github">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  Github
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/feisky" target="_blank" title="Twitter">
                  
                    <i class="fa fa-fw fa-twitter"></i>
                  
                  Twitter
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/371069890" target="_blank" title="Weibo">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  Weibo
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.cnblogs.com/feisky/" target="_blank" title="博客园">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  博客园
                </a>
              </span>
            
          
        </div>

        
        

        
        

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Feisky</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.0.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.2"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.2"></script>



  



  




  
  
  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
       search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body").append('<div class="popoverlay">').css('overflow', 'hidden');
      $('.popup').toggle();

    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
    'use strict';
    $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
            // get the contents from search data
            isfetched = true;
            $('.popup').detach().appendTo('.header-inner');
            var datas = $( "entry", xmlResponse ).map(function() {
                return {
                    title: $( "title", this ).text(),
                    content: $("content",this).text(),
                    url: $( "url" , this).text()
                };
            }).get();
            var $input = document.getElementById(search_id);
            var $resultContent = document.getElementById(content_id);
            $input.addEventListener('input', function(){
                var matchcounts = 0;
                var str='<ul class=\"search-result-list\">';
                var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                $resultContent.innerHTML = "";
                if (this.value.trim().length > 1) {
                // perform local searching
                datas.forEach(function(data) {
                    var isMatch = false;
                    var content_index = [];
                    var data_title = data.title.trim().toLowerCase();
                    var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                    var data_url = decodeURIComponent(data.url);
                    var index_title = -1;
                    var index_content = -1;
                    var first_occur = -1;
                    // only match artiles with not empty titles and contents
                    if(data_title != '') {
                        keywords.forEach(function(keyword, i) {
                            index_title = data_title.indexOf(keyword);
                            index_content = data_content.indexOf(keyword);
                            if( index_title >= 0 || index_content >= 0 ){
                                isMatch = true;
								if (i == 0) {
                                    first_occur = index_content;
                                }
                            } 
							
                        });
                    }
                    // show search results
                    if (isMatch) {
                        matchcounts += 1;
                        str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                        var content = data.content.trim().replace(/<[^>]+>/g,"");
                        if (first_occur >= 0) {
                            // cut out 100 characters
                            var start = first_occur - 20;
                            var end = first_occur + 80;
                            if(start < 0){
                                start = 0;
                            }
                            if(start == 0){
                                end = 50;
                            }
                            if(end > content.length){
                                end = content.length;
                            }
                            var match_content = content.substring(start, end);
                            // highlight all keywords
                            keywords.forEach(function(keyword){
                                var regS = new RegExp(keyword, "gi");
                                match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                            });

                            str += "<p class=\"search-result\">" + match_content +"...</p>"
                        }
                        str += "</li>";
                    }
                })};
                str += "</ul>";
                if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
                if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
                $resultContent.innerHTML = str;
            });
            proceedsearch();
        }
    });}

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };

    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".popoverlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>


  
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
  </script>

  <script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for (i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
      }
    });
  </script>
  <script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>


  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->


  


</body>
</html>
